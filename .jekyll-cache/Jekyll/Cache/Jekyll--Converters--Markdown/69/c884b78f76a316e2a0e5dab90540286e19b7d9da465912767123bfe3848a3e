I"'<blockquote>
  <p>本文来自于我的简书：<a href="https://www.jianshu.com/p/b374a7b10486">初识 Nacos(上） 学习《Spring Cloud 服务发现新选择》</a>，转载请保留链接 ;)</p>
</blockquote>

<p>最近在从零接触Alibaba 开源项目Nacos,学习的是<a href="https://github.com/mercyblitz">小马哥(mercyblitz)</a>的技术周报，之前看了后忘记总结，导致也没有什么印象。所以现在决定学习一章，写一篇学习感悟，并且持续更新下去。首先这一章节主要讲得是服务发现(Service Discovery)，作为 Spring Cloud 最核心功能特性之一，受到业界的广泛关注。
<img src="https://raw.githubusercontent.com/caojiele/caojiele.github.io/master/img/in-post/2018.09/21/post-theme.png" alt="文章主题" /></p>

<h2 id="spring-cloud-整体架构">Spring Cloud 整体架构</h2>

<p>在现行的 Spring Cloud 服务发现技术体系中，以 Spring Cloud Eureka 为典型代表，它作为官方推荐解决方案，被业 界广泛运用，然而其设计缺陷也非常之明显。还有Spring Cloud Zookeeper和Spring Cloud Consul。那么先介绍这三种的特点吧。
<img src="https://raw.githubusercontent.com/caojiele/caojiele.github.io/master/img/in-post/2018.09/21/post-architecture.png" alt="整体架构" /></p>

<h3 id="spring-cloud-eureka-特点">Spring Cloud Eureka 特点</h3>
<h4 id="优点">优点：</h4>
<ul>
  <li>Spring Cloud 背书 - 推荐服务发现方案</li>
  <li>CAP 理论 - AP模型，数据最终一致</li>
  <li>简单易用 - 开箱即用，控制台管理</li>
</ul>

<h4 id="缺点">缺点：</h4>
<ul>
  <li>内存限制 - 客户端上报完整注册信息，造成服务端内存浪费</li>
  <li>单一调度更新 - 客户端简单轮训更新，增加服务器压力</li>
  <li>集群伸缩性限制 - 广播式复制模型，增加服务器压力</li>
</ul>

<h3 id="spring-cloud-zookeeper-特点">Spring Cloud Zookeeper 特点</h3>
<h4 id="优点-1">优点：</h4>
<ul>
  <li>成熟协调系统 - Dubbo、Spring Cloud等适配方案</li>
  <li>CAP理论 - CP模型，ZAB算法，强数据一致性</li>
</ul>

<h4 id="缺点-1">缺点：</h4>
<ul>
  <li>维护成本 - 客户端、Session状态、网络故障</li>
  <li>伸缩性限制 - 内存、GC、连接</li>
</ul>

<h3 id="spring-cloud-consul-特点">Spring Cloud Consul 特点</h3>
<h4 id="优点-2">优点：</h4>
<ul>
  <li>通用方案 - 适用于 Service Mesh、 Java 生态</li>
  <li>CAP理论 - AP 模型，Raft+Gossip 算法，数据最终一致</li>
</ul>

<h4 id="缺点-2">缺点：</h4>
<ul>
  <li>可靠性无法保证 - 未经过大规模验证</li>
  <li>非 Java 生态 - 维护和问题排查困难</li>
</ul>

<p>综上所述，让我得出了Spring Cloud服务发现方案对比结果:
<img src="https://raw.githubusercontent.com/caojiele/caojiele.github.io/master/img/in-post/2018.09/21/post-compare.png" alt="方案对比结果" /></p>

<p>那么这三种服务发现的基本模式是怎样的呢？现在来谈谈Spring cloud 服务器发现模式。</p>
<ul>
  <li>首先都是服务器启动 - 启动注册中心</li>
  <li>然后增加客户端依赖 - <code class="highlighter-rouge">sping-cloud-start-*</code></li>
  <li>最后就是客户端注册 - 记得在<code class="highlighter-rouge">XXApplication.java</code>文件中添加<code class="highlighter-rouge">@EnableDiscoveryClient</code>，注解开启服务注册与发现功能。</li>
</ul>

<p>以下我以Eureka发现模式为例：</p>
<ul>
  <li>首先去<a href="https://start.spring.io">Spring Initializr</a>快速创建Eureka服务端和客户端应用程序，然后导入自己的IDE。当然你如果嫌麻烦，也可以直接导入已经写好的<a href="https://github.com/mercyblitz/tech-weekly/tree/master/2018.09.21%E3%80%8C%E5%B0%8F%E9%A9%AC%E5%93%A5%E6%8A%80%E6%9C%AF%E5%91%A8%E6%8A%A5%E3%80%8D-%20%E7%AC%AC%E4%B8%80%E6%9C%9F%E3%80%8ASpring%20Cloud%20%E6%9C%8D%E5%8A%A1%E5%8F%91%E7%8E%B0%E6%96%B0%E9%80%89%E6%8B%A9%20-%20Alibaba%20Nacos%20Discovery%E3%80%8B/%E4%BB%A3%E7%A0%81">工程</a>。</li>
  <li>然后在<code class="highlighter-rouge">resources-application.properties</code>中分别配置好两者的端口号，像客户端这块还需要写好应用名称、以及Eureka 服务器地址。</li>
  <li>最后我们就直接可以run<code class="highlighter-rouge">XXApplication.java</code>了，像我的服务端端口是<code class="highlighter-rouge">12345</code>，就访问<a href="localhost:12345">localhost:12345</a>。页面跳转如下图所示，恭喜你的Eureka服务已经起来了。</li>
  <li>Eureka-client亦如此，成功run起来后，在之前的服务端页面，也就是<a href="localhost:12345">localhost:12345</a>，刷新下会在<code class="highlighter-rouge">Instances currently registered with Eureka</code>出现<code class="highlighter-rouge">EUREKA-CLIENT</code>的状态信息。</li>
</ul>

<p>spring-cloud-alibaba-nacos-discovery 作为 Spring Cloud Alibaba 服务发现的核心模块，其架构基础与 Spring Cloud 现行方案相同，均构建在 Spring Cloud Commons 抽象。因此，它在 Spring Cloud 服务发现的使用上，开发人员将不会心存任何的违和感。</p>

<h2 id="alibaba-nacos-生态介绍">Alibaba Nacos 生态介绍</h2>
<p>从功能特性而言，spring-cloud-alibaba-nacos-discovery 仅是 Nacos 在 Spring Cloud 服务发现的解决方案，Nacos 在 Spring Cloud 中还支持分布式配置的特性。与开源产品不同的是，Nacos 曾经历过中国特色的超大流量考验，以及巨型规模的集群实施，无论从经验积累还是技术沉淀，现行 Spring Cloud 解决方案 都是无法比拟的。然而这并非说明它完美无缺，在内部的评估和讨论中，也发现其中差距和文化差异。为了解决这些问题，讨论将从整体架构和设计思考两个方面，介绍 Nacos 与 Spring 技术栈整合情况，以及与其他开源方案的适配思考，整体上，降低 Nacos 使用门槛，使迁移成本接近为零，达到“一次开发，到处运行”的目的。
那么接下来我们通过Github上，Spring Cloud Alibaba项目中官方给出的指导文档来配置启动 Nacos吧。</p>

<h3 id="下载注册中心">下载注册中心</h3>

<ol>
  <li>
    <p>首先需要获取 Nacos Server，支持直接下载和源码构建两种方式。</p>

    <ol>
      <li>直接下载：<a href="https://github.com/alibaba/nacos/releases">Nacos Server 下载页</a></li>
      <li>源码构建：进入 Nacos <a href="https://github.com/alibaba/nacos">Github 项目页面</a>，将代码 git clone 到本地自行编译打包，<a href="https://nacos.io/zh-cn/docs/quick-start.html">参考此文档</a>。<strong>推荐使用源码构建方式以获取最新版本</strong></li>
    </ol>
  </li>
</ol>

<h3 id="启动注册中心">启动注册中心</h3>

<ol>
  <li>
    <p>启动 Server，进入解压后文件夹或编译打包好的文件夹，找到如下相对文件夹 nacos/bin，并对照操作系统实际情况之下如下命令。</p>

    <ol>
      <li>Linux/Unix/Mac 操作系统，执行命令 <code class="highlighter-rouge">sh startup.sh -m standalone</code></li>
      <li>Windows 操作系统，执行命令 <code class="highlighter-rouge">cmd startup.cmd</code></li>
    </ol>
  </li>
</ol>

<h3 id="增加第三方依赖">增加第三方依赖</h3>

<ol>
  <li>首先，修改 pom.xml 文件，引入 Nacos Discovery Starter。
    <pre><code class="language-mongoDB">     &lt;dependency&gt;
         &lt;groupId&gt;org.springframework.cloud&lt;/groupId&gt;
         &lt;artifactId&gt;spring-cloud-starter-alibaba-nacos-discovery&lt;/artifactId&gt;
     &lt;/dependency&gt;
</code></pre>
    <h3 id="外部化配置">外部化配置</h3>
  </li>
  <li>在应用的 /src/main/resources/application.properties 配置文件中配置 Nacos Server 地址
    <pre><code class="language-mongoDB">     spring.cloud.nacos.discovery.server-addr=127.0.0.1:8848
</code></pre>
    <h3 id="激活服务发现">激活服务发现</h3>
  </li>
  <li>使用 @EnableDiscoveryClient 注解开启服务注册与发现功能（<code class="highlighter-rouge">SpringApplication.run</code>)
    <pre><code class="language-mongoDB">     @SpringBootApplication
     @EnableDiscoveryClient
     public class ProviderApplication {

         public static void main(String[] args) {
             SpringApplication.run(Application.class, args);
         }

         @RestController
         class EchoController {
             @RequestMapping(value = "/echo/{string}", method = RequestMethod.GET)
             public String echo(@PathVariable String string) {
                     return string;
             }
         }
     }
</code></pre>
  </li>
</ol>

<h3 id="应用启动">应用启动</h3>

<ol>
  <li>增加配置，在 nacos-discovery-provider-example 项目的 /src/main/resources/application.properties 中添加基本配置信息
    <pre><code class="language-mongoDB">     spring.application.name=service-provider
     server.port=18082
</code></pre>
  </li>
  <li>
    <p>启动应用，支持 IDE 直接启动和编译打包后启动。</p>

    <ol>
      <li>IDE直接启动：找到 nacos-discovery-provider-example 项目的主类 <code class="highlighter-rouge">ProviderApplication</code>，执行 main 方法启动应用。</li>
      <li>打包编译后启动：在 nacos-discovery-provider-example 项目中执行 <code class="highlighter-rouge">mvn clean package</code> 将工程编译打包，然后执行 <code class="highlighter-rouge">java -jar nacos-discovery-provider-example.jar</code>启动应用。</li>
    </ol>
  </li>
</ol>

<h3 id="验证">验证</h3>

<h4 id="检验服务发现">检验服务发现</h4>
<p>在浏览器输入此地址<a href="http://127.0.0.1:8848/nacos/v1/ns/instances?serviceName=service-provider">http://127.0.0.1:8848/nacos/v1/ns/instances?serviceName=service-provider</a> 并点击跳转，可以看到服务节点已经成功注册到 Nacos Server。</p>

<p><img src="https://cdn.nlark.com/lark/0/2018/png/54319/1536986288092-5cf96af9-9a26-466b-85f6-39ad1d92dfdc.png" alt="查询服务" /></p>
:ET