I"*ë<p>Spring æœ€é‡è¦çš„æ¦‚å¿µæ˜¯ IOC å’Œ AOPï¼Œæœ¬ç¯‡æ–‡ç« å…¶å®å°±æ˜¯è¦å¸¦é¢†å¤§å®¶æ¥åˆ†æä¸‹ Spring çš„ IOC å®¹å™¨ã€‚æ—¢ç„¶å¤§å®¶å¹³æ—¶éƒ½è¦ç”¨åˆ° Springï¼Œæ€ä¹ˆå¯ä»¥ä¸å¥½å¥½äº†è§£ Spring å‘¢ï¼Ÿé˜…è¯»æœ¬æ–‡å¹¶ä¸èƒ½è®©ä½ æˆä¸º Spring ä¸“å®¶ï¼Œä¸è¿‡ä¸€å®šæœ‰åŠ©äºå¤§å®¶ç†è§£ Spring çš„å¾ˆå¤šæ¦‚å¿µï¼Œå¸®åŠ©å¤§å®¶æ’æŸ¥åº”ç”¨ä¸­å’Œ Spring ç›¸å…³çš„ä¸€äº›é—®é¢˜ã€‚</p>

<p>æœ¬æ–‡é‡‡ç”¨çš„æºç ç‰ˆæœ¬æ˜¯ 4.3.11.RELEASEï¼Œç®—æ˜¯ 5.0.x å‰æ¯”è¾ƒæ–°çš„ç‰ˆæœ¬äº†ã€‚ä¸ºäº†é™ä½éš¾åº¦ï¼Œæœ¬æ–‡æ‰€è¯´çš„æ‰€æœ‰çš„å†…å®¹éƒ½æ˜¯åŸºäº xml çš„é…ç½®çš„æ–¹å¼ï¼Œå®é™…ä½¿ç”¨å·²ç»å¾ˆå°‘äººè¿™ä¹ˆåšäº†ï¼Œè‡³å°‘ä¸æ˜¯çº¯ xml é…ç½®ï¼Œä¸è¿‡ä»ç†è§£æºç çš„è§’åº¦æ¥çœ‹ç”¨è¿™ç§æ–¹å¼æ¥è¯´æ— ç–‘æ˜¯æœ€åˆé€‚çš„ã€‚</p>

<p>é˜…è¯»å»ºè®®ï¼šè¯»è€…è‡³å°‘éœ€è¦çŸ¥é“æ€ä¹ˆé…ç½® Springï¼Œäº†è§£ Spring ä¸­çš„å„ç§æ¦‚å¿µï¼Œå°‘éƒ¨åˆ†å†…å®¹æˆ‘è¿˜å‡è®¾è¯»è€…ä½¿ç”¨è¿‡ SpringMVCã€‚æœ¬æ–‡è¦è¯´çš„ IOC æ€»ä½“æ¥è¯´æœ‰ä¸¤å¤„åœ°æ–¹æœ€é‡è¦ï¼Œä¸€ä¸ªæ˜¯åˆ›å»º Bean å®¹å™¨ï¼Œä¸€ä¸ªæ˜¯åˆå§‹åŒ– Beanï¼Œå¦‚æœè¯»è€…è§‰å¾—ä¸€æ¬¡æ€§çœ‹å®Œæœ¬æ–‡å‹åŠ›æœ‰ç‚¹å¤§ï¼Œé‚£ä¹ˆå¯ä»¥æŒ‰è¿™ä¸ªæ€è·¯åˆ†ä¸¤æ¬¡æ¶ˆåŒ–ã€‚è¯»è€…ä¸ä¸€å®šå¯¹ Spring å®¹å™¨çš„æºç æ„Ÿå…´è¶£ï¼Œä¹Ÿè®¸é™„å½•éƒ¨åˆ†ä»‹ç»çš„çŸ¥è¯†å¯¹è¯»è€…æœ‰äº›è®¸ä½œç”¨ã€‚</p>

<p>å¸Œæœ›é€šè¿‡æœ¬æ–‡å¯ä»¥è®©è¯»è€…ä¸æƒ§æ€•é˜…è¯» Spring æºç ï¼Œä¹Ÿå¸Œæœ›å¤§å®¶èƒ½åé¦ˆè¡¨è¿°é”™è¯¯æˆ–ä¸åˆç†çš„åœ°æ–¹ã€‚</p>

<p><strong>ç›®å½•</strong></p>

<!-- toc -->

<h2 id="å¼•è¨€">å¼•è¨€</h2>

<p>å…ˆçœ‹ä¸‹æœ€åŸºæœ¬çš„å¯åŠ¨ Spring å®¹å™¨çš„ä¾‹å­ï¼š</p>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
</pre></td><td class="rouge-code"><pre><span class="kd">public</span> <span class="kd">static</span> <span class="kt">void</span> <span class="nf">main</span><span class="o">(</span><span class="nc">String</span><span class="o">[]</span> <span class="n">args</span><span class="o">)</span> <span class="o">{</span>
    <span class="nc">ApplicationContext</span> <span class="n">context</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">ClassPathXmlApplicationContext</span><span class="o">(</span><span class="s">"classpath:applicationfile.xml"</span><span class="o">);</span>
<span class="o">}</span>
</pre></td></tr></tbody></table></code></pre></div></div>

<p>ä»¥ä¸Šä»£ç å°±å¯ä»¥åˆ©ç”¨é…ç½®æ–‡ä»¶æ¥å¯åŠ¨ä¸€ä¸ª Spring å®¹å™¨äº†ï¼Œè¯·ä½¿ç”¨ maven çš„å°ä¼™ä¼´ç›´æ¥åœ¨ dependencies ä¸­åŠ ä¸Šä»¥ä¸‹ä¾èµ–å³å¯ï¼Œä¸ªäººæ¯”è¾ƒåå¯¹é‚£äº›ä¸çŸ¥é“è¦æ·»åŠ ä»€ä¹ˆä¾èµ–ï¼Œç„¶åæŠŠ Spring çš„æ‰€æœ‰ç›¸å…³çš„ä¸œè¥¿éƒ½åŠ è¿›æ¥çš„æ–¹å¼ã€‚</p>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
</pre></td><td class="rouge-code"><pre><span class="o">&lt;</span><span class="n">dependency</span><span class="o">&gt;</span>
  <span class="o">&lt;</span><span class="n">groupId</span><span class="o">&gt;</span><span class="n">org</span><span class="o">.</span><span class="na">springframework</span><span class="o">&lt;/</span><span class="n">groupId</span><span class="o">&gt;</span>
  <span class="o">&lt;</span><span class="n">artifactId</span><span class="o">&gt;</span><span class="n">spring</span><span class="o">-</span><span class="n">context</span><span class="o">&lt;/</span><span class="n">artifactId</span><span class="o">&gt;</span>
  <span class="o">&lt;</span><span class="n">version</span><span class="o">&gt;</span><span class="mf">4.3</span><span class="o">.</span><span class="mi">11</span><span class="o">.</span><span class="na">RELEASE</span><span class="o">&lt;/</span><span class="n">version</span><span class="o">&gt;</span>
<span class="o">&lt;/</span><span class="n">dependency</span><span class="o">&gt;</span>
</pre></td></tr></tbody></table></code></pre></div></div>

<blockquote>
  <p>spring-context ä¼šè‡ªåŠ¨å°† spring-coreã€spring-beansã€spring-aopã€spring-expression è¿™å‡ ä¸ªåŸºç¡€ jar åŒ…å¸¦è¿›æ¥ã€‚</p>
</blockquote>

<p>å¤šè¯´ä¸€å¥ï¼Œå¾ˆå¤šå¼€å‘è€…å…¥é—¨å°±ç›´æ¥æ¥è§¦çš„ SpringMVCï¼Œå¯¹ Spring å…¶å®ä¸æ˜¯å¾ˆäº†è§£ï¼ŒSpring æ˜¯æ¸è¿›å¼çš„å·¥å…·ï¼Œå¹¶ä¸å…·æœ‰å¾ˆå¼ºçš„ä¾µå…¥æ€§ï¼Œå®ƒçš„æ¨¡å—ä¹Ÿåˆ’åˆ†å¾—å¾ˆåˆç†ï¼Œå³ä½¿ä½ çš„åº”ç”¨ä¸æ˜¯ web åº”ç”¨ï¼Œæˆ–è€…ä¹‹å‰å®Œå…¨æ²¡æœ‰ä½¿ç”¨åˆ° Springï¼Œè€Œä½ å°±æƒ³ç”¨ Spring çš„ä¾èµ–æ³¨å…¥è¿™ä¸ªåŠŸèƒ½ï¼Œå…¶å®å®Œå…¨æ˜¯å¯ä»¥çš„ï¼Œå®ƒçš„å¼•å…¥ä¸ä¼šå¯¹å…¶ä»–çš„ç»„ä»¶äº§ç”Ÿå†²çªã€‚</p>

<p>åºŸè¯è¯´å®Œï¼Œæˆ‘ä»¬ç»§ç»­ã€‚<code class="highlighter-rouge">ApplicationContext context = new ClassPathXmlApplicationContext(...)</code> å…¶å®å¾ˆå¥½ç†è§£ï¼Œä»åå­—ä¸Šå°±å¯ä»¥çŒœå‡ºä¸€äºŒï¼Œå°±æ˜¯åœ¨ ClassPath ä¸­å¯»æ‰¾ xml é…ç½®æ–‡ä»¶ï¼Œæ ¹æ® xml æ–‡ä»¶å†…å®¹æ¥æ„å»º ApplicationContextã€‚å½“ç„¶ï¼Œé™¤äº† ClassPathXmlApplicationContext ä»¥å¤–ï¼Œæˆ‘ä»¬ä¹Ÿè¿˜æœ‰å…¶ä»–æ„å»º ApplicationContext çš„æ–¹æ¡ˆå¯ä¾›é€‰æ‹©ï¼Œæˆ‘ä»¬å…ˆæ¥çœ‹çœ‹å¤§ä½“çš„ç»§æ‰¿ç»“æ„æ˜¯æ€ä¹ˆæ ·çš„ï¼š</p>

<p><img src="https://www.javadoop.com/blogimages/spring-context/1.png" alt="1" /></p>

<blockquote>
  <p>è¯»è€…å¯ä»¥å¤§è‡´çœ‹ä¸€ä¸‹ç±»åï¼Œæºç åˆ†æçš„æ—¶å€™ä¸è‡³äºæ‰¾ä¸ç€çœ‹å“ªä¸ªç±»ï¼Œå› ä¸º Spring ä¸ºäº†é€‚åº”å„ç§ä½¿ç”¨åœºæ™¯ï¼Œæä¾›çš„å„ä¸ªæ¥å£éƒ½å¯èƒ½æœ‰å¾ˆå¤šçš„å®ç°ç±»ã€‚å¯¹äºæˆ‘ä»¬æ¥è¯´ï¼Œå°±æ˜¯æªç€ä¸€ä¸ªå®Œæ•´çš„åˆ†æ”¯çœ‹å®Œã€‚</p>

  <p>å½“ç„¶ï¼Œè¯»æœ¬æ–‡çš„æ—¶å€™è¯»è€…ä¹Ÿä¸å¿…å¤ªæ‹…å¿ƒï¼Œæ¯ä¸ªä»£ç å—åˆ†æçš„æ—¶å€™ï¼Œæˆ‘éƒ½ä¼šå‘Šè¯‰è¯»è€…æˆ‘ä»¬åœ¨è¯´å“ªä¸ªç±»ç¬¬å‡ è¡Œã€‚</p>
</blockquote>

<p>æˆ‘ä»¬å¯ä»¥çœ‹åˆ°ï¼ŒClassPathXmlApplicationContext å…œå…œè½¬è½¬äº†å¥½ä¹…æ‰åˆ° ApplicationContext æ¥å£ï¼ŒåŒæ ·çš„ï¼Œæˆ‘ä»¬ä¹Ÿå¯ä»¥ä½¿ç”¨ç»¿é¢œè‰²çš„ <strong>FileSystemXmlApplicationContext</strong> å’Œ <strong>AnnotationConfigApplicationContext</strong> è¿™ä¸¤ä¸ªç±»ã€‚</p>

<p><strong>FileSystemXmlApplicationContext</strong> çš„æ„é€ å‡½æ•°éœ€è¦ä¸€ä¸ª xml é…ç½®æ–‡ä»¶åœ¨ç³»ç»Ÿä¸­çš„è·¯å¾„ï¼Œå…¶ä»–å’Œ ClassPathXmlApplicationContext åŸºæœ¬ä¸Šä¸€æ ·ã€‚</p>

<p><strong>AnnotationConfigApplicationContext</strong> æ˜¯åŸºäºæ³¨è§£æ¥ä½¿ç”¨çš„ï¼Œå®ƒä¸éœ€è¦é…ç½®æ–‡ä»¶ï¼Œé‡‡ç”¨ java é…ç½®ç±»å’Œå„ç§æ³¨è§£æ¥é…ç½®ï¼Œæ˜¯æ¯”è¾ƒç®€å•çš„æ–¹å¼ï¼Œä¹Ÿæ˜¯å¤§åŠ¿æ‰€è¶‹å§ã€‚</p>

<p>ä¸è¿‡æœ¬æ–‡æ—¨åœ¨å¸®åŠ©å¤§å®¶ç†è§£æ•´ä¸ªæ„å»ºæµç¨‹ï¼Œæ‰€ä»¥å†³å®šä½¿ç”¨ ClassPathXmlApplicationContext è¿›è¡Œåˆ†æã€‚</p>

<p>æˆ‘ä»¬å…ˆæ¥ä¸€ä¸ªç®€å•çš„ä¾‹å­æ¥çœ‹çœ‹æ€ä¹ˆå®ä¾‹åŒ– ApplicationContextã€‚</p>

<p>é¦–å…ˆï¼Œå®šä¹‰ä¸€ä¸ªæ¥å£ï¼š</p>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
</pre></td><td class="rouge-code"><pre><span class="kd">public</span> <span class="kd">interface</span> <span class="nc">MessageService</span> <span class="o">{</span>
    <span class="nc">String</span> <span class="nf">getMessage</span><span class="o">();</span>
<span class="o">}</span>
</pre></td></tr></tbody></table></code></pre></div></div>

<p>å®šä¹‰æ¥å£å®ç°ç±»ï¼š</p>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
</pre></td><td class="rouge-code"><pre><span class="kd">public</span> <span class="kd">class</span> <span class="nc">MessageServiceImpl</span> <span class="kd">implements</span> <span class="nc">MessageService</span> <span class="o">{</span>

    <span class="kd">public</span> <span class="nc">String</span> <span class="nf">getMessage</span><span class="o">()</span> <span class="o">{</span>
        <span class="k">return</span> <span class="s">"hello world"</span><span class="o">;</span>
    <span class="o">}</span>
<span class="o">}</span>
</pre></td></tr></tbody></table></code></pre></div></div>

<p>æ¥ä¸‹æ¥ï¼Œæˆ‘ä»¬åœ¨ <strong>resources</strong> ç›®å½•æ–°å»ºä¸€ä¸ªé…ç½®æ–‡ä»¶ï¼Œæ–‡ä»¶åéšæ„ï¼Œé€šå¸¸å« application.xml æˆ– application-xxx.xml å°±å¯ä»¥äº†ï¼š</p>

<div class="language-xml highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
</pre></td><td class="rouge-code"><pre><span class="cp">&lt;?xml version="1.0" encoding="UTF-8" ?&gt;</span>
<span class="nt">&lt;beans</span> <span class="na">xmlns:xsi=</span><span class="s">"http://www.w3.org/2001/XMLSchema-instance"</span>
       <span class="na">xmlns=</span><span class="s">"http://www.springframework.org/schema/beans"</span>
       <span class="na">xsi:schemaLocation=</span><span class="s">"http://www.springframework.org/schema/beans http://www.springframework.org/schema/beans/spring-beans.xsd"</span> <span class="na">default-autowire=</span><span class="s">"byName"</span><span class="nt">&gt;</span>

    <span class="nt">&lt;bean</span> <span class="na">id=</span><span class="s">"messageService"</span> <span class="na">class=</span><span class="s">"com.javadoop.example.MessageServiceImpl"</span><span class="nt">/&gt;</span>
<span class="nt">&lt;/beans&gt;</span>
</pre></td></tr></tbody></table></code></pre></div></div>

<p>è¿™æ ·ï¼Œæˆ‘ä»¬å°±å¯ä»¥è·‘èµ·æ¥äº†ï¼š</p>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
</pre></td><td class="rouge-code"><pre><span class="kd">public</span> <span class="kd">class</span> <span class="nc">App</span> <span class="o">{</span>
    <span class="kd">public</span> <span class="kd">static</span> <span class="kt">void</span> <span class="nf">main</span><span class="o">(</span><span class="nc">String</span><span class="o">[]</span> <span class="n">args</span><span class="o">)</span> <span class="o">{</span>
        <span class="c1">// ç”¨æˆ‘ä»¬çš„é…ç½®æ–‡ä»¶æ¥å¯åŠ¨ä¸€ä¸ª ApplicationContext</span>
        <span class="nc">ApplicationContext</span> <span class="n">context</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">ClassPathXmlApplicationContext</span><span class="o">(</span><span class="s">"classpath:application.xml"</span><span class="o">);</span>
      
        <span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">"context å¯åŠ¨æˆåŠŸ"</span><span class="o">);</span>
      
        <span class="c1">// ä» context ä¸­å–å‡ºæˆ‘ä»¬çš„ Beanï¼Œè€Œä¸æ˜¯ç”¨ new MessageServiceImpl() è¿™ç§æ–¹å¼</span>
        <span class="nc">MessageService</span> <span class="n">messageService</span> <span class="o">=</span> <span class="n">context</span><span class="o">.</span><span class="na">getBean</span><span class="o">(</span><span class="nc">MessageService</span><span class="o">.</span><span class="na">class</span><span class="o">);</span>
        <span class="c1">// è¿™å¥å°†è¾“å‡º: hello world</span>
        <span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="n">messageService</span><span class="o">.</span><span class="na">getMessage</span><span class="o">());</span>
    <span class="o">}</span>
<span class="o">}</span>
</pre></td></tr></tbody></table></code></pre></div></div>

<p>ä»¥ä¸Šä¾‹å­å¾ˆç®€å•ï¼Œä¸è¿‡ä¹Ÿå¤Ÿå¼•å‡ºæœ¬æ–‡çš„ä¸»é¢˜äº†ï¼Œå°±æ˜¯æ€ä¹ˆæ ·é€šè¿‡é…ç½®æ–‡ä»¶æ¥å¯åŠ¨ Spring çš„ ApplicationContextï¼Ÿä¹Ÿå°±æ˜¯æˆ‘ä»¬ä»Šå¤©è¦åˆ†æçš„ IOC çš„æ ¸å¿ƒäº†ã€‚ApplicationContext å¯åŠ¨è¿‡ç¨‹ä¸­ï¼Œä¼šè´Ÿè´£åˆ›å»ºå®ä¾‹ Beanï¼Œå¾€å„ä¸ª Bean ä¸­æ³¨å…¥ä¾èµ–ç­‰ã€‚</p>

<h2 id="beanfactory-ç®€ä»‹">BeanFactory ç®€ä»‹</h2>

<p>BeanFactoryï¼Œä»åå­—ä¸Šä¹Ÿå¾ˆå¥½ç†è§£ï¼Œç”Ÿäº§ bean çš„å·¥å‚ï¼Œå®ƒè´Ÿè´£ç”Ÿäº§å’Œç®¡ç†å„ä¸ª bean å®ä¾‹ã€‚</p>

<p>åˆå­¦è€…å¯åˆ«ä»¥ä¸ºæˆ‘ä¹‹å‰è¯´é‚£ä¹ˆå¤šå’Œ BeanFactory æ— å…³ï¼Œå‰é¢è¯´çš„ ApplicationContext å…¶å®å°±æ˜¯ä¸€ä¸ª BeanFactoryã€‚æˆ‘ä»¬æ¥çœ‹ä¸‹å’Œ BeanFactory æ¥å£ç›¸å…³çš„ä¸»è¦çš„ç»§æ‰¿ç»“æ„ï¼š</p>

<p><img src="https://www.javadoop.com/blogimages/spring-context/2.png" alt="2" /></p>

<p>æˆ‘æƒ³ï¼Œå¤§å®¶çœ‹å®Œè¿™ä¸ªå›¾ä»¥åï¼Œå¯èƒ½å°±ä¸æ˜¯å¾ˆå¼€å¿ƒäº†ã€‚ApplicationContext å¾€ä¸‹çš„ç»§æ‰¿ç»“æ„å‰é¢ä¸€å¼ å›¾è¯´è¿‡äº†ï¼Œè¿™é‡Œå°±ä¸é‡å¤äº†ã€‚è¿™å¼ å›¾å‘¢ï¼ŒèƒŒä¸‹æ¥è‚¯å®šæ˜¯ä¸éœ€è¦çš„ï¼Œæœ‰å‡ ä¸ªé‡ç‚¹å’Œå¤§å®¶è¯´æ˜ä¸‹å°±å¥½ã€‚</p>

<ol>
  <li>ApplicationContext ç»§æ‰¿äº† ListableBeanFactoryï¼Œè¿™ä¸ª Listable çš„æ„æ€å°±æ˜¯ï¼Œé€šè¿‡è¿™ä¸ªæ¥å£ï¼Œæˆ‘ä»¬å¯ä»¥è·å–å¤šä¸ª Beanï¼Œå¤§å®¶çœ‹æºç ä¼šå‘ç°ï¼Œæœ€é¡¶å±‚ BeanFactory æ¥å£çš„æ–¹æ³•éƒ½æ˜¯è·å–å•ä¸ª Bean çš„ã€‚</li>
  <li>ApplicationContext ç»§æ‰¿äº† HierarchicalBeanFactoryï¼ŒHierarchical å•è¯æœ¬èº«å·²ç»èƒ½è¯´æ˜é—®é¢˜äº†ï¼Œä¹Ÿå°±æ˜¯è¯´æˆ‘ä»¬å¯ä»¥åœ¨åº”ç”¨ä¸­èµ·å¤šä¸ª BeanFactoryï¼Œç„¶åå¯ä»¥å°†å„ä¸ª BeanFactory è®¾ç½®ä¸ºçˆ¶å­å…³ç³»ã€‚</li>
  <li>AutowireCapableBeanFactory è¿™ä¸ªåå­—ä¸­çš„ Autowire å¤§å®¶éƒ½éå¸¸ç†Ÿæ‚‰ï¼Œå®ƒå°±æ˜¯ç”¨æ¥è‡ªåŠ¨è£…é… Bean ç”¨çš„ï¼Œä½†æ˜¯ä»”ç»†çœ‹ä¸Šå›¾ï¼ŒApplicationContext å¹¶æ²¡æœ‰ç»§æ‰¿å®ƒï¼Œä¸è¿‡ä¸ç”¨æ‹…å¿ƒï¼Œä¸ä½¿ç”¨ç»§æ‰¿ï¼Œä¸ä»£è¡¨ä¸å¯ä»¥ä½¿ç”¨ç»„åˆï¼Œå¦‚æœä½ çœ‹åˆ° ApplicationContext æ¥å£å®šä¹‰ä¸­çš„æœ€åä¸€ä¸ªæ–¹æ³• getAutowireCapableBeanFactory() å°±çŸ¥é“äº†ã€‚</li>
  <li>ConfigurableListableBeanFactory ä¹Ÿæ˜¯ä¸€ä¸ªç‰¹æ®Šçš„æ¥å£ï¼Œçœ‹å›¾ï¼Œç‰¹æ®Šä¹‹å¤„åœ¨äºå®ƒç»§æ‰¿äº†ç¬¬äºŒå±‚æ‰€æœ‰çš„ä¸‰ä¸ªæ¥å£ï¼Œè€Œ ApplicationContext æ²¡æœ‰ã€‚è¿™ç‚¹ä¹‹åä¼šç”¨åˆ°ã€‚</li>
  <li>è¯·å…ˆä¸ç”¨èŠ±æ—¶é—´åœ¨å…¶ä»–çš„æ¥å£å’Œç±»ä¸Šï¼Œå…ˆç†è§£æˆ‘è¯´çš„è¿™å‡ ç‚¹å°±å¯ä»¥äº†ã€‚</li>
</ol>

<p>ç„¶åï¼Œè¯·è¯»è€…æ‰“å¼€ç¼–è¾‘å™¨ï¼Œç¿»ä¸€ä¸‹ BeanFactoryã€ListableBeanFactoryã€HierarchicalBeanFactoryã€AutowireCapableBeanFactoryã€ApplicationContext è¿™å‡ ä¸ªæ¥å£çš„ä»£ç ï¼Œå¤§æ¦‚çœ‹ä¸€ä¸‹å„ä¸ªæ¥å£ä¸­çš„æ–¹æ³•ï¼Œå¤§å®¶å¿ƒé‡Œè¦æœ‰åº•ï¼Œé™äºç¯‡å¹…ï¼Œæˆ‘å°±ä¸è´´ä»£ç ä»‹ç»äº†ã€‚</p>

<h2 id="å¯åŠ¨è¿‡ç¨‹åˆ†æ">å¯åŠ¨è¿‡ç¨‹åˆ†æ</h2>

<p>ä¸‹é¢å°†ä¼šæ˜¯å†—é•¿çš„ä»£ç åˆ†æï¼Œè®°ä½ï¼Œä¸€å®šè¦è‡ªå·±æ‰“å¼€æºç æ¥çœ‹ï¼Œä¸ç„¶çº¯çœ‹æ˜¯å¾ˆç´¯çš„ã€‚</p>

<p>ç¬¬ä¸€æ­¥ï¼Œæˆ‘ä»¬è‚¯å®šè¦ä» ClassPathXmlApplicationContext çš„æ„é€ æ–¹æ³•è¯´èµ·ã€‚</p>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
</pre></td><td class="rouge-code"><pre><span class="kd">public</span> <span class="kd">class</span> <span class="nc">ClassPathXmlApplicationContext</span> <span class="kd">extends</span> <span class="nc">AbstractXmlApplicationContext</span> <span class="o">{</span>
  <span class="kd">private</span> <span class="nc">Resource</span><span class="o">[]</span> <span class="n">configResources</span><span class="o">;</span>
  
  <span class="c1">// å¦‚æœå·²ç»æœ‰ ApplicationContext å¹¶éœ€è¦é…ç½®æˆçˆ¶å­å…³ç³»ï¼Œé‚£ä¹ˆè°ƒç”¨è¿™ä¸ªæ„é€ æ–¹æ³•</span>
  <span class="kd">public</span> <span class="nf">ClassPathXmlApplicationContext</span><span class="o">(</span><span class="nc">ApplicationContext</span> <span class="n">parent</span><span class="o">)</span> <span class="o">{</span>
    <span class="kd">super</span><span class="o">(</span><span class="n">parent</span><span class="o">);</span>
  <span class="o">}</span>
  <span class="o">...</span>
  <span class="kd">public</span> <span class="nf">ClassPathXmlApplicationContext</span><span class="o">(</span><span class="nc">String</span><span class="o">[]</span> <span class="n">configLocations</span><span class="o">,</span> <span class="kt">boolean</span> <span class="n">refresh</span><span class="o">,</span> <span class="nc">ApplicationContext</span> <span class="n">parent</span><span class="o">)</span>
      <span class="kd">throws</span> <span class="nc">BeansException</span> <span class="o">{</span>

    <span class="kd">super</span><span class="o">(</span><span class="n">parent</span><span class="o">);</span>
    <span class="c1">// æ ¹æ®æä¾›çš„è·¯å¾„ï¼Œå¤„ç†æˆé…ç½®æ–‡ä»¶æ•°ç»„(ä»¥åˆ†å·ã€é€—å·ã€ç©ºæ ¼ã€tabã€æ¢è¡Œç¬¦åˆ†å‰²)</span>
    <span class="n">setConfigLocations</span><span class="o">(</span><span class="n">configLocations</span><span class="o">);</span>
    <span class="k">if</span> <span class="o">(</span><span class="n">refresh</span><span class="o">)</span> <span class="o">{</span>
      <span class="n">refresh</span><span class="o">();</span> <span class="c1">// æ ¸å¿ƒæ–¹æ³•</span>
    <span class="o">}</span>
  <span class="o">}</span>
    <span class="o">...</span>
<span class="o">}</span>
</pre></td></tr></tbody></table></code></pre></div></div>

<p>æ¥ä¸‹æ¥ï¼Œå°±æ˜¯ refresh()ï¼Œè¿™é‡Œç®€å•è¯´ä¸‹ä¸ºä»€ä¹ˆæ˜¯ refresh()ï¼Œè€Œä¸æ˜¯ init() è¿™ç§åå­—çš„æ–¹æ³•ã€‚å› ä¸º ApplicationContext å»ºç«‹èµ·æ¥ä»¥åï¼Œå…¶å®æˆ‘ä»¬æ˜¯å¯ä»¥é€šè¿‡è°ƒç”¨ refresh() è¿™ä¸ªæ–¹æ³•é‡å»ºçš„ï¼Œrefresh() ä¼šå°†åŸæ¥çš„ ApplicationContext é”€æ¯ï¼Œç„¶åå†é‡æ–°æ‰§è¡Œä¸€æ¬¡åˆå§‹åŒ–æ“ä½œã€‚</p>

<p>å¾€ä¸‹çœ‹ï¼Œrefresh() æ–¹æ³•é‡Œé¢è°ƒç”¨äº†é‚£ä¹ˆå¤šæ–¹æ³•ï¼Œå°±çŸ¥é“è‚¯å®šä¸ç®€å•äº†ï¼Œè¯·è¯»è€…å…ˆçœ‹ä¸ªå¤§æ¦‚ï¼Œç»†èŠ‚ä¹‹åä¼šè¯¦ç»†è¯´ã€‚</p>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
44
45
46
47
48
49
50
51
52
53
54
55
56
57
58
59
60
61
62
63
64
65
66
67
68
69
70
71
72
73
74
75
76
77
78
</pre></td><td class="rouge-code"><pre><span class="nd">@Override</span>
<span class="kd">public</span> <span class="kt">void</span> <span class="nf">refresh</span><span class="o">()</span> <span class="kd">throws</span> <span class="nc">BeansException</span><span class="o">,</span> <span class="nc">IllegalStateException</span> <span class="o">{</span>
   <span class="c1">// æ¥ä¸ªé”ï¼Œä¸ç„¶ refresh() è¿˜æ²¡ç»“æŸï¼Œä½ åˆæ¥ä¸ªå¯åŠ¨æˆ–é”€æ¯å®¹å™¨çš„æ“ä½œï¼Œé‚£ä¸å°±ä¹±å¥—äº†å˜›</span>
   <span class="kd">synchronized</span> <span class="o">(</span><span class="k">this</span><span class="o">.</span><span class="na">startupShutdownMonitor</span><span class="o">)</span> <span class="o">{</span>

      <span class="c1">// å‡†å¤‡å·¥ä½œï¼Œè®°å½•ä¸‹å®¹å™¨çš„å¯åŠ¨æ—¶é—´ã€æ ‡è®°â€œå·²å¯åŠ¨â€çŠ¶æ€ã€å¤„ç†é…ç½®æ–‡ä»¶ä¸­çš„å ä½ç¬¦</span>
      <span class="n">prepareRefresh</span><span class="o">();</span>
     
      <span class="c1">// è¿™æ­¥æ¯”è¾ƒå…³é”®ï¼Œè¿™æ­¥å®Œæˆåï¼Œé…ç½®æ–‡ä»¶å°±ä¼šè§£ææˆä¸€ä¸ªä¸ª Bean å®šä¹‰ï¼Œæ³¨å†Œåˆ° BeanFactory ä¸­ï¼Œ</span>
      <span class="c1">// å½“ç„¶ï¼Œè¿™é‡Œè¯´çš„ Bean è¿˜æ²¡æœ‰åˆå§‹åŒ–ï¼Œåªæ˜¯é…ç½®ä¿¡æ¯éƒ½æå–å‡ºæ¥äº†ï¼Œ</span>
      <span class="c1">// æ³¨å†Œä¹Ÿåªæ˜¯å°†è¿™äº›ä¿¡æ¯éƒ½ä¿å­˜åˆ°äº†æ³¨å†Œä¸­å¿ƒ(è¯´åˆ°åº•æ ¸å¿ƒæ˜¯ä¸€ä¸ª beanName-&gt; beanDefinition çš„ map)</span>
      <span class="nc">ConfigurableListableBeanFactory</span> <span class="n">beanFactory</span> <span class="o">=</span> <span class="n">obtainFreshBeanFactory</span><span class="o">();</span>

      <span class="c1">// è®¾ç½® BeanFactory çš„ç±»åŠ è½½å™¨ï¼Œæ·»åŠ å‡ ä¸ª BeanPostProcessorï¼Œæ‰‹åŠ¨æ³¨å†Œå‡ ä¸ªç‰¹æ®Šçš„ bean</span>
      <span class="c1">// è¿™å—å¾…ä¼šä¼šå±•å¼€è¯´</span>
      <span class="n">prepareBeanFactory</span><span class="o">(</span><span class="n">beanFactory</span><span class="o">);</span>

      <span class="k">try</span> <span class="o">{</span>
         <span class="c1">// ã€è¿™é‡Œéœ€è¦çŸ¥é“ BeanFactoryPostProcessor è¿™ä¸ªçŸ¥è¯†ç‚¹ï¼ŒBean å¦‚æœå®ç°äº†æ­¤æ¥å£ï¼Œ</span>
         <span class="c1">// é‚£ä¹ˆåœ¨å®¹å™¨åˆå§‹åŒ–ä»¥åï¼ŒSpring ä¼šè´Ÿè´£è°ƒç”¨é‡Œé¢çš„ postProcessBeanFactory æ–¹æ³•ã€‚ã€‘</span>
        
         <span class="c1">// è¿™é‡Œæ˜¯æä¾›ç»™å­ç±»çš„æ‰©å±•ç‚¹ï¼Œåˆ°è¿™é‡Œçš„æ—¶å€™ï¼Œæ‰€æœ‰çš„ Bean éƒ½åŠ è½½ã€æ³¨å†Œå®Œæˆäº†ï¼Œä½†æ˜¯éƒ½è¿˜æ²¡æœ‰åˆå§‹åŒ–</span>
         <span class="c1">// å…·ä½“çš„å­ç±»å¯ä»¥åœ¨è¿™æ­¥çš„æ—¶å€™æ·»åŠ ä¸€äº›ç‰¹æ®Šçš„ BeanFactoryPostProcessor çš„å®ç°ç±»æˆ–åšç‚¹ä»€ä¹ˆäº‹</span>
         <span class="n">postProcessBeanFactory</span><span class="o">(</span><span class="n">beanFactory</span><span class="o">);</span>
         <span class="c1">// è°ƒç”¨ BeanFactoryPostProcessor å„ä¸ªå®ç°ç±»çš„ postProcessBeanFactory(factory) æ–¹æ³•</span>
         <span class="n">invokeBeanFactoryPostProcessors</span><span class="o">(</span><span class="n">beanFactory</span><span class="o">);</span>

         <span class="c1">// æ³¨å†Œ BeanPostProcessor çš„å®ç°ç±»ï¼Œæ³¨æ„çœ‹å’Œ BeanFactoryPostProcessor çš„åŒºåˆ«</span>
         <span class="c1">// æ­¤æ¥å£ä¸¤ä¸ªæ–¹æ³•: postProcessBeforeInitialization å’Œ postProcessAfterInitialization</span>
         <span class="c1">// ä¸¤ä¸ªæ–¹æ³•åˆ†åˆ«åœ¨ Bean åˆå§‹åŒ–ä¹‹å‰å’Œåˆå§‹åŒ–ä¹‹åå¾—åˆ°æ‰§è¡Œã€‚æ³¨æ„ï¼Œåˆ°è¿™é‡Œ Bean è¿˜æ²¡åˆå§‹åŒ–</span>
         <span class="n">registerBeanPostProcessors</span><span class="o">(</span><span class="n">beanFactory</span><span class="o">);</span>

         <span class="c1">// åˆå§‹åŒ–å½“å‰ ApplicationContext çš„ MessageSourceï¼Œå›½é™…åŒ–è¿™é‡Œå°±ä¸å±•å¼€è¯´äº†ï¼Œä¸ç„¶æ²¡å®Œæ²¡äº†äº†</span>
         <span class="n">initMessageSource</span><span class="o">();</span>

         <span class="c1">// åˆå§‹åŒ–å½“å‰ ApplicationContext çš„äº‹ä»¶å¹¿æ’­å™¨ï¼Œè¿™é‡Œä¹Ÿä¸å±•å¼€äº†</span>
         <span class="n">initApplicationEventMulticaster</span><span class="o">();</span>

         <span class="c1">// ä»æ–¹æ³•åå°±å¯ä»¥çŸ¥é“ï¼Œå…¸å‹çš„æ¨¡æ¿æ–¹æ³•(é’©å­æ–¹æ³•)ï¼Œ</span>
         <span class="c1">// å…·ä½“çš„å­ç±»å¯ä»¥åœ¨è¿™é‡Œåˆå§‹åŒ–ä¸€äº›ç‰¹æ®Šçš„ Beanï¼ˆåœ¨åˆå§‹åŒ– singleton beans ä¹‹å‰ï¼‰</span>
         <span class="n">onRefresh</span><span class="o">();</span>

         <span class="c1">// æ³¨å†Œäº‹ä»¶ç›‘å¬å™¨ï¼Œç›‘å¬å™¨éœ€è¦å®ç° ApplicationListener æ¥å£ã€‚è¿™ä¹Ÿä¸æ˜¯æˆ‘ä»¬çš„é‡ç‚¹ï¼Œè¿‡</span>
         <span class="n">registerListeners</span><span class="o">();</span>

         <span class="c1">// é‡ç‚¹ï¼Œé‡ç‚¹ï¼Œé‡ç‚¹</span>
         <span class="c1">// åˆå§‹åŒ–æ‰€æœ‰çš„ singleton beans</span>
         <span class="c1">//ï¼ˆlazy-init çš„é™¤å¤–ï¼‰</span>
         <span class="n">finishBeanFactoryInitialization</span><span class="o">(</span><span class="n">beanFactory</span><span class="o">);</span>

         <span class="c1">// æœ€åï¼Œå¹¿æ’­äº‹ä»¶ï¼ŒApplicationContext åˆå§‹åŒ–å®Œæˆ</span>
         <span class="n">finishRefresh</span><span class="o">();</span>
      <span class="o">}</span>

      <span class="k">catch</span> <span class="o">(</span><span class="nc">BeansException</span> <span class="n">ex</span><span class="o">)</span> <span class="o">{</span>
         <span class="k">if</span> <span class="o">(</span><span class="n">logger</span><span class="o">.</span><span class="na">isWarnEnabled</span><span class="o">())</span> <span class="o">{</span>
            <span class="n">logger</span><span class="o">.</span><span class="na">warn</span><span class="o">(</span><span class="s">"Exception encountered during context initialization - "</span> <span class="o">+</span>
                  <span class="s">"cancelling refresh attempt: "</span> <span class="o">+</span> <span class="n">ex</span><span class="o">);</span>
         <span class="o">}</span>

         <span class="c1">// Destroy already created singletons to avoid dangling resources.</span>
         <span class="c1">// é”€æ¯å·²ç»åˆå§‹åŒ–çš„ singleton çš„ Beansï¼Œä»¥å…æœ‰äº› bean ä¼šä¸€ç›´å ç”¨èµ„æº</span>
         <span class="n">destroyBeans</span><span class="o">();</span>

         <span class="c1">// Reset 'active' flag.</span>
         <span class="n">cancelRefresh</span><span class="o">(</span><span class="n">ex</span><span class="o">);</span>

         <span class="c1">// æŠŠå¼‚å¸¸å¾€å¤–æŠ›</span>
         <span class="k">throw</span> <span class="n">ex</span><span class="o">;</span>
      <span class="o">}</span>

      <span class="k">finally</span> <span class="o">{</span>
         <span class="c1">// Reset common introspection caches in Spring's core, since we</span>
         <span class="c1">// might not ever need metadata for singleton beans anymore...</span>
         <span class="n">resetCommonCaches</span><span class="o">();</span>
      <span class="o">}</span>
   <span class="o">}</span>
<span class="o">}</span>
</pre></td></tr></tbody></table></code></pre></div></div>
<p>ä¸‹é¢ï¼Œæˆ‘ä»¬å¼€å§‹ä¸€æ­¥æ­¥æ¥è‚¢è§£è¿™ä¸ª refresh() æ–¹æ³•ã€‚</p>

<h3 id="åˆ›å»º-bean-å®¹å™¨å‰çš„å‡†å¤‡å·¥ä½œ">åˆ›å»º Bean å®¹å™¨å‰çš„å‡†å¤‡å·¥ä½œ</h3>

<p>è¿™ä¸ªæ¯”è¾ƒç®€å•ï¼Œç›´æ¥çœ‹ä»£ç ä¸­çš„å‡ ä¸ªæ³¨é‡Šå³å¯ã€‚</p>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
</pre></td><td class="rouge-code"><pre><span class="kd">protected</span> <span class="kt">void</span> <span class="nf">prepareRefresh</span><span class="o">()</span> <span class="o">{</span>
   <span class="c1">// è®°å½•å¯åŠ¨æ—¶é—´ï¼Œ</span>
   <span class="c1">// å°† active å±æ€§è®¾ç½®ä¸º trueï¼Œclosed å±æ€§è®¾ç½®ä¸º falseï¼Œå®ƒä»¬éƒ½æ˜¯ AtomicBoolean ç±»å‹</span>
   <span class="k">this</span><span class="o">.</span><span class="na">startupDate</span> <span class="o">=</span> <span class="nc">System</span><span class="o">.</span><span class="na">currentTimeMillis</span><span class="o">();</span>
   <span class="k">this</span><span class="o">.</span><span class="na">closed</span><span class="o">.</span><span class="na">set</span><span class="o">(</span><span class="kc">false</span><span class="o">);</span>
   <span class="k">this</span><span class="o">.</span><span class="na">active</span><span class="o">.</span><span class="na">set</span><span class="o">(</span><span class="kc">true</span><span class="o">);</span>

   <span class="k">if</span> <span class="o">(</span><span class="n">logger</span><span class="o">.</span><span class="na">isInfoEnabled</span><span class="o">())</span> <span class="o">{</span>
      <span class="n">logger</span><span class="o">.</span><span class="na">info</span><span class="o">(</span><span class="s">"Refreshing "</span> <span class="o">+</span> <span class="k">this</span><span class="o">);</span>
   <span class="o">}</span>

   <span class="c1">// Initialize any placeholder property sources in the context environment</span>
   <span class="n">initPropertySources</span><span class="o">();</span>

   <span class="c1">// æ ¡éªŒ xml é…ç½®æ–‡ä»¶</span>
   <span class="n">getEnvironment</span><span class="o">().</span><span class="na">validateRequiredProperties</span><span class="o">();</span>

   <span class="k">this</span><span class="o">.</span><span class="na">earlyApplicationEvents</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">LinkedHashSet</span><span class="o">&lt;</span><span class="nc">ApplicationEvent</span><span class="o">&gt;();</span>
<span class="o">}</span>
</pre></td></tr></tbody></table></code></pre></div></div>

<h3 id="åˆ›å»º-bean-å®¹å™¨åŠ è½½å¹¶æ³¨å†Œ-bean">åˆ›å»º Bean å®¹å™¨ï¼ŒåŠ è½½å¹¶æ³¨å†Œ Bean</h3>

<p>æˆ‘ä»¬å›åˆ° refresh() æ–¹æ³•ä¸­çš„ä¸‹ä¸€è¡Œ obtainFreshBeanFactory()ã€‚</p>

<p>æ³¨æ„ï¼Œè¿™ä¸ªæ–¹æ³•æ˜¯å…¨æ–‡æœ€é‡è¦çš„éƒ¨åˆ†ä¹‹ä¸€ï¼Œè¿™é‡Œå°†ä¼šåˆå§‹åŒ– BeanFactoryã€åŠ è½½ Beanã€æ³¨å†Œ Bean ç­‰ç­‰ã€‚</p>

<p>å½“ç„¶ï¼Œè¿™æ­¥ç»“æŸåï¼ŒBean å¹¶æ²¡æœ‰å®Œæˆåˆå§‹åŒ–ã€‚è¿™é‡ŒæŒ‡çš„æ˜¯ Bean å®ä¾‹å¹¶æœªåœ¨è¿™ä¸€æ­¥ç”Ÿæˆã€‚</p>

<p>// AbstractApplicationContext.java</p>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
</pre></td><td class="rouge-code"><pre><span class="kd">protected</span> <span class="nc">ConfigurableListableBeanFactory</span> <span class="nf">obtainFreshBeanFactory</span><span class="o">()</span> <span class="o">{</span>
   <span class="c1">// å…³é—­æ—§çš„ BeanFactory (å¦‚æœæœ‰)ï¼Œåˆ›å»ºæ–°çš„ BeanFactoryï¼ŒåŠ è½½ Bean å®šä¹‰ã€æ³¨å†Œ Bean ç­‰ç­‰</span>
   <span class="n">refreshBeanFactory</span><span class="o">();</span>
  
   <span class="c1">// è¿”å›åˆšåˆšåˆ›å»ºçš„ BeanFactory</span>
   <span class="nc">ConfigurableListableBeanFactory</span> <span class="n">beanFactory</span> <span class="o">=</span> <span class="n">getBeanFactory</span><span class="o">();</span>
   <span class="k">if</span> <span class="o">(</span><span class="n">logger</span><span class="o">.</span><span class="na">isDebugEnabled</span><span class="o">())</span> <span class="o">{</span>
      <span class="n">logger</span><span class="o">.</span><span class="na">debug</span><span class="o">(</span><span class="s">"Bean factory for "</span> <span class="o">+</span> <span class="n">getDisplayName</span><span class="o">()</span> <span class="o">+</span> <span class="s">": "</span> <span class="o">+</span> <span class="n">beanFactory</span><span class="o">);</span>
   <span class="o">}</span>
   <span class="k">return</span> <span class="n">beanFactory</span><span class="o">;</span>
<span class="o">}</span>
</pre></td></tr></tbody></table></code></pre></div></div>

<p>// AbstractRefreshableApplicationContext.java 120</p>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
</pre></td><td class="rouge-code"><pre><span class="nd">@Override</span>
<span class="kd">protected</span> <span class="kd">final</span> <span class="kt">void</span> <span class="nf">refreshBeanFactory</span><span class="o">()</span> <span class="kd">throws</span> <span class="nc">BeansException</span> <span class="o">{</span>
   <span class="c1">// å¦‚æœ ApplicationContext ä¸­å·²ç»åŠ è½½è¿‡ BeanFactory äº†ï¼Œé”€æ¯æ‰€æœ‰ Beanï¼Œå…³é—­ BeanFactory</span>
   <span class="c1">// æ³¨æ„ï¼Œåº”ç”¨ä¸­ BeanFactory æœ¬æ¥å°±æ˜¯å¯ä»¥å¤šä¸ªçš„ï¼Œè¿™é‡Œå¯ä¸æ˜¯è¯´åº”ç”¨å…¨å±€æ˜¯å¦æœ‰ BeanFactoryï¼Œè€Œæ˜¯å½“å‰</span>
   <span class="c1">// ApplicationContext æ˜¯å¦æœ‰ BeanFactory</span>
   <span class="k">if</span> <span class="o">(</span><span class="n">hasBeanFactory</span><span class="o">())</span> <span class="o">{</span>
      <span class="n">destroyBeans</span><span class="o">();</span>
      <span class="n">closeBeanFactory</span><span class="o">();</span>
   <span class="o">}</span>
   <span class="k">try</span> <span class="o">{</span>
      <span class="c1">// åˆå§‹åŒ–ä¸€ä¸ª DefaultListableBeanFactoryï¼Œä¸ºä»€ä¹ˆç”¨è¿™ä¸ªï¼Œæˆ‘ä»¬é©¬ä¸Šè¯´ã€‚</span>
      <span class="nc">DefaultListableBeanFactory</span> <span class="n">beanFactory</span> <span class="o">=</span> <span class="n">createBeanFactory</span><span class="o">();</span>
      <span class="c1">// ç”¨äº BeanFactory çš„åºåˆ—åŒ–ï¼Œæˆ‘æƒ³ä¸éƒ¨åˆ†äººåº”è¯¥éƒ½ç”¨ä¸åˆ°</span>
      <span class="n">beanFactory</span><span class="o">.</span><span class="na">setSerializationId</span><span class="o">(</span><span class="n">getId</span><span class="o">());</span>
     
      <span class="c1">// ä¸‹é¢è¿™ä¸¤ä¸ªæ–¹æ³•å¾ˆé‡è¦ï¼Œåˆ«è·Ÿä¸¢äº†ï¼Œå…·ä½“ç»†èŠ‚ä¹‹åè¯´</span>
      <span class="c1">// è®¾ç½® BeanFactory çš„ä¸¤ä¸ªé…ç½®å±æ€§ï¼šæ˜¯å¦å…è®¸ Bean è¦†ç›–ã€æ˜¯å¦å…è®¸å¾ªç¯å¼•ç”¨</span>
      <span class="n">customizeBeanFactory</span><span class="o">(</span><span class="n">beanFactory</span><span class="o">);</span>
     
      <span class="c1">// åŠ è½½ Bean åˆ° BeanFactory ä¸­</span>
      <span class="n">loadBeanDefinitions</span><span class="o">(</span><span class="n">beanFactory</span><span class="o">);</span>
      <span class="kd">synchronized</span> <span class="o">(</span><span class="k">this</span><span class="o">.</span><span class="na">beanFactoryMonitor</span><span class="o">)</span> <span class="o">{</span>
         <span class="k">this</span><span class="o">.</span><span class="na">beanFactory</span> <span class="o">=</span> <span class="n">beanFactory</span><span class="o">;</span>
      <span class="o">}</span>
   <span class="o">}</span>
   <span class="k">catch</span> <span class="o">(</span><span class="nc">IOException</span> <span class="n">ex</span><span class="o">)</span> <span class="o">{</span>
      <span class="k">throw</span> <span class="k">new</span> <span class="nf">ApplicationContextException</span><span class="o">(</span><span class="s">"I/O error parsing bean definition source for "</span> <span class="o">+</span> <span class="n">getDisplayName</span><span class="o">(),</span> <span class="n">ex</span><span class="o">);</span>
   <span class="o">}</span>
<span class="o">}</span>
</pre></td></tr></tbody></table></code></pre></div></div>

<blockquote>
  <p>çœ‹åˆ°è¿™é‡Œçš„æ—¶å€™ï¼Œæˆ‘è§‰å¾—è¯»è€…å°±åº”è¯¥ç«™åœ¨é«˜å¤„çœ‹ ApplicationContext äº†ï¼ŒApplicationContext ç»§æ‰¿è‡ª BeanFactoryï¼Œä½†æ˜¯å®ƒä¸åº”è¯¥è¢«ç†è§£ä¸º BeanFactory çš„å®ç°ç±»ï¼Œè€Œæ˜¯è¯´å…¶å†…éƒ¨æŒæœ‰ä¸€ä¸ªå®ä¾‹åŒ–çš„ BeanFactoryï¼ˆDefaultListableBeanFactoryï¼‰ã€‚ä»¥åæ‰€æœ‰çš„ BeanFactory ç›¸å…³çš„æ“ä½œå…¶å®æ˜¯å§”æ‰˜ç»™è¿™ä¸ªå®ä¾‹æ¥å¤„ç†çš„ã€‚</p>
</blockquote>

<p>æˆ‘ä»¬è¯´è¯´ä¸ºä»€ä¹ˆé€‰æ‹©å®ä¾‹åŒ– <strong>DefaultListableBeanFactory</strong> ï¼Ÿå‰é¢æˆ‘ä»¬è¯´äº†æœ‰ä¸ªå¾ˆé‡è¦çš„æ¥å£ ConfigurableListableBeanFactoryï¼Œå®ƒå®ç°äº† BeanFactory ä¸‹é¢ä¸€å±‚çš„æ‰€æœ‰ä¸‰ä¸ªæ¥å£ï¼Œæˆ‘æŠŠä¹‹å‰çš„ç»§æ‰¿å›¾å†æ‹¿è¿‡æ¥å¤§å®¶å†ä»”ç»†çœ‹ä¸€ä¸‹ï¼š</p>

<p><img src="https://www.javadoop.com/blogimages/spring-context/3.png" alt="3" /></p>

<p>æˆ‘ä»¬å¯ä»¥çœ‹åˆ° ConfigurableListableBeanFactory åªæœ‰ä¸€ä¸ªå®ç°ç±» DefaultListableBeanFactoryï¼Œè€Œä¸”å®ç°ç±» DefaultListableBeanFactory è¿˜é€šè¿‡å®ç°å³è¾¹çš„ AbstractAutowireCapableBeanFactory é€šåƒäº†å³è·¯ã€‚æ‰€ä»¥ç»“è®ºå°±æ˜¯ï¼Œæœ€åº•ä¸‹è¿™ä¸ªå®¶ä¼™ DefaultListableBeanFactory åŸºæœ¬ä¸Šæ˜¯æœ€ç‰›çš„ BeanFactory äº†ï¼Œè¿™ä¹Ÿæ˜¯ä¸ºä»€ä¹ˆè¿™è¾¹ä¼šä½¿ç”¨è¿™ä¸ªç±»æ¥å®ä¾‹åŒ–çš„åŸå› ã€‚</p>

<blockquote>
  <p>å¦‚æœä½ æƒ³è¦åœ¨ç¨‹åºè¿è¡Œçš„æ—¶å€™åŠ¨æ€å¾€ Spring IOC å®¹å™¨æ³¨å†Œæ–°çš„ beanï¼Œå°±ä¼šä½¿ç”¨åˆ°è¿™ä¸ªç±»ã€‚é‚£æˆ‘ä»¬æ€ä¹ˆåœ¨è¿è¡Œæ—¶è·å¾—è¿™ä¸ªå®ä¾‹å‘¢ï¼Ÿ</p>

  <p>ä¹‹å‰æˆ‘ä»¬è¯´è¿‡ ApplicationContext æ¥å£èƒ½è·å–åˆ° AutowireCapableBeanFactoryï¼Œå°±æ˜¯æœ€å³ä¸Šè§’é‚£ä¸ªï¼Œç„¶åå®ƒå‘ä¸‹è½¬å‹å°±èƒ½å¾—åˆ° DefaultListableBeanFactory äº†ã€‚</p>
</blockquote>

<p>åœ¨ç»§ç»­å¾€ä¸‹ä¹‹å‰ï¼Œæˆ‘ä»¬éœ€è¦å…ˆäº†è§£ BeanDefinitionã€‚<strong>æˆ‘ä»¬è¯´ BeanFactory æ˜¯ Bean å®¹å™¨ï¼Œé‚£ä¹ˆ Bean åˆæ˜¯ä»€ä¹ˆå‘¢ï¼Ÿ</strong></p>

<p>è¿™é‡Œçš„ BeanDefinition å°±æ˜¯æˆ‘ä»¬æ‰€è¯´çš„ Spring çš„ Beanï¼Œæˆ‘ä»¬è‡ªå·±å®šä¹‰çš„å„ä¸ª Bean å…¶å®ä¼šè½¬æ¢æˆä¸€ä¸ªä¸ª BeanDefinition å­˜åœ¨äº Spring çš„ BeanFactory ä¸­ã€‚</p>

<p>æ‰€ä»¥ï¼Œå¦‚æœæœ‰äººé—®ä½  Bean æ˜¯ä»€ä¹ˆçš„æ—¶å€™ï¼Œä½ è¦çŸ¥é“ Bean åœ¨ä»£ç å±‚é¢ä¸Šå¯ä»¥è®¤ä¸ºæ˜¯ BeanDefinition çš„å®ä¾‹ã€‚</p>

<blockquote>
  <p>BeanDefinition ä¸­ä¿å­˜äº†æˆ‘ä»¬çš„ Bean ä¿¡æ¯ï¼Œæ¯”å¦‚è¿™ä¸ª Bean æŒ‡å‘çš„æ˜¯å“ªä¸ªç±»ã€æ˜¯å¦æ˜¯å•ä¾‹çš„ã€æ˜¯å¦æ‡’åŠ è½½ã€è¿™ä¸ª Bean ä¾èµ–äº†å“ªäº› Bean ç­‰ç­‰ã€‚</p>
</blockquote>

<h4 id="beandefinition-æ¥å£å®šä¹‰">BeanDefinition æ¥å£å®šä¹‰</h4>

<p>æˆ‘ä»¬æ¥çœ‹ä¸‹ BeanDefinition çš„æ¥å£å®šä¹‰ï¼š</p>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
44
45
46
47
48
49
50
51
52
53
54
55
56
57
58
59
60
61
62
63
64
65
66
67
68
69
70
71
72
73
74
75
76
77
78
79
80
81
82
83
84
85
86
87
88
</pre></td><td class="rouge-code"><pre><span class="kd">public</span> <span class="kd">interface</span> <span class="nc">BeanDefinition</span> <span class="kd">extends</span> <span class="nc">AttributeAccessor</span><span class="o">,</span> <span class="nc">BeanMetadataElement</span> <span class="o">{</span>

   <span class="c1">// æˆ‘ä»¬å¯ä»¥çœ‹åˆ°ï¼Œé»˜è®¤åªæä¾› sington å’Œ prototype ä¸¤ç§ï¼Œ</span>
   <span class="c1">// å¾ˆå¤šè¯»è€…å¯èƒ½çŸ¥é“è¿˜æœ‰ request, session, globalSession, application, websocket è¿™å‡ ç§ï¼Œ</span>
   <span class="c1">// ä¸è¿‡ï¼Œå®ƒä»¬å±äºåŸºäº web çš„æ‰©å±•ã€‚</span>
   <span class="nc">String</span> <span class="no">SCOPE_SINGLETON</span> <span class="o">=</span> <span class="nc">ConfigurableBeanFactory</span><span class="o">.</span><span class="na">SCOPE_SINGLETON</span><span class="o">;</span>
   <span class="nc">String</span> <span class="no">SCOPE_PROTOTYPE</span> <span class="o">=</span> <span class="nc">ConfigurableBeanFactory</span><span class="o">.</span><span class="na">SCOPE_PROTOTYPE</span><span class="o">;</span>

   <span class="c1">// æ¯”è¾ƒä¸é‡è¦ï¼Œç›´æ¥è·³è¿‡å§</span>
   <span class="kt">int</span> <span class="no">ROLE_APPLICATION</span> <span class="o">=</span> <span class="mi">0</span><span class="o">;</span>
   <span class="kt">int</span> <span class="no">ROLE_SUPPORT</span> <span class="o">=</span> <span class="mi">1</span><span class="o">;</span>
   <span class="kt">int</span> <span class="no">ROLE_INFRASTRUCTURE</span> <span class="o">=</span> <span class="mi">2</span><span class="o">;</span>

   <span class="c1">// è®¾ç½®çˆ¶ Beanï¼Œè¿™é‡Œæ¶‰åŠåˆ° bean ç»§æ‰¿ï¼Œä¸æ˜¯ java ç»§æ‰¿ã€‚è¯·å‚è§é™„å½•çš„è¯¦ç»†ä»‹ç»</span>
   <span class="c1">// ä¸€å¥è¯å°±æ˜¯ï¼šç»§æ‰¿çˆ¶ Bean çš„é…ç½®ä¿¡æ¯è€Œå·²</span>
   <span class="kt">void</span> <span class="nf">setParentName</span><span class="o">(</span><span class="nc">String</span> <span class="n">parentName</span><span class="o">);</span>
  
   <span class="c1">// è·å–çˆ¶ Bean</span>
   <span class="nc">String</span> <span class="nf">getParentName</span><span class="o">();</span>
  
   <span class="c1">// è®¾ç½® Bean çš„ç±»åç§°ï¼Œå°†æ¥æ˜¯è¦é€šè¿‡åå°„æ¥ç”Ÿæˆå®ä¾‹çš„</span>
   <span class="kt">void</span> <span class="nf">setBeanClassName</span><span class="o">(</span><span class="nc">String</span> <span class="n">beanClassName</span><span class="o">);</span>
   
   <span class="c1">// è·å– Bean çš„ç±»åç§°</span>
   <span class="nc">String</span> <span class="nf">getBeanClassName</span><span class="o">();</span>

 
   <span class="c1">// è®¾ç½® bean çš„ scope</span>
   <span class="kt">void</span> <span class="nf">setScope</span><span class="o">(</span><span class="nc">String</span> <span class="n">scope</span><span class="o">);</span>

   <span class="nc">String</span> <span class="nf">getScope</span><span class="o">();</span>

   <span class="c1">// è®¾ç½®æ˜¯å¦æ‡’åŠ è½½</span>
   <span class="kt">void</span> <span class="nf">setLazyInit</span><span class="o">(</span><span class="kt">boolean</span> <span class="n">lazyInit</span><span class="o">);</span>
   
   <span class="kt">boolean</span> <span class="nf">isLazyInit</span><span class="o">();</span>

   <span class="c1">// è®¾ç½®è¯¥ Bean ä¾èµ–çš„æ‰€æœ‰çš„ Beanï¼Œæ³¨æ„ï¼Œè¿™é‡Œçš„ä¾èµ–ä¸æ˜¯æŒ‡å±æ€§ä¾èµ–(å¦‚ @Autowire æ ‡è®°çš„)ï¼Œ</span>
   <span class="c1">// æ˜¯ depends-on="" å±æ€§è®¾ç½®çš„å€¼ã€‚</span>
   <span class="kt">void</span> <span class="nf">setDependsOn</span><span class="o">(</span><span class="nc">String</span><span class="o">...</span> <span class="n">dependsOn</span><span class="o">);</span>

   <span class="c1">// è¿”å›è¯¥ Bean çš„æ‰€æœ‰ä¾èµ–</span>
   <span class="nc">String</span><span class="o">[]</span> <span class="nf">getDependsOn</span><span class="o">();</span>

   <span class="c1">// è®¾ç½®è¯¥ Bean æ˜¯å¦å¯ä»¥æ³¨å…¥åˆ°å…¶ä»– Bean ä¸­ï¼Œåªå¯¹æ ¹æ®ç±»å‹æ³¨å…¥æœ‰æ•ˆï¼Œ</span>
   <span class="c1">// å¦‚æœæ ¹æ®åç§°æ³¨å…¥ï¼Œå³ä½¿è¿™è¾¹è®¾ç½®äº† falseï¼Œä¹Ÿæ˜¯å¯ä»¥çš„</span>
   <span class="kt">void</span> <span class="nf">setAutowireCandidate</span><span class="o">(</span><span class="kt">boolean</span> <span class="n">autowireCandidate</span><span class="o">);</span>

   <span class="c1">// è¯¥ Bean æ˜¯å¦å¯ä»¥æ³¨å…¥åˆ°å…¶ä»– Bean ä¸­</span>
   <span class="kt">boolean</span> <span class="nf">isAutowireCandidate</span><span class="o">();</span>

   <span class="c1">// ä¸»è¦çš„ã€‚åŒä¸€æ¥å£çš„å¤šä¸ªå®ç°ï¼Œå¦‚æœä¸æŒ‡å®šåå­—çš„è¯ï¼ŒSpring ä¼šä¼˜å…ˆé€‰æ‹©è®¾ç½® primary ä¸º true çš„ bean</span>
   <span class="kt">void</span> <span class="nf">setPrimary</span><span class="o">(</span><span class="kt">boolean</span> <span class="n">primary</span><span class="o">);</span>

   <span class="c1">// æ˜¯å¦æ˜¯ primary çš„</span>
   <span class="kt">boolean</span> <span class="nf">isPrimary</span><span class="o">();</span>

   <span class="c1">// å¦‚æœè¯¥ Bean é‡‡ç”¨å·¥å‚æ–¹æ³•ç”Ÿæˆï¼ŒæŒ‡å®šå·¥å‚åç§°ã€‚å¯¹å·¥å‚ä¸ç†Ÿæ‚‰çš„è¯»è€…ï¼Œè¯·å‚åŠ é™„å½•</span>
   <span class="c1">// ä¸€å¥è¯å°±æ˜¯ï¼šæœ‰äº›å®ä¾‹ä¸æ˜¯ç”¨åå°„ç”Ÿæˆçš„ï¼Œè€Œæ˜¯ç”¨å·¥å‚æ¨¡å¼ç”Ÿæˆçš„</span>
   <span class="kt">void</span> <span class="nf">setFactoryBeanName</span><span class="o">(</span><span class="nc">String</span> <span class="n">factoryBeanName</span><span class="o">);</span>
   <span class="c1">// è·å–å·¥å‚åç§°</span>
   <span class="nc">String</span> <span class="nf">getFactoryBeanName</span><span class="o">();</span>
   <span class="c1">// æŒ‡å®šå·¥å‚ç±»ä¸­çš„ å·¥å‚æ–¹æ³•åç§°</span>
   <span class="kt">void</span> <span class="nf">setFactoryMethodName</span><span class="o">(</span><span class="nc">String</span> <span class="n">factoryMethodName</span><span class="o">);</span>
   <span class="c1">// è·å–å·¥å‚ç±»ä¸­çš„ å·¥å‚æ–¹æ³•åç§°</span>
   <span class="nc">String</span> <span class="nf">getFactoryMethodName</span><span class="o">();</span>

   <span class="c1">// æ„é€ å™¨å‚æ•°</span>
   <span class="nc">ConstructorArgumentValues</span> <span class="nf">getConstructorArgumentValues</span><span class="o">();</span>

   <span class="c1">// Bean ä¸­çš„å±æ€§å€¼ï¼Œåé¢ç»™ bean æ³¨å…¥å±æ€§å€¼çš„æ—¶å€™ä¼šè¯´åˆ°</span>
   <span class="nc">MutablePropertyValues</span> <span class="nf">getPropertyValues</span><span class="o">();</span>

   <span class="c1">// æ˜¯å¦ singleton</span>
   <span class="kt">boolean</span> <span class="nf">isSingleton</span><span class="o">();</span>

   <span class="c1">// æ˜¯å¦ prototype</span>
   <span class="kt">boolean</span> <span class="nf">isPrototype</span><span class="o">();</span>

   <span class="c1">// å¦‚æœè¿™ä¸ª Bean æ˜¯è¢«è®¾ç½®ä¸º abstractï¼Œé‚£ä¹ˆä¸èƒ½å®ä¾‹åŒ–ï¼Œ</span>
   <span class="c1">// å¸¸ç”¨äºä½œä¸º çˆ¶bean ç”¨äºç»§æ‰¿ï¼Œå…¶å®ä¹Ÿå¾ˆå°‘ç”¨......</span>
   <span class="kt">boolean</span> <span class="nf">isAbstract</span><span class="o">();</span>

   <span class="kt">int</span> <span class="nf">getRole</span><span class="o">();</span>
   <span class="nc">String</span> <span class="nf">getDescription</span><span class="o">();</span>
   <span class="nc">String</span> <span class="nf">getResourceDescription</span><span class="o">();</span>
   <span class="nc">BeanDefinition</span> <span class="nf">getOriginatingBeanDefinition</span><span class="o">();</span>
<span class="o">}</span>
</pre></td></tr></tbody></table></code></pre></div></div>

<blockquote>
  <p>è¿™ä¸ª BeanDefinition å…¶å®å·²ç»åŒ…å«å¾ˆå¤šçš„ä¿¡æ¯äº†ï¼Œæš‚æ—¶ä¸æ¸…æ¥šæ‰€æœ‰çš„æ–¹æ³•å¯¹åº”ä»€ä¹ˆä¸œè¥¿æ²¡å…³ç³»ï¼Œå¸Œæœ›çœ‹å®Œæœ¬æ–‡åè¯»è€…å¯ä»¥å½»åº•ææ¸…æ¥šé‡Œé¢çš„æ‰€æœ‰ä¸œè¥¿ã€‚</p>

  <p>è¿™é‡Œæ¥å£è™½ç„¶é‚£ä¹ˆå¤šï¼Œä½†æ˜¯æ²¡æœ‰ç±»ä¼¼ getInstance() è¿™ç§æ–¹æ³•æ¥è·å–æˆ‘ä»¬å®šä¹‰çš„ç±»çš„å®ä¾‹ï¼ŒçœŸæ­£çš„æˆ‘ä»¬å®šä¹‰çš„ç±»ç”Ÿæˆçš„å®ä¾‹åˆ°å“ªé‡Œå»äº†å‘¢ï¼Ÿåˆ«ç€æ€¥ï¼Œè¿™ä¸ªè¦å¾ˆåé¢æ‰èƒ½è®²åˆ°ã€‚</p>
</blockquote>

<p>æœ‰äº† BeanDefinition çš„æ¦‚å¿µä»¥åï¼Œæˆ‘ä»¬å†å¾€ä¸‹çœ‹ refreshBeanFactory() æ–¹æ³•ä¸­çš„å‰©ä½™éƒ¨åˆ†ï¼š</p>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
</pre></td><td class="rouge-code"><pre><span class="n">customizeBeanFactory</span><span class="o">(</span><span class="n">beanFactory</span><span class="o">);</span>
<span class="n">loadBeanDefinitions</span><span class="o">(</span><span class="n">beanFactory</span><span class="o">);</span>
</pre></td></tr></tbody></table></code></pre></div></div>

<p>è™½ç„¶åªæœ‰ä¸¤ä¸ªæ–¹æ³•ï¼Œä½†è·¯è¿˜å¾ˆé•¿å•Šã€‚ã€‚ã€‚</p>

<h4 id="customizebeanfactory">customizeBeanFactory</h4>

<p>customizeBeanFactory(beanFactory) æ¯”è¾ƒç®€å•ï¼Œå°±æ˜¯é…ç½®æ˜¯å¦å…è®¸ BeanDefinition è¦†ç›–ã€æ˜¯å¦å…è®¸å¾ªç¯å¼•ç”¨ã€‚</p>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
</pre></td><td class="rouge-code"><pre><span class="kd">protected</span> <span class="kt">void</span> <span class="nf">customizeBeanFactory</span><span class="o">(</span><span class="nc">DefaultListableBeanFactory</span> <span class="n">beanFactory</span><span class="o">)</span> <span class="o">{</span>
   <span class="k">if</span> <span class="o">(</span><span class="k">this</span><span class="o">.</span><span class="na">allowBeanDefinitionOverriding</span> <span class="o">!=</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
      <span class="c1">// æ˜¯å¦å…è®¸ Bean å®šä¹‰è¦†ç›–</span>
      <span class="n">beanFactory</span><span class="o">.</span><span class="na">setAllowBeanDefinitionOverriding</span><span class="o">(</span><span class="k">this</span><span class="o">.</span><span class="na">allowBeanDefinitionOverriding</span><span class="o">);</span>
   <span class="o">}</span>
   <span class="k">if</span> <span class="o">(</span><span class="k">this</span><span class="o">.</span><span class="na">allowCircularReferences</span> <span class="o">!=</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
      <span class="c1">// æ˜¯å¦å…è®¸ Bean é—´çš„å¾ªç¯ä¾èµ–</span>
      <span class="n">beanFactory</span><span class="o">.</span><span class="na">setAllowCircularReferences</span><span class="o">(</span><span class="k">this</span><span class="o">.</span><span class="na">allowCircularReferences</span><span class="o">);</span>
   <span class="o">}</span>
<span class="o">}</span>
</pre></td></tr></tbody></table></code></pre></div></div>

<p>BeanDefinition çš„è¦†ç›–é—®é¢˜å¯èƒ½ä¼šæœ‰å¼€å‘è€…ç¢°åˆ°è¿™ä¸ªå‘ï¼Œå°±æ˜¯åœ¨é…ç½®æ–‡ä»¶ä¸­å®šä¹‰ bean æ—¶ä½¿ç”¨äº†ç›¸åŒçš„ id æˆ– nameï¼Œé»˜è®¤æƒ…å†µä¸‹ï¼ŒallowBeanDefinitionOverriding å±æ€§ä¸º nullï¼Œå¦‚æœåœ¨åŒä¸€é…ç½®æ–‡ä»¶ä¸­é‡å¤äº†ï¼Œä¼šæŠ›é”™ï¼Œä½†æ˜¯å¦‚æœä¸æ˜¯åŒä¸€é…ç½®æ–‡ä»¶ä¸­ï¼Œä¼šå‘ç”Ÿè¦†ç›–ã€‚</p>

<p>å¾ªç¯å¼•ç”¨ä¹Ÿå¾ˆå¥½ç†è§£ï¼šA ä¾èµ– Bï¼Œè€Œ B ä¾èµ– Aã€‚æˆ– A ä¾èµ– Bï¼ŒB ä¾èµ– Cï¼Œè€Œ C ä¾èµ– Aã€‚</p>

<p>é»˜è®¤æƒ…å†µä¸‹ï¼ŒSpring å…è®¸å¾ªç¯ä¾èµ–ï¼Œå½“ç„¶å¦‚æœä½ åœ¨ A çš„æ„é€ æ–¹æ³•ä¸­ä¾èµ– Bï¼Œåœ¨ B çš„æ„é€ æ–¹æ³•ä¸­ä¾èµ– A æ˜¯ä¸è¡Œçš„ã€‚</p>

<p>è‡³äºè¿™ä¸¤ä¸ªå±æ€§æ€ä¹ˆé…ç½®ï¼Ÿæˆ‘åœ¨é™„å½•ä¸­è¿›è¡Œäº†ä»‹ç»ï¼Œå°¤å…¶å¯¹äºè¦†ç›–é—®é¢˜ï¼Œå¾ˆå¤šäººéƒ½å¸Œæœ›ç¦æ­¢å‡ºç° Bean è¦†ç›–ï¼Œå¯æ˜¯ Spring é»˜è®¤æ˜¯ä¸åŒæ–‡ä»¶çš„æ—¶å€™å¯ä»¥è¦†ç›–çš„ã€‚</p>

<p>ä¹‹åçš„æºç ä¸­è¿˜ä¼šå‡ºç°è¿™ä¸¤ä¸ªå±æ€§ï¼Œè¯»è€…æœ‰ä¸ªå°è±¡å°±å¯ä»¥äº†ã€‚</p>

<h4 id="åŠ è½½-bean-loadbeandefinitions">åŠ è½½ Bean: loadBeanDefinitions</h4>

<p>æ¥ä¸‹æ¥æ˜¯æœ€é‡è¦çš„ loadBeanDefinitions(beanFactory) æ–¹æ³•äº†ï¼Œè¿™ä¸ªæ–¹æ³•å°†æ ¹æ®é…ç½®ï¼ŒåŠ è½½å„ä¸ª Beanï¼Œç„¶åæ”¾åˆ° BeanFactory ä¸­ã€‚</p>

<p>è¯»å–é…ç½®çš„æ“ä½œåœ¨ XmlBeanDefinitionReader ä¸­ï¼Œå…¶è´Ÿè´£åŠ è½½é…ç½®ã€è§£æã€‚</p>

<p>// AbstractXmlApplicationContext.java 80</p>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
</pre></td><td class="rouge-code"><pre><span class="cm">/** æˆ‘ä»¬å¯ä»¥çœ‹åˆ°ï¼Œæ­¤æ–¹æ³•å°†é€šè¿‡ä¸€ä¸ª XmlBeanDefinitionReader å®ä¾‹æ¥åŠ è½½å„ä¸ª Beanã€‚*/</span>
<span class="nd">@Override</span>
<span class="kd">protected</span> <span class="kt">void</span> <span class="nf">loadBeanDefinitions</span><span class="o">(</span><span class="nc">DefaultListableBeanFactory</span> <span class="n">beanFactory</span><span class="o">)</span> <span class="kd">throws</span> <span class="nc">BeansException</span><span class="o">,</span> <span class="nc">IOException</span> <span class="o">{</span>
   <span class="c1">// ç»™è¿™ä¸ª BeanFactory å®ä¾‹åŒ–ä¸€ä¸ª XmlBeanDefinitionReader</span>
   <span class="nc">XmlBeanDefinitionReader</span> <span class="n">beanDefinitionReader</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">XmlBeanDefinitionReader</span><span class="o">(</span><span class="n">beanFactory</span><span class="o">);</span>

   <span class="c1">// Configure the bean definition reader with this context's</span>
   <span class="c1">// resource loading environment.</span>
   <span class="n">beanDefinitionReader</span><span class="o">.</span><span class="na">setEnvironment</span><span class="o">(</span><span class="k">this</span><span class="o">.</span><span class="na">getEnvironment</span><span class="o">());</span>
   <span class="n">beanDefinitionReader</span><span class="o">.</span><span class="na">setResourceLoader</span><span class="o">(</span><span class="k">this</span><span class="o">);</span>
   <span class="n">beanDefinitionReader</span><span class="o">.</span><span class="na">setEntityResolver</span><span class="o">(</span><span class="k">new</span> <span class="nc">ResourceEntityResolver</span><span class="o">(</span><span class="k">this</span><span class="o">));</span>

   <span class="c1">// åˆå§‹åŒ– BeanDefinitionReaderï¼Œå…¶å®è¿™ä¸ªæ˜¯æä¾›ç»™å­ç±»è¦†å†™çš„ï¼Œ</span>
   <span class="c1">// æˆ‘çœ‹äº†ä¸€ä¸‹ï¼Œæ²¡æœ‰ç±»è¦†å†™è¿™ä¸ªæ–¹æ³•ï¼Œæˆ‘ä»¬å§‘ä¸”å½“åšä¸é‡è¦å§</span>
   <span class="n">initBeanDefinitionReader</span><span class="o">(</span><span class="n">beanDefinitionReader</span><span class="o">);</span>
   <span class="c1">// é‡ç‚¹æ¥äº†ï¼Œç»§ç»­å¾€ä¸‹</span>
   <span class="n">loadBeanDefinitions</span><span class="o">(</span><span class="n">beanDefinitionReader</span><span class="o">);</span>
<span class="o">}</span>
</pre></td></tr></tbody></table></code></pre></div></div>

<p>ç°åœ¨è¿˜åœ¨è¿™ä¸ªç±»ä¸­ï¼Œæ¥ä¸‹æ¥ç”¨åˆšåˆšåˆå§‹åŒ–çš„ Reader å¼€å§‹æ¥åŠ è½½ xml é…ç½®ï¼Œè¿™å—ä»£ç è¯»è€…å¯ä»¥é€‰æ‹©æ€§è·³è¿‡ï¼Œä¸æ˜¯å¾ˆé‡è¦ã€‚ä¹Ÿå°±æ˜¯è¯´ï¼Œä¸‹é¢è¿™ä¸ªä»£ç å—ï¼Œè¯»è€…å¯ä»¥å¾ˆè½»æ¾åœ°ç•¥è¿‡ã€‚</p>

<p>// AbstractXmlApplicationContext.java 120</p>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
44
45
46
47
48
49
50
51
52
53
54
55
56
57
58
59
60
61
62
63
64
65
66
67
68
69
70
71
72
73
74
75
76
77
78
79
80
81
82
83
84
85
86
87
88
89
90
91
92
93
94
95
96
97
98
99
100
101
102
103
104
</pre></td><td class="rouge-code"><pre><span class="kd">protected</span> <span class="kt">void</span> <span class="nf">loadBeanDefinitions</span><span class="o">(</span><span class="nc">XmlBeanDefinitionReader</span> <span class="n">reader</span><span class="o">)</span> <span class="kd">throws</span> <span class="nc">BeansException</span><span class="o">,</span> <span class="nc">IOException</span> <span class="o">{</span>
   <span class="nc">Resource</span><span class="o">[]</span> <span class="n">configResources</span> <span class="o">=</span> <span class="n">getConfigResources</span><span class="o">();</span>
   <span class="k">if</span> <span class="o">(</span><span class="n">configResources</span> <span class="o">!=</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
      <span class="c1">// å¾€ä¸‹çœ‹</span>
      <span class="n">reader</span><span class="o">.</span><span class="na">loadBeanDefinitions</span><span class="o">(</span><span class="n">configResources</span><span class="o">);</span>
   <span class="o">}</span>
   <span class="nc">String</span><span class="o">[]</span> <span class="n">configLocations</span> <span class="o">=</span> <span class="n">getConfigLocations</span><span class="o">();</span>
   <span class="k">if</span> <span class="o">(</span><span class="n">configLocations</span> <span class="o">!=</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
      <span class="c1">// 2</span>
      <span class="n">reader</span><span class="o">.</span><span class="na">loadBeanDefinitions</span><span class="o">(</span><span class="n">configLocations</span><span class="o">);</span>
   <span class="o">}</span>
<span class="o">}</span>

<span class="c1">// ä¸Šé¢è™½ç„¶æœ‰ä¸¤ä¸ªåˆ†æ”¯ï¼Œä¸è¿‡ç¬¬äºŒä¸ªåˆ†æ”¯å¾ˆå¿«é€šè¿‡è§£æè·¯å¾„è½¬æ¢ä¸º Resource ä»¥åä¹Ÿä¼šè¿›åˆ°è¿™é‡Œ</span>
<span class="nd">@Override</span>
<span class="kd">public</span> <span class="kt">int</span> <span class="nf">loadBeanDefinitions</span><span class="o">(</span><span class="nc">Resource</span><span class="o">...</span> <span class="n">resources</span><span class="o">)</span> <span class="kd">throws</span> <span class="nc">BeanDefinitionStoreException</span> <span class="o">{</span>
   <span class="nc">Assert</span><span class="o">.</span><span class="na">notNull</span><span class="o">(</span><span class="n">resources</span><span class="o">,</span> <span class="s">"Resource array must not be null"</span><span class="o">);</span>
   <span class="kt">int</span> <span class="n">counter</span> <span class="o">=</span> <span class="mi">0</span><span class="o">;</span>
   <span class="c1">// æ³¨æ„è¿™é‡Œæ˜¯ä¸ª for å¾ªç¯ï¼Œä¹Ÿå°±æ˜¯æ¯ä¸ªæ–‡ä»¶æ˜¯ä¸€ä¸ª resource</span>
   <span class="k">for</span> <span class="o">(</span><span class="nc">Resource</span> <span class="n">resource</span> <span class="o">:</span> <span class="n">resources</span><span class="o">)</span> <span class="o">{</span>
      <span class="c1">// ç»§ç»­å¾€ä¸‹çœ‹</span>
      <span class="n">counter</span> <span class="o">+=</span> <span class="n">loadBeanDefinitions</span><span class="o">(</span><span class="n">resource</span><span class="o">);</span>
   <span class="o">}</span>
   <span class="c1">// æœ€åè¿”å› counterï¼Œè¡¨ç¤ºæ€»å…±åŠ è½½äº†å¤šå°‘çš„ BeanDefinition</span>
   <span class="k">return</span> <span class="n">counter</span><span class="o">;</span>
<span class="o">}</span>

<span class="c1">// XmlBeanDefinitionReader 303</span>
<span class="nd">@Override</span>
<span class="kd">public</span> <span class="kt">int</span> <span class="nf">loadBeanDefinitions</span><span class="o">(</span><span class="nc">Resource</span> <span class="n">resource</span><span class="o">)</span> <span class="kd">throws</span> <span class="nc">BeanDefinitionStoreException</span> <span class="o">{</span>
   <span class="k">return</span> <span class="nf">loadBeanDefinitions</span><span class="o">(</span><span class="k">new</span> <span class="nc">EncodedResource</span><span class="o">(</span><span class="n">resource</span><span class="o">));</span>
<span class="o">}</span>

<span class="c1">// XmlBeanDefinitionReader 314</span>
<span class="kd">public</span> <span class="kt">int</span> <span class="nf">loadBeanDefinitions</span><span class="o">(</span><span class="nc">EncodedResource</span> <span class="n">encodedResource</span><span class="o">)</span> <span class="kd">throws</span> <span class="nc">BeanDefinitionStoreException</span> <span class="o">{</span>
   <span class="nc">Assert</span><span class="o">.</span><span class="na">notNull</span><span class="o">(</span><span class="n">encodedResource</span><span class="o">,</span> <span class="s">"EncodedResource must not be null"</span><span class="o">);</span>
   <span class="k">if</span> <span class="o">(</span><span class="n">logger</span><span class="o">.</span><span class="na">isInfoEnabled</span><span class="o">())</span> <span class="o">{</span>
      <span class="n">logger</span><span class="o">.</span><span class="na">info</span><span class="o">(</span><span class="s">"Loading XML bean definitions from "</span> <span class="o">+</span> <span class="n">encodedResource</span><span class="o">.</span><span class="na">getResource</span><span class="o">());</span>
   <span class="o">}</span>
   <span class="c1">// ç”¨ä¸€ä¸ª ThreadLocal æ¥å­˜æ”¾é…ç½®æ–‡ä»¶èµ„æº</span>
   <span class="nc">Set</span><span class="o">&lt;</span><span class="nc">EncodedResource</span><span class="o">&gt;</span> <span class="n">currentResources</span> <span class="o">=</span> <span class="k">this</span><span class="o">.</span><span class="na">resourcesCurrentlyBeingLoaded</span><span class="o">.</span><span class="na">get</span><span class="o">();</span>
   <span class="k">if</span> <span class="o">(</span><span class="n">currentResources</span> <span class="o">==</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
      <span class="n">currentResources</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">HashSet</span><span class="o">&lt;</span><span class="nc">EncodedResource</span><span class="o">&gt;(</span><span class="mi">4</span><span class="o">);</span>
      <span class="k">this</span><span class="o">.</span><span class="na">resourcesCurrentlyBeingLoaded</span><span class="o">.</span><span class="na">set</span><span class="o">(</span><span class="n">currentResources</span><span class="o">);</span>
   <span class="o">}</span>
   <span class="k">if</span> <span class="o">(!</span><span class="n">currentResources</span><span class="o">.</span><span class="na">add</span><span class="o">(</span><span class="n">encodedResource</span><span class="o">))</span> <span class="o">{</span>
      <span class="k">throw</span> <span class="k">new</span> <span class="nf">BeanDefinitionStoreException</span><span class="o">(</span>
            <span class="s">"Detected cyclic loading of "</span> <span class="o">+</span> <span class="n">encodedResource</span> <span class="o">+</span> <span class="s">" - check your import definitions!"</span><span class="o">);</span>
   <span class="o">}</span>
   <span class="k">try</span> <span class="o">{</span>
      <span class="nc">InputStream</span> <span class="n">inputStream</span> <span class="o">=</span> <span class="n">encodedResource</span><span class="o">.</span><span class="na">getResource</span><span class="o">().</span><span class="na">getInputStream</span><span class="o">();</span>
      <span class="k">try</span> <span class="o">{</span>
         <span class="nc">InputSource</span> <span class="n">inputSource</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">InputSource</span><span class="o">(</span><span class="n">inputStream</span><span class="o">);</span>
         <span class="k">if</span> <span class="o">(</span><span class="n">encodedResource</span><span class="o">.</span><span class="na">getEncoding</span><span class="o">()</span> <span class="o">!=</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
            <span class="n">inputSource</span><span class="o">.</span><span class="na">setEncoding</span><span class="o">(</span><span class="n">encodedResource</span><span class="o">.</span><span class="na">getEncoding</span><span class="o">());</span>
         <span class="o">}</span>
         <span class="c1">// æ ¸å¿ƒéƒ¨åˆ†æ˜¯è¿™é‡Œï¼Œå¾€ä¸‹é¢çœ‹</span>
         <span class="k">return</span> <span class="nf">doLoadBeanDefinitions</span><span class="o">(</span><span class="n">inputSource</span><span class="o">,</span> <span class="n">encodedResource</span><span class="o">.</span><span class="na">getResource</span><span class="o">());</span>
      <span class="o">}</span>
      <span class="k">finally</span> <span class="o">{</span>
         <span class="n">inputStream</span><span class="o">.</span><span class="na">close</span><span class="o">();</span>
      <span class="o">}</span>
   <span class="o">}</span>
   <span class="k">catch</span> <span class="o">(</span><span class="nc">IOException</span> <span class="n">ex</span><span class="o">)</span> <span class="o">{</span>
      <span class="k">throw</span> <span class="k">new</span> <span class="nf">BeanDefinitionStoreException</span><span class="o">(</span>
            <span class="s">"IOException parsing XML document from "</span> <span class="o">+</span> <span class="n">encodedResource</span><span class="o">.</span><span class="na">getResource</span><span class="o">(),</span> <span class="n">ex</span><span class="o">);</span>
   <span class="o">}</span>
   <span class="k">finally</span> <span class="o">{</span>
      <span class="n">currentResources</span><span class="o">.</span><span class="na">remove</span><span class="o">(</span><span class="n">encodedResource</span><span class="o">);</span>
      <span class="k">if</span> <span class="o">(</span><span class="n">currentResources</span><span class="o">.</span><span class="na">isEmpty</span><span class="o">())</span> <span class="o">{</span>
         <span class="k">this</span><span class="o">.</span><span class="na">resourcesCurrentlyBeingLoaded</span><span class="o">.</span><span class="na">remove</span><span class="o">();</span>
      <span class="o">}</span>
   <span class="o">}</span>
<span class="o">}</span>

<span class="c1">// è¿˜åœ¨è¿™ä¸ªæ–‡ä»¶ä¸­ï¼Œç¬¬ 388 è¡Œ</span>
<span class="kd">protected</span> <span class="kt">int</span> <span class="nf">doLoadBeanDefinitions</span><span class="o">(</span><span class="nc">InputSource</span> <span class="n">inputSource</span><span class="o">,</span> <span class="nc">Resource</span> <span class="n">resource</span><span class="o">)</span>
      <span class="kd">throws</span> <span class="nc">BeanDefinitionStoreException</span> <span class="o">{</span>
   <span class="k">try</span> <span class="o">{</span>
      <span class="c1">// è¿™é‡Œå°±ä¸çœ‹äº†ï¼Œå°† xml æ–‡ä»¶è½¬æ¢ä¸º Document å¯¹è±¡</span>
      <span class="nc">Document</span> <span class="n">doc</span> <span class="o">=</span> <span class="n">doLoadDocument</span><span class="o">(</span><span class="n">inputSource</span><span class="o">,</span> <span class="n">resource</span><span class="o">);</span>
      <span class="c1">// ç»§ç»­</span>
      <span class="k">return</span> <span class="nf">registerBeanDefinitions</span><span class="o">(</span><span class="n">doc</span><span class="o">,</span> <span class="n">resource</span><span class="o">);</span>
   <span class="o">}</span>
   <span class="k">catch</span> <span class="o">(...</span>
<span class="o">}</span>
<span class="c1">// è¿˜åœ¨è¿™ä¸ªæ–‡ä»¶ä¸­ï¼Œç¬¬ 505 è¡Œ</span>
<span class="c1">// è¿”å›å€¼ï¼šè¿”å›ä»å½“å‰é…ç½®æ–‡ä»¶åŠ è½½äº†å¤šå°‘æ•°é‡çš„ Bean</span>
<span class="kd">public</span> <span class="kt">int</span> <span class="nf">registerBeanDefinitions</span><span class="o">(</span><span class="nc">Document</span> <span class="n">doc</span><span class="o">,</span> <span class="nc">Resource</span> <span class="n">resource</span><span class="o">)</span> <span class="kd">throws</span> <span class="nc">BeanDefinitionStoreException</span> <span class="o">{</span>
   <span class="nc">BeanDefinitionDocumentReader</span> <span class="n">documentReader</span> <span class="o">=</span> <span class="n">createBeanDefinitionDocumentReader</span><span class="o">();</span>
   <span class="kt">int</span> <span class="n">countBefore</span> <span class="o">=</span> <span class="n">getRegistry</span><span class="o">().</span><span class="na">getBeanDefinitionCount</span><span class="o">();</span>
   <span class="c1">// è¿™é‡Œ</span>
   <span class="n">documentReader</span><span class="o">.</span><span class="na">registerBeanDefinitions</span><span class="o">(</span><span class="n">doc</span><span class="o">,</span> <span class="n">createReaderContext</span><span class="o">(</span><span class="n">resource</span><span class="o">));</span>
   <span class="k">return</span> <span class="nf">getRegistry</span><span class="o">().</span><span class="na">getBeanDefinitionCount</span><span class="o">()</span> <span class="o">-</span> <span class="n">countBefore</span><span class="o">;</span>
<span class="o">}</span>
<span class="c1">// DefaultBeanDefinitionDocumentReader 90</span>
<span class="nd">@Override</span>
<span class="kd">public</span> <span class="kt">void</span> <span class="nf">registerBeanDefinitions</span><span class="o">(</span><span class="nc">Document</span> <span class="n">doc</span><span class="o">,</span> <span class="nc">XmlReaderContext</span> <span class="n">readerContext</span><span class="o">)</span> <span class="o">{</span>
   <span class="k">this</span><span class="o">.</span><span class="na">readerContext</span> <span class="o">=</span> <span class="n">readerContext</span><span class="o">;</span>
   <span class="n">logger</span><span class="o">.</span><span class="na">debug</span><span class="o">(</span><span class="s">"Loading bean definitions"</span><span class="o">);</span>
   <span class="nc">Element</span> <span class="n">root</span> <span class="o">=</span> <span class="n">doc</span><span class="o">.</span><span class="na">getDocumentElement</span><span class="o">();</span>
   <span class="c1">// ä» xml æ ¹èŠ‚ç‚¹å¼€å§‹è§£ææ–‡ä»¶</span>
   <span class="n">doRegisterBeanDefinitions</span><span class="o">(</span><span class="n">root</span><span class="o">);</span>
<span class="o">}</span>         
</pre></td></tr></tbody></table></code></pre></div></div>

<p>ç»è¿‡æ¼«é•¿çš„é“¾è·¯ï¼Œä¸€ä¸ªé…ç½®æ–‡ä»¶ç»ˆäºè½¬æ¢ä¸ºä¸€é¢— DOM æ ‘äº†ï¼Œæ³¨æ„ï¼Œè¿™é‡ŒæŒ‡çš„æ˜¯å…¶ä¸­ä¸€ä¸ªé…ç½®æ–‡ä»¶ï¼Œä¸æ˜¯æ‰€æœ‰çš„ï¼Œè¯»è€…å¯ä»¥çœ‹åˆ°ä¸Šé¢æœ‰ä¸ª for å¾ªç¯çš„ã€‚ä¸‹é¢å¼€å§‹ä»æ ¹èŠ‚ç‚¹å¼€å§‹è§£æï¼š</p>

<h5 id="doregisterbeandefinitions">doRegisterBeanDefinitionsï¼š</h5>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
</pre></td><td class="rouge-code"><pre><span class="c1">// DefaultBeanDefinitionDocumentReader 116</span>
<span class="kd">protected</span> <span class="kt">void</span> <span class="nf">doRegisterBeanDefinitions</span><span class="o">(</span><span class="nc">Element</span> <span class="n">root</span><span class="o">)</span> <span class="o">{</span>
   <span class="c1">// æˆ‘ä»¬çœ‹åå­—å°±çŸ¥é“ï¼ŒBeanDefinitionParserDelegate å¿…å®šæ˜¯ä¸€ä¸ªé‡è¦çš„ç±»ï¼Œå®ƒè´Ÿè´£è§£æ Bean å®šä¹‰ï¼Œ</span>
   <span class="c1">// è¿™é‡Œä¸ºä»€ä¹ˆè¦å®šä¹‰ä¸€ä¸ª parent? çœ‹åˆ°åé¢å°±çŸ¥é“äº†ï¼Œæ˜¯é€’å½’é—®é¢˜ï¼Œ</span>
   <span class="c1">// å› ä¸º &lt;beans /&gt; å†…éƒ¨æ˜¯å¯ä»¥å®šä¹‰ &lt;beans /&gt; çš„ï¼Œæ‰€ä»¥è¿™ä¸ªæ–¹æ³•çš„ root å…¶å®ä¸ä¸€å®šå°±æ˜¯ xml çš„æ ¹èŠ‚ç‚¹ï¼Œä¹Ÿå¯ä»¥æ˜¯åµŒå¥—åœ¨é‡Œé¢çš„ &lt;beans /&gt; èŠ‚ç‚¹ï¼Œä»æºç åˆ†æçš„è§’åº¦ï¼Œæˆ‘ä»¬å½“åšæ ¹èŠ‚ç‚¹å°±å¥½äº†</span>
   <span class="nc">BeanDefinitionParserDelegate</span> <span class="n">parent</span> <span class="o">=</span> <span class="k">this</span><span class="o">.</span><span class="na">delegate</span><span class="o">;</span>
   <span class="k">this</span><span class="o">.</span><span class="na">delegate</span> <span class="o">=</span> <span class="n">createDelegate</span><span class="o">(</span><span class="n">getReaderContext</span><span class="o">(),</span> <span class="n">root</span><span class="o">,</span> <span class="n">parent</span><span class="o">);</span>

   <span class="k">if</span> <span class="o">(</span><span class="k">this</span><span class="o">.</span><span class="na">delegate</span><span class="o">.</span><span class="na">isDefaultNamespace</span><span class="o">(</span><span class="n">root</span><span class="o">))</span> <span class="o">{</span>
      <span class="c1">// è¿™å—è¯´çš„æ˜¯æ ¹èŠ‚ç‚¹ &lt;beans ... profile="dev" /&gt; ä¸­çš„ profile æ˜¯å¦æ˜¯å½“å‰ç¯å¢ƒéœ€è¦çš„ï¼Œ</span>
      <span class="c1">// å¦‚æœå½“å‰ç¯å¢ƒé…ç½®çš„ profile ä¸åŒ…å«æ­¤ profileï¼Œé‚£å°±ç›´æ¥ return äº†ï¼Œä¸å¯¹æ­¤ &lt;beans /&gt; è§£æ</span>
      <span class="c1">// ä¸ç†Ÿæ‚‰ profile ä¸ºä½•ç‰©ï¼Œä¸ç†Ÿæ‚‰æ€ä¹ˆé…ç½® profile è¯»è€…çš„è¯·ç§»æ­¥é™„å½•åŒº</span>
      <span class="nc">String</span> <span class="n">profileSpec</span> <span class="o">=</span> <span class="n">root</span><span class="o">.</span><span class="na">getAttribute</span><span class="o">(</span><span class="no">PROFILE_ATTRIBUTE</span><span class="o">);</span>
      <span class="k">if</span> <span class="o">(</span><span class="nc">StringUtils</span><span class="o">.</span><span class="na">hasText</span><span class="o">(</span><span class="n">profileSpec</span><span class="o">))</span> <span class="o">{</span>
         <span class="nc">String</span><span class="o">[]</span> <span class="n">specifiedProfiles</span> <span class="o">=</span> <span class="nc">StringUtils</span><span class="o">.</span><span class="na">tokenizeToStringArray</span><span class="o">(</span>
               <span class="n">profileSpec</span><span class="o">,</span> <span class="nc">BeanDefinitionParserDelegate</span><span class="o">.</span><span class="na">MULTI_VALUE_ATTRIBUTE_DELIMITERS</span><span class="o">);</span>
         <span class="k">if</span> <span class="o">(!</span><span class="n">getReaderContext</span><span class="o">().</span><span class="na">getEnvironment</span><span class="o">().</span><span class="na">acceptsProfiles</span><span class="o">(</span><span class="n">specifiedProfiles</span><span class="o">))</span> <span class="o">{</span>
            <span class="k">if</span> <span class="o">(</span><span class="n">logger</span><span class="o">.</span><span class="na">isInfoEnabled</span><span class="o">())</span> <span class="o">{</span>
               <span class="n">logger</span><span class="o">.</span><span class="na">info</span><span class="o">(</span><span class="s">"Skipped XML bean definition file due to specified profiles ["</span> <span class="o">+</span> <span class="n">profileSpec</span> <span class="o">+</span>
                     <span class="s">"] not matching: "</span> <span class="o">+</span> <span class="n">getReaderContext</span><span class="o">().</span><span class="na">getResource</span><span class="o">());</span>
            <span class="o">}</span>
            <span class="k">return</span><span class="o">;</span>
         <span class="o">}</span>
      <span class="o">}</span>
   <span class="o">}</span>

   <span class="n">preProcessXml</span><span class="o">(</span><span class="n">root</span><span class="o">);</span> <span class="c1">// é’©å­</span>
   <span class="c1">// å¾€ä¸‹çœ‹</span>
   <span class="n">parseBeanDefinitions</span><span class="o">(</span><span class="n">root</span><span class="o">,</span> <span class="k">this</span><span class="o">.</span><span class="na">delegate</span><span class="o">);</span>
   <span class="n">postProcessXml</span><span class="o">(</span><span class="n">root</span><span class="o">);</span> <span class="c1">// é’©å­</span>

   <span class="k">this</span><span class="o">.</span><span class="na">delegate</span> <span class="o">=</span> <span class="n">parent</span><span class="o">;</span>
<span class="o">}</span>
</pre></td></tr></tbody></table></code></pre></div></div>

<p>preProcessXml(root) å’Œ postProcessXml(root) æ˜¯ç»™å­ç±»ç”¨çš„é’©å­æ–¹æ³•ï¼Œé‰´äºæ²¡æœ‰è¢«ä½¿ç”¨åˆ°ï¼Œä¹Ÿä¸æ˜¯æˆ‘ä»¬çš„é‡ç‚¹ï¼Œæˆ‘ä»¬ç›´æ¥è·³è¿‡ã€‚</p>

<p>è¿™é‡Œæ¶‰åŠåˆ°äº† profile çš„é—®é¢˜ï¼Œå¯¹äºä¸äº†è§£çš„è¯»è€…ï¼Œæˆ‘åœ¨é™„å½•ä¸­å¯¹ profile åšäº†ç®€å•çš„è§£é‡Šï¼Œè¯»è€…å¯ä»¥å‚è€ƒä¸€ä¸‹ã€‚</p>

<p>æ¥ä¸‹æ¥ï¼Œçœ‹æ ¸å¿ƒè§£ææ–¹æ³• parseBeanDefinitions(root, this.delegate) :</p>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
</pre></td><td class="rouge-code"><pre><span class="c1">// default namespace æ¶‰åŠåˆ°çš„å°±å››ä¸ªæ ‡ç­¾ &lt;import /&gt;ã€&lt;alias /&gt;ã€&lt;bean /&gt; å’Œ &lt;beans /&gt;ï¼Œ</span>
<span class="c1">// å…¶ä»–çš„å±äº custom çš„</span>
<span class="kd">protected</span> <span class="kt">void</span> <span class="nf">parseBeanDefinitions</span><span class="o">(</span><span class="nc">Element</span> <span class="n">root</span><span class="o">,</span> <span class="nc">BeanDefinitionParserDelegate</span> <span class="n">delegate</span><span class="o">)</span> <span class="o">{</span>
   <span class="k">if</span> <span class="o">(</span><span class="n">delegate</span><span class="o">.</span><span class="na">isDefaultNamespace</span><span class="o">(</span><span class="n">root</span><span class="o">))</span> <span class="o">{</span>
      <span class="nc">NodeList</span> <span class="n">nl</span> <span class="o">=</span> <span class="n">root</span><span class="o">.</span><span class="na">getChildNodes</span><span class="o">();</span>
      <span class="k">for</span> <span class="o">(</span><span class="kt">int</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="o">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">nl</span><span class="o">.</span><span class="na">getLength</span><span class="o">();</span> <span class="n">i</span><span class="o">++)</span> <span class="o">{</span>
         <span class="nc">Node</span> <span class="n">node</span> <span class="o">=</span> <span class="n">nl</span><span class="o">.</span><span class="na">item</span><span class="o">(</span><span class="n">i</span><span class="o">);</span>
         <span class="k">if</span> <span class="o">(</span><span class="n">node</span> <span class="k">instanceof</span> <span class="nc">Element</span><span class="o">)</span> <span class="o">{</span>
            <span class="nc">Element</span> <span class="n">ele</span> <span class="o">=</span> <span class="o">(</span><span class="nc">Element</span><span class="o">)</span> <span class="n">node</span><span class="o">;</span>
            <span class="k">if</span> <span class="o">(</span><span class="n">delegate</span><span class="o">.</span><span class="na">isDefaultNamespace</span><span class="o">(</span><span class="n">ele</span><span class="o">))</span> <span class="o">{</span>
               <span class="c1">// è§£æ default namespace ä¸‹é¢çš„å‡ ä¸ªå…ƒç´ </span>
               <span class="n">parseDefaultElement</span><span class="o">(</span><span class="n">ele</span><span class="o">,</span> <span class="n">delegate</span><span class="o">);</span>
            <span class="o">}</span>
            <span class="k">else</span> <span class="o">{</span>
               <span class="c1">// è§£æå…¶ä»– namespace çš„å…ƒç´ </span>
               <span class="n">delegate</span><span class="o">.</span><span class="na">parseCustomElement</span><span class="o">(</span><span class="n">ele</span><span class="o">);</span>
            <span class="o">}</span>
         <span class="o">}</span>
      <span class="o">}</span>
   <span class="o">}</span>
   <span class="k">else</span> <span class="o">{</span>
      <span class="n">delegate</span><span class="o">.</span><span class="na">parseCustomElement</span><span class="o">(</span><span class="n">root</span><span class="o">);</span>
   <span class="o">}</span>
<span class="o">}</span>
</pre></td></tr></tbody></table></code></pre></div></div>

<p>ä»ä¸Šé¢çš„ä»£ç ï¼Œæˆ‘ä»¬å¯ä»¥çœ‹åˆ°ï¼Œå¯¹äºæ¯ä¸ªé…ç½®æ¥è¯´ï¼Œåˆ†åˆ«è¿›å…¥åˆ° parseDefaultElement(ele, delegate); å’Œ delegate.parseCustomElement(ele); è¿™ä¸¤ä¸ªåˆ†æ”¯äº†ã€‚</p>

<p>parseDefaultElement(ele, delegate) ä»£è¡¨è§£æçš„èŠ‚ç‚¹æ˜¯ <code class="highlighter-rouge">&lt;import /&gt;</code>ã€<code class="highlighter-rouge">&lt;alias /&gt;</code>ã€<code class="highlighter-rouge">&lt;bean /&gt;</code>ã€<code class="highlighter-rouge">&lt;beans /&gt;</code> è¿™å‡ ä¸ªã€‚</p>

<blockquote>
  <p>è¿™é‡Œçš„å››ä¸ªæ ‡ç­¾ä¹‹æ‰€ä»¥æ˜¯ default çš„ï¼Œæ˜¯å› ä¸ºå®ƒä»¬æ˜¯å¤„äºè¿™ä¸ª namespace ä¸‹å®šä¹‰çš„ï¼š</p>

  <div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre></td><td class="rouge-code"><pre>http://www.springframework.org/schema/beans
</pre></td></tr></tbody></table></code></pre></div>  </div>

  <p>åˆåˆ°åˆå­¦è€…ç§‘æ™®æ—¶é—´ï¼Œä¸ç†Ÿæ‚‰ namespace çš„è¯»è€…è¯·çœ‹ä¸‹é¢è´´å‡ºæ¥çš„ xmlï¼Œè¿™é‡Œçš„ç¬¬äºŒè¡Œ <strong>xmlns</strong> å°±æ˜¯å’¯ã€‚</p>

  <div class="language-xml highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
</pre></td><td class="rouge-code"><pre><span class="nt">&lt;beans</span> <span class="na">xmlns:xsi=</span><span class="s">"http://www.w3.org/2001/XMLSchema-instance"</span>
       <span class="na">xmlns=</span><span class="s">"http://www.springframework.org/schema/beans"</span>
       <span class="na">xsi:schemaLocation=</span><span class="s">"
            http://www.springframework.org/schema/beans
          http://www.springframework.org/schema/beans/spring-beans.xsd"</span>
       <span class="na">default-autowire=</span><span class="s">"byName"</span><span class="nt">&gt;</span>
</pre></td></tr></tbody></table></code></pre></div>  </div>

  <p>è€Œå¯¹äºå…¶ä»–çš„æ ‡ç­¾ï¼Œå°†è¿›å…¥åˆ° delegate.parseCustomElement(element) è¿™ä¸ªåˆ†æ”¯ã€‚å¦‚æˆ‘ä»¬ç»å¸¸ä¼šä½¿ç”¨åˆ°çš„ <code class="highlighter-rouge">&lt;mvc /&gt;</code>ã€<code class="highlighter-rouge">&lt;task /&gt;</code>ã€<code class="highlighter-rouge">&lt;context /&gt;</code>ã€<code class="highlighter-rouge">&lt;aop /&gt;</code>ç­‰ã€‚</p>

  <p>è¿™äº›å±äºæ‰©å±•ï¼Œå¦‚æœéœ€è¦ä½¿ç”¨ä¸Šé¢è¿™äº› â€é defaultâ€œ æ ‡ç­¾ï¼Œé‚£ä¹ˆä¸Šé¢çš„ xml å¤´éƒ¨çš„åœ°æ–¹ä¹Ÿè¦å¼•å…¥ç›¸åº”çš„ namespace å’Œ .xsd æ–‡ä»¶çš„è·¯å¾„ï¼Œå¦‚ä¸‹æ‰€ç¤ºã€‚åŒæ—¶ä»£ç ä¸­éœ€è¦æä¾›ç›¸åº”çš„ parser æ¥è§£æï¼Œå¦‚ MvcNamespaceHandlerã€TaskNamespaceHandlerã€ContextNamespaceHandlerã€AopNamespaceHandler ç­‰ã€‚</p>

  <p>å‡å¦‚è¯»è€…æƒ³åˆ†æ <code class="highlighter-rouge">&lt;context:property-placeholder location="classpath:xx.properties" /&gt;</code> çš„å®ç°åŸç†ï¼Œå°±åº”è¯¥åˆ° ContextNamespaceHandler ä¸­æ‰¾ç­”æ¡ˆã€‚</p>

  <div class="language-xml highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
</pre></td><td class="rouge-code"><pre><span class="nt">&lt;beans</span> <span class="na">xmlns:xsi=</span><span class="s">"http://www.w3.org/2001/XMLSchema-instance"</span>
      <span class="na">xmlns=</span><span class="s">"http://www.springframework.org/schema/beans"</span>
      <span class="na">xmlns:context=</span><span class="s">"http://www.springframework.org/schema/context"</span>
      <span class="na">xmlns:mvc=</span><span class="s">"http://www.springframework.org/schema/mvc"</span>
      <span class="na">xsi:schemaLocation=</span><span class="s">"
           http://www.springframework.org/schema/beans 
           http://www.springframework.org/schema/beans/spring-beans.xsd
           http://www.springframework.org/schema/context
           http://www.springframework.org/schema/context/spring-context.xsd
           http://www.springframework.org/schema/mvc   
           http://www.springframework.org/schema/mvc/spring-mvc.xsd  
       "</span>
      <span class="na">default-autowire=</span><span class="s">"byName"</span><span class="nt">&gt;</span>
</pre></td></tr></tbody></table></code></pre></div>  </div>
</blockquote>

<p>å›è¿‡ç¥æ¥ï¼Œçœ‹çœ‹å¤„ç† default æ ‡ç­¾çš„æ–¹æ³•ï¼š</p>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
</pre></td><td class="rouge-code"><pre><span class="kd">private</span> <span class="kt">void</span> <span class="nf">parseDefaultElement</span><span class="o">(</span><span class="nc">Element</span> <span class="n">ele</span><span class="o">,</span> <span class="nc">BeanDefinitionParserDelegate</span> <span class="n">delegate</span><span class="o">)</span> <span class="o">{</span>
   <span class="k">if</span> <span class="o">(</span><span class="n">delegate</span><span class="o">.</span><span class="na">nodeNameEquals</span><span class="o">(</span><span class="n">ele</span><span class="o">,</span> <span class="no">IMPORT_ELEMENT</span><span class="o">))</span> <span class="o">{</span>
      <span class="c1">// å¤„ç† &lt;import /&gt; æ ‡ç­¾</span>
      <span class="n">importBeanDefinitionResource</span><span class="o">(</span><span class="n">ele</span><span class="o">);</span>
   <span class="o">}</span>
   <span class="k">else</span> <span class="nf">if</span> <span class="o">(</span><span class="n">delegate</span><span class="o">.</span><span class="na">nodeNameEquals</span><span class="o">(</span><span class="n">ele</span><span class="o">,</span> <span class="no">ALIAS_ELEMENT</span><span class="o">))</span> <span class="o">{</span>
      <span class="c1">// å¤„ç† &lt;alias /&gt; æ ‡ç­¾å®šä¹‰</span>
      <span class="c1">// &lt;alias name="fromName" alias="toName"/&gt;</span>
      <span class="n">processAliasRegistration</span><span class="o">(</span><span class="n">ele</span><span class="o">);</span>
   <span class="o">}</span>
   <span class="k">else</span> <span class="nf">if</span> <span class="o">(</span><span class="n">delegate</span><span class="o">.</span><span class="na">nodeNameEquals</span><span class="o">(</span><span class="n">ele</span><span class="o">,</span> <span class="no">BEAN_ELEMENT</span><span class="o">))</span> <span class="o">{</span>
      <span class="c1">// å¤„ç† &lt;bean /&gt; æ ‡ç­¾å®šä¹‰ï¼Œè¿™ä¹Ÿç®—æ˜¯æˆ‘ä»¬çš„é‡ç‚¹å§</span>
      <span class="n">processBeanDefinition</span><span class="o">(</span><span class="n">ele</span><span class="o">,</span> <span class="n">delegate</span><span class="o">);</span>
   <span class="o">}</span>
   <span class="k">else</span> <span class="nf">if</span> <span class="o">(</span><span class="n">delegate</span><span class="o">.</span><span class="na">nodeNameEquals</span><span class="o">(</span><span class="n">ele</span><span class="o">,</span> <span class="no">NESTED_BEANS_ELEMENT</span><span class="o">))</span> <span class="o">{</span>
      <span class="c1">// å¦‚æœç¢°åˆ°çš„æ˜¯åµŒå¥—çš„ &lt;beans /&gt; æ ‡ç­¾ï¼Œéœ€è¦é€’å½’</span>
      <span class="n">doRegisterBeanDefinitions</span><span class="o">(</span><span class="n">ele</span><span class="o">);</span>
   <span class="o">}</span>
<span class="o">}</span>
</pre></td></tr></tbody></table></code></pre></div></div>

<p>å¦‚æœæ¯ä¸ªæ ‡ç­¾éƒ½è¯´ï¼Œé‚£æˆ‘ä¸åè¡€ï¼Œä½ ä»¬éƒ½è¦åè¡€äº†ã€‚æˆ‘ä»¬æŒ‘æˆ‘ä»¬çš„é‡ç‚¹ <code class="highlighter-rouge">&lt;bean /&gt;</code> æ ‡ç­¾å‡ºæ¥è¯´ã€‚</p>

<h5 id="processbeandefinition-è§£æ-bean-æ ‡ç­¾">processBeanDefinition è§£æ bean æ ‡ç­¾</h5>

<p>ä¸‹é¢æ˜¯ processBeanDefinition è§£æ <code class="highlighter-rouge">&lt;bean /&gt;</code> æ ‡ç­¾ï¼š</p>

<p>// DefaultBeanDefinitionDocumentReader 298</p>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
</pre></td><td class="rouge-code"><pre><span class="kd">protected</span> <span class="kt">void</span> <span class="nf">processBeanDefinition</span><span class="o">(</span><span class="nc">Element</span> <span class="n">ele</span><span class="o">,</span> <span class="nc">BeanDefinitionParserDelegate</span> <span class="n">delegate</span><span class="o">)</span> <span class="o">{</span>
   <span class="c1">// å°† &lt;bean /&gt; èŠ‚ç‚¹ä¸­çš„ä¿¡æ¯æå–å‡ºæ¥ï¼Œç„¶åå°è£…åˆ°ä¸€ä¸ª BeanDefinitionHolder ä¸­ï¼Œç»†èŠ‚å¾€ä¸‹çœ‹</span>
   <span class="nc">BeanDefinitionHolder</span> <span class="n">bdHolder</span> <span class="o">=</span> <span class="n">delegate</span><span class="o">.</span><span class="na">parseBeanDefinitionElement</span><span class="o">(</span><span class="n">ele</span><span class="o">);</span>
  
   <span class="c1">// ä¸‹é¢çš„å‡ è¡Œå…ˆä¸è¦çœ‹ï¼Œè·³è¿‡å…ˆï¼Œè·³è¿‡å…ˆï¼Œè·³è¿‡å…ˆï¼Œåé¢ä¼šç»§ç»­è¯´çš„</span>
  
   <span class="k">if</span> <span class="o">(</span><span class="n">bdHolder</span> <span class="o">!=</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
      <span class="n">bdHolder</span> <span class="o">=</span> <span class="n">delegate</span><span class="o">.</span><span class="na">decorateBeanDefinitionIfRequired</span><span class="o">(</span><span class="n">ele</span><span class="o">,</span> <span class="n">bdHolder</span><span class="o">);</span>
      <span class="k">try</span> <span class="o">{</span>
         <span class="c1">// Register the final decorated instance.</span>
         <span class="nc">BeanDefinitionReaderUtils</span><span class="o">.</span><span class="na">registerBeanDefinition</span><span class="o">(</span><span class="n">bdHolder</span><span class="o">,</span> <span class="n">getReaderContext</span><span class="o">().</span><span class="na">getRegistry</span><span class="o">());</span>
      <span class="o">}</span>
      <span class="k">catch</span> <span class="o">(</span><span class="nc">BeanDefinitionStoreException</span> <span class="n">ex</span><span class="o">)</span> <span class="o">{</span>
         <span class="n">getReaderContext</span><span class="o">().</span><span class="na">error</span><span class="o">(</span><span class="s">"Failed to register bean definition with name '"</span> <span class="o">+</span>
               <span class="n">bdHolder</span><span class="o">.</span><span class="na">getBeanName</span><span class="o">()</span> <span class="o">+</span> <span class="s">"'"</span><span class="o">,</span> <span class="n">ele</span><span class="o">,</span> <span class="n">ex</span><span class="o">);</span>
      <span class="o">}</span>
      <span class="c1">// Send registration event.</span>
      <span class="n">getReaderContext</span><span class="o">().</span><span class="na">fireComponentRegistered</span><span class="o">(</span><span class="k">new</span> <span class="nc">BeanComponentDefinition</span><span class="o">(</span><span class="n">bdHolder</span><span class="o">));</span>
   <span class="o">}</span>
<span class="o">}</span>
</pre></td></tr></tbody></table></code></pre></div></div>

<p>ç»§ç»­å¾€ä¸‹çœ‹æ€ä¹ˆè§£æä¹‹å‰ï¼Œæˆ‘ä»¬å…ˆçœ‹ä¸‹ <strong><code class="highlighter-rouge">&lt;bean /&gt;</code></strong> æ ‡ç­¾ä¸­å¯ä»¥å®šä¹‰å“ªäº›å±æ€§ï¼š</p>

<table>
  <thead>
    <tr>
      <th>Property</th>
      <th>Â </th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <td>class</td>
      <td>ç±»çš„å…¨é™å®šå</td>
    </tr>
    <tr>
      <td>name</td>
      <td>å¯æŒ‡å®š idã€name(ç”¨é€—å·ã€åˆ†å·ã€ç©ºæ ¼åˆ†éš”)</td>
    </tr>
    <tr>
      <td>scope</td>
      <td>ä½œç”¨åŸŸ</td>
    </tr>
    <tr>
      <td>constructor arguments</td>
      <td>æŒ‡å®šæ„é€ å‚æ•°</td>
    </tr>
    <tr>
      <td>properties</td>
      <td>è®¾ç½®å±æ€§çš„å€¼</td>
    </tr>
    <tr>
      <td>autowiring mode</td>
      <td>no(é»˜è®¤å€¼)ã€byNameã€byTypeã€ constructor</td>
    </tr>
    <tr>
      <td>lazy-initialization mode</td>
      <td>æ˜¯å¦æ‡’åŠ è½½(å¦‚æœè¢«éæ‡’åŠ è½½çš„beanä¾èµ–äº†é‚£ä¹ˆå…¶å®ä¹Ÿå°±ä¸èƒ½æ‡’åŠ è½½äº†)</td>
    </tr>
    <tr>
      <td>initialization method</td>
      <td>bean å±æ€§è®¾ç½®å®Œæˆåï¼Œä¼šè°ƒç”¨è¿™ä¸ªæ–¹æ³•</td>
    </tr>
    <tr>
      <td>destruction method</td>
      <td>bean é”€æ¯åçš„å›è°ƒæ–¹æ³•</td>
    </tr>
  </tbody>
</table>

<p>ä¸Šé¢è¡¨æ ¼ä¸­çš„å†…å®¹æˆ‘æƒ³å¤§å®¶éƒ½éå¸¸ç†Ÿæ‚‰å§ï¼Œå¦‚æœä¸ç†Ÿæ‚‰ï¼Œé‚£å°±æ˜¯ä½ ä¸å¤Ÿäº†è§£ Spring çš„é…ç½®äº†ã€‚</p>

<p>ç®€å•åœ°è¯´å°±æ˜¯åƒä¸‹é¢è¿™æ ·å­ï¼š</p>

<div class="language-xml highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
</pre></td><td class="rouge-code"><pre><span class="nt">&lt;bean</span> <span class="na">id=</span><span class="s">"exampleBean"</span> <span class="na">name=</span><span class="s">"name1, name2, name3"</span> <span class="na">class=</span><span class="s">"com.javadoop.ExampleBean"</span>
      <span class="na">scope=</span><span class="s">"singleton"</span> <span class="na">lazy-init=</span><span class="s">"true"</span> <span class="na">init-method=</span><span class="s">"init"</span> <span class="na">destroy-method=</span><span class="s">"cleanup"</span><span class="nt">&gt;</span>
  
    <span class="c">&lt;!-- å¯ä»¥ç”¨ä¸‹é¢ä¸‰ç§å½¢å¼æŒ‡å®šæ„é€ å‚æ•° --&gt;</span>
    <span class="nt">&lt;constructor-arg</span> <span class="na">type=</span><span class="s">"int"</span> <span class="na">value=</span><span class="s">"7500000"</span><span class="nt">/&gt;</span>
    <span class="nt">&lt;constructor-arg</span> <span class="na">name=</span><span class="s">"years"</span> <span class="na">value=</span><span class="s">"7500000"</span><span class="nt">/&gt;</span>
    <span class="nt">&lt;constructor-arg</span> <span class="na">index=</span><span class="s">"0"</span> <span class="na">value=</span><span class="s">"7500000"</span><span class="nt">/&gt;</span>
  
    <span class="c">&lt;!-- property çš„å‡ ç§æƒ…å†µ --&gt;</span>
    <span class="nt">&lt;property</span> <span class="na">name=</span><span class="s">"beanOne"</span><span class="nt">&gt;</span>
        <span class="nt">&lt;ref</span> <span class="na">bean=</span><span class="s">"anotherExampleBean"</span><span class="nt">/&gt;</span>
    <span class="nt">&lt;/property&gt;</span>
    <span class="nt">&lt;property</span> <span class="na">name=</span><span class="s">"beanTwo"</span> <span class="na">ref=</span><span class="s">"yetAnotherBean"</span><span class="nt">/&gt;</span>
    <span class="nt">&lt;property</span> <span class="na">name=</span><span class="s">"integerProperty"</span> <span class="na">value=</span><span class="s">"1"</span><span class="nt">/&gt;</span>
<span class="nt">&lt;/bean&gt;</span>
</pre></td></tr></tbody></table></code></pre></div></div>

<p>å½“ç„¶ï¼Œé™¤äº†ä¸Šé¢ä¸¾ä¾‹å‡ºæ¥çš„è¿™äº›ï¼Œè¿˜æœ‰ factory-beanã€factory-methodã€<code class="highlighter-rouge">&lt;lockup-method /&gt;</code>ã€<code class="highlighter-rouge">&lt;replaced-method /&gt;</code>ã€<code class="highlighter-rouge">&lt;meta /&gt;</code>ã€<code class="highlighter-rouge">&lt;qualifier /&gt;</code> è¿™å‡ ä¸ªï¼Œå¤§å®¶æ˜¯ä¸æ˜¯ç†Ÿæ‚‰å‘¢ï¼Ÿè‡ªå·±æ£€éªŒä¸€ä¸‹è‡ªå·±å¯¹ Spring ä¸­ bean çš„äº†è§£ç¨‹åº¦ã€‚</p>

<p>æœ‰äº†ä»¥ä¸Šè¿™äº›çŸ¥è¯†ä»¥åï¼Œæˆ‘ä»¬å†ç»§ç»­å¾€é‡Œçœ‹æ€ä¹ˆè§£æ bean å…ƒç´ ï¼Œæ˜¯æ€ä¹ˆè½¬æ¢åˆ° BeanDefinitionHolder çš„ã€‚</p>

<p>// BeanDefinitionParserDelegate 428</p>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
44
45
46
47
48
49
50
51
52
53
54
55
56
57
58
59
60
61
62
63
64
65
66
67
68
69
70
71
72
73
74
75
76
77
78
</pre></td><td class="rouge-code"><pre><span class="kd">public</span> <span class="nc">BeanDefinitionHolder</span> <span class="nf">parseBeanDefinitionElement</span><span class="o">(</span><span class="nc">Element</span> <span class="n">ele</span><span class="o">)</span> <span class="o">{</span>
    <span class="k">return</span> <span class="nf">parseBeanDefinitionElement</span><span class="o">(</span><span class="n">ele</span><span class="o">,</span> <span class="kc">null</span><span class="o">);</span>
<span class="o">}</span>

<span class="kd">public</span> <span class="nc">BeanDefinitionHolder</span> <span class="nf">parseBeanDefinitionElement</span><span class="o">(</span><span class="nc">Element</span> <span class="n">ele</span><span class="o">,</span> <span class="nc">BeanDefinition</span> <span class="n">containingBean</span><span class="o">)</span> <span class="o">{</span>
   <span class="nc">String</span> <span class="n">id</span> <span class="o">=</span> <span class="n">ele</span><span class="o">.</span><span class="na">getAttribute</span><span class="o">(</span><span class="no">ID_ATTRIBUTE</span><span class="o">);</span>
   <span class="nc">String</span> <span class="n">nameAttr</span> <span class="o">=</span> <span class="n">ele</span><span class="o">.</span><span class="na">getAttribute</span><span class="o">(</span><span class="no">NAME_ATTRIBUTE</span><span class="o">);</span>

   <span class="nc">List</span><span class="o">&lt;</span><span class="nc">String</span><span class="o">&gt;</span> <span class="n">aliases</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">ArrayList</span><span class="o">&lt;</span><span class="nc">String</span><span class="o">&gt;();</span>
      
   <span class="c1">// å°† name å±æ€§çš„å®šä¹‰æŒ‰ç…§ â€œé€—å·ã€åˆ†å·ã€ç©ºæ ¼â€ åˆ‡åˆ†ï¼Œå½¢æˆä¸€ä¸ª åˆ«ååˆ—è¡¨æ•°ç»„ï¼Œ</span>
   <span class="c1">// å½“ç„¶ï¼Œå¦‚æœä½ ä¸å®šä¹‰ name å±æ€§çš„è¯ï¼Œå°±æ˜¯ç©ºçš„äº†</span>
   <span class="c1">// æˆ‘åœ¨é™„å½•ä¸­ç®€å•ä»‹ç»äº†ä¸€ä¸‹ id å’Œ name çš„é…ç½®ï¼Œå¤§å®¶å¯ä»¥çœ‹ä¸€çœ¼ï¼Œæœ‰ä¸ª20ç§’å°±å¯ä»¥äº†</span>
   <span class="k">if</span> <span class="o">(</span><span class="nc">StringUtils</span><span class="o">.</span><span class="na">hasLength</span><span class="o">(</span><span class="n">nameAttr</span><span class="o">))</span> <span class="o">{</span>
      <span class="nc">String</span><span class="o">[]</span> <span class="n">nameArr</span> <span class="o">=</span> <span class="nc">StringUtils</span><span class="o">.</span><span class="na">tokenizeToStringArray</span><span class="o">(</span><span class="n">nameAttr</span><span class="o">,</span> <span class="no">MULTI_VALUE_ATTRIBUTE_DELIMITERS</span><span class="o">);</span>
      <span class="n">aliases</span><span class="o">.</span><span class="na">addAll</span><span class="o">(</span><span class="nc">Arrays</span><span class="o">.</span><span class="na">asList</span><span class="o">(</span><span class="n">nameArr</span><span class="o">));</span>
   <span class="o">}</span>

   <span class="nc">String</span> <span class="n">beanName</span> <span class="o">=</span> <span class="n">id</span><span class="o">;</span>
   <span class="c1">// å¦‚æœæ²¡æœ‰æŒ‡å®šid, é‚£ä¹ˆç”¨åˆ«ååˆ—è¡¨çš„ç¬¬ä¸€ä¸ªåå­—ä½œä¸ºbeanName</span>
   <span class="k">if</span> <span class="o">(!</span><span class="nc">StringUtils</span><span class="o">.</span><span class="na">hasText</span><span class="o">(</span><span class="n">beanName</span><span class="o">)</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="n">aliases</span><span class="o">.</span><span class="na">isEmpty</span><span class="o">())</span> <span class="o">{</span>
      <span class="n">beanName</span> <span class="o">=</span> <span class="n">aliases</span><span class="o">.</span><span class="na">remove</span><span class="o">(</span><span class="mi">0</span><span class="o">);</span>
      <span class="k">if</span> <span class="o">(</span><span class="n">logger</span><span class="o">.</span><span class="na">isDebugEnabled</span><span class="o">())</span> <span class="o">{</span>
         <span class="n">logger</span><span class="o">.</span><span class="na">debug</span><span class="o">(</span><span class="s">"No XML 'id' specified - using '"</span> <span class="o">+</span> <span class="n">beanName</span> <span class="o">+</span>
               <span class="s">"' as bean name and "</span> <span class="o">+</span> <span class="n">aliases</span> <span class="o">+</span> <span class="s">" as aliases"</span><span class="o">);</span>
      <span class="o">}</span>
   <span class="o">}</span>

   <span class="k">if</span> <span class="o">(</span><span class="n">containingBean</span> <span class="o">==</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
      <span class="n">checkNameUniqueness</span><span class="o">(</span><span class="n">beanName</span><span class="o">,</span> <span class="n">aliases</span><span class="o">,</span> <span class="n">ele</span><span class="o">);</span>
   <span class="o">}</span>
  
   <span class="c1">// æ ¹æ® &lt;bean ...&gt;...&lt;/bean&gt; ä¸­çš„é…ç½®åˆ›å»º BeanDefinitionï¼Œç„¶åæŠŠé…ç½®ä¸­çš„ä¿¡æ¯éƒ½è®¾ç½®åˆ°å®ä¾‹ä¸­,</span>
   <span class="c1">// ç»†èŠ‚åé¢ç»†è¯´ï¼Œå…ˆçŸ¥é“ä¸‹é¢è¿™è¡Œç»“æŸåï¼Œä¸€ä¸ª BeanDefinition å®ä¾‹å°±å‡ºæ¥äº†ã€‚</span>
   <span class="nc">AbstractBeanDefinition</span> <span class="n">beanDefinition</span> <span class="o">=</span> <span class="n">parseBeanDefinitionElement</span><span class="o">(</span><span class="n">ele</span><span class="o">,</span> <span class="n">beanName</span><span class="o">,</span> <span class="n">containingBean</span><span class="o">);</span>
   
   <span class="c1">// åˆ°è¿™é‡Œï¼Œæ•´ä¸ª &lt;bean /&gt; æ ‡ç­¾å°±ç®—è§£æç»“æŸäº†ï¼Œä¸€ä¸ª BeanDefinition å°±å½¢æˆäº†ã€‚</span>
   <span class="k">if</span> <span class="o">(</span><span class="n">beanDefinition</span> <span class="o">!=</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
      <span class="c1">// å¦‚æœéƒ½æ²¡æœ‰è®¾ç½® id å’Œ nameï¼Œé‚£ä¹ˆæ­¤æ—¶çš„ beanName å°±ä¼šä¸º nullï¼Œè¿›å…¥ä¸‹é¢è¿™å—ä»£ç äº§ç”Ÿ</span>
      <span class="c1">// å¦‚æœè¯»è€…ä¸æ„Ÿå…´è¶£çš„è¯ï¼Œæˆ‘è§‰å¾—ä¸éœ€è¦å…³å¿ƒè¿™å—ä»£ç ï¼Œå¯¹æœ¬æ–‡æºç åˆ†ææ¥è¯´ï¼Œè¿™äº›ä¸œè¥¿ä¸é‡è¦</span>
      <span class="k">if</span> <span class="o">(!</span><span class="nc">StringUtils</span><span class="o">.</span><span class="na">hasText</span><span class="o">(</span><span class="n">beanName</span><span class="o">))</span> <span class="o">{</span>
         <span class="k">try</span> <span class="o">{</span>
            <span class="k">if</span> <span class="o">(</span><span class="n">containingBean</span> <span class="o">!=</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span><span class="c1">// æŒ‰ç…§æˆ‘ä»¬çš„æ€è·¯ï¼Œè¿™é‡Œ containingBean æ˜¯ null çš„</span>
               <span class="n">beanName</span> <span class="o">=</span> <span class="nc">BeanDefinitionReaderUtils</span><span class="o">.</span><span class="na">generateBeanName</span><span class="o">(</span>
                     <span class="n">beanDefinition</span><span class="o">,</span> <span class="k">this</span><span class="o">.</span><span class="na">readerContext</span><span class="o">.</span><span class="na">getRegistry</span><span class="o">(),</span> <span class="kc">true</span><span class="o">);</span>
            <span class="o">}</span>
            <span class="k">else</span> <span class="o">{</span>
               <span class="c1">// å¦‚æœæˆ‘ä»¬ä¸å®šä¹‰ id å’Œ nameï¼Œé‚£ä¹ˆæˆ‘ä»¬å¼•è¨€é‡Œçš„é‚£ä¸ªä¾‹å­ï¼š</span>
               <span class="c1">//   1. beanName ä¸ºï¼šcom.javadoop.example.MessageServiceImpl#0</span>
               <span class="c1">//   2. beanClassName ä¸ºï¼šcom.javadoop.example.MessageServiceImpl</span>
              
               <span class="n">beanName</span> <span class="o">=</span> <span class="k">this</span><span class="o">.</span><span class="na">readerContext</span><span class="o">.</span><span class="na">generateBeanName</span><span class="o">(</span><span class="n">beanDefinition</span><span class="o">);</span>
               
               <span class="nc">String</span> <span class="n">beanClassName</span> <span class="o">=</span> <span class="n">beanDefinition</span><span class="o">.</span><span class="na">getBeanClassName</span><span class="o">();</span>
               <span class="k">if</span> <span class="o">(</span><span class="n">beanClassName</span> <span class="o">!=</span> <span class="kc">null</span> <span class="o">&amp;&amp;</span>
                     <span class="n">beanName</span><span class="o">.</span><span class="na">startsWith</span><span class="o">(</span><span class="n">beanClassName</span><span class="o">)</span> <span class="o">&amp;&amp;</span> <span class="n">beanName</span><span class="o">.</span><span class="na">length</span><span class="o">()</span> <span class="o">&gt;</span> <span class="n">beanClassName</span><span class="o">.</span><span class="na">length</span><span class="o">()</span> <span class="o">&amp;&amp;</span>
                     <span class="o">!</span><span class="k">this</span><span class="o">.</span><span class="na">readerContext</span><span class="o">.</span><span class="na">getRegistry</span><span class="o">().</span><span class="na">isBeanNameInUse</span><span class="o">(</span><span class="n">beanClassName</span><span class="o">))</span> <span class="o">{</span>
                  <span class="c1">// æŠŠ beanClassName è®¾ç½®ä¸º Bean çš„åˆ«å</span>
                  <span class="n">aliases</span><span class="o">.</span><span class="na">add</span><span class="o">(</span><span class="n">beanClassName</span><span class="o">);</span>
               <span class="o">}</span>
            <span class="o">}</span>
            <span class="k">if</span> <span class="o">(</span><span class="n">logger</span><span class="o">.</span><span class="na">isDebugEnabled</span><span class="o">())</span> <span class="o">{</span>
               <span class="n">logger</span><span class="o">.</span><span class="na">debug</span><span class="o">(</span><span class="s">"Neither XML 'id' nor 'name' specified - "</span> <span class="o">+</span>
                     <span class="s">"using generated bean name ["</span> <span class="o">+</span> <span class="n">beanName</span> <span class="o">+</span> <span class="s">"]"</span><span class="o">);</span>
            <span class="o">}</span>
         <span class="o">}</span>
         <span class="k">catch</span> <span class="o">(</span><span class="nc">Exception</span> <span class="n">ex</span><span class="o">)</span> <span class="o">{</span>
            <span class="n">error</span><span class="o">(</span><span class="n">ex</span><span class="o">.</span><span class="na">getMessage</span><span class="o">(),</span> <span class="n">ele</span><span class="o">);</span>
            <span class="k">return</span> <span class="kc">null</span><span class="o">;</span>
         <span class="o">}</span>
      <span class="o">}</span>
      <span class="nc">String</span><span class="o">[]</span> <span class="n">aliasesArray</span> <span class="o">=</span> <span class="nc">StringUtils</span><span class="o">.</span><span class="na">toStringArray</span><span class="o">(</span><span class="n">aliases</span><span class="o">);</span>
      <span class="c1">// è¿”å› BeanDefinitionHolder</span>
      <span class="k">return</span> <span class="k">new</span> <span class="nf">BeanDefinitionHolder</span><span class="o">(</span><span class="n">beanDefinition</span><span class="o">,</span> <span class="n">beanName</span><span class="o">,</span> <span class="n">aliasesArray</span><span class="o">);</span>
   <span class="o">}</span>

   <span class="k">return</span> <span class="kc">null</span><span class="o">;</span>
<span class="o">}</span>
</pre></td></tr></tbody></table></code></pre></div></div>

<p>ç„¶åï¼Œæˆ‘ä»¬å†çœ‹çœ‹æ€ä¹ˆæ ¹æ®é…ç½®åˆ›å»º BeanDefinition å®ä¾‹çš„ï¼š</p>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
44
45
46
47
48
49
50
51
52
53
54
55
56
57
58
59
60
</pre></td><td class="rouge-code"><pre><span class="kd">public</span> <span class="nc">AbstractBeanDefinition</span> <span class="nf">parseBeanDefinitionElement</span><span class="o">(</span>
      <span class="nc">Element</span> <span class="n">ele</span><span class="o">,</span> <span class="nc">String</span> <span class="n">beanName</span><span class="o">,</span> <span class="nc">BeanDefinition</span> <span class="n">containingBean</span><span class="o">)</span> <span class="o">{</span>

   <span class="k">this</span><span class="o">.</span><span class="na">parseState</span><span class="o">.</span><span class="na">push</span><span class="o">(</span><span class="k">new</span> <span class="nc">BeanEntry</span><span class="o">(</span><span class="n">beanName</span><span class="o">));</span>

   <span class="nc">String</span> <span class="n">className</span> <span class="o">=</span> <span class="kc">null</span><span class="o">;</span>
   <span class="k">if</span> <span class="o">(</span><span class="n">ele</span><span class="o">.</span><span class="na">hasAttribute</span><span class="o">(</span><span class="no">CLASS_ATTRIBUTE</span><span class="o">))</span> <span class="o">{</span>
      <span class="n">className</span> <span class="o">=</span> <span class="n">ele</span><span class="o">.</span><span class="na">getAttribute</span><span class="o">(</span><span class="no">CLASS_ATTRIBUTE</span><span class="o">).</span><span class="na">trim</span><span class="o">();</span>
   <span class="o">}</span>

   <span class="k">try</span> <span class="o">{</span>
      <span class="nc">String</span> <span class="n">parent</span> <span class="o">=</span> <span class="kc">null</span><span class="o">;</span>
      <span class="k">if</span> <span class="o">(</span><span class="n">ele</span><span class="o">.</span><span class="na">hasAttribute</span><span class="o">(</span><span class="no">PARENT_ATTRIBUTE</span><span class="o">))</span> <span class="o">{</span>
         <span class="n">parent</span> <span class="o">=</span> <span class="n">ele</span><span class="o">.</span><span class="na">getAttribute</span><span class="o">(</span><span class="no">PARENT_ATTRIBUTE</span><span class="o">);</span>
      <span class="o">}</span>
      <span class="c1">// åˆ›å»º BeanDefinitionï¼Œç„¶åè®¾ç½®ç±»ä¿¡æ¯è€Œå·²ï¼Œå¾ˆç®€å•ï¼Œå°±ä¸è´´ä»£ç äº†</span>
      <span class="nc">AbstractBeanDefinition</span> <span class="n">bd</span> <span class="o">=</span> <span class="n">createBeanDefinition</span><span class="o">(</span><span class="n">className</span><span class="o">,</span> <span class="n">parent</span><span class="o">);</span>

      <span class="c1">// è®¾ç½® BeanDefinition çš„ä¸€å †å±æ€§ï¼Œè¿™äº›å±æ€§å®šä¹‰åœ¨ AbstractBeanDefinition ä¸­</span>
      <span class="n">parseBeanDefinitionAttributes</span><span class="o">(</span><span class="n">ele</span><span class="o">,</span> <span class="n">beanName</span><span class="o">,</span> <span class="n">containingBean</span><span class="o">,</span> <span class="n">bd</span><span class="o">);</span>
      <span class="n">bd</span><span class="o">.</span><span class="na">setDescription</span><span class="o">(</span><span class="nc">DomUtils</span><span class="o">.</span><span class="na">getChildElementValueByTagName</span><span class="o">(</span><span class="n">ele</span><span class="o">,</span> <span class="no">DESCRIPTION_ELEMENT</span><span class="o">));</span>
    
      <span class="cm">/**
       * ä¸‹é¢çš„ä¸€å †æ˜¯è§£æ &lt;bean&gt;......&lt;/bean&gt; å†…éƒ¨çš„å­å…ƒç´ ï¼Œ
       * è§£æå‡ºæ¥ä»¥åçš„ä¿¡æ¯éƒ½æ”¾åˆ° bd çš„å±æ€§ä¸­
       */</span>
     
      <span class="c1">// è§£æ &lt;meta /&gt;</span>
      <span class="n">parseMetaElements</span><span class="o">(</span><span class="n">ele</span><span class="o">,</span> <span class="n">bd</span><span class="o">);</span>
      <span class="c1">// è§£æ &lt;lookup-method /&gt;</span>
      <span class="n">parseLookupOverrideSubElements</span><span class="o">(</span><span class="n">ele</span><span class="o">,</span> <span class="n">bd</span><span class="o">.</span><span class="na">getMethodOverrides</span><span class="o">());</span>
      <span class="c1">// è§£æ &lt;replaced-method /&gt;</span>
      <span class="n">parseReplacedMethodSubElements</span><span class="o">(</span><span class="n">ele</span><span class="o">,</span> <span class="n">bd</span><span class="o">.</span><span class="na">getMethodOverrides</span><span class="o">());</span>
    <span class="c1">// è§£æ &lt;constructor-arg /&gt;</span>
      <span class="n">parseConstructorArgElements</span><span class="o">(</span><span class="n">ele</span><span class="o">,</span> <span class="n">bd</span><span class="o">);</span>
      <span class="c1">// è§£æ &lt;property /&gt;</span>
      <span class="n">parsePropertyElements</span><span class="o">(</span><span class="n">ele</span><span class="o">,</span> <span class="n">bd</span><span class="o">);</span>
      <span class="c1">// è§£æ &lt;qualifier /&gt;</span>
      <span class="n">parseQualifierElements</span><span class="o">(</span><span class="n">ele</span><span class="o">,</span> <span class="n">bd</span><span class="o">);</span>

      <span class="n">bd</span><span class="o">.</span><span class="na">setResource</span><span class="o">(</span><span class="k">this</span><span class="o">.</span><span class="na">readerContext</span><span class="o">.</span><span class="na">getResource</span><span class="o">());</span>
      <span class="n">bd</span><span class="o">.</span><span class="na">setSource</span><span class="o">(</span><span class="n">extractSource</span><span class="o">(</span><span class="n">ele</span><span class="o">));</span>

      <span class="k">return</span> <span class="n">bd</span><span class="o">;</span>
   <span class="o">}</span>
   <span class="k">catch</span> <span class="o">(</span><span class="nc">ClassNotFoundException</span> <span class="n">ex</span><span class="o">)</span> <span class="o">{</span>
      <span class="n">error</span><span class="o">(</span><span class="s">"Bean class ["</span> <span class="o">+</span> <span class="n">className</span> <span class="o">+</span> <span class="s">"] not found"</span><span class="o">,</span> <span class="n">ele</span><span class="o">,</span> <span class="n">ex</span><span class="o">);</span>
   <span class="o">}</span>
   <span class="k">catch</span> <span class="o">(</span><span class="nc">NoClassDefFoundError</span> <span class="n">err</span><span class="o">)</span> <span class="o">{</span>
      <span class="n">error</span><span class="o">(</span><span class="s">"Class that bean class ["</span> <span class="o">+</span> <span class="n">className</span> <span class="o">+</span> <span class="s">"] depends on not found"</span><span class="o">,</span> <span class="n">ele</span><span class="o">,</span> <span class="n">err</span><span class="o">);</span>
   <span class="o">}</span>
   <span class="k">catch</span> <span class="o">(</span><span class="nc">Throwable</span> <span class="n">ex</span><span class="o">)</span> <span class="o">{</span>
      <span class="n">error</span><span class="o">(</span><span class="s">"Unexpected failure during bean definition parsing"</span><span class="o">,</span> <span class="n">ele</span><span class="o">,</span> <span class="n">ex</span><span class="o">);</span>
   <span class="o">}</span>
   <span class="k">finally</span> <span class="o">{</span>
      <span class="k">this</span><span class="o">.</span><span class="na">parseState</span><span class="o">.</span><span class="na">pop</span><span class="o">();</span>
   <span class="o">}</span>

   <span class="k">return</span> <span class="kc">null</span><span class="o">;</span>
<span class="o">}</span>
</pre></td></tr></tbody></table></code></pre></div></div>

<p>åˆ°è¿™é‡Œï¼Œæˆ‘ä»¬å·²ç»å®Œæˆäº†æ ¹æ® <code class="highlighter-rouge">&lt;bean /&gt;</code> é…ç½®åˆ›å»ºäº†ä¸€ä¸ª BeanDefinitionHolder å®ä¾‹ã€‚æ³¨æ„ï¼Œæ˜¯ä¸€ä¸ªã€‚</p>

<p>æˆ‘ä»¬å›åˆ°è§£æ <code class="highlighter-rouge">&lt;bean /&gt;</code> çš„å…¥å£æ–¹æ³•:</p>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
</pre></td><td class="rouge-code"><pre><span class="kd">protected</span> <span class="kt">void</span> <span class="nf">processBeanDefinition</span><span class="o">(</span><span class="nc">Element</span> <span class="n">ele</span><span class="o">,</span> <span class="nc">BeanDefinitionParserDelegate</span> <span class="n">delegate</span><span class="o">)</span> <span class="o">{</span>
   <span class="c1">// å°† &lt;bean /&gt; èŠ‚ç‚¹è½¬æ¢ä¸º BeanDefinitionHolderï¼Œå°±æ˜¯ä¸Šé¢è¯´çš„ä¸€å †</span>
   <span class="nc">BeanDefinitionHolder</span> <span class="n">bdHolder</span> <span class="o">=</span> <span class="n">delegate</span><span class="o">.</span><span class="na">parseBeanDefinitionElement</span><span class="o">(</span><span class="n">ele</span><span class="o">);</span>
   <span class="k">if</span> <span class="o">(</span><span class="n">bdHolder</span> <span class="o">!=</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
      <span class="c1">// å¦‚æœæœ‰è‡ªå®šä¹‰å±æ€§çš„è¯ï¼Œè¿›è¡Œç›¸åº”çš„è§£æï¼Œå…ˆå¿½ç•¥</span>
      <span class="n">bdHolder</span> <span class="o">=</span> <span class="n">delegate</span><span class="o">.</span><span class="na">decorateBeanDefinitionIfRequired</span><span class="o">(</span><span class="n">ele</span><span class="o">,</span> <span class="n">bdHolder</span><span class="o">);</span>
      <span class="k">try</span> <span class="o">{</span>
         <span class="c1">// æˆ‘ä»¬æŠŠè¿™æ­¥å«åš æ³¨å†ŒBean å§</span>
         <span class="nc">BeanDefinitionReaderUtils</span><span class="o">.</span><span class="na">registerBeanDefinition</span><span class="o">(</span><span class="n">bdHolder</span><span class="o">,</span> <span class="n">getReaderContext</span><span class="o">().</span><span class="na">getRegistry</span><span class="o">());</span>
      <span class="o">}</span>
      <span class="k">catch</span> <span class="o">(</span><span class="nc">BeanDefinitionStoreException</span> <span class="n">ex</span><span class="o">)</span> <span class="o">{</span>
         <span class="n">getReaderContext</span><span class="o">().</span><span class="na">error</span><span class="o">(</span><span class="s">"Failed to register bean definition with name '"</span> <span class="o">+</span>
               <span class="n">bdHolder</span><span class="o">.</span><span class="na">getBeanName</span><span class="o">()</span> <span class="o">+</span> <span class="s">"'"</span><span class="o">,</span> <span class="n">ele</span><span class="o">,</span> <span class="n">ex</span><span class="o">);</span>
      <span class="o">}</span>
      <span class="c1">// æ³¨å†Œå®Œæˆåï¼Œå‘é€äº‹ä»¶ï¼Œæœ¬æ–‡ä¸å±•å¼€è¯´è¿™ä¸ª</span>
      <span class="n">getReaderContext</span><span class="o">().</span><span class="na">fireComponentRegistered</span><span class="o">(</span><span class="k">new</span> <span class="nc">BeanComponentDefinition</span><span class="o">(</span><span class="n">bdHolder</span><span class="o">));</span>
   <span class="o">}</span>
<span class="o">}</span>
</pre></td></tr></tbody></table></code></pre></div></div>

<p>å¤§å®¶å†ä»”ç»†çœ‹ä¸€ä¸‹è¿™å—å§ï¼Œæˆ‘ä»¬åé¢å°±ä¸å›æ¥è¯´è¿™ä¸ªäº†ã€‚è¿™é‡Œå·²ç»æ ¹æ®ä¸€ä¸ª <code class="highlighter-rouge">&lt;bean /&gt;</code> æ ‡ç­¾äº§ç”Ÿäº†ä¸€ä¸ª BeanDefinitionHolder çš„å®ä¾‹ï¼Œè¿™ä¸ªå®ä¾‹é‡Œé¢ä¹Ÿå°±æ˜¯ä¸€ä¸ª BeanDefinition çš„å®ä¾‹å’Œå®ƒçš„ beanNameã€aliases è¿™ä¸‰ä¸ªä¿¡æ¯ï¼Œæ³¨æ„ï¼Œæˆ‘ä»¬çš„å…³æ³¨ç‚¹å§‹ç»ˆåœ¨ BeanDefinition ä¸Šï¼š</p>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
</pre></td><td class="rouge-code"><pre><span class="kd">public</span> <span class="kd">class</span> <span class="nc">BeanDefinitionHolder</span> <span class="kd">implements</span> <span class="nc">BeanMetadataElement</span> <span class="o">{</span>

  <span class="kd">private</span> <span class="kd">final</span> <span class="nc">BeanDefinition</span> <span class="n">beanDefinition</span><span class="o">;</span>

  <span class="kd">private</span> <span class="kd">final</span> <span class="nc">String</span> <span class="n">beanName</span><span class="o">;</span>

  <span class="kd">private</span> <span class="kd">final</span> <span class="nc">String</span><span class="o">[]</span> <span class="n">aliases</span><span class="o">;</span>
<span class="o">...</span>
</pre></td></tr></tbody></table></code></pre></div></div>

<p>ç„¶åæˆ‘ä»¬å‡†å¤‡æ³¨å†Œè¿™ä¸ª BeanDefinitionï¼Œæœ€åï¼ŒæŠŠè¿™ä¸ªæ³¨å†Œäº‹ä»¶å‘é€å‡ºå»ã€‚</p>

<p>ä¸‹é¢ï¼Œæˆ‘ä»¬å¼€å§‹è¯´è¯´æ³¨å†Œ Bean å§ã€‚</p>

<h5 id="æ³¨å†Œ-bean">æ³¨å†Œ Bean</h5>

<p>// BeanDefinitionReaderUtils 143</p>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
</pre></td><td class="rouge-code"><pre><span class="kd">public</span> <span class="kd">static</span> <span class="kt">void</span> <span class="nf">registerBeanDefinition</span><span class="o">(</span>
      <span class="nc">BeanDefinitionHolder</span> <span class="n">definitionHolder</span><span class="o">,</span> <span class="nc">BeanDefinitionRegistry</span> <span class="n">registry</span><span class="o">)</span>
      <span class="kd">throws</span> <span class="nc">BeanDefinitionStoreException</span> <span class="o">{</span>

   <span class="nc">String</span> <span class="n">beanName</span> <span class="o">=</span> <span class="n">definitionHolder</span><span class="o">.</span><span class="na">getBeanName</span><span class="o">();</span>
   <span class="c1">// æ³¨å†Œè¿™ä¸ª Bean</span>
   <span class="n">registry</span><span class="o">.</span><span class="na">registerBeanDefinition</span><span class="o">(</span><span class="n">beanName</span><span class="o">,</span> <span class="n">definitionHolder</span><span class="o">.</span><span class="na">getBeanDefinition</span><span class="o">());</span>

   <span class="c1">// å¦‚æœè¿˜æœ‰åˆ«åçš„è¯ï¼Œä¹Ÿè¦æ ¹æ®åˆ«åå…¨éƒ¨æ³¨å†Œä¸€éï¼Œä¸ç„¶æ ¹æ®åˆ«åå°±ä¼šæ‰¾ä¸åˆ° Bean äº†</span>
   <span class="nc">String</span><span class="o">[]</span> <span class="n">aliases</span> <span class="o">=</span> <span class="n">definitionHolder</span><span class="o">.</span><span class="na">getAliases</span><span class="o">();</span>
   <span class="k">if</span> <span class="o">(</span><span class="n">aliases</span> <span class="o">!=</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
      <span class="k">for</span> <span class="o">(</span><span class="nc">String</span> <span class="n">alias</span> <span class="o">:</span> <span class="n">aliases</span><span class="o">)</span> <span class="o">{</span>
         <span class="c1">// alias -&gt; beanName ä¿å­˜å®ƒä»¬çš„åˆ«åä¿¡æ¯ï¼Œè¿™ä¸ªå¾ˆç®€å•ï¼Œç”¨ä¸€ä¸ª map ä¿å­˜ä¸€ä¸‹å°±å¯ä»¥äº†ï¼Œ</span>
         <span class="c1">// è·å–çš„æ—¶å€™ï¼Œä¼šå…ˆå°† alias è½¬æ¢ä¸º beanNameï¼Œç„¶åå†æŸ¥æ‰¾</span>
         <span class="n">registry</span><span class="o">.</span><span class="na">registerAlias</span><span class="o">(</span><span class="n">beanName</span><span class="o">,</span> <span class="n">alias</span><span class="o">);</span>
      <span class="o">}</span>
   <span class="o">}</span>
<span class="o">}</span>
</pre></td></tr></tbody></table></code></pre></div></div>

<p>åˆ«åæ³¨å†Œçš„æ”¾ä¸€è¾¹ï¼Œæ¯•ç«Ÿå®ƒå¾ˆç®€å•ï¼Œæˆ‘ä»¬çœ‹çœ‹æ€ä¹ˆæ³¨å†Œ Beanã€‚</p>

<p>// DefaultListableBeanFactory 793</p>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
44
45
46
47
48
49
50
51
52
53
54
55
56
57
58
59
60
61
62
63
64
65
66
67
68
69
70
71
72
73
74
75
76
77
78
79
80
81
82
</pre></td><td class="rouge-code"><pre><span class="nd">@Override</span>
<span class="kd">public</span> <span class="kt">void</span> <span class="nf">registerBeanDefinition</span><span class="o">(</span><span class="nc">String</span> <span class="n">beanName</span><span class="o">,</span> <span class="nc">BeanDefinition</span> <span class="n">beanDefinition</span><span class="o">)</span>
      <span class="kd">throws</span> <span class="nc">BeanDefinitionStoreException</span> <span class="o">{</span>

   <span class="nc">Assert</span><span class="o">.</span><span class="na">hasText</span><span class="o">(</span><span class="n">beanName</span><span class="o">,</span> <span class="s">"Bean name must not be empty"</span><span class="o">);</span>
   <span class="nc">Assert</span><span class="o">.</span><span class="na">notNull</span><span class="o">(</span><span class="n">beanDefinition</span><span class="o">,</span> <span class="s">"BeanDefinition must not be null"</span><span class="o">);</span>

   <span class="k">if</span> <span class="o">(</span><span class="n">beanDefinition</span> <span class="k">instanceof</span> <span class="nc">AbstractBeanDefinition</span><span class="o">)</span> <span class="o">{</span>
      <span class="k">try</span> <span class="o">{</span>
         <span class="o">((</span><span class="nc">AbstractBeanDefinition</span><span class="o">)</span> <span class="n">beanDefinition</span><span class="o">).</span><span class="na">validate</span><span class="o">();</span>
      <span class="o">}</span>
      <span class="k">catch</span> <span class="o">(</span><span class="nc">BeanDefinitionValidationException</span> <span class="n">ex</span><span class="o">)</span> <span class="o">{</span>
         <span class="k">throw</span> <span class="k">new</span> <span class="nf">BeanDefinitionStoreException</span><span class="o">(...);</span>
      <span class="o">}</span>
   <span class="o">}</span>

   <span class="c1">// old? è¿˜è®°å¾— â€œå…è®¸ bean è¦†ç›–â€ è¿™ä¸ªé…ç½®å—ï¼ŸallowBeanDefinitionOverriding</span>
   <span class="nc">BeanDefinition</span> <span class="n">oldBeanDefinition</span><span class="o">;</span>
  
   <span class="c1">// ä¹‹åä¼šçœ‹åˆ°ï¼Œæ‰€æœ‰çš„ Bean æ³¨å†Œåä¼šæ”¾å…¥è¿™ä¸ª beanDefinitionMap ä¸­</span>
   <span class="n">oldBeanDefinition</span> <span class="o">=</span> <span class="k">this</span><span class="o">.</span><span class="na">beanDefinitionMap</span><span class="o">.</span><span class="na">get</span><span class="o">(</span><span class="n">beanName</span><span class="o">);</span>
  
   <span class="c1">// å¤„ç†é‡å¤åç§°çš„ Bean å®šä¹‰çš„æƒ…å†µ</span>
   <span class="k">if</span> <span class="o">(</span><span class="n">oldBeanDefinition</span> <span class="o">!=</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
      <span class="k">if</span> <span class="o">(!</span><span class="n">isAllowBeanDefinitionOverriding</span><span class="o">())</span> <span class="o">{</span>
         <span class="c1">// å¦‚æœä¸å…è®¸è¦†ç›–çš„è¯ï¼ŒæŠ›å¼‚å¸¸</span>
         <span class="k">throw</span> <span class="k">new</span> <span class="nf">BeanDefinitionStoreException</span><span class="o">(</span><span class="n">beanDefinition</span><span class="o">.</span><span class="na">getResourceDescription</span><span class="o">()...</span>
      <span class="o">}</span>
      <span class="k">else</span> <span class="nf">if</span> <span class="o">(</span><span class="n">oldBeanDefinition</span><span class="o">.</span><span class="na">getRole</span><span class="o">()</span> <span class="o">&lt;</span> <span class="n">beanDefinition</span><span class="o">.</span><span class="na">getRole</span><span class="o">())</span> <span class="o">{</span>
         <span class="c1">// log...ç”¨æ¡†æ¶å®šä¹‰çš„ Bean è¦†ç›–ç”¨æˆ·è‡ªå®šä¹‰çš„ Bean </span>
      <span class="o">}</span>
      <span class="k">else</span> <span class="nf">if</span> <span class="o">(!</span><span class="n">beanDefinition</span><span class="o">.</span><span class="na">equals</span><span class="o">(</span><span class="n">oldBeanDefinition</span><span class="o">))</span> <span class="o">{</span>
         <span class="c1">// log...ç”¨æ–°çš„ Bean è¦†ç›–æ—§çš„ Bean</span>
      <span class="o">}</span>
      <span class="k">else</span> <span class="o">{</span>
         <span class="c1">// log...ç”¨åŒç­‰çš„ Bean è¦†ç›–æ—§çš„ Beanï¼Œè¿™é‡ŒæŒ‡çš„æ˜¯ equals æ–¹æ³•è¿”å› true çš„ Bean</span>
      <span class="o">}</span>
      <span class="c1">// è¦†ç›–</span>
      <span class="k">this</span><span class="o">.</span><span class="na">beanDefinitionMap</span><span class="o">.</span><span class="na">put</span><span class="o">(</span><span class="n">beanName</span><span class="o">,</span> <span class="n">beanDefinition</span><span class="o">);</span>
   <span class="o">}</span>
   <span class="k">else</span> <span class="o">{</span>
      <span class="c1">// åˆ¤æ–­æ˜¯å¦å·²ç»æœ‰å…¶ä»–çš„ Bean å¼€å§‹åˆå§‹åŒ–äº†.</span>
      <span class="c1">// æ³¨æ„ï¼Œ"æ³¨å†ŒBean" è¿™ä¸ªåŠ¨ä½œç»“æŸï¼ŒBean ä¾ç„¶è¿˜æ²¡æœ‰åˆå§‹åŒ–ï¼Œæˆ‘ä»¬åé¢ä¼šæœ‰å¤§ç¯‡å¹…è¯´åˆå§‹åŒ–è¿‡ç¨‹ï¼Œ</span>
      <span class="c1">// åœ¨ Spring å®¹å™¨å¯åŠ¨çš„æœ€åï¼Œä¼š é¢„åˆå§‹åŒ– æ‰€æœ‰çš„ singleton beans</span>
      <span class="k">if</span> <span class="o">(</span><span class="n">hasBeanCreationStarted</span><span class="o">())</span> <span class="o">{</span>
         <span class="c1">// Cannot modify startup-time collection elements anymore (for stable iteration)</span>
         <span class="kd">synchronized</span> <span class="o">(</span><span class="k">this</span><span class="o">.</span><span class="na">beanDefinitionMap</span><span class="o">)</span> <span class="o">{</span>
            <span class="k">this</span><span class="o">.</span><span class="na">beanDefinitionMap</span><span class="o">.</span><span class="na">put</span><span class="o">(</span><span class="n">beanName</span><span class="o">,</span> <span class="n">beanDefinition</span><span class="o">);</span>
            <span class="nc">List</span><span class="o">&lt;</span><span class="nc">String</span><span class="o">&gt;</span> <span class="n">updatedDefinitions</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">ArrayList</span><span class="o">&lt;</span><span class="nc">String</span><span class="o">&gt;(</span><span class="k">this</span><span class="o">.</span><span class="na">beanDefinitionNames</span><span class="o">.</span><span class="na">size</span><span class="o">()</span> <span class="o">+</span> <span class="mi">1</span><span class="o">);</span>
            <span class="n">updatedDefinitions</span><span class="o">.</span><span class="na">addAll</span><span class="o">(</span><span class="k">this</span><span class="o">.</span><span class="na">beanDefinitionNames</span><span class="o">);</span>
            <span class="n">updatedDefinitions</span><span class="o">.</span><span class="na">add</span><span class="o">(</span><span class="n">beanName</span><span class="o">);</span>
            <span class="k">this</span><span class="o">.</span><span class="na">beanDefinitionNames</span> <span class="o">=</span> <span class="n">updatedDefinitions</span><span class="o">;</span>
            <span class="k">if</span> <span class="o">(</span><span class="k">this</span><span class="o">.</span><span class="na">manualSingletonNames</span><span class="o">.</span><span class="na">contains</span><span class="o">(</span><span class="n">beanName</span><span class="o">))</span> <span class="o">{</span>
               <span class="nc">Set</span><span class="o">&lt;</span><span class="nc">String</span><span class="o">&gt;</span> <span class="n">updatedSingletons</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">LinkedHashSet</span><span class="o">&lt;</span><span class="nc">String</span><span class="o">&gt;(</span><span class="k">this</span><span class="o">.</span><span class="na">manualSingletonNames</span><span class="o">);</span>
               <span class="n">updatedSingletons</span><span class="o">.</span><span class="na">remove</span><span class="o">(</span><span class="n">beanName</span><span class="o">);</span>
               <span class="k">this</span><span class="o">.</span><span class="na">manualSingletonNames</span> <span class="o">=</span> <span class="n">updatedSingletons</span><span class="o">;</span>
            <span class="o">}</span>
         <span class="o">}</span>
      <span class="o">}</span>
      <span class="k">else</span> <span class="o">{</span>
         <span class="c1">// æœ€æ­£å¸¸çš„åº”è¯¥æ˜¯è¿›åˆ°è¿™ä¸ªåˆ†æ”¯ã€‚</span>
        
         <span class="c1">// å°† BeanDefinition æ”¾åˆ°è¿™ä¸ª map ä¸­ï¼Œè¿™ä¸ª map ä¿å­˜äº†æ‰€æœ‰çš„ BeanDefinition</span>
         <span class="k">this</span><span class="o">.</span><span class="na">beanDefinitionMap</span><span class="o">.</span><span class="na">put</span><span class="o">(</span><span class="n">beanName</span><span class="o">,</span> <span class="n">beanDefinition</span><span class="o">);</span>
         <span class="c1">// è¿™æ˜¯ä¸ª ArrayListï¼Œæ‰€ä»¥ä¼šæŒ‰ç…§ bean é…ç½®çš„é¡ºåºä¿å­˜æ¯ä¸€ä¸ªæ³¨å†Œçš„ Bean çš„åå­—</span>
         <span class="k">this</span><span class="o">.</span><span class="na">beanDefinitionNames</span><span class="o">.</span><span class="na">add</span><span class="o">(</span><span class="n">beanName</span><span class="o">);</span>
         <span class="c1">// è¿™æ˜¯ä¸ª LinkedHashSetï¼Œä»£è¡¨çš„æ˜¯æ‰‹åŠ¨æ³¨å†Œçš„ singleton beanï¼Œ</span>
         <span class="c1">// æ³¨æ„è¿™é‡Œæ˜¯ remove æ–¹æ³•ï¼Œåˆ°è¿™é‡Œçš„ Bean å½“ç„¶ä¸æ˜¯æ‰‹åŠ¨æ³¨å†Œçš„</span>
         <span class="c1">// æ‰‹åŠ¨æŒ‡çš„æ˜¯é€šè¿‡è°ƒç”¨ä»¥ä¸‹æ–¹æ³•æ³¨å†Œçš„ bean ï¼š</span>
         <span class="c1">//     registerSingleton(String beanName, Object singletonObject)</span>
         <span class="c1">// è¿™ä¸æ˜¯é‡ç‚¹ï¼Œè§£é‡Šåªæ˜¯ä¸ºäº†ä¸è®©å¤§å®¶ç–‘æƒ‘ã€‚Spring ä¼šåœ¨åé¢"æ‰‹åŠ¨"æ³¨å†Œä¸€äº› Beanï¼Œ</span>
         <span class="c1">// å¦‚ "environment"ã€"systemProperties" ç­‰ beanï¼Œæˆ‘ä»¬è‡ªå·±ä¹Ÿå¯ä»¥åœ¨è¿è¡Œæ—¶æ³¨å†Œ Bean åˆ°å®¹å™¨ä¸­çš„</span>
         <span class="k">this</span><span class="o">.</span><span class="na">manualSingletonNames</span><span class="o">.</span><span class="na">remove</span><span class="o">(</span><span class="n">beanName</span><span class="o">);</span>
      <span class="o">}</span>
      <span class="c1">// è¿™ä¸ªä¸é‡è¦ï¼Œåœ¨é¢„åˆå§‹åŒ–çš„æ—¶å€™ä¼šç”¨åˆ°ï¼Œä¸å¿…ç®¡å®ƒã€‚</span>
      <span class="k">this</span><span class="o">.</span><span class="na">frozenBeanDefinitionNames</span> <span class="o">=</span> <span class="kc">null</span><span class="o">;</span>
   <span class="o">}</span>

   <span class="k">if</span> <span class="o">(</span><span class="n">oldBeanDefinition</span> <span class="o">!=</span> <span class="kc">null</span> <span class="o">||</span> <span class="n">containsSingleton</span><span class="o">(</span><span class="n">beanName</span><span class="o">))</span> <span class="o">{</span>
      <span class="n">resetBeanDefinition</span><span class="o">(</span><span class="n">beanName</span><span class="o">);</span>
   <span class="o">}</span>
<span class="o">}</span>
</pre></td></tr></tbody></table></code></pre></div></div>

<p>æ€»ç»“ä¸€ä¸‹ï¼Œåˆ°è¿™é‡Œå·²ç»åˆå§‹åŒ–äº† Bean å®¹å™¨ï¼Œ<code class="highlighter-rouge">&lt;bean /&gt;</code> é…ç½®ä¹Ÿç›¸åº”çš„è½¬æ¢ä¸ºäº†ä¸€ä¸ªä¸ª BeanDefinitionï¼Œç„¶åæ³¨å†Œäº†å„ä¸ª BeanDefinition åˆ°æ³¨å†Œä¸­å¿ƒï¼Œå¹¶ä¸”å‘é€äº†æ³¨å†Œäº‹ä»¶ã€‚</p>

<blockquote>
  <p>åˆ°è¿™é‡Œæ˜¯ä¸€ä¸ªåˆ†æ°´å²­ï¼Œå‰é¢çš„å†…å®¹éƒ½è¿˜ç®—æ¯”è¾ƒç®€å•ï¼Œå¤§å®¶è¦æ¸…æ¥šåœ°çŸ¥é“å‰é¢éƒ½åšäº†å“ªäº›äº‹æƒ…ã€‚</p>
</blockquote>

<h3 id="bean-å®¹å™¨å®ä¾‹åŒ–å®Œæˆå">Bean å®¹å™¨å®ä¾‹åŒ–å®Œæˆå</h3>

<p>è¯´åˆ°è¿™é‡Œï¼Œæˆ‘ä»¬å›åˆ° refresh() æ–¹æ³•ï¼Œæˆ‘é‡æ–°è´´äº†ä¸€éä»£ç ï¼Œçœ‹çœ‹æˆ‘ä»¬è¯´åˆ°å“ªäº†ã€‚æ˜¯çš„ï¼Œæˆ‘ä»¬æ‰è¯´å®Œ obtainFreshBeanFactory() æ–¹æ³•ã€‚</p>

<p>è€ƒè™‘åˆ°ç¯‡å¹…ï¼Œè¿™é‡Œå¼€å§‹å¤§å¹…ç¼©å‡æ‰æ²¡å¿…è¦è¯¦ç»†ä»‹ç»çš„éƒ¨åˆ†ï¼Œå¤§å®¶ç›´æ¥çœ‹ä¸‹é¢çš„ä»£ç ä¸­çš„æ³¨é‡Šå°±å¥½äº†ã€‚</p>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
44
45
46
47
48
49
50
51
52
53
54
55
56
57
58
59
60
61
62
63
64
65
66
67
68
69
70
71
72
73
74
75
76
77
78
79
80
</pre></td><td class="rouge-code"><pre><span class="nd">@Override</span>
<span class="kd">public</span> <span class="kt">void</span> <span class="nf">refresh</span><span class="o">()</span> <span class="kd">throws</span> <span class="nc">BeansException</span><span class="o">,</span> <span class="nc">IllegalStateException</span> <span class="o">{</span>
   <span class="c1">// æ¥ä¸ªé”ï¼Œä¸ç„¶ refresh() è¿˜æ²¡ç»“æŸï¼Œä½ åˆæ¥ä¸ªå¯åŠ¨æˆ–é”€æ¯å®¹å™¨çš„æ“ä½œï¼Œé‚£ä¸å°±ä¹±å¥—äº†å˜›</span>
   <span class="kd">synchronized</span> <span class="o">(</span><span class="k">this</span><span class="o">.</span><span class="na">startupShutdownMonitor</span><span class="o">)</span> <span class="o">{</span>

      <span class="c1">// å‡†å¤‡å·¥ä½œï¼Œè®°å½•ä¸‹å®¹å™¨çš„å¯åŠ¨æ—¶é—´ã€æ ‡è®°â€œå·²å¯åŠ¨â€çŠ¶æ€ã€å¤„ç†é…ç½®æ–‡ä»¶ä¸­çš„å ä½ç¬¦</span>
      <span class="n">prepareRefresh</span><span class="o">();</span>
     
      <span class="c1">// è¿™æ­¥æ¯”è¾ƒå…³é”®ï¼Œè¿™æ­¥å®Œæˆåï¼Œé…ç½®æ–‡ä»¶å°±ä¼šè§£ææˆä¸€ä¸ªä¸ª Bean å®šä¹‰ï¼Œæ³¨å†Œåˆ° BeanFactory ä¸­ï¼Œ</span>
      <span class="c1">// å½“ç„¶ï¼Œè¿™é‡Œè¯´çš„ Bean è¿˜æ²¡æœ‰åˆå§‹åŒ–ï¼Œåªæ˜¯é…ç½®ä¿¡æ¯éƒ½æå–å‡ºæ¥äº†ï¼Œ</span>
      <span class="c1">// æ³¨å†Œä¹Ÿåªæ˜¯å°†è¿™äº›ä¿¡æ¯éƒ½ä¿å­˜åˆ°äº†æ³¨å†Œä¸­å¿ƒ(è¯´åˆ°åº•æ ¸å¿ƒæ˜¯ä¸€ä¸ª beanName-&gt; beanDefinition çš„ map)</span>
      <span class="nc">ConfigurableListableBeanFactory</span> <span class="n">beanFactory</span> <span class="o">=</span> <span class="n">obtainFreshBeanFactory</span><span class="o">();</span>

      <span class="c1">// è®¾ç½® BeanFactory çš„ç±»åŠ è½½å™¨ï¼Œæ·»åŠ å‡ ä¸ª BeanPostProcessorï¼Œæ‰‹åŠ¨æ³¨å†Œå‡ ä¸ªç‰¹æ®Šçš„ bean</span>
      <span class="c1">// è¿™å—å¾…ä¼šä¼šå±•å¼€è¯´</span>
      <span class="n">prepareBeanFactory</span><span class="o">(</span><span class="n">beanFactory</span><span class="o">);</span>

      <span class="k">try</span> <span class="o">{</span>
         <span class="c1">// ã€è¿™é‡Œéœ€è¦çŸ¥é“ BeanFactoryPostProcessor è¿™ä¸ªçŸ¥è¯†ç‚¹ï¼ŒBean å¦‚æœå®ç°äº†æ­¤æ¥å£ï¼Œ</span>
         <span class="c1">// é‚£ä¹ˆåœ¨å®¹å™¨åˆå§‹åŒ–ä»¥åï¼ŒSpring ä¼šè´Ÿè´£è°ƒç”¨é‡Œé¢çš„ postProcessBeanFactory æ–¹æ³•ã€‚ã€‘</span>
        
         <span class="c1">// è¿™é‡Œæ˜¯æä¾›ç»™å­ç±»çš„æ‰©å±•ç‚¹ï¼Œåˆ°è¿™é‡Œçš„æ—¶å€™ï¼Œæ‰€æœ‰çš„ Bean éƒ½åŠ è½½ã€æ³¨å†Œå®Œæˆäº†ï¼Œä½†æ˜¯éƒ½è¿˜æ²¡æœ‰åˆå§‹åŒ–</span>
         <span class="c1">// å…·ä½“çš„å­ç±»å¯ä»¥åœ¨è¿™æ­¥çš„æ—¶å€™æ·»åŠ ä¸€äº›ç‰¹æ®Šçš„ BeanFactoryPostProcessor çš„å®ç°ç±»æˆ–åšç‚¹ä»€ä¹ˆäº‹</span>
         <span class="n">postProcessBeanFactory</span><span class="o">(</span><span class="n">beanFactory</span><span class="o">);</span>
         <span class="c1">// è°ƒç”¨ BeanFactoryPostProcessor å„ä¸ªå®ç°ç±»çš„ postProcessBeanFactory(factory) å›è°ƒæ–¹æ³•</span>
         <span class="n">invokeBeanFactoryPostProcessors</span><span class="o">(</span><span class="n">beanFactory</span><span class="o">);</span>          
         
          

         <span class="c1">// æ³¨å†Œ BeanPostProcessor çš„å®ç°ç±»ï¼Œæ³¨æ„çœ‹å’Œ BeanFactoryPostProcessor çš„åŒºåˆ«</span>
         <span class="c1">// æ­¤æ¥å£ä¸¤ä¸ªæ–¹æ³•: postProcessBeforeInitialization å’Œ postProcessAfterInitialization</span>
         <span class="c1">// ä¸¤ä¸ªæ–¹æ³•åˆ†åˆ«åœ¨ Bean åˆå§‹åŒ–ä¹‹å‰å’Œåˆå§‹åŒ–ä¹‹åå¾—åˆ°æ‰§è¡Œã€‚è¿™é‡Œä»…ä»…æ˜¯æ³¨å†Œï¼Œä¹‹åä¼šçœ‹åˆ°å›è°ƒè¿™ä¸¤æ–¹æ³•çš„æ—¶æœº</span>
         <span class="n">registerBeanPostProcessors</span><span class="o">(</span><span class="n">beanFactory</span><span class="o">);</span>

         <span class="c1">// åˆå§‹åŒ–å½“å‰ ApplicationContext çš„ MessageSourceï¼Œå›½é™…åŒ–è¿™é‡Œå°±ä¸å±•å¼€è¯´äº†ï¼Œä¸ç„¶æ²¡å®Œæ²¡äº†äº†</span>
         <span class="n">initMessageSource</span><span class="o">();</span>

         <span class="c1">// åˆå§‹åŒ–å½“å‰ ApplicationContext çš„äº‹ä»¶å¹¿æ’­å™¨ï¼Œè¿™é‡Œä¹Ÿä¸å±•å¼€äº†</span>
         <span class="n">initApplicationEventMulticaster</span><span class="o">();</span>

         <span class="c1">// ä»æ–¹æ³•åå°±å¯ä»¥çŸ¥é“ï¼Œå…¸å‹çš„æ¨¡æ¿æ–¹æ³•(é’©å­æ–¹æ³•)ï¼Œä¸å±•å¼€è¯´</span>
         <span class="c1">// å…·ä½“çš„å­ç±»å¯ä»¥åœ¨è¿™é‡Œåˆå§‹åŒ–ä¸€äº›ç‰¹æ®Šçš„ Beanï¼ˆåœ¨åˆå§‹åŒ– singleton beans ä¹‹å‰ï¼‰</span>
         <span class="n">onRefresh</span><span class="o">();</span>

         <span class="c1">// æ³¨å†Œäº‹ä»¶ç›‘å¬å™¨ï¼Œç›‘å¬å™¨éœ€è¦å®ç° ApplicationListener æ¥å£ã€‚è¿™ä¹Ÿä¸æ˜¯æˆ‘ä»¬çš„é‡ç‚¹ï¼Œè¿‡</span>
         <span class="n">registerListeners</span><span class="o">();</span>

         <span class="c1">// é‡ç‚¹ï¼Œé‡ç‚¹ï¼Œé‡ç‚¹</span>
         <span class="c1">// åˆå§‹åŒ–æ‰€æœ‰çš„ singleton beans</span>
         <span class="c1">//ï¼ˆlazy-init çš„é™¤å¤–ï¼‰</span>
         <span class="n">finishBeanFactoryInitialization</span><span class="o">(</span><span class="n">beanFactory</span><span class="o">);</span>

         <span class="c1">// æœ€åï¼Œå¹¿æ’­äº‹ä»¶ï¼ŒApplicationContext åˆå§‹åŒ–å®Œæˆï¼Œä¸å±•å¼€</span>
         <span class="n">finishRefresh</span><span class="o">();</span>
      <span class="o">}</span>

      <span class="k">catch</span> <span class="o">(</span><span class="nc">BeansException</span> <span class="n">ex</span><span class="o">)</span> <span class="o">{</span>
         <span class="k">if</span> <span class="o">(</span><span class="n">logger</span><span class="o">.</span><span class="na">isWarnEnabled</span><span class="o">())</span> <span class="o">{</span>
            <span class="n">logger</span><span class="o">.</span><span class="na">warn</span><span class="o">(</span><span class="s">"Exception encountered during context initialization - "</span> <span class="o">+</span>
                  <span class="s">"cancelling refresh attempt: "</span> <span class="o">+</span> <span class="n">ex</span><span class="o">);</span>
         <span class="o">}</span>

         <span class="c1">// Destroy already created singletons to avoid dangling resources.</span>
         <span class="c1">// é”€æ¯å·²ç»åˆå§‹åŒ–çš„ singleton çš„ Beansï¼Œä»¥å…æœ‰äº› bean ä¼šä¸€ç›´å ç”¨èµ„æº</span>
         <span class="n">destroyBeans</span><span class="o">();</span>

         <span class="c1">// Reset 'active' flag.</span>
         <span class="n">cancelRefresh</span><span class="o">(</span><span class="n">ex</span><span class="o">);</span>

         <span class="c1">// æŠŠå¼‚å¸¸å¾€å¤–æŠ›</span>
         <span class="k">throw</span> <span class="n">ex</span><span class="o">;</span>
      <span class="o">}</span>

      <span class="k">finally</span> <span class="o">{</span>
         <span class="c1">// Reset common introspection caches in Spring's core, since we</span>
         <span class="c1">// might not ever need metadata for singleton beans anymore...</span>
         <span class="n">resetCommonCaches</span><span class="o">();</span>
      <span class="o">}</span>
   <span class="o">}</span>
<span class="o">}</span>
</pre></td></tr></tbody></table></code></pre></div></div>
<h3 id="å‡†å¤‡-bean-å®¹å™¨-preparebeanfactory">å‡†å¤‡ Bean å®¹å™¨: prepareBeanFactory</h3>

<p>ä¹‹å‰æˆ‘ä»¬è¯´è¿‡ï¼ŒSpring æŠŠæˆ‘ä»¬åœ¨ xml é…ç½®çš„ bean éƒ½æ³¨å†Œä»¥åï¼Œä¼šâ€æ‰‹åŠ¨â€æ³¨å†Œä¸€äº›ç‰¹æ®Šçš„ beanã€‚</p>

<p>è¿™é‡Œç®€å•ä»‹ç»ä¸‹ prepareBeanFactory(factory) æ–¹æ³•ï¼š</p>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
44
45
46
47
48
49
50
51
52
53
54
55
56
57
58
59
60
61
62
63
64
65
66
67
68
69
70
71
72
73
74
</pre></td><td class="rouge-code"><pre><span class="cm">/**
 * Configure the factory's standard context characteristics,
 * such as the context's ClassLoader and post-processors.
 * @param beanFactory the BeanFactory to configure
 */</span>
<span class="kd">protected</span> <span class="kt">void</span> <span class="nf">prepareBeanFactory</span><span class="o">(</span><span class="nc">ConfigurableListableBeanFactory</span> <span class="n">beanFactory</span><span class="o">)</span> <span class="o">{</span>
   <span class="c1">// è®¾ç½® BeanFactory çš„ç±»åŠ è½½å™¨ï¼Œæˆ‘ä»¬çŸ¥é“ BeanFactory éœ€è¦åŠ è½½ç±»ï¼Œä¹Ÿå°±éœ€è¦ç±»åŠ è½½å™¨ï¼Œ</span>
   <span class="c1">// è¿™é‡Œè®¾ç½®ä¸ºåŠ è½½å½“å‰ ApplicationContext ç±»çš„ç±»åŠ è½½å™¨</span>
   <span class="n">beanFactory</span><span class="o">.</span><span class="na">setBeanClassLoader</span><span class="o">(</span><span class="n">getClassLoader</span><span class="o">());</span>
    
   <span class="c1">// è®¾ç½® BeanExpressionResolver</span>
   <span class="n">beanFactory</span><span class="o">.</span><span class="na">setBeanExpressionResolver</span><span class="o">(</span><span class="k">new</span> <span class="nc">StandardBeanExpressionResolver</span><span class="o">(</span><span class="n">beanFactory</span><span class="o">.</span><span class="na">getBeanClassLoader</span><span class="o">()));</span>
   <span class="c1">// </span>
   <span class="n">beanFactory</span><span class="o">.</span><span class="na">addPropertyEditorRegistrar</span><span class="o">(</span><span class="k">new</span> <span class="nc">ResourceEditorRegistrar</span><span class="o">(</span><span class="k">this</span><span class="o">,</span> <span class="n">getEnvironment</span><span class="o">()));</span>

   <span class="c1">// æ·»åŠ ä¸€ä¸ª BeanPostProcessorï¼Œè¿™ä¸ª processor æ¯”è¾ƒç®€å•ï¼š</span>
   <span class="c1">// å®ç°äº† Aware æ¥å£çš„ beans åœ¨åˆå§‹åŒ–çš„æ—¶å€™ï¼Œè¿™ä¸ª processor è´Ÿè´£å›è°ƒï¼Œ</span>
   <span class="c1">// è¿™ä¸ªæˆ‘ä»¬å¾ˆå¸¸ç”¨ï¼Œå¦‚æˆ‘ä»¬ä¼šä¸ºäº†è·å– ApplicationContext è€Œ implement ApplicationContextAware</span>
   <span class="c1">// æ³¨æ„ï¼šå®ƒä¸ä»…ä»…å›è°ƒ ApplicationContextAwareï¼Œ</span>
   <span class="c1">//   è¿˜ä¼šè´Ÿè´£å›è°ƒ EnvironmentAwareã€ResourceLoaderAware ç­‰ï¼Œçœ‹ä¸‹æºç å°±æ¸…æ¥šäº†</span>
   <span class="n">beanFactory</span><span class="o">.</span><span class="na">addBeanPostProcessor</span><span class="o">(</span><span class="k">new</span> <span class="nc">ApplicationContextAwareProcessor</span><span class="o">(</span><span class="k">this</span><span class="o">));</span>
  
   <span class="c1">// ä¸‹é¢å‡ è¡Œçš„æ„æ€å°±æ˜¯ï¼Œå¦‚æœæŸä¸ª bean ä¾èµ–äºä»¥ä¸‹å‡ ä¸ªæ¥å£çš„å®ç°ç±»ï¼Œåœ¨è‡ªåŠ¨è£…é…çš„æ—¶å€™å¿½ç•¥å®ƒä»¬ï¼Œ</span>
   <span class="c1">// Spring ä¼šé€šè¿‡å…¶ä»–æ–¹å¼æ¥å¤„ç†è¿™äº›ä¾èµ–ã€‚</span>
   <span class="n">beanFactory</span><span class="o">.</span><span class="na">ignoreDependencyInterface</span><span class="o">(</span><span class="nc">EnvironmentAware</span><span class="o">.</span><span class="na">class</span><span class="o">);</span>
   <span class="n">beanFactory</span><span class="o">.</span><span class="na">ignoreDependencyInterface</span><span class="o">(</span><span class="nc">EmbeddedValueResolverAware</span><span class="o">.</span><span class="na">class</span><span class="o">);</span>
   <span class="n">beanFactory</span><span class="o">.</span><span class="na">ignoreDependencyInterface</span><span class="o">(</span><span class="nc">ResourceLoaderAware</span><span class="o">.</span><span class="na">class</span><span class="o">);</span>
   <span class="n">beanFactory</span><span class="o">.</span><span class="na">ignoreDependencyInterface</span><span class="o">(</span><span class="nc">ApplicationEventPublisherAware</span><span class="o">.</span><span class="na">class</span><span class="o">);</span>
   <span class="n">beanFactory</span><span class="o">.</span><span class="na">ignoreDependencyInterface</span><span class="o">(</span><span class="nc">MessageSourceAware</span><span class="o">.</span><span class="na">class</span><span class="o">);</span>
   <span class="n">beanFactory</span><span class="o">.</span><span class="na">ignoreDependencyInterface</span><span class="o">(</span><span class="nc">ApplicationContextAware</span><span class="o">.</span><span class="na">class</span><span class="o">);</span>

   <span class="cm">/**
    * ä¸‹é¢å‡ è¡Œå°±æ˜¯ä¸ºç‰¹æ®Šçš„å‡ ä¸ª bean èµ‹å€¼ï¼Œå¦‚æœæœ‰ bean ä¾èµ–äº†ä»¥ä¸‹å‡ ä¸ªï¼Œä¼šæ³¨å…¥è¿™è¾¹ç›¸åº”çš„å€¼ï¼Œ
    * ä¹‹å‰æˆ‘ä»¬è¯´è¿‡ï¼Œ"å½“å‰ ApplicationContext æŒæœ‰ä¸€ä¸ª BeanFactory"ï¼Œè¿™é‡Œè§£é‡Šäº†ç¬¬ä¸€è¡Œ
    * ApplicationContext è¿˜ç»§æ‰¿äº† ResourceLoaderã€ApplicationEventPublisherã€MessageSource
    * æ‰€ä»¥å¯¹äºè¿™å‡ ä¸ªä¾èµ–ï¼Œå¯ä»¥èµ‹å€¼ä¸º thisï¼Œæ³¨æ„ this æ˜¯ä¸€ä¸ª ApplicationContext
    * é‚£è¿™é‡Œæ€ä¹ˆæ²¡çœ‹åˆ°ä¸º MessageSource èµ‹å€¼å‘¢ï¼Ÿé‚£æ˜¯å› ä¸º MessageSource è¢«æ³¨å†Œæˆä¸ºäº†ä¸€ä¸ªæ™®é€šçš„ bean
    */</span>
   <span class="n">beanFactory</span><span class="o">.</span><span class="na">registerResolvableDependency</span><span class="o">(</span><span class="nc">BeanFactory</span><span class="o">.</span><span class="na">class</span><span class="o">,</span> <span class="n">beanFactory</span><span class="o">);</span>
   <span class="n">beanFactory</span><span class="o">.</span><span class="na">registerResolvableDependency</span><span class="o">(</span><span class="nc">ResourceLoader</span><span class="o">.</span><span class="na">class</span><span class="o">,</span> <span class="k">this</span><span class="o">);</span>
   <span class="n">beanFactory</span><span class="o">.</span><span class="na">registerResolvableDependency</span><span class="o">(</span><span class="nc">ApplicationEventPublisher</span><span class="o">.</span><span class="na">class</span><span class="o">,</span> <span class="k">this</span><span class="o">);</span>
   <span class="n">beanFactory</span><span class="o">.</span><span class="na">registerResolvableDependency</span><span class="o">(</span><span class="nc">ApplicationContext</span><span class="o">.</span><span class="na">class</span><span class="o">,</span> <span class="k">this</span><span class="o">);</span>

   <span class="c1">// è¿™ä¸ª BeanPostProcessor ä¹Ÿå¾ˆç®€å•ï¼Œåœ¨ bean å®ä¾‹åŒ–åï¼Œå¦‚æœæ˜¯ ApplicationListener çš„å­ç±»ï¼Œ</span>
   <span class="c1">// é‚£ä¹ˆå°†å…¶æ·»åŠ åˆ° listener åˆ—è¡¨ä¸­ï¼Œå¯ä»¥ç†è§£æˆï¼šæ³¨å†Œ äº‹ä»¶ç›‘å¬å™¨</span>
   <span class="n">beanFactory</span><span class="o">.</span><span class="na">addBeanPostProcessor</span><span class="o">(</span><span class="k">new</span> <span class="nc">ApplicationListenerDetector</span><span class="o">(</span><span class="k">this</span><span class="o">));</span>

   <span class="c1">// è¿™é‡Œæ¶‰åŠåˆ°ç‰¹æ®Šçš„ beanï¼Œåä¸ºï¼šloadTimeWeaverï¼Œè¿™ä¸æ˜¯æˆ‘ä»¬çš„é‡ç‚¹ï¼Œå¿½ç•¥å®ƒ</span>
   <span class="c1">// tips: ltw æ˜¯ AspectJ çš„æ¦‚å¿µï¼ŒæŒ‡çš„æ˜¯åœ¨è¿è¡ŒæœŸè¿›è¡Œç»‡å…¥ï¼Œè¿™ä¸ªå’Œ Spring AOP ä¸ä¸€æ ·ï¼Œ</span>
   <span class="c1">//    æ„Ÿå…´è¶£çš„è¯»è€…è¯·å‚è€ƒæˆ‘å†™çš„å…³äº AspectJ çš„å¦ä¸€ç¯‡æ–‡ç«  https://www.javadoop.com/post/aspectj</span>
   <span class="k">if</span> <span class="o">(</span><span class="n">beanFactory</span><span class="o">.</span><span class="na">containsBean</span><span class="o">(</span><span class="no">LOAD_TIME_WEAVER_BEAN_NAME</span><span class="o">))</span> <span class="o">{</span>
      <span class="n">beanFactory</span><span class="o">.</span><span class="na">addBeanPostProcessor</span><span class="o">(</span><span class="k">new</span> <span class="nc">LoadTimeWeaverAwareProcessor</span><span class="o">(</span><span class="n">beanFactory</span><span class="o">));</span>
      <span class="c1">// Set a temporary ClassLoader for type matching.</span>
      <span class="n">beanFactory</span><span class="o">.</span><span class="na">setTempClassLoader</span><span class="o">(</span><span class="k">new</span> <span class="nc">ContextTypeMatchClassLoader</span><span class="o">(</span><span class="n">beanFactory</span><span class="o">.</span><span class="na">getBeanClassLoader</span><span class="o">()));</span>
   <span class="o">}</span>

   <span class="cm">/**
    * ä»ä¸‹é¢å‡ è¡Œä»£ç æˆ‘ä»¬å¯ä»¥çŸ¥é“ï¼ŒSpring å¾€å¾€å¾ˆ "æ™ºèƒ½" å°±æ˜¯å› ä¸ºå®ƒä¼šå¸®æˆ‘ä»¬é»˜è®¤æ³¨å†Œä¸€äº›æœ‰ç”¨çš„ beanï¼Œ
    * æˆ‘ä»¬ä¹Ÿå¯ä»¥é€‰æ‹©è¦†ç›–
    */</span>
  
   <span class="c1">// å¦‚æœæ²¡æœ‰å®šä¹‰ "environment" è¿™ä¸ª beanï¼Œé‚£ä¹ˆ Spring ä¼š "æ‰‹åŠ¨" æ³¨å†Œä¸€ä¸ª</span>
   <span class="k">if</span> <span class="o">(!</span><span class="n">beanFactory</span><span class="o">.</span><span class="na">containsLocalBean</span><span class="o">(</span><span class="no">ENVIRONMENT_BEAN_NAME</span><span class="o">))</span> <span class="o">{</span>
      <span class="n">beanFactory</span><span class="o">.</span><span class="na">registerSingleton</span><span class="o">(</span><span class="no">ENVIRONMENT_BEAN_NAME</span><span class="o">,</span> <span class="n">getEnvironment</span><span class="o">());</span>
   <span class="o">}</span>
   <span class="c1">// å¦‚æœæ²¡æœ‰å®šä¹‰ "systemProperties" è¿™ä¸ª beanï¼Œé‚£ä¹ˆ Spring ä¼š "æ‰‹åŠ¨" æ³¨å†Œä¸€ä¸ª</span>
   <span class="k">if</span> <span class="o">(!</span><span class="n">beanFactory</span><span class="o">.</span><span class="na">containsLocalBean</span><span class="o">(</span><span class="no">SYSTEM_PROPERTIES_BEAN_NAME</span><span class="o">))</span> <span class="o">{</span>
      <span class="n">beanFactory</span><span class="o">.</span><span class="na">registerSingleton</span><span class="o">(</span><span class="no">SYSTEM_PROPERTIES_BEAN_NAME</span><span class="o">,</span> <span class="n">getEnvironment</span><span class="o">().</span><span class="na">getSystemProperties</span><span class="o">());</span>
   <span class="o">}</span>
   <span class="c1">// å¦‚æœæ²¡æœ‰å®šä¹‰ "systemEnvironment" è¿™ä¸ª beanï¼Œé‚£ä¹ˆ Spring ä¼š "æ‰‹åŠ¨" æ³¨å†Œä¸€ä¸ª</span>
   <span class="k">if</span> <span class="o">(!</span><span class="n">beanFactory</span><span class="o">.</span><span class="na">containsLocalBean</span><span class="o">(</span><span class="no">SYSTEM_ENVIRONMENT_BEAN_NAME</span><span class="o">))</span> <span class="o">{</span>
      <span class="n">beanFactory</span><span class="o">.</span><span class="na">registerSingleton</span><span class="o">(</span><span class="no">SYSTEM_ENVIRONMENT_BEAN_NAME</span><span class="o">,</span> <span class="n">getEnvironment</span><span class="o">().</span><span class="na">getSystemEnvironment</span><span class="o">());</span>
   <span class="o">}</span>
<span class="o">}</span>
</pre></td></tr></tbody></table></code></pre></div></div>

<p>åœ¨ä¸Šé¢è¿™å—ä»£ç ä¸­ï¼ŒSpring å¯¹ä¸€äº›ç‰¹æ®Šçš„ bean è¿›è¡Œäº†å¤„ç†ï¼Œè¯»è€…å¦‚æœæš‚æ—¶è¿˜ä¸èƒ½æ¶ˆåŒ–å®ƒä»¬ä¹Ÿæ²¡æœ‰å…³ç³»ï¼Œæ…¢æ…¢å¾€ä¸‹çœ‹ã€‚</p>

<h3 id="åˆå§‹åŒ–æ‰€æœ‰çš„-singleton-beans">åˆå§‹åŒ–æ‰€æœ‰çš„ singleton beans</h3>

<p>æˆ‘ä»¬çš„é‡ç‚¹å½“ç„¶æ˜¯ finishBeanFactoryInitialization(beanFactory); è¿™ä¸ªå·¨å¤´äº†ï¼Œè¿™é‡Œä¼šè´Ÿè´£åˆå§‹åŒ–æ‰€æœ‰çš„ singleton beansã€‚</p>

<p>æ³¨æ„ï¼Œåé¢çš„æè¿°ä¸­ï¼Œæˆ‘éƒ½ä¼šä½¿ç”¨<strong>åˆå§‹åŒ–</strong>æˆ–<strong>é¢„åˆå§‹åŒ–</strong>æ¥ä»£è¡¨è¿™ä¸ªé˜¶æ®µï¼ŒSpring ä¼šåœ¨è¿™ä¸ªé˜¶æ®µå®Œæˆæ‰€æœ‰çš„ singleton beans çš„å®ä¾‹åŒ–ã€‚</p>

<p>æˆ‘ä»¬æ¥æ€»ç»“ä¸€ä¸‹ï¼Œåˆ°ç›®å‰ä¸ºæ­¢ï¼Œåº”è¯¥è¯´ BeanFactory å·²ç»åˆ›å»ºå®Œæˆï¼Œå¹¶ä¸”æ‰€æœ‰çš„å®ç°äº† BeanFactoryPostProcessor æ¥å£çš„ Bean éƒ½å·²ç»åˆå§‹åŒ–å¹¶ä¸”å…¶ä¸­çš„ postProcessBeanFactory(factory) æ–¹æ³•å·²ç»å¾—åˆ°å›è°ƒæ‰§è¡Œäº†ã€‚è€Œä¸” Spring å·²ç»â€œæ‰‹åŠ¨â€æ³¨å†Œäº†ä¸€äº›ç‰¹æ®Šçš„ Beanï¼Œå¦‚ â€˜environmentâ€™ã€â€˜systemPropertiesâ€™ ç­‰ã€‚</p>

<p>å‰©ä¸‹çš„å°±æ˜¯åˆå§‹åŒ– singleton beans äº†ï¼Œæˆ‘ä»¬çŸ¥é“å®ƒä»¬æ˜¯å•ä¾‹çš„ï¼Œå¦‚æœæ²¡æœ‰è®¾ç½®æ‡’åŠ è½½ï¼Œé‚£ä¹ˆ Spring ä¼šåœ¨æ¥ä¸‹æ¥åˆå§‹åŒ–æ‰€æœ‰çš„ singleton beansã€‚</p>

<p>// AbstractApplicationContext.java 834</p>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
</pre></td><td class="rouge-code"><pre><span class="c1">// åˆå§‹åŒ–å‰©ä½™çš„ singleton beans</span>
<span class="kd">protected</span> <span class="kt">void</span> <span class="nf">finishBeanFactoryInitialization</span><span class="o">(</span><span class="nc">ConfigurableListableBeanFactory</span> <span class="n">beanFactory</span><span class="o">)</span> <span class="o">{</span>

   <span class="c1">// é¦–å…ˆï¼Œåˆå§‹åŒ–åå­—ä¸º conversionService çš„ Beanã€‚æœ¬ç€é€ä½›é€åˆ°è¥¿çš„ç²¾ç¥ï¼Œæˆ‘åœ¨é™„å½•ä¸­ç®€å•ä»‹ç»äº†ä¸€ä¸‹ ConversionServiceï¼Œå› ä¸ºè¿™å®åœ¨å¤ªå®ç”¨äº†</span>
   <span class="c1">// ä»€ä¹ˆï¼Œçœ‹ä»£ç è¿™é‡Œæ²¡æœ‰åˆå§‹åŒ– Bean å•Šï¼</span>
   <span class="c1">// æ³¨æ„äº†ï¼Œåˆå§‹åŒ–çš„åŠ¨ä½œåŒ…è£…åœ¨ beanFactory.getBean(...) ä¸­ï¼Œè¿™é‡Œå…ˆä¸è¯´ç»†èŠ‚ï¼Œå…ˆå¾€ä¸‹çœ‹å§</span>
   <span class="k">if</span> <span class="o">(</span><span class="n">beanFactory</span><span class="o">.</span><span class="na">containsBean</span><span class="o">(</span><span class="no">CONVERSION_SERVICE_BEAN_NAME</span><span class="o">)</span> <span class="o">&amp;&amp;</span>
         <span class="n">beanFactory</span><span class="o">.</span><span class="na">isTypeMatch</span><span class="o">(</span><span class="no">CONVERSION_SERVICE_BEAN_NAME</span><span class="o">,</span> <span class="nc">ConversionService</span><span class="o">.</span><span class="na">class</span><span class="o">))</span> <span class="o">{</span>
      <span class="n">beanFactory</span><span class="o">.</span><span class="na">setConversionService</span><span class="o">(</span>
            <span class="n">beanFactory</span><span class="o">.</span><span class="na">getBean</span><span class="o">(</span><span class="no">CONVERSION_SERVICE_BEAN_NAME</span><span class="o">,</span> <span class="nc">ConversionService</span><span class="o">.</span><span class="na">class</span><span class="o">));</span>
   <span class="o">}</span>

   <span class="c1">// Register a default embedded value resolver if no bean post-processor</span>
   <span class="c1">// (such as a PropertyPlaceholderConfigurer bean) registered any before:</span>
   <span class="c1">// at this point, primarily for resolution in annotation attribute values.</span>
   <span class="k">if</span> <span class="o">(!</span><span class="n">beanFactory</span><span class="o">.</span><span class="na">hasEmbeddedValueResolver</span><span class="o">())</span> <span class="o">{</span>
      <span class="n">beanFactory</span><span class="o">.</span><span class="na">addEmbeddedValueResolver</span><span class="o">(</span><span class="k">new</span> <span class="nc">StringValueResolver</span><span class="o">()</span> <span class="o">{</span>
         <span class="nd">@Override</span>
         <span class="kd">public</span> <span class="nc">String</span> <span class="nf">resolveStringValue</span><span class="o">(</span><span class="nc">String</span> <span class="n">strVal</span><span class="o">)</span> <span class="o">{</span>
            <span class="k">return</span> <span class="nf">getEnvironment</span><span class="o">().</span><span class="na">resolvePlaceholders</span><span class="o">(</span><span class="n">strVal</span><span class="o">);</span>
         <span class="o">}</span>
      <span class="o">});</span>
   <span class="o">}</span>

   <span class="c1">// å…ˆåˆå§‹åŒ– LoadTimeWeaverAware ç±»å‹çš„ Bean</span>
   <span class="c1">// ä¹‹å‰ä¹Ÿè¯´è¿‡ï¼Œè¿™æ˜¯ AspectJ ç›¸å…³çš„å†…å®¹ï¼Œæ”¾å¿ƒè·³è¿‡å§</span>
   <span class="nc">String</span><span class="o">[]</span> <span class="n">weaverAwareNames</span> <span class="o">=</span> <span class="n">beanFactory</span><span class="o">.</span><span class="na">getBeanNamesForType</span><span class="o">(</span><span class="nc">LoadTimeWeaverAware</span><span class="o">.</span><span class="na">class</span><span class="o">,</span> <span class="kc">false</span><span class="o">,</span> <span class="kc">false</span><span class="o">);</span>
   <span class="k">for</span> <span class="o">(</span><span class="nc">String</span> <span class="n">weaverAwareName</span> <span class="o">:</span> <span class="n">weaverAwareNames</span><span class="o">)</span> <span class="o">{</span>
      <span class="n">getBean</span><span class="o">(</span><span class="n">weaverAwareName</span><span class="o">);</span>
   <span class="o">}</span>

   <span class="c1">// Stop using the temporary ClassLoader for type matching.</span>
   <span class="n">beanFactory</span><span class="o">.</span><span class="na">setTempClassLoader</span><span class="o">(</span><span class="kc">null</span><span class="o">);</span>

   <span class="c1">// æ²¡ä»€ä¹ˆåˆ«çš„ç›®çš„ï¼Œå› ä¸ºåˆ°è¿™ä¸€æ­¥çš„æ—¶å€™ï¼ŒSpring å·²ç»å¼€å§‹é¢„åˆå§‹åŒ– singleton beans äº†ï¼Œ</span>
   <span class="c1">// è‚¯å®šä¸å¸Œæœ›è¿™ä¸ªæ—¶å€™è¿˜å‡ºç° bean å®šä¹‰è§£æã€åŠ è½½ã€æ³¨å†Œã€‚</span>
   <span class="n">beanFactory</span><span class="o">.</span><span class="na">freezeConfiguration</span><span class="o">();</span>

   <span class="c1">// å¼€å§‹åˆå§‹åŒ–</span>
   <span class="n">beanFactory</span><span class="o">.</span><span class="na">preInstantiateSingletons</span><span class="o">();</span>
<span class="o">}</span>
</pre></td></tr></tbody></table></code></pre></div></div>

<p>ä»ä¸Šé¢æœ€åä¸€è¡Œå¾€é‡Œçœ‹ï¼Œæˆ‘ä»¬å°±åˆå›åˆ° DefaultListableBeanFactory è¿™ä¸ªç±»äº†ï¼Œè¿™ä¸ªç±»å¤§å®¶åº”è¯¥éƒ½ä¸é™Œç”Ÿäº†å§ã€‚</p>

<h4 id="preinstantiatesingletons">preInstantiateSingletons</h4>

<p>// DefaultListableBeanFactory 728</p>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
44
45
46
47
48
49
50
51
52
53
54
55
56
57
58
59
60
61
62
63
64
65
66
67
68
69
</pre></td><td class="rouge-code"><pre><span class="nd">@Override</span>
<span class="kd">public</span> <span class="kt">void</span> <span class="nf">preInstantiateSingletons</span><span class="o">()</span> <span class="kd">throws</span> <span class="nc">BeansException</span> <span class="o">{</span>
   <span class="k">if</span> <span class="o">(</span><span class="k">this</span><span class="o">.</span><span class="na">logger</span><span class="o">.</span><span class="na">isDebugEnabled</span><span class="o">())</span> <span class="o">{</span>
      <span class="k">this</span><span class="o">.</span><span class="na">logger</span><span class="o">.</span><span class="na">debug</span><span class="o">(</span><span class="s">"Pre-instantiating singletons in "</span> <span class="o">+</span> <span class="k">this</span><span class="o">);</span>
   <span class="o">}</span>
   <span class="c1">// this.beanDefinitionNames ä¿å­˜äº†æ‰€æœ‰çš„ beanNames</span>
   <span class="nc">List</span><span class="o">&lt;</span><span class="nc">String</span><span class="o">&gt;</span> <span class="n">beanNames</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">ArrayList</span><span class="o">&lt;</span><span class="nc">String</span><span class="o">&gt;(</span><span class="k">this</span><span class="o">.</span><span class="na">beanDefinitionNames</span><span class="o">);</span>

   <span class="c1">// è§¦å‘æ‰€æœ‰çš„éæ‡’åŠ è½½çš„ singleton beans çš„åˆå§‹åŒ–æ“ä½œ</span>
   <span class="k">for</span> <span class="o">(</span><span class="nc">String</span> <span class="n">beanName</span> <span class="o">:</span> <span class="n">beanNames</span><span class="o">)</span> <span class="o">{</span>
     
      <span class="c1">// åˆå¹¶çˆ¶ Bean ä¸­çš„é…ç½®ï¼Œæ³¨æ„ &lt;bean id="" class="" parent="" /&gt; ä¸­çš„ parentï¼Œç”¨çš„ä¸å¤šå§ï¼Œ</span>
      <span class="c1">// è€ƒè™‘åˆ°è¿™å¯èƒ½ä¼šå½±å“å¤§å®¶çš„ç†è§£ï¼Œæˆ‘åœ¨é™„å½•ä¸­è§£é‡Šäº†ä¸€ä¸‹ "Bean ç»§æ‰¿"ï¼Œä¸äº†è§£çš„è¯·åˆ°é™„å½•ä¸­çœ‹ä¸€ä¸‹</span>
      <span class="nc">RootBeanDefinition</span> <span class="n">bd</span> <span class="o">=</span> <span class="n">getMergedLocalBeanDefinition</span><span class="o">(</span><span class="n">beanName</span><span class="o">);</span>
     
      <span class="c1">// éæŠ½è±¡ã€éæ‡’åŠ è½½çš„ singletonsã€‚å¦‚æœé…ç½®äº† 'abstract = true'ï¼Œé‚£æ˜¯ä¸éœ€è¦åˆå§‹åŒ–çš„</span>
      <span class="k">if</span> <span class="o">(!</span><span class="n">bd</span><span class="o">.</span><span class="na">isAbstract</span><span class="o">()</span> <span class="o">&amp;&amp;</span> <span class="n">bd</span><span class="o">.</span><span class="na">isSingleton</span><span class="o">()</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="n">bd</span><span class="o">.</span><span class="na">isLazyInit</span><span class="o">())</span> <span class="o">{</span>
         <span class="c1">// å¤„ç† FactoryBean(è¯»è€…å¦‚æœä¸ç†Ÿæ‚‰ FactoryBeanï¼Œè¯·ç§»æ­¥é™„å½•åŒºäº†è§£)</span>
         <span class="k">if</span> <span class="o">(</span><span class="n">isFactoryBean</span><span class="o">(</span><span class="n">beanName</span><span class="o">))</span> <span class="o">{</span>
            <span class="c1">// FactoryBean çš„è¯ï¼Œåœ¨ beanName å‰é¢åŠ ä¸Š â€˜&amp;â€™ ç¬¦å·ã€‚å†è°ƒç”¨ getBeanï¼ŒgetBean æ–¹æ³•åˆ«æ€¥</span>
            <span class="kd">final</span> <span class="nc">FactoryBean</span><span class="o">&lt;?&gt;</span> <span class="n">factory</span> <span class="o">=</span> <span class="o">(</span><span class="nc">FactoryBean</span><span class="o">&lt;?&gt;)</span> <span class="n">getBean</span><span class="o">(</span><span class="no">FACTORY_BEAN_PREFIX</span> <span class="o">+</span> <span class="n">beanName</span><span class="o">);</span>
            <span class="c1">// åˆ¤æ–­å½“å‰ FactoryBean æ˜¯å¦æ˜¯ SmartFactoryBean çš„å®ç°ï¼Œæ­¤å¤„å¿½ç•¥ï¼Œç›´æ¥è·³è¿‡</span>
            <span class="kt">boolean</span> <span class="n">isEagerInit</span><span class="o">;</span>
            <span class="k">if</span> <span class="o">(</span><span class="nc">System</span><span class="o">.</span><span class="na">getSecurityManager</span><span class="o">()</span> <span class="o">!=</span> <span class="kc">null</span> <span class="o">&amp;&amp;</span> <span class="n">factory</span> <span class="k">instanceof</span> <span class="nc">SmartFactoryBean</span><span class="o">)</span> <span class="o">{</span>
               <span class="n">isEagerInit</span> <span class="o">=</span> <span class="nc">AccessController</span><span class="o">.</span><span class="na">doPrivileged</span><span class="o">(</span><span class="k">new</span> <span class="nc">PrivilegedAction</span><span class="o">&lt;</span><span class="nc">Boolean</span><span class="o">&gt;()</span> <span class="o">{</span>
                  <span class="nd">@Override</span>
                  <span class="kd">public</span> <span class="nc">Boolean</span> <span class="nf">run</span><span class="o">()</span> <span class="o">{</span>
                     <span class="k">return</span> <span class="o">((</span><span class="nc">SmartFactoryBean</span><span class="o">&lt;?&gt;)</span> <span class="n">factory</span><span class="o">).</span><span class="na">isEagerInit</span><span class="o">();</span>
                  <span class="o">}</span>
               <span class="o">},</span> <span class="n">getAccessControlContext</span><span class="o">());</span>
            <span class="o">}</span>
            <span class="k">else</span> <span class="o">{</span>
               <span class="n">isEagerInit</span> <span class="o">=</span> <span class="o">(</span><span class="n">factory</span> <span class="k">instanceof</span> <span class="nc">SmartFactoryBean</span> <span class="o">&amp;&amp;</span>
                     <span class="o">((</span><span class="nc">SmartFactoryBean</span><span class="o">&lt;?&gt;)</span> <span class="n">factory</span><span class="o">).</span><span class="na">isEagerInit</span><span class="o">());</span>
            <span class="o">}</span>
            <span class="k">if</span> <span class="o">(</span><span class="n">isEagerInit</span><span class="o">)</span> <span class="o">{</span>
               
               <span class="n">getBean</span><span class="o">(</span><span class="n">beanName</span><span class="o">);</span>
            <span class="o">}</span>
         <span class="o">}</span>
         <span class="k">else</span> <span class="o">{</span>
            <span class="c1">// å¯¹äºæ™®é€šçš„ Beanï¼Œåªè¦è°ƒç”¨ getBean(beanName) è¿™ä¸ªæ–¹æ³•å°±å¯ä»¥è¿›è¡Œåˆå§‹åŒ–äº†</span>
            <span class="n">getBean</span><span class="o">(</span><span class="n">beanName</span><span class="o">);</span>
         <span class="o">}</span>
      <span class="o">}</span>
   <span class="o">}</span>

  
   <span class="c1">// åˆ°è¿™é‡Œè¯´æ˜æ‰€æœ‰çš„éæ‡’åŠ è½½çš„ singleton beans å·²ç»å®Œæˆäº†åˆå§‹åŒ–</span>
   <span class="c1">// å¦‚æœæˆ‘ä»¬å®šä¹‰çš„ bean æ˜¯å®ç°äº† SmartInitializingSingleton æ¥å£çš„ï¼Œé‚£ä¹ˆåœ¨è¿™é‡Œå¾—åˆ°å›è°ƒï¼Œå¿½ç•¥</span>
   <span class="k">for</span> <span class="o">(</span><span class="nc">String</span> <span class="n">beanName</span> <span class="o">:</span> <span class="n">beanNames</span><span class="o">)</span> <span class="o">{</span>
      <span class="nc">Object</span> <span class="n">singletonInstance</span> <span class="o">=</span> <span class="n">getSingleton</span><span class="o">(</span><span class="n">beanName</span><span class="o">);</span>
      <span class="k">if</span> <span class="o">(</span><span class="n">singletonInstance</span> <span class="k">instanceof</span> <span class="nc">SmartInitializingSingleton</span><span class="o">)</span> <span class="o">{</span>
         <span class="kd">final</span> <span class="nc">SmartInitializingSingleton</span> <span class="n">smartSingleton</span> <span class="o">=</span> <span class="o">(</span><span class="nc">SmartInitializingSingleton</span><span class="o">)</span> <span class="n">singletonInstance</span><span class="o">;</span>
         <span class="k">if</span> <span class="o">(</span><span class="nc">System</span><span class="o">.</span><span class="na">getSecurityManager</span><span class="o">()</span> <span class="o">!=</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
            <span class="nc">AccessController</span><span class="o">.</span><span class="na">doPrivileged</span><span class="o">(</span><span class="k">new</span> <span class="nc">PrivilegedAction</span><span class="o">&lt;</span><span class="nc">Object</span><span class="o">&gt;()</span> <span class="o">{</span>
               <span class="nd">@Override</span>
               <span class="kd">public</span> <span class="nc">Object</span> <span class="nf">run</span><span class="o">()</span> <span class="o">{</span>
                  <span class="n">smartSingleton</span><span class="o">.</span><span class="na">afterSingletonsInstantiated</span><span class="o">();</span>
                  <span class="k">return</span> <span class="kc">null</span><span class="o">;</span>
               <span class="o">}</span>
            <span class="o">},</span> <span class="n">getAccessControlContext</span><span class="o">());</span>
         <span class="o">}</span>
         <span class="k">else</span> <span class="o">{</span>
            <span class="n">smartSingleton</span><span class="o">.</span><span class="na">afterSingletonsInstantiated</span><span class="o">();</span>
         <span class="o">}</span>
      <span class="o">}</span>
   <span class="o">}</span>
<span class="o">}</span>
</pre></td></tr></tbody></table></code></pre></div></div>

<p>æ¥ä¸‹æ¥ï¼Œæˆ‘ä»¬å°±è¿›å…¥åˆ° getBean(beanName) æ–¹æ³•äº†ï¼Œè¿™ä¸ªæ–¹æ³•æˆ‘ä»¬ç»å¸¸ç”¨æ¥ä» BeanFactory ä¸­è·å–ä¸€ä¸ª Beanï¼Œè€Œåˆå§‹åŒ–çš„è¿‡ç¨‹ä¹Ÿå°è£…åˆ°äº†è¿™ä¸ªæ–¹æ³•é‡Œã€‚</p>

<h4 id="getbean">getBean</h4>

<p>åœ¨ç»§ç»­å‰è¿›ä¹‹å‰ï¼Œè¯»è€…åº”è¯¥å…·å¤‡ FactoryBean çš„çŸ¥è¯†ï¼Œå¦‚æœè¯»è€…è¿˜ä¸ç†Ÿæ‚‰ï¼Œè¯·ç§»æ­¥é™„å½•éƒ¨åˆ†äº†è§£ FactoryBeanã€‚</p>

<p>// AbstractBeanFactory 196</p>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
44
45
46
47
48
49
50
51
52
53
54
55
56
57
58
59
60
61
62
63
64
65
66
67
68
69
70
71
72
73
74
75
76
77
78
79
80
81
82
83
84
85
86
87
88
89
90
91
92
93
94
95
96
97
98
99
100
101
102
103
104
105
106
107
108
109
110
111
112
113
114
115
116
117
118
119
120
121
122
123
124
125
126
127
128
129
130
131
132
133
134
135
136
137
138
139
140
141
142
143
144
145
146
147
148
149
150
151
152
153
154
155
156
157
158
159
160
161
162
163
164
165
166
167
168
169
170
171
172
173
174
175
176
</pre></td><td class="rouge-code"><pre><span class="nd">@Override</span>
<span class="kd">public</span> <span class="nc">Object</span> <span class="nf">getBean</span><span class="o">(</span><span class="nc">String</span> <span class="n">name</span><span class="o">)</span> <span class="kd">throws</span> <span class="nc">BeansException</span> <span class="o">{</span>
   <span class="k">return</span> <span class="nf">doGetBean</span><span class="o">(</span><span class="n">name</span><span class="o">,</span> <span class="kc">null</span><span class="o">,</span> <span class="kc">null</span><span class="o">,</span> <span class="kc">false</span><span class="o">);</span>
<span class="o">}</span>

<span class="c1">// æˆ‘ä»¬åœ¨å‰–æåˆå§‹åŒ– Bean çš„è¿‡ç¨‹ï¼Œä½†æ˜¯ getBean æ–¹æ³•æˆ‘ä»¬ç»å¸¸æ˜¯ç”¨æ¥ä»å®¹å™¨ä¸­è·å– Bean ç”¨çš„ï¼Œæ³¨æ„åˆ‡æ¢æ€è·¯ï¼Œ</span>
<span class="c1">// å·²ç»åˆå§‹åŒ–è¿‡äº†å°±ä»å®¹å™¨ä¸­ç›´æ¥è¿”å›ï¼Œå¦åˆ™å°±å…ˆåˆå§‹åŒ–å†è¿”å›</span>
<span class="nd">@SuppressWarnings</span><span class="o">(</span><span class="s">"unchecked"</span><span class="o">)</span>
<span class="kd">protected</span> <span class="o">&lt;</span><span class="no">T</span><span class="o">&gt;</span> <span class="no">T</span> <span class="nf">doGetBean</span><span class="o">(</span>
      <span class="kd">final</span> <span class="nc">String</span> <span class="n">name</span><span class="o">,</span> <span class="kd">final</span> <span class="nc">Class</span><span class="o">&lt;</span><span class="no">T</span><span class="o">&gt;</span> <span class="n">requiredType</span><span class="o">,</span> <span class="kd">final</span> <span class="nc">Object</span><span class="o">[]</span> <span class="n">args</span><span class="o">,</span> <span class="kt">boolean</span> <span class="n">typeCheckOnly</span><span class="o">)</span>
      <span class="kd">throws</span> <span class="nc">BeansException</span> <span class="o">{</span>
   <span class="c1">// è·å–ä¸€ä¸ª â€œæ­£ç»Ÿçš„â€ beanNameï¼Œå¤„ç†ä¸¤ç§æƒ…å†µï¼Œä¸€ä¸ªæ˜¯å‰é¢è¯´çš„ FactoryBean(å‰é¢å¸¦ â€˜&amp;â€™)ï¼Œ</span>
   <span class="c1">// ä¸€ä¸ªæ˜¯åˆ«åé—®é¢˜ï¼Œå› ä¸ºè¿™ä¸ªæ–¹æ³•æ˜¯ getBeanï¼Œè·å– Bean ç”¨çš„ï¼Œä½ è¦æ˜¯ä¼ ä¸€ä¸ªåˆ«åè¿›æ¥ï¼Œæ˜¯å®Œå…¨å¯ä»¥çš„</span>
   <span class="kd">final</span> <span class="nc">String</span> <span class="n">beanName</span> <span class="o">=</span> <span class="n">transformedBeanName</span><span class="o">(</span><span class="n">name</span><span class="o">);</span>
  
   <span class="c1">// æ³¨æ„è·Ÿç€è¿™ä¸ªï¼Œè¿™ä¸ªæ˜¯è¿”å›å€¼</span>
   <span class="nc">Object</span> <span class="n">bean</span><span class="o">;</span> 

   <span class="c1">// æ£€æŸ¥ä¸‹æ˜¯ä¸æ˜¯å·²ç»åˆ›å»ºè¿‡äº†</span>
   <span class="nc">Object</span> <span class="n">sharedInstance</span> <span class="o">=</span> <span class="n">getSingleton</span><span class="o">(</span><span class="n">beanName</span><span class="o">);</span>
  
   <span class="c1">// è¿™é‡Œè¯´ä¸‹ args å‘—ï¼Œè™½ç„¶çœ‹ä¸Šå»ä¸€ç‚¹ä¸é‡è¦ã€‚å‰é¢æˆ‘ä»¬ä¸€è·¯è¿›æ¥çš„æ—¶å€™éƒ½æ˜¯ getBean(beanName)ï¼Œ</span>
   <span class="c1">// æ‰€ä»¥ args ä¼ å‚å…¶å®æ˜¯ null çš„ï¼Œä½†æ˜¯å¦‚æœ args ä¸ä¸ºç©ºçš„æ—¶å€™ï¼Œé‚£ä¹ˆæ„å‘³ç€è°ƒç”¨æ–¹ä¸æ˜¯å¸Œæœ›è·å– Beanï¼Œè€Œæ˜¯åˆ›å»º Bean</span>
   <span class="k">if</span> <span class="o">(</span><span class="n">sharedInstance</span> <span class="o">!=</span> <span class="kc">null</span> <span class="o">&amp;&amp;</span> <span class="n">args</span> <span class="o">==</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
      <span class="k">if</span> <span class="o">(</span><span class="n">logger</span><span class="o">.</span><span class="na">isDebugEnabled</span><span class="o">())</span> <span class="o">{</span>
         <span class="k">if</span> <span class="o">(</span><span class="n">isSingletonCurrentlyInCreation</span><span class="o">(</span><span class="n">beanName</span><span class="o">))</span> <span class="o">{</span>
            <span class="n">logger</span><span class="o">.</span><span class="na">debug</span><span class="o">(</span><span class="s">"..."</span><span class="o">);</span>
         <span class="o">}</span>
         <span class="k">else</span> <span class="o">{</span>
            <span class="n">logger</span><span class="o">.</span><span class="na">debug</span><span class="o">(</span><span class="s">"Returning cached instance of singleton bean '"</span> <span class="o">+</span> <span class="n">beanName</span> <span class="o">+</span> <span class="s">"'"</span><span class="o">);</span>
         <span class="o">}</span>
      <span class="o">}</span>
      <span class="c1">// ä¸‹é¢è¿™ä¸ªæ–¹æ³•ï¼šå¦‚æœæ˜¯æ™®é€š Bean çš„è¯ï¼Œç›´æ¥è¿”å› sharedInstanceï¼Œ</span>
      <span class="c1">// å¦‚æœæ˜¯ FactoryBean çš„è¯ï¼Œè¿”å›å®ƒåˆ›å»ºçš„é‚£ä¸ªå®ä¾‹å¯¹è±¡</span>
      <span class="c1">// (FactoryBean çŸ¥è¯†ï¼Œè¯»è€…è‹¥ä¸æ¸…æ¥šè¯·ç§»æ­¥é™„å½•)</span>
      <span class="n">bean</span> <span class="o">=</span> <span class="n">getObjectForBeanInstance</span><span class="o">(</span><span class="n">sharedInstance</span><span class="o">,</span> <span class="n">name</span><span class="o">,</span> <span class="n">beanName</span><span class="o">,</span> <span class="kc">null</span><span class="o">);</span>
   <span class="o">}</span>

   <span class="k">else</span> <span class="o">{</span>
      <span class="k">if</span> <span class="o">(</span><span class="n">isPrototypeCurrentlyInCreation</span><span class="o">(</span><span class="n">beanName</span><span class="o">))</span> <span class="o">{</span>
         <span class="c1">// åˆ›å»ºè¿‡äº†æ­¤ beanName çš„ prototype ç±»å‹çš„ beanï¼Œé‚£ä¹ˆæŠ›å¼‚å¸¸ï¼Œ</span>
         <span class="c1">// å¾€å¾€æ˜¯å› ä¸ºé™·å…¥äº†å¾ªç¯å¼•ç”¨</span>
         <span class="k">throw</span> <span class="k">new</span> <span class="nf">BeanCurrentlyInCreationException</span><span class="o">(</span><span class="n">beanName</span><span class="o">);</span>
      <span class="o">}</span>

      <span class="c1">// æ£€æŸ¥ä¸€ä¸‹è¿™ä¸ª BeanDefinition åœ¨å®¹å™¨ä¸­æ˜¯å¦å­˜åœ¨</span>
      <span class="nc">BeanFactory</span> <span class="n">parentBeanFactory</span> <span class="o">=</span> <span class="n">getParentBeanFactory</span><span class="o">();</span>
      <span class="k">if</span> <span class="o">(</span><span class="n">parentBeanFactory</span> <span class="o">!=</span> <span class="kc">null</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="n">containsBeanDefinition</span><span class="o">(</span><span class="n">beanName</span><span class="o">))</span> <span class="o">{</span>
         <span class="c1">// å¦‚æœå½“å‰å®¹å™¨ä¸å­˜åœ¨è¿™ä¸ª BeanDefinitionï¼Œè¯•è¯•çˆ¶å®¹å™¨ä¸­æœ‰æ²¡æœ‰</span>
         <span class="nc">String</span> <span class="n">nameToLookup</span> <span class="o">=</span> <span class="n">originalBeanName</span><span class="o">(</span><span class="n">name</span><span class="o">);</span>
         <span class="k">if</span> <span class="o">(</span><span class="n">args</span> <span class="o">!=</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
            <span class="c1">// è¿”å›çˆ¶å®¹å™¨çš„æŸ¥è¯¢ç»“æœ</span>
            <span class="k">return</span> <span class="o">(</span><span class="no">T</span><span class="o">)</span> <span class="n">parentBeanFactory</span><span class="o">.</span><span class="na">getBean</span><span class="o">(</span><span class="n">nameToLookup</span><span class="o">,</span> <span class="n">args</span><span class="o">);</span>
         <span class="o">}</span>
         <span class="k">else</span> <span class="o">{</span>
            <span class="c1">// No args -&gt; delegate to standard getBean method.</span>
            <span class="k">return</span> <span class="n">parentBeanFactory</span><span class="o">.</span><span class="na">getBean</span><span class="o">(</span><span class="n">nameToLookup</span><span class="o">,</span> <span class="n">requiredType</span><span class="o">);</span>
         <span class="o">}</span>
      <span class="o">}</span>

      <span class="k">if</span> <span class="o">(!</span><span class="n">typeCheckOnly</span><span class="o">)</span> <span class="o">{</span>
         <span class="c1">// typeCheckOnly ä¸º falseï¼Œå°†å½“å‰ beanName æ”¾å…¥ä¸€ä¸ª alreadyCreated çš„ Set é›†åˆä¸­ã€‚</span>
         <span class="n">markBeanAsCreated</span><span class="o">(</span><span class="n">beanName</span><span class="o">);</span>
      <span class="o">}</span>

      <span class="cm">/*
       * ç¨ç¨æ€»ç»“ä¸€ä¸‹ï¼š
       * åˆ°è¿™é‡Œçš„è¯ï¼Œè¦å‡†å¤‡åˆ›å»º Bean äº†ï¼Œå¯¹äº singleton çš„ Bean æ¥è¯´ï¼Œå®¹å™¨ä¸­è¿˜æ²¡åˆ›å»ºè¿‡æ­¤ Beanï¼›
       * å¯¹äº prototype çš„ Bean æ¥è¯´ï¼Œæœ¬æ¥å°±æ˜¯è¦åˆ›å»ºä¸€ä¸ªæ–°çš„ Beanã€‚
       */</span>
      <span class="k">try</span> <span class="o">{</span>
         <span class="kd">final</span> <span class="nc">RootBeanDefinition</span> <span class="n">mbd</span> <span class="o">=</span> <span class="n">getMergedLocalBeanDefinition</span><span class="o">(</span><span class="n">beanName</span><span class="o">);</span>
         <span class="n">checkMergedBeanDefinition</span><span class="o">(</span><span class="n">mbd</span><span class="o">,</span> <span class="n">beanName</span><span class="o">,</span> <span class="n">args</span><span class="o">);</span>

         <span class="c1">// å…ˆåˆå§‹åŒ–ä¾èµ–çš„æ‰€æœ‰ Beanï¼Œè¿™ä¸ªå¾ˆå¥½ç†è§£ã€‚</span>
         <span class="c1">// æ³¨æ„ï¼Œè¿™é‡Œçš„ä¾èµ–æŒ‡çš„æ˜¯ depends-on ä¸­å®šä¹‰çš„ä¾èµ–</span>
         <span class="nc">String</span><span class="o">[]</span> <span class="n">dependsOn</span> <span class="o">=</span> <span class="n">mbd</span><span class="o">.</span><span class="na">getDependsOn</span><span class="o">();</span>
         <span class="k">if</span> <span class="o">(</span><span class="n">dependsOn</span> <span class="o">!=</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
            <span class="k">for</span> <span class="o">(</span><span class="nc">String</span> <span class="n">dep</span> <span class="o">:</span> <span class="n">dependsOn</span><span class="o">)</span> <span class="o">{</span>
               <span class="c1">// æ£€æŸ¥æ˜¯ä¸æ˜¯æœ‰å¾ªç¯ä¾èµ–ï¼Œè¿™é‡Œçš„å¾ªç¯ä¾èµ–å’Œæˆ‘ä»¬å‰é¢è¯´çš„å¾ªç¯ä¾èµ–åˆä¸ä¸€æ ·ï¼Œè¿™é‡Œè‚¯å®šæ˜¯ä¸å…è®¸å‡ºç°çš„ï¼Œä¸ç„¶è¦ä¹±å¥—äº†ï¼Œè¯»è€…æƒ³ä¸€ä¸‹å°±çŸ¥é“äº†</span>
               <span class="k">if</span> <span class="o">(</span><span class="n">isDependent</span><span class="o">(</span><span class="n">beanName</span><span class="o">,</span> <span class="n">dep</span><span class="o">))</span> <span class="o">{</span>
                  <span class="k">throw</span> <span class="k">new</span> <span class="nf">BeanCreationException</span><span class="o">(</span><span class="n">mbd</span><span class="o">.</span><span class="na">getResourceDescription</span><span class="o">(),</span> <span class="n">beanName</span><span class="o">,</span>
                        <span class="s">"Circular depends-on relationship between '"</span> <span class="o">+</span> <span class="n">beanName</span> <span class="o">+</span> <span class="s">"' and '"</span> <span class="o">+</span> <span class="n">dep</span> <span class="o">+</span> <span class="s">"'"</span><span class="o">);</span>
               <span class="o">}</span>
               <span class="c1">// æ³¨å†Œä¸€ä¸‹ä¾èµ–å…³ç³»</span>
               <span class="n">registerDependentBean</span><span class="o">(</span><span class="n">dep</span><span class="o">,</span> <span class="n">beanName</span><span class="o">);</span>
               <span class="c1">// å…ˆåˆå§‹åŒ–è¢«ä¾èµ–é¡¹</span>
               <span class="n">getBean</span><span class="o">(</span><span class="n">dep</span><span class="o">);</span>
            <span class="o">}</span>
         <span class="o">}</span>

         <span class="c1">// å¦‚æœæ˜¯ singleton scope çš„ï¼Œåˆ›å»º singleton çš„å®ä¾‹</span>
         <span class="k">if</span> <span class="o">(</span><span class="n">mbd</span><span class="o">.</span><span class="na">isSingleton</span><span class="o">())</span> <span class="o">{</span>
            <span class="n">sharedInstance</span> <span class="o">=</span> <span class="n">getSingleton</span><span class="o">(</span><span class="n">beanName</span><span class="o">,</span> <span class="k">new</span> <span class="nc">ObjectFactory</span><span class="o">&lt;</span><span class="nc">Object</span><span class="o">&gt;()</span> <span class="o">{</span>
               <span class="nd">@Override</span>
               <span class="kd">public</span> <span class="nc">Object</span> <span class="nf">getObject</span><span class="o">()</span> <span class="kd">throws</span> <span class="nc">BeansException</span> <span class="o">{</span>
                  <span class="k">try</span> <span class="o">{</span>
                     <span class="c1">// æ‰§è¡Œåˆ›å»º Beanï¼Œè¯¦æƒ…åé¢å†è¯´</span>
                     <span class="k">return</span> <span class="nf">createBean</span><span class="o">(</span><span class="n">beanName</span><span class="o">,</span> <span class="n">mbd</span><span class="o">,</span> <span class="n">args</span><span class="o">);</span>
                  <span class="o">}</span>
                  <span class="k">catch</span> <span class="o">(</span><span class="nc">BeansException</span> <span class="n">ex</span><span class="o">)</span> <span class="o">{</span>
                     <span class="n">destroySingleton</span><span class="o">(</span><span class="n">beanName</span><span class="o">);</span>
                     <span class="k">throw</span> <span class="n">ex</span><span class="o">;</span>
                  <span class="o">}</span>
               <span class="o">}</span>
            <span class="o">});</span>
            <span class="n">bean</span> <span class="o">=</span> <span class="n">getObjectForBeanInstance</span><span class="o">(</span><span class="n">sharedInstance</span><span class="o">,</span> <span class="n">name</span><span class="o">,</span> <span class="n">beanName</span><span class="o">,</span> <span class="n">mbd</span><span class="o">);</span>
         <span class="o">}</span>

         <span class="c1">// å¦‚æœæ˜¯ prototype scope çš„ï¼Œåˆ›å»º prototype çš„å®ä¾‹</span>
         <span class="k">else</span> <span class="nf">if</span> <span class="o">(</span><span class="n">mbd</span><span class="o">.</span><span class="na">isPrototype</span><span class="o">())</span> <span class="o">{</span>
            <span class="c1">// It's a prototype -&gt; create a new instance.</span>
            <span class="nc">Object</span> <span class="n">prototypeInstance</span> <span class="o">=</span> <span class="kc">null</span><span class="o">;</span>
            <span class="k">try</span> <span class="o">{</span>
               <span class="n">beforePrototypeCreation</span><span class="o">(</span><span class="n">beanName</span><span class="o">);</span>
               <span class="c1">// æ‰§è¡Œåˆ›å»º Bean</span>
               <span class="n">prototypeInstance</span> <span class="o">=</span> <span class="n">createBean</span><span class="o">(</span><span class="n">beanName</span><span class="o">,</span> <span class="n">mbd</span><span class="o">,</span> <span class="n">args</span><span class="o">);</span>
            <span class="o">}</span>
            <span class="k">finally</span> <span class="o">{</span>
               <span class="n">afterPrototypeCreation</span><span class="o">(</span><span class="n">beanName</span><span class="o">);</span>
            <span class="o">}</span>
            <span class="n">bean</span> <span class="o">=</span> <span class="n">getObjectForBeanInstance</span><span class="o">(</span><span class="n">prototypeInstance</span><span class="o">,</span> <span class="n">name</span><span class="o">,</span> <span class="n">beanName</span><span class="o">,</span> <span class="n">mbd</span><span class="o">);</span>
         <span class="o">}</span>

         <span class="c1">// å¦‚æœä¸æ˜¯ singleton å’Œ prototype çš„è¯ï¼Œéœ€è¦å§”æ‰˜ç»™ç›¸åº”çš„å®ç°ç±»æ¥å¤„ç†</span>
         <span class="k">else</span> <span class="o">{</span>
            <span class="nc">String</span> <span class="n">scopeName</span> <span class="o">=</span> <span class="n">mbd</span><span class="o">.</span><span class="na">getScope</span><span class="o">();</span>
            <span class="kd">final</span> <span class="nc">Scope</span> <span class="n">scope</span> <span class="o">=</span> <span class="k">this</span><span class="o">.</span><span class="na">scopes</span><span class="o">.</span><span class="na">get</span><span class="o">(</span><span class="n">scopeName</span><span class="o">);</span>
            <span class="k">if</span> <span class="o">(</span><span class="n">scope</span> <span class="o">==</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
               <span class="k">throw</span> <span class="k">new</span> <span class="nf">IllegalStateException</span><span class="o">(</span><span class="s">"No Scope registered for scope name '"</span> <span class="o">+</span> <span class="n">scopeName</span> <span class="o">+</span> <span class="s">"'"</span><span class="o">);</span>
            <span class="o">}</span>
            <span class="k">try</span> <span class="o">{</span>
               <span class="nc">Object</span> <span class="n">scopedInstance</span> <span class="o">=</span> <span class="n">scope</span><span class="o">.</span><span class="na">get</span><span class="o">(</span><span class="n">beanName</span><span class="o">,</span> <span class="k">new</span> <span class="nc">ObjectFactory</span><span class="o">&lt;</span><span class="nc">Object</span><span class="o">&gt;()</span> <span class="o">{</span>
                  <span class="nd">@Override</span>
                  <span class="kd">public</span> <span class="nc">Object</span> <span class="nf">getObject</span><span class="o">()</span> <span class="kd">throws</span> <span class="nc">BeansException</span> <span class="o">{</span>
                     <span class="n">beforePrototypeCreation</span><span class="o">(</span><span class="n">beanName</span><span class="o">);</span>
                     <span class="k">try</span> <span class="o">{</span>
                        <span class="c1">// æ‰§è¡Œåˆ›å»º Bean</span>
                        <span class="k">return</span> <span class="nf">createBean</span><span class="o">(</span><span class="n">beanName</span><span class="o">,</span> <span class="n">mbd</span><span class="o">,</span> <span class="n">args</span><span class="o">);</span>
                     <span class="o">}</span>
                     <span class="k">finally</span> <span class="o">{</span>
                        <span class="n">afterPrototypeCreation</span><span class="o">(</span><span class="n">beanName</span><span class="o">);</span>
                     <span class="o">}</span>
                  <span class="o">}</span>
               <span class="o">});</span>
               <span class="n">bean</span> <span class="o">=</span> <span class="n">getObjectForBeanInstance</span><span class="o">(</span><span class="n">scopedInstance</span><span class="o">,</span> <span class="n">name</span><span class="o">,</span> <span class="n">beanName</span><span class="o">,</span> <span class="n">mbd</span><span class="o">);</span>
            <span class="o">}</span>
            <span class="k">catch</span> <span class="o">(</span><span class="nc">IllegalStateException</span> <span class="n">ex</span><span class="o">)</span> <span class="o">{</span>
               <span class="k">throw</span> <span class="k">new</span> <span class="nf">BeanCreationException</span><span class="o">(</span><span class="n">beanName</span><span class="o">,</span>
                     <span class="s">"Scope '"</span> <span class="o">+</span> <span class="n">scopeName</span> <span class="o">+</span> <span class="s">"' is not active for the current thread; consider "</span> <span class="o">+</span>
                     <span class="s">"defining a scoped proxy for this bean if you intend to refer to it from a singleton"</span><span class="o">,</span>
                     <span class="n">ex</span><span class="o">);</span>
            <span class="o">}</span>
         <span class="o">}</span>
      <span class="o">}</span>
      <span class="k">catch</span> <span class="o">(</span><span class="nc">BeansException</span> <span class="n">ex</span><span class="o">)</span> <span class="o">{</span>
         <span class="n">cleanupAfterBeanCreationFailure</span><span class="o">(</span><span class="n">beanName</span><span class="o">);</span>
         <span class="k">throw</span> <span class="n">ex</span><span class="o">;</span>
      <span class="o">}</span>
   <span class="o">}</span>

   <span class="c1">// æœ€åï¼Œæ£€æŸ¥ä¸€ä¸‹ç±»å‹å¯¹ä¸å¯¹ï¼Œä¸å¯¹çš„è¯å°±æŠ›å¼‚å¸¸ï¼Œå¯¹çš„è¯å°±è¿”å›äº†</span>
   <span class="k">if</span> <span class="o">(</span><span class="n">requiredType</span> <span class="o">!=</span> <span class="kc">null</span> <span class="o">&amp;&amp;</span> <span class="n">bean</span> <span class="o">!=</span> <span class="kc">null</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="n">requiredType</span><span class="o">.</span><span class="na">isInstance</span><span class="o">(</span><span class="n">bean</span><span class="o">))</span> <span class="o">{</span>
      <span class="k">try</span> <span class="o">{</span>
         <span class="k">return</span> <span class="nf">getTypeConverter</span><span class="o">().</span><span class="na">convertIfNecessary</span><span class="o">(</span><span class="n">bean</span><span class="o">,</span> <span class="n">requiredType</span><span class="o">);</span>
      <span class="o">}</span>
      <span class="k">catch</span> <span class="o">(</span><span class="nc">TypeMismatchException</span> <span class="n">ex</span><span class="o">)</span> <span class="o">{</span>
         <span class="k">if</span> <span class="o">(</span><span class="n">logger</span><span class="o">.</span><span class="na">isDebugEnabled</span><span class="o">())</span> <span class="o">{</span>
            <span class="n">logger</span><span class="o">.</span><span class="na">debug</span><span class="o">(</span><span class="s">"Failed to convert bean '"</span> <span class="o">+</span> <span class="n">name</span> <span class="o">+</span> <span class="s">"' to required type '"</span> <span class="o">+</span>
                  <span class="nc">ClassUtils</span><span class="o">.</span><span class="na">getQualifiedName</span><span class="o">(</span><span class="n">requiredType</span><span class="o">)</span> <span class="o">+</span> <span class="s">"'"</span><span class="o">,</span> <span class="n">ex</span><span class="o">);</span>
         <span class="o">}</span>
         <span class="k">throw</span> <span class="k">new</span> <span class="nf">BeanNotOfRequiredTypeException</span><span class="o">(</span><span class="n">name</span><span class="o">,</span> <span class="n">requiredType</span><span class="o">,</span> <span class="n">bean</span><span class="o">.</span><span class="na">getClass</span><span class="o">());</span>
      <span class="o">}</span>
   <span class="o">}</span>
   <span class="k">return</span> <span class="o">(</span><span class="no">T</span><span class="o">)</span> <span class="n">bean</span><span class="o">;</span>
<span class="o">}</span>
</pre></td></tr></tbody></table></code></pre></div></div>

<p>å¤§å®¶åº”è¯¥ä¹ŸçŒœåˆ°äº†ï¼Œæ¥ä¸‹æ¥å½“ç„¶æ˜¯åˆ†æ createBean æ–¹æ³•ï¼š</p>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre></td><td class="rouge-code"><pre><span class="kd">protected</span> <span class="kd">abstract</span> <span class="nc">Object</span> <span class="nf">createBean</span><span class="o">(</span><span class="nc">String</span> <span class="n">beanName</span><span class="o">,</span> <span class="nc">RootBeanDefinition</span> <span class="n">mbd</span><span class="o">,</span> <span class="nc">Object</span><span class="o">[]</span> <span class="n">args</span><span class="o">)</span> <span class="kd">throws</span> <span class="nc">BeanCreationException</span><span class="o">;</span>
</pre></td></tr></tbody></table></code></pre></div></div>

<p>ç¬¬ä¸‰ä¸ªå‚æ•° args æ•°ç»„ä»£è¡¨åˆ›å»ºå®ä¾‹éœ€è¦çš„å‚æ•°ï¼Œä¸å°±æ˜¯ç»™æ„é€ æ–¹æ³•ç”¨çš„å‚æ•°ï¼Œæˆ–è€…æ˜¯å·¥å‚ Bean çš„å‚æ•°å˜›ï¼Œä¸è¿‡è¦æ³¨æ„ï¼Œåœ¨æˆ‘ä»¬çš„åˆå§‹åŒ–é˜¶æ®µï¼Œargs æ˜¯ nullã€‚</p>

<p>è¿™å›æˆ‘ä»¬è¦åˆ°ä¸€ä¸ªæ–°çš„ç±»äº† AbstractAutowireCapableBeanFactoryï¼Œçœ‹ç±»åï¼ŒAutowireCapableï¼Ÿç±»åæ˜¯ä¸æ˜¯ä¹Ÿè¯´æ˜äº†ç‚¹é—®é¢˜äº†ã€‚</p>

<p>ä¸»è¦æ˜¯ä¸ºäº†ä»¥ä¸‹åœºæ™¯ï¼Œé‡‡ç”¨ @Autowired æ³¨è§£æ³¨å…¥å±æ€§å€¼ï¼š</p>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
</pre></td><td class="rouge-code"><pre><span class="kd">public</span> <span class="kd">class</span> <span class="nc">MessageServiceImpl</span> <span class="kd">implements</span> <span class="nc">MessageService</span> <span class="o">{</span>
    <span class="nd">@Autowired</span>
    <span class="kd">private</span> <span class="nc">UserService</span> <span class="n">userService</span><span class="o">;</span>
  
    <span class="kd">public</span> <span class="nc">String</span> <span class="nf">getMessage</span><span class="o">()</span> <span class="o">{</span>
        <span class="k">return</span> <span class="n">userService</span><span class="o">.</span><span class="na">getMessage</span><span class="o">();</span>
    <span class="o">}</span>
<span class="o">}</span>
</pre></td></tr></tbody></table></code></pre></div></div>

<div class="language-xml highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre></td><td class="rouge-code"><pre><span class="nt">&lt;bean</span> <span class="na">id=</span><span class="s">"messageService"</span> <span class="na">class=</span><span class="s">"com.javadoop.example.MessageServiceImpl"</span> <span class="nt">/&gt;</span>
</pre></td></tr></tbody></table></code></pre></div></div>

<p>ä»¥ä¸Šè¿™ç§å±äºæ··ç”¨äº† xml å’Œ æ³¨è§£ ä¸¤ç§æ–¹å¼çš„é…ç½®æ–¹å¼ï¼ŒSpring ä¼šå¤„ç†è¿™ç§æƒ…å†µã€‚</p>

<p>å¥½äº†ï¼Œè¯»è€…è¦çŸ¥é“è¿™ä¹ˆå›äº‹å°±å¯ä»¥äº†ï¼Œç»§ç»­å‘å‰ã€‚</p>

<p>// AbstractAutowireCapableBeanFactory 447</p>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
44
45
46
47
48
49
</pre></td><td class="rouge-code"><pre><span class="cm">/**
 * Central method of this class: creates a bean instance,
 * populates the bean instance, applies post-processors, etc.
 * @see #doCreateBean
 */</span>
<span class="nd">@Override</span>
<span class="kd">protected</span> <span class="nc">Object</span> <span class="nf">createBean</span><span class="o">(</span><span class="nc">String</span> <span class="n">beanName</span><span class="o">,</span> <span class="nc">RootBeanDefinition</span> <span class="n">mbd</span><span class="o">,</span> <span class="nc">Object</span><span class="o">[]</span> <span class="n">args</span><span class="o">)</span> <span class="kd">throws</span> <span class="nc">BeanCreationException</span> <span class="o">{</span>
   <span class="k">if</span> <span class="o">(</span><span class="n">logger</span><span class="o">.</span><span class="na">isDebugEnabled</span><span class="o">())</span> <span class="o">{</span>
      <span class="n">logger</span><span class="o">.</span><span class="na">debug</span><span class="o">(</span><span class="s">"Creating instance of bean '"</span> <span class="o">+</span> <span class="n">beanName</span> <span class="o">+</span> <span class="s">"'"</span><span class="o">);</span>
   <span class="o">}</span>
   <span class="nc">RootBeanDefinition</span> <span class="n">mbdToUse</span> <span class="o">=</span> <span class="n">mbd</span><span class="o">;</span>

   <span class="c1">// ç¡®ä¿ BeanDefinition ä¸­çš„ Class è¢«åŠ è½½</span>
   <span class="nc">Class</span><span class="o">&lt;?&gt;</span> <span class="n">resolvedClass</span> <span class="o">=</span> <span class="n">resolveBeanClass</span><span class="o">(</span><span class="n">mbd</span><span class="o">,</span> <span class="n">beanName</span><span class="o">);</span>
   <span class="k">if</span> <span class="o">(</span><span class="n">resolvedClass</span> <span class="o">!=</span> <span class="kc">null</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="n">mbd</span><span class="o">.</span><span class="na">hasBeanClass</span><span class="o">()</span> <span class="o">&amp;&amp;</span> <span class="n">mbd</span><span class="o">.</span><span class="na">getBeanClassName</span><span class="o">()</span> <span class="o">!=</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
      <span class="n">mbdToUse</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">RootBeanDefinition</span><span class="o">(</span><span class="n">mbd</span><span class="o">);</span>
      <span class="n">mbdToUse</span><span class="o">.</span><span class="na">setBeanClass</span><span class="o">(</span><span class="n">resolvedClass</span><span class="o">);</span>
   <span class="o">}</span>

   <span class="c1">// å‡†å¤‡æ–¹æ³•è¦†å†™ï¼Œè¿™é‡Œåˆæ¶‰åŠåˆ°ä¸€ä¸ªæ¦‚å¿µï¼šMethodOverridesï¼Œå®ƒæ¥è‡ªäº bean å®šä¹‰ä¸­çš„ &lt;lookup-method /&gt; </span>
   <span class="c1">// å’Œ &lt;replaced-method /&gt;ï¼Œå¦‚æœè¯»è€…æ„Ÿå…´è¶£ï¼Œå›åˆ° bean è§£æçš„åœ°æ–¹çœ‹çœ‹å¯¹è¿™ä¸¤ä¸ªæ ‡ç­¾çš„è§£æã€‚</span>
   <span class="c1">// æˆ‘åœ¨é™„å½•ä¸­ä¹Ÿå¯¹è¿™ä¸¤ä¸ªæ ‡ç­¾çš„ç›¸å…³çŸ¥è¯†ç‚¹è¿›è¡Œäº†ä»‹ç»ï¼Œè¯»è€…å¯ä»¥ç§»æ­¥å»çœ‹çœ‹</span>
   <span class="k">try</span> <span class="o">{</span>
      <span class="n">mbdToUse</span><span class="o">.</span><span class="na">prepareMethodOverrides</span><span class="o">();</span>
   <span class="o">}</span>
   <span class="k">catch</span> <span class="o">(</span><span class="nc">BeanDefinitionValidationException</span> <span class="n">ex</span><span class="o">)</span> <span class="o">{</span>
      <span class="k">throw</span> <span class="k">new</span> <span class="nf">BeanDefinitionStoreException</span><span class="o">(</span><span class="n">mbdToUse</span><span class="o">.</span><span class="na">getResourceDescription</span><span class="o">(),</span>
            <span class="n">beanName</span><span class="o">,</span> <span class="s">"Validation of method overrides failed"</span><span class="o">,</span> <span class="n">ex</span><span class="o">);</span>
   <span class="o">}</span>

   <span class="k">try</span> <span class="o">{</span>
      <span class="c1">// è®© InstantiationAwareBeanPostProcessor åœ¨è¿™ä¸€æ­¥æœ‰æœºä¼šè¿”å›ä»£ç†ï¼Œ</span>
      <span class="c1">// åœ¨ ã€ŠSpring AOP æºç åˆ†æã€‹é‚£ç¯‡æ–‡ç« ä¸­æœ‰è§£é‡Šï¼Œè¿™é‡Œå…ˆè·³è¿‡</span>
      <span class="nc">Object</span> <span class="n">bean</span> <span class="o">=</span> <span class="n">resolveBeforeInstantiation</span><span class="o">(</span><span class="n">beanName</span><span class="o">,</span> <span class="n">mbdToUse</span><span class="o">);</span>
      <span class="k">if</span> <span class="o">(</span><span class="n">bean</span> <span class="o">!=</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
         <span class="k">return</span> <span class="n">bean</span><span class="o">;</span> 
      <span class="o">}</span>
   <span class="o">}</span>
   <span class="k">catch</span> <span class="o">(</span><span class="nc">Throwable</span> <span class="n">ex</span><span class="o">)</span> <span class="o">{</span>
      <span class="k">throw</span> <span class="k">new</span> <span class="nf">BeanCreationException</span><span class="o">(</span><span class="n">mbdToUse</span><span class="o">.</span><span class="na">getResourceDescription</span><span class="o">(),</span> <span class="n">beanName</span><span class="o">,</span>
            <span class="s">"BeanPostProcessor before instantiation of bean failed"</span><span class="o">,</span> <span class="n">ex</span><span class="o">);</span>
   <span class="o">}</span>
   <span class="c1">// é‡å¤´æˆï¼Œåˆ›å»º bean</span>
   <span class="nc">Object</span> <span class="n">beanInstance</span> <span class="o">=</span> <span class="n">doCreateBean</span><span class="o">(</span><span class="n">beanName</span><span class="o">,</span> <span class="n">mbdToUse</span><span class="o">,</span> <span class="n">args</span><span class="o">);</span>
   <span class="k">if</span> <span class="o">(</span><span class="n">logger</span><span class="o">.</span><span class="na">isDebugEnabled</span><span class="o">())</span> <span class="o">{</span>
      <span class="n">logger</span><span class="o">.</span><span class="na">debug</span><span class="o">(</span><span class="s">"Finished creating instance of bean '"</span> <span class="o">+</span> <span class="n">beanName</span> <span class="o">+</span> <span class="s">"'"</span><span class="o">);</span>
   <span class="o">}</span>
   <span class="k">return</span> <span class="n">beanInstance</span><span class="o">;</span>
<span class="o">}</span>
</pre></td></tr></tbody></table></code></pre></div></div>

<h4 id="åˆ›å»º-bean">åˆ›å»º Bean</h4>

<p>æˆ‘ä»¬ç»§ç»­å¾€é‡Œçœ‹ doCreateBean è¿™ä¸ªæ–¹æ³•ï¼š</p>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
44
45
46
47
48
49
50
51
52
53
54
55
56
57
58
59
60
61
62
63
64
65
66
67
68
69
70
71
72
73
74
75
76
77
78
79
80
81
82
83
84
85
86
87
88
89
90
91
92
93
94
95
96
97
98
99
100
101
102
103
104
105
106
107
108
109
110
111
112
113
114
115
116
117
118
119
120
121
122
123
124
125
</pre></td><td class="rouge-code"><pre><span class="cm">/**
 * Actually create the specified bean. Pre-creation processing has already happened
 * at this point, e.g. checking {@code postProcessBeforeInstantiation} callbacks.
 * &lt;p&gt;Differentiates between default bean instantiation, use of a
 * factory method, and autowiring a constructor.
 * @param beanName the name of the bean
 * @param mbd the merged bean definition for the bean
 * @param args explicit arguments to use for constructor or factory method invocation
 * @return a new instance of the bean
 * @throws BeanCreationException if the bean could not be created
 * @see #instantiateBean
 * @see #instantiateUsingFactoryMethod
 * @see #autowireConstructor
 */</span>
<span class="kd">protected</span> <span class="nc">Object</span> <span class="nf">doCreateBean</span><span class="o">(</span><span class="kd">final</span> <span class="nc">String</span> <span class="n">beanName</span><span class="o">,</span> <span class="kd">final</span> <span class="nc">RootBeanDefinition</span> <span class="n">mbd</span><span class="o">,</span> <span class="kd">final</span> <span class="nc">Object</span><span class="o">[]</span> <span class="n">args</span><span class="o">)</span>
      <span class="kd">throws</span> <span class="nc">BeanCreationException</span> <span class="o">{</span>

   <span class="c1">// Instantiate the bean.</span>
   <span class="nc">BeanWrapper</span> <span class="n">instanceWrapper</span> <span class="o">=</span> <span class="kc">null</span><span class="o">;</span>
   <span class="k">if</span> <span class="o">(</span><span class="n">mbd</span><span class="o">.</span><span class="na">isSingleton</span><span class="o">())</span> <span class="o">{</span>
      <span class="n">instanceWrapper</span> <span class="o">=</span> <span class="k">this</span><span class="o">.</span><span class="na">factoryBeanInstanceCache</span><span class="o">.</span><span class="na">remove</span><span class="o">(</span><span class="n">beanName</span><span class="o">);</span>
   <span class="o">}</span>
   <span class="k">if</span> <span class="o">(</span><span class="n">instanceWrapper</span> <span class="o">==</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
      <span class="c1">// è¯´æ˜ä¸æ˜¯ FactoryBeanï¼Œè¿™é‡Œå®ä¾‹åŒ– Beanï¼Œè¿™é‡Œéå¸¸å…³é”®ï¼Œç»†èŠ‚ä¹‹åå†è¯´</span>
      <span class="n">instanceWrapper</span> <span class="o">=</span> <span class="n">createBeanInstance</span><span class="o">(</span><span class="n">beanName</span><span class="o">,</span> <span class="n">mbd</span><span class="o">,</span> <span class="n">args</span><span class="o">);</span>
   <span class="o">}</span>
   <span class="c1">// è¿™ä¸ªå°±æ˜¯ Bean é‡Œé¢çš„ æˆ‘ä»¬å®šä¹‰çš„ç±» çš„å®ä¾‹ï¼Œå¾ˆå¤šåœ°æ–¹æˆ‘ç›´æ¥æè¿°æˆ "bean å®ä¾‹"</span>
   <span class="kd">final</span> <span class="nc">Object</span> <span class="n">bean</span> <span class="o">=</span> <span class="o">(</span><span class="n">instanceWrapper</span> <span class="o">!=</span> <span class="kc">null</span> <span class="o">?</span> <span class="n">instanceWrapper</span><span class="o">.</span><span class="na">getWrappedInstance</span><span class="o">()</span> <span class="o">:</span> <span class="kc">null</span><span class="o">);</span>
   <span class="c1">// ç±»å‹</span>
   <span class="nc">Class</span><span class="o">&lt;?&gt;</span> <span class="n">beanType</span> <span class="o">=</span> <span class="o">(</span><span class="n">instanceWrapper</span> <span class="o">!=</span> <span class="kc">null</span> <span class="o">?</span> <span class="n">instanceWrapper</span><span class="o">.</span><span class="na">getWrappedClass</span><span class="o">()</span> <span class="o">:</span> <span class="kc">null</span><span class="o">);</span>
   <span class="n">mbd</span><span class="o">.</span><span class="na">resolvedTargetType</span> <span class="o">=</span> <span class="n">beanType</span><span class="o">;</span>

   <span class="c1">// å»ºè®®è·³è¿‡å§ï¼Œæ¶‰åŠæ¥å£ï¼šMergedBeanDefinitionPostProcessor</span>
   <span class="kd">synchronized</span> <span class="o">(</span><span class="n">mbd</span><span class="o">.</span><span class="na">postProcessingLock</span><span class="o">)</span> <span class="o">{</span>
      <span class="k">if</span> <span class="o">(!</span><span class="n">mbd</span><span class="o">.</span><span class="na">postProcessed</span><span class="o">)</span> <span class="o">{</span>
         <span class="k">try</span> <span class="o">{</span>
            <span class="c1">// MergedBeanDefinitionPostProcessorï¼Œè¿™ä¸ªæˆ‘çœŸä¸å±•å¼€è¯´äº†ï¼Œç›´æ¥è·³è¿‡å§ï¼Œå¾ˆå°‘ç”¨çš„</span>
            <span class="n">applyMergedBeanDefinitionPostProcessors</span><span class="o">(</span><span class="n">mbd</span><span class="o">,</span> <span class="n">beanType</span><span class="o">,</span> <span class="n">beanName</span><span class="o">);</span>
         <span class="o">}</span>
         <span class="k">catch</span> <span class="o">(</span><span class="nc">Throwable</span> <span class="n">ex</span><span class="o">)</span> <span class="o">{</span>
            <span class="k">throw</span> <span class="k">new</span> <span class="nf">BeanCreationException</span><span class="o">(</span><span class="n">mbd</span><span class="o">.</span><span class="na">getResourceDescription</span><span class="o">(),</span> <span class="n">beanName</span><span class="o">,</span>
                  <span class="s">"Post-processing of merged bean definition failed"</span><span class="o">,</span> <span class="n">ex</span><span class="o">);</span>
         <span class="o">}</span>
         <span class="n">mbd</span><span class="o">.</span><span class="na">postProcessed</span> <span class="o">=</span> <span class="kc">true</span><span class="o">;</span>
      <span class="o">}</span>
   <span class="o">}</span>

   <span class="c1">// Eagerly cache singletons to be able to resolve circular references</span>
   <span class="c1">// even when triggered by lifecycle interfaces like BeanFactoryAware.</span>
   <span class="c1">// ä¸‹é¢è¿™å—ä»£ç æ˜¯ä¸ºäº†è§£å†³å¾ªç¯ä¾èµ–çš„é—®é¢˜ï¼Œä»¥åæœ‰æ—¶é—´ï¼Œæˆ‘å†å¯¹å¾ªç¯ä¾èµ–è¿™ä¸ªé—®é¢˜è¿›è¡Œè§£æå§</span>
   <span class="kt">boolean</span> <span class="n">earlySingletonExposure</span> <span class="o">=</span> <span class="o">(</span><span class="n">mbd</span><span class="o">.</span><span class="na">isSingleton</span><span class="o">()</span> <span class="o">&amp;&amp;</span> <span class="k">this</span><span class="o">.</span><span class="na">allowCircularReferences</span> <span class="o">&amp;&amp;</span>
         <span class="n">isSingletonCurrentlyInCreation</span><span class="o">(</span><span class="n">beanName</span><span class="o">));</span>
   <span class="k">if</span> <span class="o">(</span><span class="n">earlySingletonExposure</span><span class="o">)</span> <span class="o">{</span>
      <span class="k">if</span> <span class="o">(</span><span class="n">logger</span><span class="o">.</span><span class="na">isDebugEnabled</span><span class="o">())</span> <span class="o">{</span>
         <span class="n">logger</span><span class="o">.</span><span class="na">debug</span><span class="o">(</span><span class="s">"Eagerly caching bean '"</span> <span class="o">+</span> <span class="n">beanName</span> <span class="o">+</span>
               <span class="s">"' to allow for resolving potential circular references"</span><span class="o">);</span>
      <span class="o">}</span>
      <span class="n">addSingletonFactory</span><span class="o">(</span><span class="n">beanName</span><span class="o">,</span> <span class="k">new</span> <span class="nc">ObjectFactory</span><span class="o">&lt;</span><span class="nc">Object</span><span class="o">&gt;()</span> <span class="o">{</span>
         <span class="nd">@Override</span>
         <span class="kd">public</span> <span class="nc">Object</span> <span class="nf">getObject</span><span class="o">()</span> <span class="kd">throws</span> <span class="nc">BeansException</span> <span class="o">{</span>
            <span class="k">return</span> <span class="nf">getEarlyBeanReference</span><span class="o">(</span><span class="n">beanName</span><span class="o">,</span> <span class="n">mbd</span><span class="o">,</span> <span class="n">bean</span><span class="o">);</span>
         <span class="o">}</span>
      <span class="o">});</span>
   <span class="o">}</span>

   <span class="c1">// Initialize the bean instance.</span>
   <span class="nc">Object</span> <span class="n">exposedObject</span> <span class="o">=</span> <span class="n">bean</span><span class="o">;</span>
   <span class="k">try</span> <span class="o">{</span>
      <span class="c1">// è¿™ä¸€æ­¥ä¹Ÿæ˜¯éå¸¸å…³é”®çš„ï¼Œè¿™ä¸€æ­¥è´Ÿè´£å±æ€§è£…é…ï¼Œå› ä¸ºå‰é¢çš„å®ä¾‹åªæ˜¯å®ä¾‹åŒ–äº†ï¼Œå¹¶æ²¡æœ‰è®¾å€¼ï¼Œè¿™é‡Œå°±æ˜¯è®¾å€¼</span>
      <span class="n">populateBean</span><span class="o">(</span><span class="n">beanName</span><span class="o">,</span> <span class="n">mbd</span><span class="o">,</span> <span class="n">instanceWrapper</span><span class="o">);</span>
      <span class="k">if</span> <span class="o">(</span><span class="n">exposedObject</span> <span class="o">!=</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
         <span class="c1">// è¿˜è®°å¾— init-method å—ï¼Ÿè¿˜æœ‰ InitializingBean æ¥å£ï¼Ÿè¿˜æœ‰ BeanPostProcessor æ¥å£ï¼Ÿ</span>
         <span class="c1">// è¿™é‡Œå°±æ˜¯å¤„ç† bean åˆå§‹åŒ–å®Œæˆåçš„å„ç§å›è°ƒ</span>
         <span class="n">exposedObject</span> <span class="o">=</span> <span class="n">initializeBean</span><span class="o">(</span><span class="n">beanName</span><span class="o">,</span> <span class="n">exposedObject</span><span class="o">,</span> <span class="n">mbd</span><span class="o">);</span>
      <span class="o">}</span>
   <span class="o">}</span>
   <span class="k">catch</span> <span class="o">(</span><span class="nc">Throwable</span> <span class="n">ex</span><span class="o">)</span> <span class="o">{</span>
      <span class="k">if</span> <span class="o">(</span><span class="n">ex</span> <span class="k">instanceof</span> <span class="nc">BeanCreationException</span> <span class="o">&amp;&amp;</span> <span class="n">beanName</span><span class="o">.</span><span class="na">equals</span><span class="o">(((</span><span class="nc">BeanCreationException</span><span class="o">)</span> <span class="n">ex</span><span class="o">).</span><span class="na">getBeanName</span><span class="o">()))</span> <span class="o">{</span>
         <span class="k">throw</span> <span class="o">(</span><span class="nc">BeanCreationException</span><span class="o">)</span> <span class="n">ex</span><span class="o">;</span>
      <span class="o">}</span>
      <span class="k">else</span> <span class="o">{</span>
         <span class="k">throw</span> <span class="k">new</span> <span class="nf">BeanCreationException</span><span class="o">(</span>
               <span class="n">mbd</span><span class="o">.</span><span class="na">getResourceDescription</span><span class="o">(),</span> <span class="n">beanName</span><span class="o">,</span> <span class="s">"Initialization of bean failed"</span><span class="o">,</span> <span class="n">ex</span><span class="o">);</span>
      <span class="o">}</span>
   <span class="o">}</span>

   <span class="k">if</span> <span class="o">(</span><span class="n">earlySingletonExposure</span><span class="o">)</span> <span class="o">{</span>
      <span class="c1">// </span>
      <span class="nc">Object</span> <span class="n">earlySingletonReference</span> <span class="o">=</span> <span class="n">getSingleton</span><span class="o">(</span><span class="n">beanName</span><span class="o">,</span> <span class="kc">false</span><span class="o">);</span>
      <span class="k">if</span> <span class="o">(</span><span class="n">earlySingletonReference</span> <span class="o">!=</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
         <span class="k">if</span> <span class="o">(</span><span class="n">exposedObject</span> <span class="o">==</span> <span class="n">bean</span><span class="o">)</span> <span class="o">{</span>
            <span class="n">exposedObject</span> <span class="o">=</span> <span class="n">earlySingletonReference</span><span class="o">;</span>
         <span class="o">}</span>
         <span class="k">else</span> <span class="nf">if</span> <span class="o">(!</span><span class="k">this</span><span class="o">.</span><span class="na">allowRawInjectionDespiteWrapping</span> <span class="o">&amp;&amp;</span> <span class="n">hasDependentBean</span><span class="o">(</span><span class="n">beanName</span><span class="o">))</span> <span class="o">{</span>
            <span class="nc">String</span><span class="o">[]</span> <span class="n">dependentBeans</span> <span class="o">=</span> <span class="n">getDependentBeans</span><span class="o">(</span><span class="n">beanName</span><span class="o">);</span>
            <span class="nc">Set</span><span class="o">&lt;</span><span class="nc">String</span><span class="o">&gt;</span> <span class="n">actualDependentBeans</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">LinkedHashSet</span><span class="o">&lt;</span><span class="nc">String</span><span class="o">&gt;(</span><span class="n">dependentBeans</span><span class="o">.</span><span class="na">length</span><span class="o">);</span>
            <span class="k">for</span> <span class="o">(</span><span class="nc">String</span> <span class="n">dependentBean</span> <span class="o">:</span> <span class="n">dependentBeans</span><span class="o">)</span> <span class="o">{</span>
               <span class="k">if</span> <span class="o">(!</span><span class="n">removeSingletonIfCreatedForTypeCheckOnly</span><span class="o">(</span><span class="n">dependentBean</span><span class="o">))</span> <span class="o">{</span>
                  <span class="n">actualDependentBeans</span><span class="o">.</span><span class="na">add</span><span class="o">(</span><span class="n">dependentBean</span><span class="o">);</span>
               <span class="o">}</span>
            <span class="o">}</span>
            <span class="k">if</span> <span class="o">(!</span><span class="n">actualDependentBeans</span><span class="o">.</span><span class="na">isEmpty</span><span class="o">())</span> <span class="o">{</span>
               <span class="k">throw</span> <span class="k">new</span> <span class="nf">BeanCurrentlyInCreationException</span><span class="o">(</span><span class="n">beanName</span><span class="o">,</span>
                     <span class="s">"Bean with name '"</span> <span class="o">+</span> <span class="n">beanName</span> <span class="o">+</span> <span class="s">"' has been injected into other beans ["</span> <span class="o">+</span>
                     <span class="nc">StringUtils</span><span class="o">.</span><span class="na">collectionToCommaDelimitedString</span><span class="o">(</span><span class="n">actualDependentBeans</span><span class="o">)</span> <span class="o">+</span>
                     <span class="s">"] in its raw version as part of a circular reference, but has eventually been "</span> <span class="o">+</span>
                     <span class="s">"wrapped. This means that said other beans do not use the final version of the "</span> <span class="o">+</span>
                     <span class="s">"bean. This is often the result of over-eager type matching - consider using "</span> <span class="o">+</span>
                     <span class="s">"'getBeanNamesOfType' with the 'allowEagerInit' flag turned off, for example."</span><span class="o">);</span>
            <span class="o">}</span>
         <span class="o">}</span>
      <span class="o">}</span>
   <span class="o">}</span>

   <span class="c1">// Register bean as disposable.</span>
   <span class="k">try</span> <span class="o">{</span>
      <span class="n">registerDisposableBeanIfNecessary</span><span class="o">(</span><span class="n">beanName</span><span class="o">,</span> <span class="n">bean</span><span class="o">,</span> <span class="n">mbd</span><span class="o">);</span>
   <span class="o">}</span>
   <span class="k">catch</span> <span class="o">(</span><span class="nc">BeanDefinitionValidationException</span> <span class="n">ex</span><span class="o">)</span> <span class="o">{</span>
      <span class="k">throw</span> <span class="k">new</span> <span class="nf">BeanCreationException</span><span class="o">(</span>
            <span class="n">mbd</span><span class="o">.</span><span class="na">getResourceDescription</span><span class="o">(),</span> <span class="n">beanName</span><span class="o">,</span> <span class="s">"Invalid destruction signature"</span><span class="o">,</span> <span class="n">ex</span><span class="o">);</span>
   <span class="o">}</span>

   <span class="k">return</span> <span class="n">exposedObject</span><span class="o">;</span>
<span class="o">}</span>
</pre></td></tr></tbody></table></code></pre></div></div>

<p>åˆ°è¿™é‡Œï¼Œæˆ‘ä»¬å·²ç»åˆ†æå®Œäº† doCreateBean æ–¹æ³•ï¼Œæ€»çš„æ¥è¯´ï¼Œæˆ‘ä»¬å·²ç»è¯´å®Œäº†æ•´ä¸ªåˆå§‹åŒ–æµç¨‹ã€‚</p>

<p>æ¥ä¸‹æ¥æˆ‘ä»¬æŒ‘ doCreateBean ä¸­çš„ä¸‰ä¸ªç»†èŠ‚å‡ºæ¥è¯´è¯´ã€‚ä¸€ä¸ªæ˜¯åˆ›å»º Bean å®ä¾‹çš„ createBeanInstance æ–¹æ³•ï¼Œä¸€ä¸ªæ˜¯ä¾èµ–æ³¨å…¥çš„ populateBean æ–¹æ³•ï¼Œè¿˜æœ‰å°±æ˜¯å›è°ƒæ–¹æ³• initializeBeanã€‚</p>

<p>æ³¨æ„äº†ï¼Œæ¥ä¸‹æ¥çš„è¿™ä¸‰ä¸ªæ–¹æ³•è¦è®¤çœŸè¯´é‚£ä¹Ÿæ˜¯æå…¶å¤æ‚çš„ï¼Œå¾ˆå¤šåœ°æ–¹æˆ‘å°±ç‚¹åˆ°ä¸ºæ­¢äº†ï¼Œæ„Ÿå…´è¶£çš„è¯»è€…å¯ä»¥è‡ªå·±å¾€é‡Œçœ‹ï¼Œæœ€å¥½å°±æ˜¯ç¢°åˆ°ä¸æ‡‚çš„ï¼Œè‡ªå·±å†™ä»£ç å»è°ƒè¯•å®ƒã€‚</p>

<h5 id="åˆ›å»º-bean-å®ä¾‹">åˆ›å»º Bean å®ä¾‹</h5>

<p>æˆ‘ä»¬å…ˆçœ‹çœ‹ createBeanInstance æ–¹æ³•ã€‚éœ€è¦è¯´æ˜çš„æ˜¯ï¼Œè¿™ä¸ªæ–¹æ³•å¦‚æœæ¯ä¸ªåˆ†æ”¯éƒ½åˆ†æä¸‹å»ï¼Œå¿…ç„¶ä¹Ÿæ˜¯æå…¶å¤æ‚å†—é•¿çš„ï¼Œæˆ‘ä»¬æŒ‘é‡ç‚¹è¯´ã€‚æ­¤æ–¹æ³•çš„ç›®çš„å°±æ˜¯å®ä¾‹åŒ–æˆ‘ä»¬æŒ‡å®šçš„ç±»ã€‚</p>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
44
45
46
47
48
49
50
</pre></td><td class="rouge-code"><pre><span class="kd">protected</span> <span class="nc">BeanWrapper</span> <span class="nf">createBeanInstance</span><span class="o">(</span><span class="nc">String</span> <span class="n">beanName</span><span class="o">,</span> <span class="nc">RootBeanDefinition</span> <span class="n">mbd</span><span class="o">,</span> <span class="nc">Object</span><span class="o">[]</span> <span class="n">args</span><span class="o">)</span> <span class="o">{</span>
   <span class="c1">// ç¡®ä¿å·²ç»åŠ è½½äº†æ­¤ class</span>
   <span class="nc">Class</span><span class="o">&lt;?&gt;</span> <span class="n">beanClass</span> <span class="o">=</span> <span class="n">resolveBeanClass</span><span class="o">(</span><span class="n">mbd</span><span class="o">,</span> <span class="n">beanName</span><span class="o">);</span>

   <span class="c1">// æ ¡éªŒä¸€ä¸‹è¿™ä¸ªç±»çš„è®¿é—®æƒé™</span>
   <span class="k">if</span> <span class="o">(</span><span class="n">beanClass</span> <span class="o">!=</span> <span class="kc">null</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="nc">Modifier</span><span class="o">.</span><span class="na">isPublic</span><span class="o">(</span><span class="n">beanClass</span><span class="o">.</span><span class="na">getModifiers</span><span class="o">())</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="n">mbd</span><span class="o">.</span><span class="na">isNonPublicAccessAllowed</span><span class="o">())</span> <span class="o">{</span>
      <span class="k">throw</span> <span class="k">new</span> <span class="nf">BeanCreationException</span><span class="o">(</span><span class="n">mbd</span><span class="o">.</span><span class="na">getResourceDescription</span><span class="o">(),</span> <span class="n">beanName</span><span class="o">,</span>
            <span class="s">"Bean class isn't public, and non-public access not allowed: "</span> <span class="o">+</span> <span class="n">beanClass</span><span class="o">.</span><span class="na">getName</span><span class="o">());</span>
   <span class="o">}</span>

   <span class="k">if</span> <span class="o">(</span><span class="n">mbd</span><span class="o">.</span><span class="na">getFactoryMethodName</span><span class="o">()</span> <span class="o">!=</span> <span class="kc">null</span><span class="o">)</span>  <span class="o">{</span>
      <span class="c1">// é‡‡ç”¨å·¥å‚æ–¹æ³•å®ä¾‹åŒ–ï¼Œä¸ç†Ÿæ‚‰è¿™ä¸ªæ¦‚å¿µçš„è¯»è€…è¯·çœ‹é™„å½•ï¼Œæ³¨æ„ï¼Œä¸æ˜¯ FactoryBean</span>
      <span class="k">return</span> <span class="nf">instantiateUsingFactoryMethod</span><span class="o">(</span><span class="n">beanName</span><span class="o">,</span> <span class="n">mbd</span><span class="o">,</span> <span class="n">args</span><span class="o">);</span>
   <span class="o">}</span>

   <span class="c1">// å¦‚æœä¸æ˜¯ç¬¬ä¸€æ¬¡åˆ›å»ºï¼Œæ¯”å¦‚ç¬¬äºŒæ¬¡åˆ›å»º prototype beanã€‚</span>
   <span class="c1">// è¿™ç§æƒ…å†µä¸‹ï¼Œæˆ‘ä»¬å¯ä»¥ä»ç¬¬ä¸€æ¬¡åˆ›å»ºçŸ¥é“ï¼Œé‡‡ç”¨æ— å‚æ„é€ å‡½æ•°ï¼Œè¿˜æ˜¯æ„é€ å‡½æ•°ä¾èµ–æ³¨å…¥ æ¥å®Œæˆå®ä¾‹åŒ–</span>
   <span class="kt">boolean</span> <span class="n">resolved</span> <span class="o">=</span> <span class="kc">false</span><span class="o">;</span>
   <span class="kt">boolean</span> <span class="n">autowireNecessary</span> <span class="o">=</span> <span class="kc">false</span><span class="o">;</span>
   <span class="k">if</span> <span class="o">(</span><span class="n">args</span> <span class="o">==</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
      <span class="kd">synchronized</span> <span class="o">(</span><span class="n">mbd</span><span class="o">.</span><span class="na">constructorArgumentLock</span><span class="o">)</span> <span class="o">{</span>
         <span class="k">if</span> <span class="o">(</span><span class="n">mbd</span><span class="o">.</span><span class="na">resolvedConstructorOrFactoryMethod</span> <span class="o">!=</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
            <span class="n">resolved</span> <span class="o">=</span> <span class="kc">true</span><span class="o">;</span>
            <span class="n">autowireNecessary</span> <span class="o">=</span> <span class="n">mbd</span><span class="o">.</span><span class="na">constructorArgumentsResolved</span><span class="o">;</span>
         <span class="o">}</span>
      <span class="o">}</span>
   <span class="o">}</span>
   <span class="k">if</span> <span class="o">(</span><span class="n">resolved</span><span class="o">)</span> <span class="o">{</span>
      <span class="k">if</span> <span class="o">(</span><span class="n">autowireNecessary</span><span class="o">)</span> <span class="o">{</span>
         <span class="c1">// æ„é€ å‡½æ•°ä¾èµ–æ³¨å…¥</span>
         <span class="k">return</span> <span class="nf">autowireConstructor</span><span class="o">(</span><span class="n">beanName</span><span class="o">,</span> <span class="n">mbd</span><span class="o">,</span> <span class="kc">null</span><span class="o">,</span> <span class="kc">null</span><span class="o">);</span>
      <span class="o">}</span>
      <span class="k">else</span> <span class="o">{</span>
         <span class="c1">// æ— å‚æ„é€ å‡½æ•°</span>
         <span class="k">return</span> <span class="nf">instantiateBean</span><span class="o">(</span><span class="n">beanName</span><span class="o">,</span> <span class="n">mbd</span><span class="o">);</span>
      <span class="o">}</span>
   <span class="o">}</span>

   <span class="c1">// åˆ¤æ–­æ˜¯å¦é‡‡ç”¨æœ‰å‚æ„é€ å‡½æ•°</span>
   <span class="nc">Constructor</span><span class="o">&lt;?&gt;[]</span> <span class="n">ctors</span> <span class="o">=</span> <span class="n">determineConstructorsFromBeanPostProcessors</span><span class="o">(</span><span class="n">beanClass</span><span class="o">,</span> <span class="n">beanName</span><span class="o">);</span>
   <span class="k">if</span> <span class="o">(</span><span class="n">ctors</span> <span class="o">!=</span> <span class="kc">null</span> <span class="o">||</span>
         <span class="n">mbd</span><span class="o">.</span><span class="na">getResolvedAutowireMode</span><span class="o">()</span> <span class="o">==</span> <span class="nc">RootBeanDefinition</span><span class="o">.</span><span class="na">AUTOWIRE_CONSTRUCTOR</span> <span class="o">||</span>
         <span class="n">mbd</span><span class="o">.</span><span class="na">hasConstructorArgumentValues</span><span class="o">()</span> <span class="o">||</span> <span class="o">!</span><span class="nc">ObjectUtils</span><span class="o">.</span><span class="na">isEmpty</span><span class="o">(</span><span class="n">args</span><span class="o">))</span>  <span class="o">{</span>
      <span class="c1">// æ„é€ å‡½æ•°ä¾èµ–æ³¨å…¥</span>
      <span class="k">return</span> <span class="nf">autowireConstructor</span><span class="o">(</span><span class="n">beanName</span><span class="o">,</span> <span class="n">mbd</span><span class="o">,</span> <span class="n">ctors</span><span class="o">,</span> <span class="n">args</span><span class="o">);</span>
   <span class="o">}</span>

   <span class="c1">// è°ƒç”¨æ— å‚æ„é€ å‡½æ•°</span>
   <span class="k">return</span> <span class="nf">instantiateBean</span><span class="o">(</span><span class="n">beanName</span><span class="o">,</span> <span class="n">mbd</span><span class="o">);</span>
<span class="o">}</span>
</pre></td></tr></tbody></table></code></pre></div></div>

<p>æŒ‘ä¸ªç®€å•çš„<strong>æ— å‚æ„é€ å‡½æ•°</strong>æ„é€ å®ä¾‹æ¥çœ‹çœ‹ï¼š</p>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
</pre></td><td class="rouge-code"><pre><span class="kd">protected</span> <span class="nc">BeanWrapper</span> <span class="nf">instantiateBean</span><span class="o">(</span><span class="kd">final</span> <span class="nc">String</span> <span class="n">beanName</span><span class="o">,</span> <span class="kd">final</span> <span class="nc">RootBeanDefinition</span> <span class="n">mbd</span><span class="o">)</span> <span class="o">{</span>
   <span class="k">try</span> <span class="o">{</span>
      <span class="nc">Object</span> <span class="n">beanInstance</span><span class="o">;</span>
      <span class="kd">final</span> <span class="nc">BeanFactory</span> <span class="n">parent</span> <span class="o">=</span> <span class="k">this</span><span class="o">;</span>
      <span class="k">if</span> <span class="o">(</span><span class="nc">System</span><span class="o">.</span><span class="na">getSecurityManager</span><span class="o">()</span> <span class="o">!=</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
         <span class="n">beanInstance</span> <span class="o">=</span> <span class="nc">AccessController</span><span class="o">.</span><span class="na">doPrivileged</span><span class="o">(</span><span class="k">new</span> <span class="nc">PrivilegedAction</span><span class="o">&lt;</span><span class="nc">Object</span><span class="o">&gt;()</span> <span class="o">{</span>
            <span class="nd">@Override</span>
            <span class="kd">public</span> <span class="nc">Object</span> <span class="nf">run</span><span class="o">()</span> <span class="o">{</span>
               
               <span class="k">return</span> <span class="nf">getInstantiationStrategy</span><span class="o">().</span><span class="na">instantiate</span><span class="o">(</span><span class="n">mbd</span><span class="o">,</span> <span class="n">beanName</span><span class="o">,</span> <span class="n">parent</span><span class="o">);</span>
            <span class="o">}</span>
         <span class="o">},</span> <span class="n">getAccessControlContext</span><span class="o">());</span>
      <span class="o">}</span>
      <span class="k">else</span> <span class="o">{</span>
         <span class="c1">// å®ä¾‹åŒ–</span>
         <span class="n">beanInstance</span> <span class="o">=</span> <span class="n">getInstantiationStrategy</span><span class="o">().</span><span class="na">instantiate</span><span class="o">(</span><span class="n">mbd</span><span class="o">,</span> <span class="n">beanName</span><span class="o">,</span> <span class="n">parent</span><span class="o">);</span>
      <span class="o">}</span>
      <span class="c1">// åŒ…è£…ä¸€ä¸‹ï¼Œè¿”å›</span>
      <span class="nc">BeanWrapper</span> <span class="n">bw</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">BeanWrapperImpl</span><span class="o">(</span><span class="n">beanInstance</span><span class="o">);</span>
      <span class="n">initBeanWrapper</span><span class="o">(</span><span class="n">bw</span><span class="o">);</span>
      <span class="k">return</span> <span class="n">bw</span><span class="o">;</span>
   <span class="o">}</span>
   <span class="k">catch</span> <span class="o">(</span><span class="nc">Throwable</span> <span class="n">ex</span><span class="o">)</span> <span class="o">{</span>
      <span class="k">throw</span> <span class="k">new</span> <span class="nf">BeanCreationException</span><span class="o">(</span>
            <span class="n">mbd</span><span class="o">.</span><span class="na">getResourceDescription</span><span class="o">(),</span> <span class="n">beanName</span><span class="o">,</span> <span class="s">"Instantiation of bean failed"</span><span class="o">,</span> <span class="n">ex</span><span class="o">);</span>
   <span class="o">}</span>
<span class="o">}</span>
</pre></td></tr></tbody></table></code></pre></div></div>

<p>æˆ‘ä»¬å¯ä»¥çœ‹åˆ°ï¼Œå…³é”®çš„åœ°æ–¹åœ¨äºï¼š</p>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre></td><td class="rouge-code"><pre><span class="n">beanInstance</span> <span class="o">=</span> <span class="n">getInstantiationStrategy</span><span class="o">().</span><span class="na">instantiate</span><span class="o">(</span><span class="n">mbd</span><span class="o">,</span> <span class="n">beanName</span><span class="o">,</span> <span class="n">parent</span><span class="o">);</span>
</pre></td></tr></tbody></table></code></pre></div></div>

<p>è¿™é‡Œä¼šè¿›è¡Œå®é™…çš„å®ä¾‹åŒ–è¿‡ç¨‹ï¼Œæˆ‘ä»¬è¿›å»çœ‹çœ‹:</p>

<p>// SimpleInstantiationStrategy 59</p>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
</pre></td><td class="rouge-code"><pre><span class="nd">@Override</span>
<span class="kd">public</span> <span class="nc">Object</span> <span class="nf">instantiate</span><span class="o">(</span><span class="nc">RootBeanDefinition</span> <span class="n">bd</span><span class="o">,</span> <span class="nc">String</span> <span class="n">beanName</span><span class="o">,</span> <span class="nc">BeanFactory</span> <span class="n">owner</span><span class="o">)</span> <span class="o">{</span>

   <span class="c1">// å¦‚æœä¸å­˜åœ¨æ–¹æ³•è¦†å†™ï¼Œé‚£å°±ä½¿ç”¨ java åå°„è¿›è¡Œå®ä¾‹åŒ–ï¼Œå¦åˆ™ä½¿ç”¨ CGLIB,</span>
   <span class="c1">// æ–¹æ³•è¦†å†™ è¯·å‚è§é™„å½•"æ–¹æ³•æ³¨å…¥"ä¸­å¯¹ lookup-method å’Œ replaced-method çš„ä»‹ç»</span>
   <span class="k">if</span> <span class="o">(</span><span class="n">bd</span><span class="o">.</span><span class="na">getMethodOverrides</span><span class="o">().</span><span class="na">isEmpty</span><span class="o">())</span> <span class="o">{</span>
      <span class="nc">Constructor</span><span class="o">&lt;?&gt;</span> <span class="n">constructorToUse</span><span class="o">;</span>
      <span class="kd">synchronized</span> <span class="o">(</span><span class="n">bd</span><span class="o">.</span><span class="na">constructorArgumentLock</span><span class="o">)</span> <span class="o">{</span>
         <span class="n">constructorToUse</span> <span class="o">=</span> <span class="o">(</span><span class="nc">Constructor</span><span class="o">&lt;?&gt;)</span> <span class="n">bd</span><span class="o">.</span><span class="na">resolvedConstructorOrFactoryMethod</span><span class="o">;</span>
         <span class="k">if</span> <span class="o">(</span><span class="n">constructorToUse</span> <span class="o">==</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
            <span class="kd">final</span> <span class="nc">Class</span><span class="o">&lt;?&gt;</span> <span class="n">clazz</span> <span class="o">=</span> <span class="n">bd</span><span class="o">.</span><span class="na">getBeanClass</span><span class="o">();</span>
            <span class="k">if</span> <span class="o">(</span><span class="n">clazz</span><span class="o">.</span><span class="na">isInterface</span><span class="o">())</span> <span class="o">{</span>
               <span class="k">throw</span> <span class="k">new</span> <span class="nf">BeanInstantiationException</span><span class="o">(</span><span class="n">clazz</span><span class="o">,</span> <span class="s">"Specified class is an interface"</span><span class="o">);</span>
            <span class="o">}</span>
            <span class="k">try</span> <span class="o">{</span>
               <span class="k">if</span> <span class="o">(</span><span class="nc">System</span><span class="o">.</span><span class="na">getSecurityManager</span><span class="o">()</span> <span class="o">!=</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
                  <span class="n">constructorToUse</span> <span class="o">=</span> <span class="nc">AccessController</span><span class="o">.</span><span class="na">doPrivileged</span><span class="o">(</span><span class="k">new</span> <span class="nc">PrivilegedExceptionAction</span><span class="o">&lt;</span><span class="nc">Constructor</span><span class="o">&lt;?&gt;&gt;()</span> <span class="o">{</span>
                     <span class="nd">@Override</span>
                     <span class="kd">public</span> <span class="nc">Constructor</span><span class="o">&lt;?&gt;</span> <span class="n">run</span><span class="o">()</span> <span class="kd">throws</span> <span class="nc">Exception</span> <span class="o">{</span>
                        <span class="k">return</span> <span class="n">clazz</span><span class="o">.</span><span class="na">getDeclaredConstructor</span><span class="o">((</span><span class="nc">Class</span><span class="o">[])</span> <span class="kc">null</span><span class="o">);</span>
                     <span class="o">}</span>
                  <span class="o">});</span>
               <span class="o">}</span>
               <span class="k">else</span> <span class="o">{</span>
                  <span class="n">constructorToUse</span> <span class="o">=</span> <span class="n">clazz</span><span class="o">.</span><span class="na">getDeclaredConstructor</span><span class="o">((</span><span class="nc">Class</span><span class="o">[])</span> <span class="kc">null</span><span class="o">);</span>
               <span class="o">}</span>
               <span class="n">bd</span><span class="o">.</span><span class="na">resolvedConstructorOrFactoryMethod</span> <span class="o">=</span> <span class="n">constructorToUse</span><span class="o">;</span>
            <span class="o">}</span>
            <span class="k">catch</span> <span class="o">(</span><span class="nc">Throwable</span> <span class="n">ex</span><span class="o">)</span> <span class="o">{</span>
               <span class="k">throw</span> <span class="k">new</span> <span class="nf">BeanInstantiationException</span><span class="o">(</span><span class="n">clazz</span><span class="o">,</span> <span class="s">"No default constructor found"</span><span class="o">,</span> <span class="n">ex</span><span class="o">);</span>
            <span class="o">}</span>
         <span class="o">}</span>
      <span class="o">}</span>
      <span class="c1">// åˆ©ç”¨æ„é€ æ–¹æ³•è¿›è¡Œå®ä¾‹åŒ–</span>
      <span class="k">return</span> <span class="nc">BeanUtils</span><span class="o">.</span><span class="na">instantiateClass</span><span class="o">(</span><span class="n">constructorToUse</span><span class="o">);</span>
   <span class="o">}</span>
   <span class="k">else</span> <span class="o">{</span>
      <span class="c1">// å­˜åœ¨æ–¹æ³•è¦†å†™ï¼Œåˆ©ç”¨ CGLIB æ¥å®Œæˆå®ä¾‹åŒ–ï¼Œéœ€è¦ä¾èµ–äº CGLIB ç”Ÿæˆå­ç±»ï¼Œè¿™é‡Œå°±ä¸å±•å¼€äº†ã€‚</span>
      <span class="c1">// tips: å› ä¸ºå¦‚æœä¸ä½¿ç”¨ CGLIB çš„è¯ï¼Œå­˜åœ¨ override çš„æƒ…å†µ JDK å¹¶æ²¡æœ‰æä¾›ç›¸åº”çš„å®ä¾‹åŒ–æ”¯æŒ</span>
      <span class="k">return</span> <span class="nf">instantiateWithMethodInjection</span><span class="o">(</span><span class="n">bd</span><span class="o">,</span> <span class="n">beanName</span><span class="o">,</span> <span class="n">owner</span><span class="o">);</span>
   <span class="o">}</span>
<span class="o">}</span>
</pre></td></tr></tbody></table></code></pre></div></div>

<p>åˆ°è¿™é‡Œï¼Œæˆ‘ä»¬å°±ç®—å®ä¾‹åŒ–å®Œæˆäº†ã€‚æˆ‘ä»¬å¼€å§‹è¯´æ€ä¹ˆè¿›è¡Œå±æ€§æ³¨å…¥ã€‚</p>

<h5 id="bean-å±æ€§æ³¨å…¥">bean å±æ€§æ³¨å…¥</h5>

<p>çœ‹å®Œäº† createBeanInstance(â€¦) æ–¹æ³•ï¼Œæˆ‘ä»¬æ¥çœ‹çœ‹ populateBean(â€¦) æ–¹æ³•ï¼Œè¯¥æ–¹æ³•è´Ÿè´£è¿›è¡Œå±æ€§è®¾å€¼ï¼Œå¤„ç†ä¾èµ–ã€‚</p>

<p>// AbstractAutowireCapableBeanFactory 1203</p>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
44
45
46
47
48
49
50
51
52
53
54
55
56
57
58
59
60
61
62
63
64
65
66
67
68
69
70
71
72
73
74
75
76
77
78
</pre></td><td class="rouge-code"><pre><span class="kd">protected</span> <span class="kt">void</span> <span class="nf">populateBean</span><span class="o">(</span><span class="nc">String</span> <span class="n">beanName</span><span class="o">,</span> <span class="nc">RootBeanDefinition</span> <span class="n">mbd</span><span class="o">,</span> <span class="nc">BeanWrapper</span> <span class="n">bw</span><span class="o">)</span> <span class="o">{</span>
   <span class="c1">// bean å®ä¾‹çš„æ‰€æœ‰å±æ€§éƒ½åœ¨è¿™é‡Œäº†</span>
   <span class="nc">PropertyValues</span> <span class="n">pvs</span> <span class="o">=</span> <span class="n">mbd</span><span class="o">.</span><span class="na">getPropertyValues</span><span class="o">();</span>

   <span class="k">if</span> <span class="o">(</span><span class="n">bw</span> <span class="o">==</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
      <span class="k">if</span> <span class="o">(!</span><span class="n">pvs</span><span class="o">.</span><span class="na">isEmpty</span><span class="o">())</span> <span class="o">{</span>
         <span class="k">throw</span> <span class="k">new</span> <span class="nf">BeanCreationException</span><span class="o">(</span>
               <span class="n">mbd</span><span class="o">.</span><span class="na">getResourceDescription</span><span class="o">(),</span> <span class="n">beanName</span><span class="o">,</span> <span class="s">"Cannot apply property values to null instance"</span><span class="o">);</span>
      <span class="o">}</span>
      <span class="k">else</span> <span class="o">{</span>
         <span class="c1">// Skip property population phase for null instance.</span>
         <span class="k">return</span><span class="o">;</span>
      <span class="o">}</span>
   <span class="o">}</span>

   <span class="c1">// åˆ°è¿™æ­¥çš„æ—¶å€™ï¼Œbean å®ä¾‹åŒ–å®Œæˆï¼ˆé€šè¿‡å·¥å‚æ–¹æ³•æˆ–æ„é€ æ–¹æ³•ï¼‰ï¼Œä½†æ˜¯è¿˜æ²¡å¼€å§‹å±æ€§è®¾å€¼ï¼Œ</span>
   <span class="c1">// InstantiationAwareBeanPostProcessor çš„å®ç°ç±»å¯ä»¥åœ¨è¿™é‡Œå¯¹ bean è¿›è¡ŒçŠ¶æ€ä¿®æ”¹ï¼Œ</span>
   <span class="c1">// æˆ‘ä¹Ÿæ²¡æ‰¾åˆ°æœ‰å®é™…çš„ä½¿ç”¨ï¼Œæ‰€ä»¥æˆ‘ä»¬æš‚ä¸”å¿½ç•¥è¿™å—å§</span>
   <span class="kt">boolean</span> <span class="n">continueWithPropertyPopulation</span> <span class="o">=</span> <span class="kc">true</span><span class="o">;</span>
   <span class="k">if</span> <span class="o">(!</span><span class="n">mbd</span><span class="o">.</span><span class="na">isSynthetic</span><span class="o">()</span> <span class="o">&amp;&amp;</span> <span class="n">hasInstantiationAwareBeanPostProcessors</span><span class="o">())</span> <span class="o">{</span>
      <span class="k">for</span> <span class="o">(</span><span class="nc">BeanPostProcessor</span> <span class="n">bp</span> <span class="o">:</span> <span class="n">getBeanPostProcessors</span><span class="o">())</span> <span class="o">{</span>
         <span class="k">if</span> <span class="o">(</span><span class="n">bp</span> <span class="k">instanceof</span> <span class="nc">InstantiationAwareBeanPostProcessor</span><span class="o">)</span> <span class="o">{</span>
            <span class="nc">InstantiationAwareBeanPostProcessor</span> <span class="n">ibp</span> <span class="o">=</span> <span class="o">(</span><span class="nc">InstantiationAwareBeanPostProcessor</span><span class="o">)</span> <span class="n">bp</span><span class="o">;</span>
            <span class="c1">// å¦‚æœè¿”å› falseï¼Œä»£è¡¨ä¸éœ€è¦è¿›è¡Œåç»­çš„å±æ€§è®¾å€¼ï¼Œä¹Ÿä¸éœ€è¦å†ç»è¿‡å…¶ä»–çš„ BeanPostProcessor çš„å¤„ç†</span>
            <span class="k">if</span> <span class="o">(!</span><span class="n">ibp</span><span class="o">.</span><span class="na">postProcessAfterInstantiation</span><span class="o">(</span><span class="n">bw</span><span class="o">.</span><span class="na">getWrappedInstance</span><span class="o">(),</span> <span class="n">beanName</span><span class="o">))</span> <span class="o">{</span>
               <span class="n">continueWithPropertyPopulation</span> <span class="o">=</span> <span class="kc">false</span><span class="o">;</span>
               <span class="k">break</span><span class="o">;</span>
            <span class="o">}</span>
         <span class="o">}</span>
      <span class="o">}</span>
   <span class="o">}</span>

   <span class="k">if</span> <span class="o">(!</span><span class="n">continueWithPropertyPopulation</span><span class="o">)</span> <span class="o">{</span>
      <span class="k">return</span><span class="o">;</span>
   <span class="o">}</span>

   <span class="k">if</span> <span class="o">(</span><span class="n">mbd</span><span class="o">.</span><span class="na">getResolvedAutowireMode</span><span class="o">()</span> <span class="o">==</span> <span class="nc">RootBeanDefinition</span><span class="o">.</span><span class="na">AUTOWIRE_BY_NAME</span> <span class="o">||</span>
         <span class="n">mbd</span><span class="o">.</span><span class="na">getResolvedAutowireMode</span><span class="o">()</span> <span class="o">==</span> <span class="nc">RootBeanDefinition</span><span class="o">.</span><span class="na">AUTOWIRE_BY_TYPE</span><span class="o">)</span> <span class="o">{</span>
      <span class="nc">MutablePropertyValues</span> <span class="n">newPvs</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">MutablePropertyValues</span><span class="o">(</span><span class="n">pvs</span><span class="o">);</span>

      <span class="c1">// é€šè¿‡åå­—æ‰¾åˆ°æ‰€æœ‰å±æ€§å€¼ï¼Œå¦‚æœæ˜¯ bean ä¾èµ–ï¼Œå…ˆåˆå§‹åŒ–ä¾èµ–çš„ beanã€‚è®°å½•ä¾èµ–å…³ç³»</span>
      <span class="k">if</span> <span class="o">(</span><span class="n">mbd</span><span class="o">.</span><span class="na">getResolvedAutowireMode</span><span class="o">()</span> <span class="o">==</span> <span class="nc">RootBeanDefinition</span><span class="o">.</span><span class="na">AUTOWIRE_BY_NAME</span><span class="o">)</span> <span class="o">{</span>
         <span class="n">autowireByName</span><span class="o">(</span><span class="n">beanName</span><span class="o">,</span> <span class="n">mbd</span><span class="o">,</span> <span class="n">bw</span><span class="o">,</span> <span class="n">newPvs</span><span class="o">);</span>
      <span class="o">}</span>

      <span class="c1">// é€šè¿‡ç±»å‹è£…é…ã€‚å¤æ‚ä¸€äº›</span>
      <span class="k">if</span> <span class="o">(</span><span class="n">mbd</span><span class="o">.</span><span class="na">getResolvedAutowireMode</span><span class="o">()</span> <span class="o">==</span> <span class="nc">RootBeanDefinition</span><span class="o">.</span><span class="na">AUTOWIRE_BY_TYPE</span><span class="o">)</span> <span class="o">{</span>
         <span class="n">autowireByType</span><span class="o">(</span><span class="n">beanName</span><span class="o">,</span> <span class="n">mbd</span><span class="o">,</span> <span class="n">bw</span><span class="o">,</span> <span class="n">newPvs</span><span class="o">);</span>
      <span class="o">}</span>

      <span class="n">pvs</span> <span class="o">=</span> <span class="n">newPvs</span><span class="o">;</span>
   <span class="o">}</span>

   <span class="kt">boolean</span> <span class="n">hasInstAwareBpps</span> <span class="o">=</span> <span class="n">hasInstantiationAwareBeanPostProcessors</span><span class="o">();</span>
   <span class="kt">boolean</span> <span class="n">needsDepCheck</span> <span class="o">=</span> <span class="o">(</span><span class="n">mbd</span><span class="o">.</span><span class="na">getDependencyCheck</span><span class="o">()</span> <span class="o">!=</span> <span class="nc">RootBeanDefinition</span><span class="o">.</span><span class="na">DEPENDENCY_CHECK_NONE</span><span class="o">);</span>

   <span class="k">if</span> <span class="o">(</span><span class="n">hasInstAwareBpps</span> <span class="o">||</span> <span class="n">needsDepCheck</span><span class="o">)</span> <span class="o">{</span>
      <span class="nc">PropertyDescriptor</span><span class="o">[]</span> <span class="n">filteredPds</span> <span class="o">=</span> <span class="n">filterPropertyDescriptorsForDependencyCheck</span><span class="o">(</span><span class="n">bw</span><span class="o">,</span> <span class="n">mbd</span><span class="o">.</span><span class="na">allowCaching</span><span class="o">);</span>
      <span class="k">if</span> <span class="o">(</span><span class="n">hasInstAwareBpps</span><span class="o">)</span> <span class="o">{</span>
         <span class="k">for</span> <span class="o">(</span><span class="nc">BeanPostProcessor</span> <span class="n">bp</span> <span class="o">:</span> <span class="n">getBeanPostProcessors</span><span class="o">())</span> <span class="o">{</span>
            <span class="k">if</span> <span class="o">(</span><span class="n">bp</span> <span class="k">instanceof</span> <span class="nc">InstantiationAwareBeanPostProcessor</span><span class="o">)</span> <span class="o">{</span>
               <span class="nc">InstantiationAwareBeanPostProcessor</span> <span class="n">ibp</span> <span class="o">=</span> <span class="o">(</span><span class="nc">InstantiationAwareBeanPostProcessor</span><span class="o">)</span> <span class="n">bp</span><span class="o">;</span>
               <span class="c1">// è¿™é‡Œæœ‰ä¸ªéå¸¸æœ‰ç”¨çš„ BeanPostProcessor è¿›åˆ°è¿™é‡Œ: AutowiredAnnotationBeanPostProcessor</span>
               <span class="c1">// å¯¹é‡‡ç”¨ @Autowiredã€@Value æ³¨è§£çš„ä¾èµ–è¿›è¡Œè®¾å€¼ï¼Œè¿™é‡Œçš„å†…å®¹ä¹Ÿæ˜¯éå¸¸ä¸°å¯Œçš„ï¼Œä¸è¿‡æœ¬æ–‡ä¸ä¼šå±•å¼€è¯´äº†ï¼Œæ„Ÿå…´è¶£çš„è¯»è€…è¯·è‡ªè¡Œç ”ç©¶</span>
               <span class="n">pvs</span> <span class="o">=</span> <span class="n">ibp</span><span class="o">.</span><span class="na">postProcessPropertyValues</span><span class="o">(</span><span class="n">pvs</span><span class="o">,</span> <span class="n">filteredPds</span><span class="o">,</span> <span class="n">bw</span><span class="o">.</span><span class="na">getWrappedInstance</span><span class="o">(),</span> <span class="n">beanName</span><span class="o">);</span>
               <span class="k">if</span> <span class="o">(</span><span class="n">pvs</span> <span class="o">==</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
                  <span class="k">return</span><span class="o">;</span>
               <span class="o">}</span>
            <span class="o">}</span>
         <span class="o">}</span>
      <span class="o">}</span>
      <span class="k">if</span> <span class="o">(</span><span class="n">needsDepCheck</span><span class="o">)</span> <span class="o">{</span>
         <span class="n">checkDependencies</span><span class="o">(</span><span class="n">beanName</span><span class="o">,</span> <span class="n">mbd</span><span class="o">,</span> <span class="n">filteredPds</span><span class="o">,</span> <span class="n">pvs</span><span class="o">);</span>
      <span class="o">}</span>
   <span class="o">}</span>
   <span class="c1">// è®¾ç½® bean å®ä¾‹çš„å±æ€§å€¼</span>
   <span class="n">applyPropertyValues</span><span class="o">(</span><span class="n">beanName</span><span class="o">,</span> <span class="n">mbd</span><span class="o">,</span> <span class="n">bw</span><span class="o">,</span> <span class="n">pvs</span><span class="o">);</span>
<span class="o">}</span>
</pre></td></tr></tbody></table></code></pre></div></div>

<h5 id="initializebean">initializeBean</h5>

<p>å±æ€§æ³¨å…¥å®Œæˆåï¼Œè¿™ä¸€æ­¥å…¶å®å°±æ˜¯å¤„ç†å„ç§å›è°ƒäº†ï¼Œè¿™å—ä»£ç æ¯”è¾ƒç®€å•ã€‚</p>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
</pre></td><td class="rouge-code"><pre><span class="kd">protected</span> <span class="nc">Object</span> <span class="nf">initializeBean</span><span class="o">(</span><span class="kd">final</span> <span class="nc">String</span> <span class="n">beanName</span><span class="o">,</span> <span class="kd">final</span> <span class="nc">Object</span> <span class="n">bean</span><span class="o">,</span> <span class="nc">RootBeanDefinition</span> <span class="n">mbd</span><span class="o">)</span> <span class="o">{</span>
   <span class="k">if</span> <span class="o">(</span><span class="nc">System</span><span class="o">.</span><span class="na">getSecurityManager</span><span class="o">()</span> <span class="o">!=</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
      <span class="nc">AccessController</span><span class="o">.</span><span class="na">doPrivileged</span><span class="o">(</span><span class="k">new</span> <span class="nc">PrivilegedAction</span><span class="o">&lt;</span><span class="nc">Object</span><span class="o">&gt;()</span> <span class="o">{</span>
         <span class="nd">@Override</span>
         <span class="kd">public</span> <span class="nc">Object</span> <span class="nf">run</span><span class="o">()</span> <span class="o">{</span>
            <span class="n">invokeAwareMethods</span><span class="o">(</span><span class="n">beanName</span><span class="o">,</span> <span class="n">bean</span><span class="o">);</span>
            <span class="k">return</span> <span class="kc">null</span><span class="o">;</span>
         <span class="o">}</span>
      <span class="o">},</span> <span class="n">getAccessControlContext</span><span class="o">());</span>
   <span class="o">}</span>
   <span class="k">else</span> <span class="o">{</span>
      <span class="c1">// å¦‚æœ bean å®ç°äº† BeanNameAwareã€BeanClassLoaderAware æˆ– BeanFactoryAware æ¥å£ï¼Œå›è°ƒ</span>
      <span class="n">invokeAwareMethods</span><span class="o">(</span><span class="n">beanName</span><span class="o">,</span> <span class="n">bean</span><span class="o">);</span>
   <span class="o">}</span>

   <span class="nc">Object</span> <span class="n">wrappedBean</span> <span class="o">=</span> <span class="n">bean</span><span class="o">;</span>
   <span class="k">if</span> <span class="o">(</span><span class="n">mbd</span> <span class="o">==</span> <span class="kc">null</span> <span class="o">||</span> <span class="o">!</span><span class="n">mbd</span><span class="o">.</span><span class="na">isSynthetic</span><span class="o">())</span> <span class="o">{</span>
      <span class="c1">// BeanPostProcessor çš„ postProcessBeforeInitialization å›è°ƒ</span>
      <span class="n">wrappedBean</span> <span class="o">=</span> <span class="n">applyBeanPostProcessorsBeforeInitialization</span><span class="o">(</span><span class="n">wrappedBean</span><span class="o">,</span> <span class="n">beanName</span><span class="o">);</span>
   <span class="o">}</span>

   <span class="k">try</span> <span class="o">{</span>
      <span class="c1">// å¤„ç† bean ä¸­å®šä¹‰çš„ init-methodï¼Œ</span>
      <span class="c1">// æˆ–è€…å¦‚æœ bean å®ç°äº† InitializingBean æ¥å£ï¼Œè°ƒç”¨ afterPropertiesSet() æ–¹æ³•</span>
      <span class="n">invokeInitMethods</span><span class="o">(</span><span class="n">beanName</span><span class="o">,</span> <span class="n">wrappedBean</span><span class="o">,</span> <span class="n">mbd</span><span class="o">);</span>
   <span class="o">}</span>
   <span class="k">catch</span> <span class="o">(</span><span class="nc">Throwable</span> <span class="n">ex</span><span class="o">)</span> <span class="o">{</span>
      <span class="k">throw</span> <span class="k">new</span> <span class="nf">BeanCreationException</span><span class="o">(</span>
            <span class="o">(</span><span class="n">mbd</span> <span class="o">!=</span> <span class="kc">null</span> <span class="o">?</span> <span class="n">mbd</span><span class="o">.</span><span class="na">getResourceDescription</span><span class="o">()</span> <span class="o">:</span> <span class="kc">null</span><span class="o">),</span>
            <span class="n">beanName</span><span class="o">,</span> <span class="s">"Invocation of init method failed"</span><span class="o">,</span> <span class="n">ex</span><span class="o">);</span>
   <span class="o">}</span>

   <span class="k">if</span> <span class="o">(</span><span class="n">mbd</span> <span class="o">==</span> <span class="kc">null</span> <span class="o">||</span> <span class="o">!</span><span class="n">mbd</span><span class="o">.</span><span class="na">isSynthetic</span><span class="o">())</span> <span class="o">{</span>
      <span class="c1">// BeanPostProcessor çš„ postProcessAfterInitialization å›è°ƒ</span>
      <span class="n">wrappedBean</span> <span class="o">=</span> <span class="n">applyBeanPostProcessorsAfterInitialization</span><span class="o">(</span><span class="n">wrappedBean</span><span class="o">,</span> <span class="n">beanName</span><span class="o">);</span>
   <span class="o">}</span>
   <span class="k">return</span> <span class="n">wrappedBean</span><span class="o">;</span>
<span class="o">}</span>
</pre></td></tr></tbody></table></code></pre></div></div>

<p>å¤§å®¶å‘ç°æ²¡æœ‰ï¼ŒBeanPostProcessor çš„ä¸¤ä¸ªå›è°ƒéƒ½å‘ç”Ÿåœ¨è¿™è¾¹ï¼Œåªä¸è¿‡ä¸­é—´å¤„ç†äº† init-methodï¼Œæ˜¯ä¸æ˜¯å’Œè¯»è€…åŸæ¥çš„è®¤çŸ¥æœ‰ç‚¹ä¸ä¸€æ ·äº†ï¼Ÿ</p>

<h2 id="é™„å½•">é™„å½•</h2>

<h3 id="id-å’Œ-name">id å’Œ name</h3>

<p>æ¯ä¸ª Bean åœ¨ Spring å®¹å™¨ä¸­éƒ½æœ‰ä¸€ä¸ªå”¯ä¸€çš„åå­—ï¼ˆbeanNameï¼‰å’Œ 0 ä¸ªæˆ–å¤šä¸ªåˆ«åï¼ˆaliasesï¼‰ã€‚</p>

<p>æˆ‘ä»¬ä» Spring å®¹å™¨ä¸­è·å– Bean çš„æ—¶å€™ï¼Œå¯ä»¥æ ¹æ® beanNameï¼Œä¹Ÿå¯ä»¥é€šè¿‡åˆ«åã€‚</p>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre></td><td class="rouge-code"><pre><span class="n">beanFactory</span><span class="o">.</span><span class="na">getBean</span><span class="o">(</span><span class="s">"beanName or alias"</span><span class="o">);</span>
</pre></td></tr></tbody></table></code></pre></div></div>

<p>åœ¨é…ç½® <code class="highlighter-rouge">&lt;bean /&gt;</code> çš„è¿‡ç¨‹ä¸­ï¼Œæˆ‘ä»¬å¯ä»¥é…ç½® id å’Œ nameï¼Œçœ‹å‡ ä¸ªä¾‹å­å°±çŸ¥é“æ˜¯æ€ä¹ˆå›äº‹äº†ã€‚</p>

<div class="language-xml highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre></td><td class="rouge-code"><pre><span class="nt">&lt;bean</span> <span class="na">id=</span><span class="s">"messageService"</span> <span class="na">name=</span><span class="s">"m1, m2, m3"</span> <span class="na">class=</span><span class="s">"com.javadoop.example.MessageServiceImpl"</span><span class="nt">&gt;</span>
</pre></td></tr></tbody></table></code></pre></div></div>

<p>ä»¥ä¸Šé…ç½®çš„ç»“æœå°±æ˜¯ï¼šbeanName ä¸º messageServiceï¼Œåˆ«åæœ‰ 3 ä¸ªï¼Œåˆ†åˆ«ä¸º m1ã€m2ã€m3ã€‚</p>

<div class="language-xml highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre></td><td class="rouge-code"><pre><span class="nt">&lt;bean</span> <span class="na">name=</span><span class="s">"m1, m2, m3"</span> <span class="na">class=</span><span class="s">"com.javadoop.example.MessageServiceImpl"</span> <span class="nt">/&gt;</span>
</pre></td></tr></tbody></table></code></pre></div></div>

<p>ä»¥ä¸Šé…ç½®çš„ç»“æœå°±æ˜¯ï¼šbeanName ä¸º m1ï¼Œåˆ«åæœ‰ 2 ä¸ªï¼Œåˆ†åˆ«ä¸º m2ã€m3ã€‚</p>

<div class="language-xml highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre></td><td class="rouge-code"><pre><span class="nt">&lt;bean</span> <span class="na">class=</span><span class="s">"com.javadoop.example.MessageServiceImpl"</span><span class="nt">&gt;</span>
</pre></td></tr></tbody></table></code></pre></div></div>

<p>beanName ä¸ºï¼šcom.javadoop.example.MessageServiceImpl#0ï¼Œ</p>

<p>åˆ«å 1 ä¸ªï¼Œä¸ºï¼š com.javadoop.example.MessageServiceImpl</p>

<div class="language-xml highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre></td><td class="rouge-code"><pre><span class="nt">&lt;bean</span> <span class="na">id=</span><span class="s">"messageService"</span> <span class="na">class=</span><span class="s">"com.javadoop.example.MessageServiceImpl"</span><span class="nt">&gt;</span>
</pre></td></tr></tbody></table></code></pre></div></div>

<p>ä»¥ä¸Šé…ç½®çš„ç»“æœå°±æ˜¯ï¼šbeanName ä¸º messageServiceï¼Œæ²¡æœ‰åˆ«åã€‚</p>

<h3 id="é…ç½®æ˜¯å¦å…è®¸-bean-è¦†ç›–æ˜¯å¦å…è®¸å¾ªç¯ä¾èµ–">é…ç½®æ˜¯å¦å…è®¸ Bean è¦†ç›–ã€æ˜¯å¦å…è®¸å¾ªç¯ä¾èµ–</h3>

<p>æˆ‘ä»¬è¯´è¿‡ï¼Œé»˜è®¤æƒ…å†µä¸‹ï¼ŒallowBeanDefinitionOverriding å±æ€§ä¸º nullã€‚å¦‚æœåœ¨åŒä¸€é…ç½®æ–‡ä»¶ä¸­ Bean id æˆ– name é‡å¤äº†ï¼Œä¼šæŠ›é”™ï¼Œä½†æ˜¯å¦‚æœä¸æ˜¯åŒä¸€é…ç½®æ–‡ä»¶ä¸­ï¼Œä¼šå‘ç”Ÿè¦†ç›–ã€‚</p>

<p>å¯æ˜¯æœ‰äº›æ—¶å€™æˆ‘ä»¬å¸Œæœ›åœ¨ç³»ç»Ÿå¯åŠ¨çš„è¿‡ç¨‹ä¸­å°±ä¸¥æ ¼æœç»å‘ç”Ÿ Bean è¦†ç›–ï¼Œå› ä¸ºä¸‡ä¸€å‡ºç°è¿™ç§æƒ…å†µï¼Œä¼šå¢åŠ æˆ‘ä»¬æ’æŸ¥é—®é¢˜çš„æˆæœ¬ã€‚</p>

<p>å¾ªç¯ä¾èµ–è¯´çš„æ˜¯ A ä¾èµ– Bï¼Œè€Œ B åˆä¾èµ– Aã€‚æˆ–è€…æ˜¯ A ä¾èµ– Bï¼ŒB ä¾èµ– Cï¼Œè€Œ C å´ä¾èµ– Aã€‚é»˜è®¤ allowCircularReferences ä¹Ÿæ˜¯ nullã€‚</p>

<p>å®ƒä»¬ä¸¤ä¸ªå±æ€§æ˜¯ä¸€èµ·å‡ºç°çš„ï¼Œå¿…ç„¶å¯ä»¥åœ¨åŒä¸€ä¸ªåœ°æ–¹ä¸€èµ·è¿›è¡Œé…ç½®ã€‚</p>

<p>æ·»åŠ è¿™ä¸¤ä¸ªå±æ€§çš„ä½œè€… Juergen Hoeller åœ¨è¿™ä¸ª <a href="https://jira.spring.io/browse/SPR-4374">jira</a> çš„è®¨è®ºä¸­è¯´æ˜äº†æ€ä¹ˆé…ç½®è¿™ä¸¤ä¸ªå±æ€§ã€‚</p>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
</pre></td><td class="rouge-code"><pre><span class="kd">public</span> <span class="kd">class</span> <span class="nc">NoBeanOverridingContextLoader</span> <span class="kd">extends</span> <span class="nc">ContextLoader</span> <span class="o">{</span>
 
  <span class="nd">@Override</span>
  <span class="kd">protected</span> <span class="kt">void</span> <span class="nf">customizeContext</span><span class="o">(</span><span class="nc">ServletContext</span> <span class="n">servletContext</span><span class="o">,</span> <span class="nc">ConfigurableWebApplicationContext</span> <span class="n">applicationContext</span><span class="o">)</span> <span class="o">{</span>
    <span class="kd">super</span><span class="o">.</span><span class="na">customizeContext</span><span class="o">(</span><span class="n">servletContext</span><span class="o">,</span> <span class="n">applicationContext</span><span class="o">);</span>
    <span class="nc">AbstractRefreshableApplicationContext</span> <span class="n">arac</span> <span class="o">=</span> <span class="o">(</span><span class="nc">AbstractRefreshableApplicationContext</span><span class="o">)</span> <span class="n">applicationContext</span><span class="o">;</span>
    <span class="n">arac</span><span class="o">.</span><span class="na">setAllowBeanDefinitionOverriding</span><span class="o">(</span><span class="kc">false</span><span class="o">);</span>
  <span class="o">}</span>
<span class="o">}</span>
</pre></td></tr></tbody></table></code></pre></div></div>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
</pre></td><td class="rouge-code"><pre><span class="kd">public</span> <span class="kd">class</span> <span class="nc">MyContextLoaderListener</span> <span class="kd">extends</span> <span class="n">org</span><span class="o">.</span><span class="na">springframework</span><span class="o">.</span><span class="na">web</span><span class="o">.</span><span class="na">context</span><span class="o">.</span><span class="na">ContextLoaderListener</span> <span class="o">{</span>
 
  <span class="nd">@Override</span>
  <span class="kd">protected</span> <span class="nc">ContextLoader</span> <span class="nf">createContextLoader</span><span class="o">()</span> <span class="o">{</span>
    <span class="k">return</span> <span class="k">new</span> <span class="nf">NoBeanOverridingContextLoader</span><span class="o">();</span>
  <span class="o">}</span>
  
<span class="o">}</span>
</pre></td></tr></tbody></table></code></pre></div></div>

<div class="language-xml highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
</pre></td><td class="rouge-code"><pre><span class="nt">&lt;listener&gt;</span>
    <span class="nt">&lt;listener-class&gt;</span>com.javadoop.MyContextLoaderListener<span class="nt">&lt;/listener-class&gt;</span>  
<span class="nt">&lt;/listener&gt;</span>
</pre></td></tr></tbody></table></code></pre></div></div>

<p>å¦‚æœä»¥ä¸Šæ–¹å¼ä¸èƒ½æ»¡è¶³ä½ çš„éœ€æ±‚ï¼Œè¯·å‚è€ƒè¿™ä¸ªé“¾æ¥ï¼š<a href="http://blog.csdn.net/zgmzyr/article/details/39380477">è§£å†³springä¸­ä¸åŒé…ç½®æ–‡ä»¶ä¸­å­˜åœ¨nameæˆ–è€…idç›¸åŒçš„beanå¯èƒ½å¼•èµ·çš„é—®é¢˜</a></p>

<h3 id="profile">profile</h3>

<p>æˆ‘ä»¬å¯ä»¥æŠŠä¸åŒç¯å¢ƒçš„é…ç½®åˆ†åˆ«é…ç½®åˆ°å•ç‹¬çš„æ–‡ä»¶ä¸­ï¼Œä¸¾ä¸ªä¾‹å­ï¼š</p>

<div class="language-xml highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
</pre></td><td class="rouge-code"><pre><span class="nt">&lt;beans</span> <span class="na">profile=</span><span class="s">"development"</span>
    <span class="na">xmlns=</span><span class="s">"http://www.springframework.org/schema/beans"</span>
    <span class="na">xmlns:xsi=</span><span class="s">"http://www.w3.org/2001/XMLSchema-instance"</span>
    <span class="na">xmlns:jdbc=</span><span class="s">"http://www.springframework.org/schema/jdbc"</span>
    <span class="na">xsi:schemaLocation=</span><span class="s">"..."</span><span class="nt">&gt;</span>

    <span class="nt">&lt;jdbc:embedded-database</span> <span class="na">id=</span><span class="s">"dataSource"</span><span class="nt">&gt;</span>
        <span class="nt">&lt;jdbc:script</span> <span class="na">location=</span><span class="s">"classpath:com/bank/config/sql/schema.sql"</span><span class="nt">/&gt;</span>
        <span class="nt">&lt;jdbc:script</span> <span class="na">location=</span><span class="s">"classpath:com/bank/config/sql/test-data.sql"</span><span class="nt">/&gt;</span>
    <span class="nt">&lt;/jdbc:embedded-database&gt;</span>
<span class="nt">&lt;/beans&gt;</span>
</pre></td></tr></tbody></table></code></pre></div></div>
<div class="language-xml highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
</pre></td><td class="rouge-code"><pre><span class="nt">&lt;beans</span> <span class="na">profile=</span><span class="s">"production"</span>
    <span class="na">xmlns=</span><span class="s">"http://www.springframework.org/schema/beans"</span>
    <span class="na">xmlns:xsi=</span><span class="s">"http://www.w3.org/2001/XMLSchema-instance"</span>
    <span class="na">xmlns:jee=</span><span class="s">"http://www.springframework.org/schema/jee"</span>
    <span class="na">xsi:schemaLocation=</span><span class="s">"..."</span><span class="nt">&gt;</span>

    <span class="nt">&lt;jee:jndi-lookup</span> <span class="na">id=</span><span class="s">"dataSource"</span> <span class="na">jndi-name=</span><span class="s">"java:comp/env/jdbc/datasource"</span><span class="nt">/&gt;</span>
<span class="nt">&lt;/beans&gt;</span>
</pre></td></tr></tbody></table></code></pre></div></div>

<p>åº”è¯¥ä¸å¿…åšè¿‡å¤šè§£é‡Šäº†å§ï¼Œçœ‹æ¯ä¸ªæ–‡ä»¶ç¬¬ä¸€è¡Œçš„ profile=â€â€œã€‚</p>

<p>å½“ç„¶ï¼Œæˆ‘ä»¬ä¹Ÿå¯ä»¥åœ¨ä¸€ä¸ªé…ç½®æ–‡ä»¶ä¸­ä½¿ç”¨ï¼š</p>

<div class="language-xml highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
</pre></td><td class="rouge-code"><pre><span class="nt">&lt;beans</span> <span class="na">xmlns=</span><span class="s">"http://www.springframework.org/schema/beans"</span>
    <span class="na">xmlns:xsi=</span><span class="s">"http://www.w3.org/2001/XMLSchema-instance"</span>
    <span class="na">xmlns:jdbc=</span><span class="s">"http://www.springframework.org/schema/jdbc"</span>
    <span class="na">xmlns:jee=</span><span class="s">"http://www.springframework.org/schema/jee"</span>
    <span class="na">xsi:schemaLocation=</span><span class="s">"..."</span><span class="nt">&gt;</span>

    <span class="nt">&lt;beans</span> <span class="na">profile=</span><span class="s">"development"</span><span class="nt">&gt;</span>
        <span class="nt">&lt;jdbc:embedded-database</span> <span class="na">id=</span><span class="s">"dataSource"</span><span class="nt">&gt;</span>
            <span class="nt">&lt;jdbc:script</span> <span class="na">location=</span><span class="s">"classpath:com/bank/config/sql/schema.sql"</span><span class="nt">/&gt;</span>
            <span class="nt">&lt;jdbc:script</span> <span class="na">location=</span><span class="s">"classpath:com/bank/config/sql/test-data.sql"</span><span class="nt">/&gt;</span>
        <span class="nt">&lt;/jdbc:embedded-database&gt;</span>
    <span class="nt">&lt;/beans&gt;</span>

    <span class="nt">&lt;beans</span> <span class="na">profile=</span><span class="s">"production"</span><span class="nt">&gt;</span>
        <span class="nt">&lt;jee:jndi-lookup</span> <span class="na">id=</span><span class="s">"dataSource"</span> <span class="na">jndi-name=</span><span class="s">"java:comp/env/jdbc/datasource"</span><span class="nt">/&gt;</span>
    <span class="nt">&lt;/beans&gt;</span>
<span class="nt">&lt;/beans&gt;</span>
</pre></td></tr></tbody></table></code></pre></div></div>

<p>ç†è§£èµ·æ¥ä¹Ÿå¾ˆç®€å•å§ã€‚</p>

<p>æ¥ä¸‹æ¥çš„é—®é¢˜æ˜¯ï¼Œæ€ä¹ˆä½¿ç”¨ç‰¹å®šçš„ profile å‘¢ï¼ŸSpring åœ¨å¯åŠ¨çš„è¿‡ç¨‹ä¸­ï¼Œä¼šå»å¯»æ‰¾ â€œspring.profiles.activeâ€ çš„å±æ€§å€¼ï¼Œæ ¹æ®è¿™ä¸ªå±æ€§å€¼æ¥çš„ã€‚é‚£æ€ä¹ˆé…ç½®è¿™ä¸ªå€¼å‘¢ï¼Ÿ</p>

<p>Spring ä¼šåœ¨è¿™å‡ ä¸ªåœ°æ–¹å¯»æ‰¾ spring.profiles.active çš„å±æ€§å€¼ï¼šæ“ä½œç³»ç»Ÿç¯å¢ƒå˜é‡ã€JVM ç³»ç»Ÿå˜é‡ã€web.xml ä¸­å®šä¹‰çš„å‚æ•°ã€JNDIã€‚</p>

<p>æœ€ç®€å•çš„æ–¹å¼è«è¿‡äºåœ¨ç¨‹åºå¯åŠ¨çš„æ—¶å€™æŒ‡å®šï¼š</p>

<div class="language-shell highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre></td><td class="rouge-code"><pre><span class="nt">-Dspring</span>.profiles.active<span class="o">=</span><span class="s2">"profile1,profile2"</span>
</pre></td></tr></tbody></table></code></pre></div></div>

<blockquote>
  <p>profile å¯ä»¥æ¿€æ´»å¤šä¸ª</p>
</blockquote>

<p>å½“ç„¶ï¼Œæˆ‘ä»¬ä¹Ÿå¯ä»¥é€šè¿‡ä»£ç çš„å½¢å¼ä» Environment ä¸­è®¾ç½® profileï¼š</p>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
</pre></td><td class="rouge-code"><pre><span class="nc">AnnotationConfigApplicationContext</span> <span class="n">ctx</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">AnnotationConfigApplicationContext</span><span class="o">();</span>
<span class="n">ctx</span><span class="o">.</span><span class="na">getEnvironment</span><span class="o">().</span><span class="na">setActiveProfiles</span><span class="o">(</span><span class="s">"development"</span><span class="o">);</span>
<span class="n">ctx</span><span class="o">.</span><span class="na">register</span><span class="o">(</span><span class="nc">SomeConfig</span><span class="o">.</span><span class="na">class</span><span class="o">,</span> <span class="nc">StandaloneDataConfig</span><span class="o">.</span><span class="na">class</span><span class="o">,</span> <span class="nc">JndiDataConfig</span><span class="o">.</span><span class="na">class</span><span class="o">);</span>
<span class="n">ctx</span><span class="o">.</span><span class="na">refresh</span><span class="o">();</span> <span class="c1">// é‡å¯</span>
</pre></td></tr></tbody></table></code></pre></div></div>

<p>å¦‚æœæ˜¯ Spring Boot çš„è¯æ›´ç®€å•ï¼Œæˆ‘ä»¬ä¸€èˆ¬ä¼šåˆ›å»º application.propertiesã€application-dev.propertiesã€application-prod.properties ç­‰æ–‡ä»¶ï¼Œå…¶ä¸­ application.properties é…ç½®å„ä¸ªç¯å¢ƒé€šç”¨çš„é…ç½®ï¼Œapplication-{profile}.properties ä¸­é…ç½®ç‰¹å®šç¯å¢ƒçš„é…ç½®ï¼Œç„¶ååœ¨å¯åŠ¨çš„æ—¶å€™æŒ‡å®š profileï¼š</p>

<div class="language-shell highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre></td><td class="rouge-code"><pre>java <span class="nt">-Dspring</span>.profiles.active<span class="o">=</span>prod <span class="nt">-jar</span> JavaDoop.jar
</pre></td></tr></tbody></table></code></pre></div></div>

<p>å¦‚æœæ˜¯å•å…ƒæµ‹è¯•ä¸­ä½¿ç”¨çš„è¯ï¼Œåœ¨æµ‹è¯•ç±»ä¸­ä½¿ç”¨ @ActiveProfiles æŒ‡å®šï¼Œè¿™é‡Œå°±ä¸å±•å¼€äº†ã€‚</p>

<h3 id="å·¥å‚æ¨¡å¼ç”Ÿæˆ-bean">å·¥å‚æ¨¡å¼ç”Ÿæˆ Bean</h3>

<p>è¯·è¯»è€…æ³¨æ„ factory-bean å’Œ FactoryBean çš„åŒºåˆ«ã€‚è¿™èŠ‚è¯´çš„æ˜¯å‰è€…ï¼Œæ˜¯è¯´é™æ€å·¥å‚æˆ–å®ä¾‹å·¥å‚ï¼Œè€Œåè€…æ˜¯ Spring ä¸­çš„ç‰¹æ®Šæ¥å£ï¼Œä»£è¡¨ä¸€ç±»ç‰¹æ®Šçš„ Beanï¼Œé™„å½•çš„ä¸‹é¢ä¸€èŠ‚ä¼šä»‹ç» FactoryBeanã€‚</p>

<p>è®¾è®¡æ¨¡å¼é‡Œï¼Œå·¥å‚æ–¹æ³•æ¨¡å¼åˆ†é™æ€å·¥å‚å’Œå®ä¾‹å·¥å‚ï¼Œæˆ‘ä»¬åˆ†åˆ«çœ‹çœ‹ Spring ä¸­æ€ä¹ˆé…ç½®è¿™ä¸¤ä¸ªï¼Œæ¥ä¸ªä»£ç ç¤ºä¾‹å°±ä»€ä¹ˆéƒ½æ¸…æ¥šäº†ã€‚</p>

<p>é™æ€å·¥å‚ï¼š</p>

<div class="language-xml highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
</pre></td><td class="rouge-code"><pre><span class="nt">&lt;bean</span> <span class="na">id=</span><span class="s">"clientService"</span>
    <span class="na">class=</span><span class="s">"examples.ClientService"</span>
    <span class="na">factory-method=</span><span class="s">"createInstance"</span><span class="nt">/&gt;</span>
</pre></td></tr></tbody></table></code></pre></div></div>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
</pre></td><td class="rouge-code"><pre><span class="kd">public</span> <span class="kd">class</span> <span class="nc">ClientService</span> <span class="o">{</span>
    <span class="kd">private</span> <span class="kd">static</span> <span class="nc">ClientService</span> <span class="n">clientService</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">ClientService</span><span class="o">();</span>
    <span class="kd">private</span> <span class="nf">ClientService</span><span class="o">()</span> <span class="o">{}</span>

    <span class="c1">// é™æ€æ–¹æ³•</span>
    <span class="kd">public</span> <span class="kd">static</span> <span class="nc">ClientService</span> <span class="nf">createInstance</span><span class="o">()</span> <span class="o">{</span>
        <span class="k">return</span> <span class="n">clientService</span><span class="o">;</span>
    <span class="o">}</span>
<span class="o">}</span>
</pre></td></tr></tbody></table></code></pre></div></div>

<p>å®ä¾‹å·¥å‚ï¼š</p>

<div class="language-xml highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
</pre></td><td class="rouge-code"><pre><span class="nt">&lt;bean</span> <span class="na">id=</span><span class="s">"serviceLocator"</span> <span class="na">class=</span><span class="s">"examples.DefaultServiceLocator"</span><span class="nt">&gt;</span>
    <span class="c">&lt;!-- inject any dependencies required by this locator bean --&gt;</span>
<span class="nt">&lt;/bean&gt;</span>

<span class="nt">&lt;bean</span> <span class="na">id=</span><span class="s">"clientService"</span>
    <span class="na">factory-bean=</span><span class="s">"serviceLocator"</span>
    <span class="na">factory-method=</span><span class="s">"createClientServiceInstance"</span><span class="nt">/&gt;</span>

<span class="nt">&lt;bean</span> <span class="na">id=</span><span class="s">"accountService"</span>
    <span class="na">factory-bean=</span><span class="s">"serviceLocator"</span>
    <span class="na">factory-method=</span><span class="s">"createAccountServiceInstance"</span><span class="nt">/&gt;</span>
</pre></td></tr></tbody></table></code></pre></div></div>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
</pre></td><td class="rouge-code"><pre><span class="kd">public</span> <span class="kd">class</span> <span class="nc">DefaultServiceLocator</span> <span class="o">{</span>

    <span class="kd">private</span> <span class="kd">static</span> <span class="nc">ClientService</span> <span class="n">clientService</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">ClientServiceImpl</span><span class="o">();</span>

    <span class="kd">private</span> <span class="kd">static</span> <span class="nc">AccountService</span> <span class="n">accountService</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">AccountServiceImpl</span><span class="o">();</span>

    <span class="kd">public</span> <span class="nc">ClientService</span> <span class="nf">createClientServiceInstance</span><span class="o">()</span> <span class="o">{</span>
        <span class="k">return</span> <span class="n">clientService</span><span class="o">;</span>
    <span class="o">}</span>

    <span class="kd">public</span> <span class="nc">AccountService</span> <span class="nf">createAccountServiceInstance</span><span class="o">()</span> <span class="o">{</span>
        <span class="k">return</span> <span class="n">accountService</span><span class="o">;</span>
    <span class="o">}</span>
<span class="o">}</span>
</pre></td></tr></tbody></table></code></pre></div></div>
<h3 id="factorybean">FactoryBean</h3>

<p>FactoryBean é€‚ç”¨äº Bean çš„åˆ›å»ºè¿‡ç¨‹æ¯”è¾ƒå¤æ‚çš„åœºæ™¯ï¼Œæ¯”å¦‚æ•°æ®åº“è¿æ¥æ± çš„åˆ›å»ºã€‚</p>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
</pre></td><td class="rouge-code"><pre><span class="kd">public</span> <span class="kd">interface</span> <span class="nc">FactoryBean</span><span class="o">&lt;</span><span class="no">T</span><span class="o">&gt;</span> <span class="o">{</span>
    <span class="no">T</span> <span class="nf">getObject</span><span class="o">()</span> <span class="kd">throws</span> <span class="nc">Exception</span><span class="o">;</span>
    <span class="nc">Class</span><span class="o">&lt;</span><span class="no">T</span><span class="o">&gt;</span> <span class="nf">getObjectType</span><span class="o">();</span>
    <span class="kt">boolean</span> <span class="nf">isSingleton</span><span class="o">();</span>
<span class="o">}</span>
</pre></td></tr></tbody></table></code></pre></div></div>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
</pre></td><td class="rouge-code"><pre><span class="kd">public</span> <span class="kd">class</span> <span class="nc">Person</span> <span class="o">{</span> 
    <span class="kd">private</span> <span class="nc">Car</span> <span class="n">car</span> <span class="o">;</span>
    <span class="kd">private</span> <span class="kt">void</span> <span class="nf">setCar</span><span class="o">(</span><span class="nc">Car</span> <span class="n">car</span><span class="o">){</span> <span class="k">this</span><span class="o">.</span><span class="na">car</span> <span class="o">=</span> <span class="n">car</span><span class="o">;</span>  <span class="o">}</span>  
<span class="o">}</span>
</pre></td></tr></tbody></table></code></pre></div></div>

<p>æˆ‘ä»¬å‡è®¾ç°åœ¨éœ€è¦åˆ›å»ºä¸€ä¸ª Person çš„ Beanï¼Œé¦–å…ˆæˆ‘ä»¬éœ€è¦ä¸€ä¸ª Car çš„å®ä¾‹ï¼Œæˆ‘ä»¬è¿™é‡Œå‡è®¾ Car çš„å®ä¾‹åˆ›å»ºå¾ˆéº»çƒ¦ï¼Œé‚£ä¹ˆæˆ‘ä»¬å¯ä»¥æŠŠåˆ›å»º Car çš„å¤æ‚è¿‡ç¨‹åŒ…è£…èµ·æ¥ï¼š</p>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
</pre></td><td class="rouge-code"><pre><span class="kd">public</span> <span class="kd">class</span> <span class="nc">MyCarFactoryBean</span> <span class="kd">implements</span> <span class="nc">FactoryBean</span><span class="o">&lt;</span><span class="nc">Car</span><span class="o">&gt;{</span>
    <span class="kd">private</span> <span class="nc">String</span> <span class="n">make</span><span class="o">;</span> 
    <span class="kd">private</span> <span class="kt">int</span> <span class="n">year</span> <span class="o">;</span>
    
    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">setMake</span><span class="o">(</span><span class="nc">String</span> <span class="n">m</span><span class="o">){</span> <span class="k">this</span><span class="o">.</span><span class="na">make</span> <span class="o">=</span><span class="n">m</span> <span class="o">;</span> <span class="o">}</span>
    
    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">setYear</span><span class="o">(</span><span class="kt">int</span> <span class="n">y</span><span class="o">){</span> <span class="k">this</span><span class="o">.</span><span class="na">year</span> <span class="o">=</span> <span class="n">y</span><span class="o">;</span> <span class="o">}</span>
    
    <span class="kd">public</span> <span class="nc">Car</span> <span class="nf">getObject</span><span class="o">(){</span> 
      <span class="c1">// è¿™é‡Œæˆ‘ä»¬å‡è®¾ Car çš„å®ä¾‹åŒ–è¿‡ç¨‹éå¸¸å¤æ‚ï¼Œåæ­£å°±ä¸æ˜¯å‡ è¡Œä»£ç å¯ä»¥å†™å®Œçš„é‚£ç§</span>
      <span class="nc">CarBuilder</span> <span class="n">cb</span> <span class="o">=</span> <span class="nc">CarBuilder</span><span class="o">.</span><span class="na">car</span><span class="o">();</span>
      
      <span class="k">if</span><span class="o">(</span><span class="n">year</span><span class="o">!=</span><span class="mi">0</span><span class="o">)</span> <span class="n">cb</span><span class="o">.</span><span class="na">setYear</span><span class="o">(</span><span class="k">this</span><span class="o">.</span><span class="na">year</span><span class="o">);</span>
      <span class="k">if</span><span class="o">(</span><span class="nc">StringUtils</span><span class="o">.</span><span class="na">hasText</span><span class="o">(</span><span class="k">this</span><span class="o">.</span><span class="na">make</span><span class="o">))</span> <span class="n">cb</span><span class="o">.</span><span class="na">setMake</span><span class="o">(</span> <span class="k">this</span><span class="o">.</span><span class="na">make</span> <span class="o">);</span> 
      <span class="k">return</span> <span class="n">cb</span><span class="o">.</span><span class="na">factory</span><span class="o">();</span> 
    <span class="o">}</span>
    
    <span class="kd">public</span> <span class="nc">Class</span><span class="o">&lt;</span><span class="nc">Car</span><span class="o">&gt;</span> <span class="nf">getObjectType</span><span class="o">()</span> <span class="o">{</span> <span class="k">return</span> <span class="nc">Car</span><span class="o">.</span><span class="na">class</span> <span class="o">;</span> <span class="o">}</span> 
    
    <span class="kd">public</span> <span class="kt">boolean</span> <span class="nf">isSingleton</span><span class="o">()</span> <span class="o">{</span> <span class="k">return</span> <span class="kc">false</span><span class="o">;</span> <span class="o">}</span>
<span class="o">}</span>
</pre></td></tr></tbody></table></code></pre></div></div>

<p>æˆ‘ä»¬çœ‹çœ‹è£…é…çš„æ—¶å€™æ˜¯æ€ä¹ˆé…ç½®çš„ï¼š</p>

<div class="language-xml highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
</pre></td><td class="rouge-code"><pre><span class="nt">&lt;bean</span> <span class="na">class =</span> <span class="s">"com.javadoop.MyCarFactoryBean"</span> <span class="na">id =</span> <span class="s">"car"</span><span class="nt">&gt;</span>
  <span class="nt">&lt;property</span> <span class="na">name =</span> <span class="s">"make"</span> <span class="na">value =</span><span class="s">"Honda"</span><span class="nt">/&gt;</span>
  <span class="nt">&lt;property</span> <span class="na">name =</span> <span class="s">"year"</span> <span class="na">value =</span><span class="s">"1984"</span><span class="nt">/&gt;</span>
<span class="nt">&lt;/bean&gt;</span>
<span class="nt">&lt;bean</span> <span class="na">class =</span> <span class="s">"com.javadoop.Person"</span> <span class="na">id =</span> <span class="s">"josh"</span><span class="nt">&gt;</span>
  <span class="nt">&lt;property</span> <span class="na">name =</span> <span class="s">"car"</span> <span class="na">ref =</span> <span class="s">"car"</span><span class="nt">/&gt;</span>
<span class="nt">&lt;/bean&gt;</span>
</pre></td></tr></tbody></table></code></pre></div></div>

<p>çœ‹åˆ°ä¸ä¸€æ ·äº†å—ï¼Ÿid ä¸º â€œcarâ€ çš„ bean å…¶å®æŒ‡å®šçš„æ˜¯ä¸€ä¸ª FactoryBeanï¼Œä¸è¿‡é…ç½®çš„æ—¶å€™ï¼Œæˆ‘ä»¬ç›´æ¥è®©é…ç½® Person çš„ Bean ç›´æ¥ä¾èµ–äºè¿™ä¸ª FactoryBean å°±å¯ä»¥äº†ã€‚ä¸­é—´çš„è¿‡ç¨‹ Spring å·²ç»å°è£…å¥½äº†ã€‚</p>

<p>è¯´åˆ°è¿™é‡Œï¼Œæˆ‘ä»¬å†æ¥ç‚¹å¹²è´§ã€‚æˆ‘ä»¬çŸ¥é“ï¼Œç°åœ¨è¿˜ç”¨ xml é…ç½® Bean ä¾èµ–çš„è¶Šæ¥è¶Šå°‘äº†ï¼Œæ›´å¤šæ—¶å€™ï¼Œæˆ‘ä»¬å¯èƒ½ä¼šé‡‡ç”¨ java  config çš„æ–¹å¼æ¥é…ç½®ï¼Œè¿™é‡Œæœ‰ä»€ä¹ˆä¸ä¸€æ ·å‘¢ï¼Ÿ</p>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
</pre></td><td class="rouge-code"><pre><span class="nd">@Configuration</span> 
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">CarConfiguration</span> <span class="o">{</span> 

    <span class="nd">@Bean</span> 
    <span class="kd">public</span> <span class="nc">MyCarFactoryBean</span> <span class="nf">carFactoryBean</span><span class="o">(){</span> 
      <span class="nc">MyCarFactoryBean</span> <span class="n">cfb</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">MyCarFactoryBean</span><span class="o">();</span>
      <span class="n">cfb</span><span class="o">.</span><span class="na">setMake</span><span class="o">(</span><span class="s">"Honda"</span><span class="o">);</span>
      <span class="n">cfb</span><span class="o">.</span><span class="na">setYear</span><span class="o">(</span><span class="mi">1984</span><span class="o">);</span>
      <span class="k">return</span> <span class="n">cfb</span><span class="o">;</span>
    <span class="o">}</span>

    <span class="nd">@Bean</span>
    <span class="kd">public</span> <span class="nc">Person</span> <span class="nf">aPerson</span><span class="o">(){</span> 
    <span class="nc">Person</span> <span class="n">person</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">Person</span><span class="o">();</span>
      <span class="c1">// æ³¨æ„è¿™é‡Œçš„ä¸åŒ</span>
    <span class="n">person</span><span class="o">.</span><span class="na">setCar</span><span class="o">(</span><span class="n">carFactoryBean</span><span class="o">().</span><span class="na">getObject</span><span class="o">());</span>
    <span class="k">return</span> <span class="n">person</span><span class="o">;</span> 
    <span class="o">}</span> 
<span class="o">}</span>
</pre></td></tr></tbody></table></code></pre></div></div>

<p>è¿™ä¸ªæ—¶å€™ï¼Œå…¶å®æˆ‘ä»¬çš„æ€è·¯ä¹Ÿå¾ˆç®€å•ï¼ŒæŠŠ MyCarFactoryBean çœ‹æˆæ˜¯ä¸€ä¸ªç®€å•çš„ Bean å°±å¯ä»¥äº†ï¼Œä¸å¿…ç†ä¼šä»€ä¹ˆ FactoryBeanï¼Œå®ƒæ˜¯ä¸æ˜¯ FactoryBean å’Œæˆ‘ä»¬æ²¡å…³ç³»ã€‚</p>

<h3 id="åˆå§‹åŒ–-bean-çš„å›è°ƒ">åˆå§‹åŒ– Bean çš„å›è°ƒ</h3>

<p>æœ‰ä»¥ä¸‹å››ç§æ–¹æ¡ˆï¼š</p>

<div class="language-xml highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre></td><td class="rouge-code"><pre><span class="nt">&lt;bean</span> <span class="na">id=</span><span class="s">"exampleInitBean"</span> <span class="na">class=</span><span class="s">"examples.ExampleBean"</span> <span class="na">init-method=</span><span class="s">"init"</span><span class="nt">/&gt;</span>
</pre></td></tr></tbody></table></code></pre></div></div>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
</pre></td><td class="rouge-code"><pre><span class="kd">public</span> <span class="kd">class</span> <span class="nc">AnotherExampleBean</span> <span class="kd">implements</span> <span class="nc">InitializingBean</span> <span class="o">{</span>

    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">afterPropertiesSet</span><span class="o">()</span> <span class="o">{</span>
        <span class="c1">// do some initialization work</span>
    <span class="o">}</span>
<span class="o">}</span>
</pre></td></tr></tbody></table></code></pre></div></div>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
</pre></td><td class="rouge-code"><pre><span class="nd">@Bean</span><span class="o">(</span><span class="n">initMethod</span> <span class="o">=</span> <span class="s">"init"</span><span class="o">)</span>
<span class="kd">public</span> <span class="nc">Foo</span> <span class="nf">foo</span><span class="o">()</span> <span class="o">{</span>
    <span class="k">return</span> <span class="k">new</span> <span class="nf">Foo</span><span class="o">();</span>
<span class="o">}</span>
</pre></td></tr></tbody></table></code></pre></div></div>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
</pre></td><td class="rouge-code"><pre><span class="nd">@PostConstruct</span>
<span class="kd">public</span> <span class="kt">void</span> <span class="nf">init</span><span class="o">()</span> <span class="o">{</span>
    
<span class="o">}</span>
</pre></td></tr></tbody></table></code></pre></div></div>

<h3 id="é”€æ¯-bean-çš„å›è°ƒ">é”€æ¯ Bean çš„å›è°ƒ</h3>

<div class="language-xml highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre></td><td class="rouge-code"><pre><span class="nt">&lt;bean</span> <span class="na">id=</span><span class="s">"exampleInitBean"</span> <span class="na">class=</span><span class="s">"examples.ExampleBean"</span> <span class="na">destroy-method=</span><span class="s">"cleanup"</span><span class="nt">/&gt;</span>
</pre></td></tr></tbody></table></code></pre></div></div>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
</pre></td><td class="rouge-code"><pre><span class="kd">public</span> <span class="kd">class</span> <span class="nc">AnotherExampleBean</span> <span class="kd">implements</span> <span class="nc">DisposableBean</span> <span class="o">{</span>

    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">destroy</span><span class="o">()</span> <span class="o">{</span>
        <span class="c1">// do some destruction work (like releasing pooled connections)</span>
    <span class="o">}</span>
<span class="o">}</span>
</pre></td></tr></tbody></table></code></pre></div></div>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
</pre></td><td class="rouge-code"><pre><span class="nd">@Bean</span><span class="o">(</span><span class="n">destroyMethod</span> <span class="o">=</span> <span class="s">"cleanup"</span><span class="o">)</span>
<span class="kd">public</span> <span class="nc">Bar</span> <span class="nf">bar</span><span class="o">()</span> <span class="o">{</span>
    <span class="k">return</span> <span class="k">new</span> <span class="nf">Bar</span><span class="o">();</span>
<span class="o">}</span>
</pre></td></tr></tbody></table></code></pre></div></div>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
</pre></td><td class="rouge-code"><pre><span class="nd">@PreDestroy</span>
<span class="kd">public</span> <span class="kt">void</span> <span class="nf">cleanup</span><span class="o">()</span> <span class="o">{</span>
    
<span class="o">}</span>
</pre></td></tr></tbody></table></code></pre></div></div>

<h3 id="conversionservice">ConversionService</h3>

<p>æ—¢ç„¶æ–‡ä¸­è¯´åˆ°äº†è¿™ä¸ªï¼Œé¡ºä¾¿æä¸€ä¸‹å¥½äº†ã€‚</p>

<p>æœ€æœ‰ç”¨çš„åœºæ™¯å°±æ˜¯ï¼Œå®ƒç”¨æ¥å°†å‰ç«¯ä¼ è¿‡æ¥çš„å‚æ•°å’Œåç«¯çš„ controller æ–¹æ³•ä¸Šçš„å‚æ•°è¿›è¡Œç»‘å®šçš„æ—¶å€™ç”¨ã€‚</p>

<p>åƒå‰ç«¯ä¼ è¿‡æ¥çš„å­—ç¬¦ä¸²ã€æ•´æ•°è¦è½¬æ¢ä¸ºåç«¯çš„ Stringã€Integer å¾ˆå®¹æ˜“ï¼Œä½†æ˜¯å¦‚æœ controller æ–¹æ³•éœ€è¦çš„æ˜¯ä¸€ä¸ªæšä¸¾å€¼ï¼Œæˆ–è€…æ˜¯ Date è¿™äº›éåŸºç¡€ç±»å‹ï¼ˆå«åŸºç¡€ç±»å‹åŒ…è£…ç±»ï¼‰å€¼çš„æ—¶å€™ï¼Œæˆ‘ä»¬å°±å¯ä»¥è€ƒè™‘é‡‡ç”¨ ConversionService æ¥è¿›è¡Œè½¬æ¢ã€‚</p>

<div class="language-xml highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
</pre></td><td class="rouge-code"><pre><span class="nt">&lt;bean</span> <span class="na">id=</span><span class="s">"conversionService"</span>
  <span class="na">class=</span><span class="s">"org.springframework.context.support.ConversionServiceFactoryBean"</span><span class="nt">&gt;</span>
  <span class="nt">&lt;property</span> <span class="na">name=</span><span class="s">"converters"</span><span class="nt">&gt;</span>
    <span class="nt">&lt;list&gt;</span>
      <span class="nt">&lt;bean</span> <span class="na">class=</span><span class="s">"com.javadoop.learning.utils.StringToEnumConverterFactory"</span><span class="nt">/&gt;</span>
    <span class="nt">&lt;/list&gt;</span>
  <span class="nt">&lt;/property&gt;</span>
<span class="nt">&lt;/bean&gt;</span>
</pre></td></tr></tbody></table></code></pre></div></div>

<p>ConversionService æ¥å£å¾ˆç®€å•ï¼Œæ‰€ä»¥è¦è‡ªå®šä¹‰ä¸€ä¸ª convert çš„è¯ä¹Ÿå¾ˆç®€å•ã€‚</p>

<p>ä¸‹é¢å†è¯´ä¸€ä¸ªå®ç°è¿™ç§è½¬æ¢å¾ˆç®€å•çš„æ–¹å¼ï¼Œé‚£å°±æ˜¯å®ç° Converter æ¥å£ã€‚</p>

<p>æ¥çœ‹ä¸€ä¸ªå¾ˆç®€å•çš„ä¾‹å­ï¼Œè¿™æ ·æ¯”ä»€ä¹ˆéƒ½ç®¡ç”¨ã€‚</p>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
</pre></td><td class="rouge-code"><pre><span class="kd">public</span> <span class="kd">class</span> <span class="nc">StringToDateConverter</span> <span class="kd">implements</span> <span class="nc">Converter</span><span class="o">&lt;</span><span class="nc">String</span><span class="o">,</span> <span class="nc">Date</span><span class="o">&gt;</span> <span class="o">{</span>

    <span class="nd">@Override</span>
    <span class="kd">public</span> <span class="nc">Date</span> <span class="nf">convert</span><span class="o">(</span><span class="nc">String</span> <span class="n">source</span><span class="o">)</span> <span class="o">{</span>
        <span class="k">try</span> <span class="o">{</span>
            <span class="k">return</span> <span class="nc">DateUtils</span><span class="o">.</span><span class="na">parseDate</span><span class="o">(</span><span class="n">source</span><span class="o">,</span> <span class="s">"yyyy-MM-dd"</span><span class="o">,</span> <span class="s">"yyyy-MM-dd HH:mm:ss"</span><span class="o">,</span> <span class="s">"yyyy-MM-dd HH:mm"</span><span class="o">,</span> <span class="s">"HH:mm:ss"</span><span class="o">,</span> <span class="s">"HH:mm"</span><span class="o">);</span>
        <span class="o">}</span> <span class="k">catch</span> <span class="o">(</span><span class="nc">ParseException</span> <span class="n">e</span><span class="o">)</span> <span class="o">{</span>
            <span class="k">return</span> <span class="kc">null</span><span class="o">;</span>
        <span class="o">}</span>
    <span class="o">}</span>
<span class="o">}</span>
</pre></td></tr></tbody></table></code></pre></div></div>

<p>åªè¦æ³¨å†Œè¿™ä¸ª Bean å°±å¯ä»¥äº†ã€‚è¿™æ ·ï¼Œå‰ç«¯å¾€åç«¯ä¼ çš„æ—¶é—´æè¿°å­—ç¬¦ä¸²å°±å¾ˆå®¹æ˜“ç»‘å®šæˆ Date ç±»å‹äº†ï¼Œä¸éœ€è¦å…¶ä»–ä»»ä½•æ“ä½œã€‚</p>

<h3 id="bean-ç»§æ‰¿">Bean ç»§æ‰¿</h3>

<p>åœ¨åˆå§‹åŒ– Bean çš„åœ°æ–¹ï¼Œæˆ‘ä»¬è¯´è¿‡äº†è¿™ä¸ªï¼š</p>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre></td><td class="rouge-code"><pre><span class="nc">RootBeanDefinition</span> <span class="n">bd</span> <span class="o">=</span> <span class="n">getMergedLocalBeanDefinition</span><span class="o">(</span><span class="n">beanName</span><span class="o">);</span>
</pre></td></tr></tbody></table></code></pre></div></div>

<p>è¿™é‡Œæ¶‰åŠåˆ°çš„å°±æ˜¯ <code class="highlighter-rouge">&lt;bean parent="" /&gt;</code> ä¸­çš„ parent å±æ€§ï¼Œæˆ‘ä»¬æ¥çœ‹çœ‹ Spring ä¸­æ˜¯ç”¨è¿™ä¸ªæ¥å¹²ä»€ä¹ˆçš„ã€‚</p>

<p>é¦–å…ˆï¼Œæˆ‘ä»¬è¦æ˜ç™½ï¼Œè¿™é‡Œçš„ç»§æ‰¿å’Œ java è¯­æ³•ä¸­çš„ç»§æ‰¿æ²¡æœ‰ä»»ä½•å…³ç³»ï¼Œä¸è¿‡æ€è·¯æ˜¯ç›¸é€šçš„ã€‚child bean ä¼šç»§æ‰¿ parent bean çš„æ‰€æœ‰é…ç½®ï¼Œä¹Ÿå¯ä»¥è¦†ç›–ä¸€äº›é…ç½®ï¼Œå½“ç„¶ä¹Ÿå¯ä»¥æ–°å¢é¢å¤–çš„é…ç½®ã€‚</p>

<p>Spring ä¸­æä¾›äº†ç»§æ‰¿è‡ª AbstractBeanDefinition çš„ <code class="highlighter-rouge">ChildBeanDefinition</code> æ¥è¡¨ç¤º child beanã€‚</p>

<p>çœ‹å¦‚ä¸‹ä¸€ä¸ªä¾‹å­:</p>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
</pre></td><td class="rouge-code"><pre><span class="o">&lt;</span><span class="n">bean</span> <span class="n">id</span><span class="o">=</span><span class="s">"inheritedTestBean"</span> <span class="kd">abstract</span><span class="o">=</span><span class="s">"true"</span> <span class="kd">class</span><span class="err">="</span><span class="nc">org</span><span class="o">.</span><span class="na">springframework</span><span class="o">.</span><span class="na">beans</span><span class="o">.</span><span class="na">TestBean</span><span class="s">"&gt;
    &lt;property name="</span><span class="n">name</span><span class="s">" value="</span><span class="n">parent</span><span class="s">"/&gt;
    &lt;property name="</span><span class="n">age</span><span class="s">" value="</span><span class="mi">1</span><span class="s">"/&gt;
&lt;/bean&gt;

&lt;bean id="</span><span class="n">inheritsWithDifferentClass</span><span class="s">" class="</span><span class="n">org</span><span class="o">.</span><span class="na">springframework</span><span class="o">.</span><span class="na">beans</span><span class="o">.</span><span class="na">DerivedTestBean</span><span class="s">"
        parent="</span><span class="n">inheritedTestBean</span><span class="s">" init-method="</span><span class="n">initialize</span><span class="s">"&gt;
        
    &lt;property name="</span><span class="n">name</span><span class="s">" value="</span><span class="n">override</span><span class="err">"</span><span class="o">/&gt;</span>
<span class="o">&lt;/</span><span class="n">bean</span><span class="o">&gt;</span>
</pre></td></tr></tbody></table></code></pre></div></div>

<p>parent bean è®¾ç½®äº† <code class="highlighter-rouge">abstract="true"</code> æ‰€ä»¥å®ƒä¸ä¼šè¢«å®ä¾‹åŒ–ï¼Œchild bean ç»§æ‰¿äº† parent bean çš„ä¸¤ä¸ªå±æ€§ï¼Œä½†æ˜¯å¯¹ name å±æ€§è¿›è¡Œäº†è¦†å†™ã€‚</p>

<p>child bean ä¼šç»§æ‰¿ scopeã€æ„é€ å™¨å‚æ•°å€¼ã€å±æ€§å€¼ã€init-methodã€destroy-method ç­‰ç­‰ã€‚</p>

<p>å½“ç„¶ï¼Œæˆ‘ä¸æ˜¯è¯´ parent bean ä¸­çš„ abstract = true åœ¨è¿™é‡Œæ˜¯å¿…é¡»çš„ï¼Œåªæ˜¯è¯´å¦‚æœåŠ ä¸Šäº†ä»¥å Spring åœ¨å®ä¾‹åŒ– singleton beans çš„æ—¶å€™ä¼šå¿½ç•¥è¿™ä¸ª beanã€‚</p>

<p>æ¯”å¦‚ä¸‹é¢è¿™ä¸ªæç«¯ parent beanï¼Œå®ƒæ²¡æœ‰æŒ‡å®š classï¼Œæ‰€ä»¥æ¯«æ— ç–‘é—®ï¼Œè¿™ä¸ª bean çš„ä½œç”¨å°±æ˜¯ç”¨æ¥å……å½“æ¨¡æ¿ç”¨çš„ parent beanï¼Œæ­¤å¤„å°±å¿…é¡»åŠ ä¸Š abstract = trueã€‚</p>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
</pre></td><td class="rouge-code"><pre><span class="o">&lt;</span><span class="n">bean</span> <span class="n">id</span><span class="o">=</span><span class="s">"inheritedTestBeanWithoutClass"</span> <span class="kd">abstract</span><span class="o">=</span><span class="s">"true"</span><span class="o">&gt;</span>
    <span class="o">&lt;</span><span class="n">property</span> <span class="n">name</span><span class="o">=</span><span class="s">"name"</span> <span class="n">value</span><span class="o">=</span><span class="s">"parent"</span><span class="o">/&gt;</span>
    <span class="o">&lt;</span><span class="n">property</span> <span class="n">name</span><span class="o">=</span><span class="s">"age"</span> <span class="n">value</span><span class="o">=</span><span class="s">"1"</span><span class="o">/&gt;</span>
<span class="o">&lt;/</span><span class="n">bean</span><span class="o">&gt;</span>
</pre></td></tr></tbody></table></code></pre></div></div>
<h3 id="æ–¹æ³•æ³¨å…¥">æ–¹æ³•æ³¨å…¥</h3>

<p>ä¸€èˆ¬æ¥è¯´ï¼Œæˆ‘ä»¬çš„åº”ç”¨ä¸­å¤§å¤šæ•°çš„ Bean éƒ½æ˜¯ singleton çš„ã€‚singleton ä¾èµ– singletonï¼Œæˆ–è€… prototype ä¾èµ– prototype éƒ½å¾ˆå¥½è§£å†³ï¼Œç›´æ¥è®¾ç½®å±æ€§ä¾èµ–å°±å¯ä»¥äº†ã€‚</p>

<p>ä½†æ˜¯ï¼Œå¦‚æœæ˜¯ singleton ä¾èµ– prototype å‘¢ï¼Ÿè¿™ä¸ªæ—¶å€™ä¸èƒ½ç”¨å±æ€§ä¾èµ–ï¼Œå› ä¸ºå¦‚æœç”¨å±æ€§ä¾èµ–çš„è¯ï¼Œæˆ‘ä»¬æ¯æ¬¡å…¶å®æ‹¿åˆ°çš„è¿˜æ˜¯ç¬¬ä¸€æ¬¡åˆå§‹åŒ–æ—¶å€™çš„ beanã€‚</p>

<p>ä¸€ç§è§£å†³æ–¹æ¡ˆå°±æ˜¯ä¸è¦ç”¨å±æ€§ä¾èµ–ï¼Œæ¯æ¬¡è·å–ä¾èµ–çš„ bean çš„æ—¶å€™ä» BeanFactory ä¸­å–ã€‚è¿™ä¸ªä¹Ÿæ˜¯å¤§å®¶æœ€å¸¸ç”¨çš„æ–¹å¼äº†å§ã€‚æ€ä¹ˆå–ï¼Œæˆ‘å°±ä¸ä»‹ç»äº†ï¼Œå¤§éƒ¨åˆ† Spring é¡¹ç›®å¤§å®¶éƒ½ä¼šå®šä¹‰é‚£ä¹ˆä¸ªå·¥å…·ç±»çš„ã€‚</p>

<p>å¦ä¸€ç§è§£å†³æ–¹æ¡ˆå°±æ˜¯è¿™é‡Œè¦ä»‹ç»çš„é€šè¿‡ä½¿ç”¨ Lookup methodã€‚</p>

<h4 id="lookup-method">lookup-method</h4>

<p>æˆ‘ä»¬æ¥çœ‹ä¸€ä¸‹ Spring Reference ä¸­æä¾›çš„ä¸€ä¸ªä¾‹å­ï¼š</p>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
</pre></td><td class="rouge-code"><pre><span class="kn">package</span> <span class="n">fiona</span><span class="o">.</span><span class="na">apple</span><span class="o">;</span>

<span class="c1">// no more Spring imports!</span>

<span class="kd">public</span> <span class="kd">abstract</span> <span class="kd">class</span> <span class="nc">CommandManager</span> <span class="o">{</span>

    <span class="kd">public</span> <span class="nc">Object</span> <span class="nf">process</span><span class="o">(</span><span class="nc">Object</span> <span class="n">commandState</span><span class="o">)</span> <span class="o">{</span>
        <span class="c1">// grab a new instance of the appropriate Command interface</span>
        <span class="nc">Command</span> <span class="n">command</span> <span class="o">=</span> <span class="n">createCommand</span><span class="o">();</span>
        <span class="c1">// set the state on the (hopefully brand new) Command instance</span>
        <span class="n">command</span><span class="o">.</span><span class="na">setState</span><span class="o">(</span><span class="n">commandState</span><span class="o">);</span>
        <span class="k">return</span> <span class="n">command</span><span class="o">.</span><span class="na">execute</span><span class="o">();</span>
    <span class="o">}</span>

    <span class="c1">// okay... but where is the implementation of this method?</span>
    <span class="kd">protected</span> <span class="kd">abstract</span> <span class="nc">Command</span> <span class="nf">createCommand</span><span class="o">();</span>
<span class="o">}</span>
</pre></td></tr></tbody></table></code></pre></div></div>

<p>xml é…ç½® <code class="highlighter-rouge">&lt;lookup-method /&gt;</code>ï¼š</p>

<div class="language-xml highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
</pre></td><td class="rouge-code"><pre><span class="c">&lt;!-- a stateful bean deployed as a prototype (non-singleton) --&gt;</span>
<span class="nt">&lt;bean</span> <span class="na">id=</span><span class="s">"myCommand"</span> <span class="na">class=</span><span class="s">"fiona.apple.AsyncCommand"</span> <span class="na">scope=</span><span class="s">"prototype"</span><span class="nt">&gt;</span>
    <span class="c">&lt;!-- inject dependencies here as required --&gt;</span>
<span class="nt">&lt;/bean&gt;</span>

<span class="c">&lt;!-- commandProcessor uses statefulCommandHelper --&gt;</span>
<span class="nt">&lt;bean</span> <span class="na">id=</span><span class="s">"commandManager"</span> <span class="na">class=</span><span class="s">"fiona.apple.CommandManager"</span><span class="nt">&gt;</span>
    <span class="nt">&lt;lookup-method</span> <span class="na">name=</span><span class="s">"createCommand"</span> <span class="na">bean=</span><span class="s">"myCommand"</span><span class="nt">/&gt;</span>
<span class="nt">&lt;/bean&gt;</span>
</pre></td></tr></tbody></table></code></pre></div></div>

<p>Spring é‡‡ç”¨ <strong>CGLIB ç”Ÿæˆå­—èŠ‚ç </strong>çš„æ–¹å¼æ¥ç”Ÿæˆä¸€ä¸ªå­ç±»ã€‚æˆ‘ä»¬å®šä¹‰çš„ç±»ä¸èƒ½å®šä¹‰ä¸º final classï¼ŒæŠ½è±¡æ–¹æ³•ä¸Šä¹Ÿä¸èƒ½åŠ  finalã€‚</p>

<p>lookup-method ä¸Šçš„é…ç½®ä¹Ÿå¯ä»¥é‡‡ç”¨æ³¨è§£æ¥å®Œæˆï¼Œè¿™æ ·å°±å¯ä»¥ä¸ç”¨é…ç½® <code class="highlighter-rouge">&lt;lookup-method /&gt;</code> äº†ï¼Œå…¶ä»–ä¸å˜ï¼š</p>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
</pre></td><td class="rouge-code"><pre><span class="kd">public</span> <span class="kd">abstract</span> <span class="kd">class</span> <span class="nc">CommandManager</span> <span class="o">{</span>

    <span class="kd">public</span> <span class="nc">Object</span> <span class="nf">process</span><span class="o">(</span><span class="nc">Object</span> <span class="n">commandState</span><span class="o">)</span> <span class="o">{</span>
        <span class="nc">MyCommand</span> <span class="n">command</span> <span class="o">=</span> <span class="n">createCommand</span><span class="o">();</span>
        <span class="n">command</span><span class="o">.</span><span class="na">setState</span><span class="o">(</span><span class="n">commandState</span><span class="o">);</span>
        <span class="k">return</span> <span class="n">command</span><span class="o">.</span><span class="na">execute</span><span class="o">();</span>
    <span class="o">}</span>

    <span class="nd">@Lookup</span><span class="o">(</span><span class="s">"myCommand"</span><span class="o">)</span>
    <span class="kd">protected</span> <span class="kd">abstract</span> <span class="nc">Command</span> <span class="nf">createCommand</span><span class="o">();</span>
<span class="o">}</span>
</pre></td></tr></tbody></table></code></pre></div></div>

<blockquote>
  <p>æ³¨æ„ï¼Œæ—¢ç„¶ç”¨äº†æ³¨è§£ï¼Œè¦é…ç½®æ³¨è§£æ‰«æï¼š<code class="highlighter-rouge">&lt;context:component-scan base-package="com.javadoop" /&gt;</code></p>
</blockquote>

<p>ç”šè‡³ï¼Œæˆ‘ä»¬å¯ä»¥åƒä¸‹é¢è¿™æ ·ï¼š</p>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
</pre></td><td class="rouge-code"><pre><span class="kd">public</span> <span class="kd">abstract</span> <span class="kd">class</span> <span class="nc">CommandManager</span> <span class="o">{</span>

    <span class="kd">public</span> <span class="nc">Object</span> <span class="nf">process</span><span class="o">(</span><span class="nc">Object</span> <span class="n">commandState</span><span class="o">)</span> <span class="o">{</span>
        <span class="nc">MyCommand</span> <span class="n">command</span> <span class="o">=</span> <span class="n">createCommand</span><span class="o">();</span>
        <span class="n">command</span><span class="o">.</span><span class="na">setState</span><span class="o">(</span><span class="n">commandState</span><span class="o">);</span>
        <span class="k">return</span> <span class="n">command</span><span class="o">.</span><span class="na">execute</span><span class="o">();</span>
    <span class="o">}</span>

    <span class="nd">@Lookup</span>
    <span class="kd">protected</span> <span class="kd">abstract</span> <span class="nc">MyCommand</span> <span class="nf">createCommand</span><span class="o">();</span>
<span class="o">}</span>
</pre></td></tr></tbody></table></code></pre></div></div>

<blockquote>
  <p>ä¸Šé¢çš„è¿”å›å€¼ç”¨äº† MyCommandï¼Œå½“ç„¶ï¼Œå¦‚æœ Command åªæœ‰ä¸€ä¸ªå®ç°ç±»ï¼Œé‚£è¿”å›å€¼ä¹Ÿå¯ä»¥å†™ Commandã€‚</p>
</blockquote>

<h4 id="replaced-method">replaced-method</h4>

<p>è®°ä½å®ƒçš„åŠŸèƒ½ï¼Œå°±æ˜¯æ›¿æ¢æ‰ bean ä¸­çš„ä¸€äº›æ–¹æ³•ã€‚</p>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
</pre></td><td class="rouge-code"><pre><span class="kd">public</span> <span class="kd">class</span> <span class="nc">MyValueCalculator</span> <span class="o">{</span>

    <span class="kd">public</span> <span class="nc">String</span> <span class="nf">computeValue</span><span class="o">(</span><span class="nc">String</span> <span class="n">input</span><span class="o">)</span> <span class="o">{</span>
        <span class="c1">// some real code...</span>
    <span class="o">}</span>

    <span class="c1">// some other methods...</span>
<span class="o">}</span>
</pre></td></tr></tbody></table></code></pre></div></div>

<p>æ–¹æ³•è¦†å†™ï¼Œæ³¨æ„è¦å®ç° MethodReplacer æ¥å£ï¼š</p>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
</pre></td><td class="rouge-code"><pre><span class="kd">public</span> <span class="kd">class</span> <span class="nc">ReplacementComputeValue</span> <span class="kd">implements</span> <span class="n">org</span><span class="o">.</span><span class="na">springframework</span><span class="o">.</span><span class="na">beans</span><span class="o">.</span><span class="na">factory</span><span class="o">.</span><span class="na">support</span><span class="o">.</span><span class="na">MethodReplacer</span> <span class="o">{</span>

    <span class="kd">public</span> <span class="nc">Object</span> <span class="nf">reimplement</span><span class="o">(</span><span class="nc">Object</span> <span class="n">o</span><span class="o">,</span> <span class="nc">Method</span> <span class="n">m</span><span class="o">,</span> <span class="nc">Object</span><span class="o">[]</span> <span class="n">args</span><span class="o">)</span> <span class="kd">throws</span> <span class="nc">Throwable</span> <span class="o">{</span>
        <span class="c1">// get the input value, work with it, and return a computed result</span>
        <span class="nc">String</span> <span class="n">input</span> <span class="o">=</span> <span class="o">(</span><span class="nc">String</span><span class="o">)</span> <span class="n">args</span><span class="o">[</span><span class="mi">0</span><span class="o">];</span>
        <span class="o">...</span>
        <span class="k">return</span> <span class="o">...;</span>
    <span class="o">}</span>
<span class="o">}</span>
</pre></td></tr></tbody></table></code></pre></div></div>

<p>é…ç½®ä¹Ÿå¾ˆç®€å•ï¼š</p>

<div class="language-xml highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
</pre></td><td class="rouge-code"><pre><span class="nt">&lt;bean</span> <span class="na">id=</span><span class="s">"myValueCalculator"</span> <span class="na">class=</span><span class="s">"x.y.z.MyValueCalculator"</span><span class="nt">&gt;</span>
    <span class="c">&lt;!-- å®šä¹‰ computeValue è¿™ä¸ªæ–¹æ³•è¦è¢«æ›¿æ¢æ‰ --&gt;</span>
    <span class="nt">&lt;replaced-method</span> <span class="na">name=</span><span class="s">"computeValue"</span> <span class="na">replacer=</span><span class="s">"replacementComputeValue"</span><span class="nt">&gt;</span>
        <span class="nt">&lt;arg-type&gt;</span>String<span class="nt">&lt;/arg-type&gt;</span>
    <span class="nt">&lt;/replaced-method&gt;</span>
<span class="nt">&lt;/bean&gt;</span>

<span class="nt">&lt;bean</span> <span class="na">id=</span><span class="s">"replacementComputeValue"</span> <span class="na">class=</span><span class="s">"a.b.c.ReplacementComputeValue"</span><span class="nt">/&gt;</span>
</pre></td></tr></tbody></table></code></pre></div></div>

<blockquote>
  <p>arg-type æ˜æ˜¾ä¸æ˜¯å¿…é¡»çš„ï¼Œé™¤éå­˜åœ¨æ–¹æ³•é‡è½½ï¼Œè¿™æ ·å¿…é¡»é€šè¿‡å‚æ•°ç±»å‹åˆ—è¡¨æ¥åˆ¤æ–­è¿™é‡Œè¦è¦†ç›–å“ªä¸ªæ–¹æ³•ã€‚</p>
</blockquote>

<h3 id="beanpostprocessor">BeanPostProcessor</h3>

<p>åº”è¯¥è¯´ BeanPostProcessor æ¦‚å¿µåœ¨ Spring ä¸­ä¹Ÿæ˜¯æ¯”è¾ƒé‡è¦çš„ã€‚æˆ‘ä»¬çœ‹ä¸‹æ¥å£å®šä¹‰ï¼š</p>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
</pre></td><td class="rouge-code"><pre><span class="kd">public</span> <span class="kd">interface</span> <span class="nc">BeanPostProcessor</span> <span class="o">{</span>

   <span class="nc">Object</span> <span class="nf">postProcessBeforeInitialization</span><span class="o">(</span><span class="nc">Object</span> <span class="n">bean</span><span class="o">,</span> <span class="nc">String</span> <span class="n">beanName</span><span class="o">)</span> <span class="kd">throws</span> <span class="nc">BeansException</span><span class="o">;</span>

   <span class="nc">Object</span> <span class="nf">postProcessAfterInitialization</span><span class="o">(</span><span class="nc">Object</span> <span class="n">bean</span><span class="o">,</span> <span class="nc">String</span> <span class="n">beanName</span><span class="o">)</span> <span class="kd">throws</span> <span class="nc">BeansException</span><span class="o">;</span>

<span class="o">}</span>
</pre></td></tr></tbody></table></code></pre></div></div>

<p>çœ‹è¿™ä¸ªæ¥å£ä¸­çš„ä¸¤ä¸ªæ–¹æ³•åå­—æˆ‘ä»¬å¤§ä½“ä¸Šå¯ä»¥çŒœæµ‹ bean åœ¨åˆå§‹åŒ–ä¹‹å‰ä¼šæ‰§è¡Œ postProcessBeforeInitialization è¿™ä¸ªæ–¹æ³•ï¼Œåˆå§‹åŒ–å®Œæˆä¹‹åä¼šæ‰§è¡Œ postProcessAfterInitialization è¿™ä¸ªæ–¹æ³•ã€‚ä½†æ˜¯ï¼Œè¿™ä¹ˆç†è§£æ˜¯éå¸¸ç‰‡é¢çš„ã€‚</p>

<p>é¦–å…ˆï¼Œæˆ‘ä»¬è¦æ˜ç™½ï¼Œé™¤äº†æˆ‘ä»¬è‡ªå·±å®šä¹‰çš„ BeanPostProcessor å®ç°å¤–ï¼ŒSpring å®¹å™¨åœ¨å¯åŠ¨æ—¶è‡ªåŠ¨ç»™æˆ‘ä»¬ä¹ŸåŠ äº†å‡ ä¸ªã€‚å¦‚åœ¨è·å– BeanFactory çš„ obtainFactory() æ–¹æ³•ç»“æŸåçš„ prepareBeanFactory(factory)ï¼Œå¤§å®¶ä»”ç»†çœ‹ä¼šå‘ç°ï¼ŒSpring å¾€å®¹å™¨ä¸­æ·»åŠ äº†è¿™ä¸¤ä¸ª BeanPostProcessorï¼šApplicationContextAwareProcessorã€ApplicationListenerDetectorã€‚</p>

<p>æˆ‘ä»¬å›åˆ°è¿™ä¸ªæ¥å£æœ¬èº«ï¼Œè¯»è€…è¯·çœ‹ç¬¬ä¸€ä¸ªæ–¹æ³•ï¼Œè¿™ä¸ªæ–¹æ³•æ¥å—çš„ç¬¬ä¸€ä¸ªå‚æ•°æ˜¯ bean å®ä¾‹ï¼Œç¬¬äºŒä¸ªå‚æ•°æ˜¯ bean çš„åå­—ï¼Œé‡ç‚¹åœ¨è¿”å›å€¼å°†ä¼šä½œä¸ºæ–°çš„ bean å®ä¾‹ï¼Œæ‰€ä»¥ï¼Œæ²¡äº‹çš„è¯è¿™é‡Œä¸èƒ½éšä¾¿è¿”å›ä¸ª nullã€‚</p>

<p>é‚£æ„å‘³ç€ä»€ä¹ˆå‘¢ï¼Ÿæˆ‘ä»¬å¾ˆå®¹æ˜“æƒ³åˆ°çš„å°±æ˜¯ï¼Œæˆ‘ä»¬è¿™é‡Œå¯ä»¥å¯¹ä¸€äº›æˆ‘ä»¬æƒ³è¦ä¿®é¥°çš„ bean å®ä¾‹åšä¸€äº›äº‹æƒ…ã€‚ä½†æ˜¯å¯¹äº Spring æ¡†æ¶æ¥è¯´ï¼Œå®ƒä¼šå†³å®šæ˜¯ä¸æ˜¯è¦åœ¨è¿™ä¸ªæ–¹æ³•ä¸­è¿”å› bean å®ä¾‹çš„ä»£ç†ï¼Œè¿™æ ·å°±æœ‰æ›´å¤§çš„æƒ³è±¡ç©ºé—´äº†ã€‚</p>

<p>æœ€åï¼Œæˆ‘ä»¬è¯´è¯´å¦‚æœæˆ‘ä»¬è‡ªå·±å®šä¹‰ä¸€ä¸ª bean å®ç° BeanPostProcessor çš„è¯ï¼Œå®ƒçš„æ‰§è¡Œæ—¶æœºæ˜¯ä»€ä¹ˆæ—¶å€™ï¼Ÿ</p>

<p>å¦‚æœä»”ç»†çœ‹äº†ä»£ç åˆ†æçš„è¯ï¼Œå…¶å®å¾ˆå®¹æ˜“çŸ¥é“äº†ï¼Œåœ¨ bean å®ä¾‹åŒ–å®Œæˆã€å±æ€§æ³¨å…¥å®Œæˆä¹‹åï¼Œä¼šæ‰§è¡Œå›è°ƒæ–¹æ³•ï¼Œå…·ä½“è¯·å‚è§ç±» AbstractAutowireCapableBeanFactory#initBean æ–¹æ³•ã€‚</p>

<p>é¦–å…ˆä¼šå›è°ƒå‡ ä¸ªå®ç°äº† Aware æ¥å£çš„ beanï¼Œç„¶åå°±å¼€å§‹å›è°ƒ BeanPostProcessor çš„ postProcessBeforeInitialization æ–¹æ³•ï¼Œä¹‹åæ˜¯å›è°ƒ init-methodï¼Œç„¶åå†å›è°ƒ BeanPostProcessor çš„ postProcessAfterInitialization æ–¹æ³•ã€‚</p>

<h2 id="æ€»ç»“">æ€»ç»“</h2>

<p>æŒ‰ç†è¯´ï¼Œæ€»ç»“åº”è¯¥å†™åœ¨é™„å½•å‰é¢ï¼Œæˆ‘å°±ä¸è®²ç©¶äº†ã€‚</p>

<p>åœ¨èŠ±äº†é‚£ä¹ˆå¤šæ—¶é—´åï¼Œè¿™ç¯‡æ–‡ç« ç»ˆäºç®—æ˜¯åŸºæœ¬å†™å®Œäº†ï¼Œå¤§å®¶åœ¨æƒŠå¹ Spring ç»™æˆ‘ä»¬åšäº†é‚£ä¹ˆå¤šçš„äº‹çš„æ—¶å€™ï¼Œåº”è¯¥é€è¿‡ç°è±¡çœ‹æœ¬è´¨ï¼Œå»ç†è§£ Spring å†™å¾—å¥½çš„åœ°æ–¹ï¼Œå»ç†è§£å®ƒçš„è®¾è®¡æ€æƒ³ã€‚</p>

<p>æœ¬æ–‡çš„ç¼ºé™·åœ¨äºå¯¹ Spring é¢„åˆå§‹åŒ– singleton beans çš„è¿‡ç¨‹åˆ†æä¸å¤Ÿï¼Œä¸»è¦æ˜¯ä»£ç é‡çœŸçš„æ¯”è¾ƒå¤§ï¼Œåˆ†æ”¯æ—è·¯ä¼—å¤šã€‚åŒæ—¶ï¼Œè™½ç„¶é™„å½•æ¡ç›®ä¸å°‘ï¼Œä½†æ˜¯åºå¤§çš„ Spring çœŸçš„å¼•å‡ºäº†å¾ˆå¤šçš„æ¦‚å¿µï¼Œå¸Œæœ›æ—¥åæœ‰ç²¾åŠ›å¯ä»¥æ…¢æ…¢è¡¥å……ä¸€äº›ã€‚</p>
:ET