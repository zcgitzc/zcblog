I"Âv<blockquote>
  <p>æœ¬æ–‡æ¥è‡ªäºæˆ‘çš„<a href="https://www.imooc.com/u/4024769">æ…•è¯¾ç½‘æ‰‹è®°</a>ï¼š<a href="https://www.imooc.com/article/288342">å°é©¬å“¥Javaé¢è¯•é¢˜è¯¾ç¨‹æ€»ç»“</a>ï¼Œè½¬è½½è¯·ä¿ç•™é“¾æ¥ ;)</p>
</blockquote>

<p>å‰æ®µæ—¶é—´åœ¨æ…•è¯¾ç½‘ç›´æ’­ä¸Šå¬<a href="https://www.imooc.com/t/5387391">å°é©¬å“¥</a>é¢è¯•åŠé€€ï¼ˆâ€é¢è¯•è™æˆ‘åƒç™¾éï¼ŒJava å¹¶å‘çœŸè®¨åŒâ€ï¼‰ï¼Œå‘ç°è®²å¾—ä¸œè¥¿æ¯”è‡ªå·±æ‹¿åˆ°offerè¿˜è¦é«˜å…´ï¼Œäºæ˜¯è‡ªå·±åœ¨çº¿ä¸‹åšäº†ä¸€ç‚¹å°ç¬”è®°ï¼Œä¾›å„ä½å‚è€ƒã€‚</p>

<p>è¯¾ç¨‹åœ°å€ï¼š<a href="https://www.bilibili.com/video/av49124110">https://www.bilibili.com/video/av49124110</a></p>

<p>æºç æ–‡æ¡£åœ°å€ï¼š<a href="https://github.com/mercyblitz/tech-weekly/tree/master/2019.04.12%20%E3%80%8C%E5%B0%8F%E9%A9%AC%E5%93%A5%E6%8A%80%E6%9C%AF%E5%91%A8%E6%8A%A5%E3%80%8D-%20%E7%AC%AC%E4%BA%8C%E5%8D%81%E4%B8%89%E6%9C%9F%E3%80%8A%E9%9D%A2%E8%AF%95%E8%99%90%E6%88%91%E5%8D%83%E7%99%BE%E9%81%8D%EF%BC%8CJava%20%E5%B9%B6%E5%8F%91%E7%9C%9F%E8%AE%A8%E5%8E%8C%EF%BC%88%E7%BB%AD%EF%BC%89%E3%80%8B">https://github.com/mercyblitz/tech-weekly</a></p>

<h2 id="java-å¤šçº¿ç¨‹">Java å¤šçº¿ç¨‹</h2>

<h3 id="1çº¿ç¨‹åˆ›å»º">1ã€çº¿ç¨‹åˆ›å»º</h3>

<h4 id="åŸºæœ¬ç‰ˆ">åŸºæœ¬ç‰ˆ</h4>
<p>æœ‰å“ªäº›æ–¹æ³•åˆ›å»ºçº¿ç¨‹ï¼Ÿ</p>

<p>ä»…ä»…åªæœ‰<strong>new thread</strong>è¿™ç§æ–¹æ³•åˆ›å»ºçº¿ç¨‹</p>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
</pre></td><td class="rouge-code"><pre><span class="kd">public</span> <span class="kd">class</span> <span class="nc">ThreadCreationQuestion</span> <span class="o">{</span>

    <span class="kd">public</span> <span class="kd">static</span> <span class="kt">void</span> <span class="nf">main</span><span class="o">(</span><span class="nc">String</span><span class="o">[]</span> <span class="n">args</span><span class="o">)</span> <span class="o">{</span>
        <span class="c1">// main çº¿ç¨‹ -&gt; å­çº¿ç¨‹</span>
        <span class="nc">Thread</span> <span class="n">thread</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">Thread</span><span class="o">(()</span> <span class="o">-&gt;</span> <span class="o">{</span>
        <span class="o">},</span> <span class="s">"å­çº¿ç¨‹-1"</span><span class="o">);</span>

    <span class="o">}</span>

    <span class="cm">/**
     * ä¸é¼“åŠ±è‡ªå®šä¹‰ï¼ˆæ‰©å±•ï¼‰ Thread
     */</span>
    <span class="kd">private</span> <span class="kd">static</span> <span class="kd">class</span> <span class="nc">MyThread</span> <span class="kd">extends</span> <span class="nc">Thread</span> <span class="o">{</span>

        <span class="cm">/**
         * å¤šæ€çš„æ–¹å¼ï¼Œè¦†ç›–çˆ¶ç±»å®ç°
         */</span>
        <span class="nd">@Override</span>
        <span class="kd">public</span> <span class="kt">void</span> <span class="nf">run</span><span class="o">(){</span>
            <span class="kd">super</span><span class="o">.</span><span class="na">run</span><span class="o">();</span>
        <span class="o">}</span>
    <span class="o">}</span>

<span class="o">}</span>
</pre></td></tr></tbody></table></code></pre></div></div>

<p>ä¸è¿è¡Œçº¿ç¨‹æ–¹æ³•åŒºåˆ†ï¼š
<strong>java.lang.Runnable()</strong> æˆ– <strong>java.lang.Threadç±»</strong></p>

<h4 id="è¿›é˜¶ç‰ˆ">è¿›é˜¶ç‰ˆ</h4>
<p>å¦‚ä½•é€šè¿‡Java åˆ›å»ºè¿›ç¨‹ï¼Ÿ</p>
<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
</pre></td><td class="rouge-code"><pre><span class="kd">public</span> <span class="kd">class</span> <span class="nc">ProcessCreationQuestion</span> <span class="o">{</span>

    <span class="kd">public</span> <span class="kd">static</span> <span class="kt">void</span> <span class="nf">main</span><span class="o">(</span><span class="nc">String</span><span class="o">[]</span> <span class="n">args</span><span class="o">)</span> <span class="kd">throws</span> <span class="nc">IOException</span> <span class="o">{</span>

        <span class="c1">// è·å– Java Runtime</span>
        <span class="nc">Runtime</span> <span class="n">runtime</span> <span class="o">=</span> <span class="nc">Runtime</span><span class="o">.</span><span class="na">getRuntime</span><span class="o">();</span>
        <span class="nc">Process</span> <span class="n">process</span> <span class="o">=</span> <span class="n">runtime</span><span class="o">.</span><span class="na">exec</span><span class="o">(</span><span class="s">"cmd /k start http://www.baidu.com"</span><span class="o">);</span>
        <span class="n">process</span><span class="o">.</span><span class="na">exitValue</span><span class="o">();</span>
    <span class="o">}</span>
<span class="o">}</span>
</pre></td></tr></tbody></table></code></pre></div></div>

<h4 id="åŠé€€ç‰ˆ">åŠé€€ç‰ˆ</h4>
<p>å¦‚ä½•é”€æ¯ä¸€ä¸ªçº¿ç¨‹ï¼Ÿ</p>
<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
</pre></td><td class="rouge-code"><pre><span class="kd">public</span> <span class="kd">class</span> <span class="nc">ThreadStateQuestion</span> <span class="o">{</span>


    <span class="kd">public</span> <span class="kd">static</span> <span class="kt">void</span> <span class="nf">main</span><span class="o">(</span><span class="nc">String</span><span class="o">[]</span> <span class="n">args</span><span class="o">)</span> <span class="o">{</span>

        <span class="c1">// main çº¿ç¨‹ -&gt; å­çº¿ç¨‹</span>
        <span class="nc">Thread</span> <span class="n">thread</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">Thread</span><span class="o">(()</span> <span class="o">-&gt;</span> <span class="o">{</span> <span class="c1">// new Runnable(){ public void run(){...}};</span>
            <span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">printf</span><span class="o">(</span><span class="s">"çº¿ç¨‹[%s] æ­£åœ¨æ‰§è¡Œ...\n"</span><span class="o">,</span> <span class="nc">Thread</span><span class="o">.</span><span class="na">currentThread</span><span class="o">().</span><span class="na">getName</span><span class="o">());</span>  <span class="c1">// 2</span>
        <span class="o">},</span> <span class="s">"å­çº¿ç¨‹-1"</span><span class="o">);</span>

        <span class="c1">// å¯åŠ¨çº¿ç¨‹</span>
        <span class="n">thread</span><span class="o">.</span><span class="na">start</span><span class="o">();</span>

        <span class="c1">// å…ˆäº Runnable æ‰§è¡Œ</span>
        <span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">printf</span><span class="o">(</span><span class="s">"çº¿ç¨‹[%s] æ˜¯å¦è¿˜æ´»ç€: %s\n"</span><span class="o">,</span> <span class="n">thread</span><span class="o">.</span><span class="na">getName</span><span class="o">(),</span> <span class="n">thread</span><span class="o">.</span><span class="na">isAlive</span><span class="o">());</span> <span class="c1">// 1</span>
        <span class="c1">// åœ¨ Java ä¸­ï¼Œæ‰§è¡Œçº¿ç¨‹ Java æ˜¯æ²¡æœ‰åŠæ³•é”€æ¯å®ƒçš„ï¼Œ</span>
        <span class="c1">// ä½†æ˜¯å½“ Thread.isAlive() è¿”å› false æ—¶ï¼Œå®é™…åº•å±‚çš„ Thread å·²ç»è¢«é”€æ¯äº†</span>
    <span class="o">}</span>
</pre></td></tr></tbody></table></code></pre></div></div>

<p>Javaä»£ç ä¸­æ˜¯æ— æ³•å®ç°çš„ï¼Œåªèƒ½è¡¨ç°ä¸€ä¸ªçº¿ç¨‹çš„çŠ¶æ€ã€‚</p>

<p>è€ŒCPPæ˜¯å¯ä»¥å®ç°çš„ã€‚</p>

<h3 id="2çº¿ç¨‹æ‰§è¡Œ">2ã€çº¿ç¨‹æ‰§è¡Œ</h3>

<h4 id="åŸºæœ¬ç‰ˆ-1">åŸºæœ¬ç‰ˆ</h4>
<p>å¦‚ä½•é€šè¿‡ Java API å¯åŠ¨çº¿ç¨‹ï¼Ÿ</p>

<p><strong>thread.start();</strong></p>

<h4 id="è¿›é˜¶ç‰ˆ-1">è¿›é˜¶ç‰ˆ</h4>
<p>å½“æœ‰çº¿ç¨‹ T1ã€T2 ä»¥åŠ T3ï¼Œå¦‚ä½•å®ç°T1 -&gt; T2 -&gt; T3çš„æ‰§è¡Œé¡ºåºï¼Ÿ</p>
<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
</pre></td><td class="rouge-code"><pre><span class="kd">private</span> <span class="kd">static</span> <span class="kt">void</span> <span class="nf">threadJoinOneByOne</span><span class="o">()</span> <span class="kd">throws</span> <span class="nc">InterruptedException</span> <span class="o">{</span>
        <span class="nc">Thread</span> <span class="n">t1</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">Thread</span><span class="o">(</span><span class="nl">ThreadExecutionQuestion:</span><span class="o">:</span><span class="n">action</span><span class="o">,</span> <span class="s">"t1"</span><span class="o">);</span>
        <span class="nc">Thread</span> <span class="n">t2</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">Thread</span><span class="o">(</span><span class="nl">ThreadExecutionQuestion:</span><span class="o">:</span><span class="n">action</span><span class="o">,</span> <span class="s">"t2"</span><span class="o">);</span>
        <span class="nc">Thread</span> <span class="n">t3</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">Thread</span><span class="o">(</span><span class="nl">ThreadExecutionQuestion:</span><span class="o">:</span><span class="n">action</span><span class="o">,</span> <span class="s">"t3"</span><span class="o">);</span>

        <span class="c1">// start() ä»…æ˜¯é€šçŸ¥çº¿ç¨‹å¯åŠ¨</span>
        <span class="n">t1</span><span class="o">.</span><span class="na">start</span><span class="o">();</span>
        <span class="c1">// join() æ§åˆ¶çº¿ç¨‹å¿…é¡»æ‰§è¡Œå®Œæˆ</span>
        <span class="n">t1</span><span class="o">.</span><span class="na">join</span><span class="o">();</span>

        <span class="n">t2</span><span class="o">.</span><span class="na">start</span><span class="o">();</span>
        <span class="n">t2</span><span class="o">.</span><span class="na">join</span><span class="o">();</span>

        <span class="n">t3</span><span class="o">.</span><span class="na">start</span><span class="o">();</span>
        <span class="n">t3</span><span class="o">.</span><span class="na">join</span><span class="o">();</span>
    <span class="o">}</span>

    <span class="kd">private</span> <span class="kd">static</span> <span class="kt">void</span> <span class="nf">action</span><span class="o">()</span> <span class="o">{</span>
        <span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">printf</span><span class="o">(</span><span class="s">"çº¿ç¨‹[%s] æ­£åœ¨æ‰§è¡Œ...\n"</span><span class="o">,</span> <span class="nc">Thread</span><span class="o">.</span><span class="na">currentThread</span><span class="o">().</span><span class="na">getName</span><span class="o">());</span>  <span class="c1">// 2</span>
    <span class="o">}</span>
<span class="o">}</span>
</pre></td></tr></tbody></table></code></pre></div></div>
<p><strong>CountDownLatch</strong>ä¹Ÿå¯ä»¥å®ç°ï¼›</p>

<p><strong>è°ƒæ•´ä¼˜å…ˆçº§</strong>å¹¶ä¸èƒ½ä¿è¯ä¼˜å…ˆçº§é«˜çš„çº¿ç¨‹å…ˆæ‰§è¡Œã€‚</p>

<h4 id="åŠé€€ç‰ˆ-1">åŠé€€ç‰ˆ</h4>
<p>ä»¥ä¸Šé—®é¢˜è¯·è‡³å°‘æä¾›å¦å¤–ä¸€ç§å®ç°ï¼Ÿï¼ˆ1.5ï¼‰</p>

<p>1ã€spin æ–¹æ³•</p>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
</pre></td><td class="rouge-code"><pre>    <span class="kd">private</span> <span class="kd">static</span> <span class="kt">void</span> <span class="nf">threadLoop</span><span class="o">()</span> <span class="o">{</span>

        <span class="nc">Thread</span> <span class="n">t1</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">Thread</span><span class="o">(</span><span class="nl">ThreadExecutionQuestion:</span><span class="o">:</span><span class="n">action</span><span class="o">,</span> <span class="s">"t1"</span><span class="o">);</span>
        <span class="nc">Thread</span> <span class="n">t2</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">Thread</span><span class="o">(</span><span class="nl">ThreadExecutionQuestion:</span><span class="o">:</span><span class="n">action</span><span class="o">,</span> <span class="s">"t2"</span><span class="o">);</span>
        <span class="nc">Thread</span> <span class="n">t3</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">Thread</span><span class="o">(</span><span class="nl">ThreadExecutionQuestion:</span><span class="o">:</span><span class="n">action</span><span class="o">,</span> <span class="s">"t3"</span><span class="o">);</span>

        <span class="n">t1</span><span class="o">.</span><span class="na">start</span><span class="o">();</span>

        <span class="k">while</span> <span class="o">(</span><span class="n">t1</span><span class="o">.</span><span class="na">isAlive</span><span class="o">())</span> <span class="o">{</span>
            <span class="c1">// è‡ªæ—‹ Spin</span>
        <span class="o">}</span>

        <span class="n">t2</span><span class="o">.</span><span class="na">start</span><span class="o">();</span>

        <span class="k">while</span> <span class="o">(</span><span class="n">t2</span><span class="o">.</span><span class="na">isAlive</span><span class="o">())</span> <span class="o">{</span>

        <span class="o">}</span>

        <span class="n">t3</span><span class="o">.</span><span class="na">start</span><span class="o">();</span>

        <span class="k">while</span> <span class="o">(</span><span class="n">t3</span><span class="o">.</span><span class="na">isAlive</span><span class="o">())</span> <span class="o">{</span>

        <span class="o">}</span>
    <span class="o">}</span>
</pre></td></tr></tbody></table></code></pre></div></div>

<p>2ã€sleep æ–¹æ³•</p>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
</pre></td><td class="rouge-code"><pre> <span class="kd">private</span> <span class="kd">static</span> <span class="kt">void</span> <span class="nf">threadSleep</span><span class="o">()</span> <span class="kd">throws</span> <span class="nc">InterruptedException</span> <span class="o">{</span>

        <span class="nc">Thread</span> <span class="n">t1</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">Thread</span><span class="o">(</span><span class="nl">ThreadExecutionQuestion:</span><span class="o">:</span><span class="n">action</span><span class="o">,</span> <span class="s">"t1"</span><span class="o">);</span>
        <span class="nc">Thread</span> <span class="n">t2</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">Thread</span><span class="o">(</span><span class="nl">ThreadExecutionQuestion:</span><span class="o">:</span><span class="n">action</span><span class="o">,</span> <span class="s">"t2"</span><span class="o">);</span>
        <span class="nc">Thread</span> <span class="n">t3</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">Thread</span><span class="o">(</span><span class="nl">ThreadExecutionQuestion:</span><span class="o">:</span><span class="n">action</span><span class="o">,</span> <span class="s">"t3"</span><span class="o">);</span>

        <span class="n">t1</span><span class="o">.</span><span class="na">start</span><span class="o">();</span>

        <span class="k">while</span> <span class="o">(</span><span class="n">t1</span><span class="o">.</span><span class="na">isAlive</span><span class="o">())</span> <span class="o">{</span>
            <span class="c1">// sleep</span>
            <span class="nc">Thread</span><span class="o">.</span><span class="na">sleep</span><span class="o">(</span><span class="mi">0</span><span class="o">);</span>
        <span class="o">}</span>

        <span class="n">t2</span><span class="o">.</span><span class="na">start</span><span class="o">();</span>

        <span class="k">while</span> <span class="o">(</span><span class="n">t2</span><span class="o">.</span><span class="na">isAlive</span><span class="o">())</span> <span class="o">{</span>
            <span class="nc">Thread</span><span class="o">.</span><span class="na">sleep</span><span class="o">(</span><span class="mi">0</span><span class="o">);</span>
        <span class="o">}</span>

        <span class="n">t3</span><span class="o">.</span><span class="na">start</span><span class="o">();</span>

        <span class="k">while</span> <span class="o">(</span><span class="n">t3</span><span class="o">.</span><span class="na">isAlive</span><span class="o">())</span> <span class="o">{</span>
            <span class="nc">Thread</span><span class="o">.</span><span class="na">sleep</span><span class="o">(</span><span class="mi">0</span><span class="o">);</span>
        <span class="o">}</span>

    <span class="o">}</span>
</pre></td></tr></tbody></table></code></pre></div></div>

<p>3ã€while æ–¹æ³•</p>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
</pre></td><td class="rouge-code"><pre>    <span class="kd">private</span> <span class="kd">static</span> <span class="kt">void</span> <span class="nf">threadWait</span><span class="o">()</span> <span class="kd">throws</span> <span class="nc">InterruptedException</span> <span class="o">{</span>

        <span class="nc">Thread</span> <span class="n">t1</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">Thread</span><span class="o">(</span><span class="nl">ThreadExecutionQuestion:</span><span class="o">:</span><span class="n">action</span><span class="o">,</span> <span class="s">"t1"</span><span class="o">);</span>
        <span class="nc">Thread</span> <span class="n">t2</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">Thread</span><span class="o">(</span><span class="nl">ThreadExecutionQuestion:</span><span class="o">:</span><span class="n">action</span><span class="o">,</span> <span class="s">"t2"</span><span class="o">);</span>
        <span class="nc">Thread</span> <span class="n">t3</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">Thread</span><span class="o">(</span><span class="nl">ThreadExecutionQuestion:</span><span class="o">:</span><span class="n">action</span><span class="o">,</span> <span class="s">"t3"</span><span class="o">);</span>

        <span class="n">threadStartAndWait</span><span class="o">(</span><span class="n">t1</span><span class="o">);</span>
        <span class="n">threadStartAndWait</span><span class="o">(</span><span class="n">t2</span><span class="o">);</span>
        <span class="n">threadStartAndWait</span><span class="o">(</span><span class="n">t3</span><span class="o">);</span>
    <span class="o">}</span>

    <span class="kd">private</span> <span class="kd">static</span> <span class="kt">void</span> <span class="nf">threadStartAndWait</span><span class="o">(</span><span class="nc">Thread</span> <span class="n">thread</span><span class="o">)</span> <span class="o">{</span>

        <span class="k">if</span> <span class="o">(</span><span class="nc">Thread</span><span class="o">.</span><span class="na">State</span><span class="o">.</span><span class="na">NEW</span><span class="o">.</span><span class="na">equals</span><span class="o">(</span><span class="n">thread</span><span class="o">.</span><span class="na">getState</span><span class="o">()))</span> <span class="o">{</span>
            <span class="n">thread</span><span class="o">.</span><span class="na">start</span><span class="o">();</span>
        <span class="o">}</span>

        <span class="k">while</span> <span class="o">(</span><span class="n">thread</span><span class="o">.</span><span class="na">isAlive</span><span class="o">())</span> <span class="o">{</span>
            <span class="kd">synchronized</span> <span class="o">(</span><span class="n">thread</span><span class="o">)</span> <span class="o">{</span>
                <span class="k">try</span> <span class="o">{</span>
                    <span class="n">thread</span><span class="o">.</span><span class="na">wait</span><span class="o">();</span> <span class="c1">// åˆ°åº•æ˜¯è°é€šçŸ¥ Thread -&gt; thread.notify();  JVMå¸®å®ƒå”¤èµ·</span>
                                  <span class="c1">// LockSupport.park(); </span>
                                 <span class="c1">// æ­»é”å‘ç”Ÿ</span>
                <span class="o">}</span> <span class="k">catch</span> <span class="o">(</span><span class="nc">Exception</span> <span class="n">e</span><span class="o">)</span> <span class="o">{</span>
                    <span class="k">throw</span> <span class="k">new</span> <span class="nf">RuntimeException</span><span class="o">(</span><span class="n">e</span><span class="o">);</span>
                <span class="o">}</span>
            <span class="o">}</span>
        <span class="o">}</span>
    <span class="o">}</span>
</pre></td></tr></tbody></table></code></pre></div></div>
<h3 id="3çº¿ç¨‹ç»ˆæ­¢">3ã€çº¿ç¨‹ç»ˆæ­¢</h3>

<h4 id="åŸºæœ¬ç‰ˆ-2">åŸºæœ¬ç‰ˆ</h4>
<p>å¦‚ä½•åœæ­¢ä¸€ä¸ªçº¿ç¨‹ï¼Ÿ</p>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
44
45
46
47
48
49
50
51
52
53
54
</pre></td><td class="rouge-code"><pre><span class="kd">public</span> <span class="kd">class</span> <span class="nc">HowToStopThreadQuestion</span> <span class="o">{</span>

    <span class="kd">public</span> <span class="kd">static</span> <span class="kt">void</span> <span class="nf">main</span><span class="o">(</span><span class="nc">String</span><span class="o">[]</span> <span class="n">args</span><span class="o">)</span> <span class="kd">throws</span> <span class="nc">InterruptedException</span> <span class="o">{</span>

        <span class="nc">Action</span> <span class="n">action</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">Action</span><span class="o">();</span>

        <span class="c1">// æ–¹æ³•ä¸€</span>
        <span class="nc">Thread</span> <span class="n">t1</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">Thread</span><span class="o">(</span><span class="n">action</span><span class="o">,</span> <span class="s">"t1"</span><span class="o">);</span>

        <span class="n">t1</span><span class="o">.</span><span class="na">start</span><span class="o">();</span>

        <span class="c1">// æ”¹å˜ action stopped çŠ¶æ€</span>
        <span class="n">action</span><span class="o">.</span><span class="na">setStopped</span><span class="o">(</span><span class="kc">true</span><span class="o">);</span>

        <span class="n">t1</span><span class="o">.</span><span class="na">join</span><span class="o">();</span>

        <span class="c1">// æ–¹æ³•äºŒ</span>
        <span class="nc">Thread</span> <span class="n">t2</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">Thread</span><span class="o">(()</span> <span class="o">-&gt;</span> <span class="o">{</span>
            <span class="k">if</span> <span class="o">(!</span><span class="nc">Thread</span><span class="o">.</span><span class="na">currentThread</span><span class="o">().</span><span class="na">isInterrupted</span><span class="o">())</span> <span class="o">{</span>
                <span class="n">action</span><span class="o">();</span>
            <span class="o">}</span>
        <span class="o">},</span> <span class="s">"t2"</span><span class="o">);</span>

        <span class="n">t2</span><span class="o">.</span><span class="na">start</span><span class="o">();</span>
        <span class="c1">// ä¸­æ–­æ“ä½œ(ä»…ä»…è®¾ç½®çŠ¶æ€ï¼Œè€Œå¹¶éä¸­æ­¢çº¿ç¨‹ï¼‰</span>
        <span class="n">t2</span><span class="o">.</span><span class="na">interrupt</span><span class="o">();</span>
        <span class="n">t2</span><span class="o">.</span><span class="na">join</span><span class="o">();</span>
    <span class="o">}</span>


    <span class="kd">private</span> <span class="kd">static</span> <span class="kd">class</span> <span class="nc">Action</span> <span class="kd">implements</span> <span class="nc">Runnable</span> <span class="o">{</span>

        <span class="c1">// çº¿ç¨‹å®‰å…¨é—®é¢˜ï¼Œç¡®ä¿å¯è§æ€§ï¼ˆHappens-Before)</span>
        <span class="kd">private</span> <span class="kd">volatile</span> <span class="kt">boolean</span> <span class="n">stopped</span> <span class="o">=</span> <span class="kc">false</span><span class="o">;</span>

        <span class="nd">@Override</span>
        <span class="kd">public</span> <span class="kt">void</span> <span class="nf">run</span><span class="o">()</span> <span class="o">{</span>
            <span class="k">if</span> <span class="o">(!</span><span class="n">stopped</span><span class="o">)</span> <span class="o">{</span>
                <span class="c1">// æ‰§è¡ŒåŠ¨ä½œ</span>
                <span class="n">action</span><span class="o">();</span>
            <span class="o">}</span>
        <span class="o">}</span>

        <span class="kd">public</span> <span class="kt">void</span> <span class="nf">setStopped</span><span class="o">(</span><span class="kt">boolean</span> <span class="n">stopped</span><span class="o">)</span> <span class="o">{</span>

            <span class="k">this</span><span class="o">.</span><span class="na">stopped</span> <span class="o">=</span> <span class="n">stopped</span><span class="o">;</span>
        <span class="o">}</span>
    <span class="o">}</span>

    <span class="kd">private</span> <span class="kd">static</span> <span class="kt">void</span> <span class="nf">action</span><span class="o">()</span> <span class="o">{</span>
        <span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">printf</span><span class="o">(</span><span class="s">"çº¿ç¨‹[%s] æ­£åœ¨æ‰§è¡Œ...\n"</span><span class="o">,</span> <span class="nc">Thread</span><span class="o">.</span><span class="na">currentThread</span><span class="o">().</span><span class="na">getName</span><span class="o">());</span>  <span class="c1">// 2</span>
    <span class="o">}</span>
<span class="o">}</span>

</pre></td></tr></tbody></table></code></pre></div></div>
<p>æƒ³è¦åœæ­¢ä¸€ä¸ªçº¿ç¨‹æ˜¯ä¸å¯èƒ½çš„ï¼ŒçœŸæ­£çš„åªèƒ½åœæ­¢é€»è¾‘ã€‚</p>

<h4 id="è¿›é˜¶ç‰ˆ-2">è¿›é˜¶ç‰ˆ</h4>
<p>ä¸ºä»€ä¹ˆ Java è¦æ”¾å¼ƒ Thread çš„ stop()æ–¹æ³•ï¼Ÿ</p>

<p><strong>Because it is inherently unsafe. Stopping a thread causes it to unlock all the monitors that it has locked.</strong>(The monitors are unlocked as the ThreadDeath exception propagates up the stack.) If any of the objects previously protected by these monitors were in an inconsistent state, other threads may now view these objects in an inconsistent state. Such objects are said to be damaged. When threads operate on damaged objects, arbitrary behavior can result. This behavior may be subtle and difficult to detect, or it may be pronounced. Unlike other unchecked exceptions, ThreadDeath kills threads silently; thus, the user has no warning that his program may be corrupted. The corruption can manifest itself at any time after the actual damage occurs, even hours or days in the future.</p>

<p>è¯¥æ–¹æ³•å…·æœ‰å›ºæœ‰çš„ä¸å®‰å…¨æ€§ã€‚ç”¨ Thread.stop æ¥ç»ˆæ­¢çº¿ç¨‹å°†é‡Šæ”¾å®ƒå·²ç»é”å®šçš„æ‰€æœ‰ç›‘è§†å™¨ï¼ˆä½œä¸ºæ²¿å †æ ˆå‘ä¸Šä¼ æ’­çš„æœªæ£€æŸ¥ ThreadDeath å¼‚å¸¸çš„ä¸€ä¸ªè‡ªç„¶åæœï¼‰ã€‚å¦‚æœä»¥å‰å—è¿™äº›ç›‘è§†å™¨ä¿æŠ¤çš„ä»»ä½•å¯¹è±¡éƒ½å¤„äºä¸€ç§ä¸ä¸€è‡´çš„çŠ¶æ€ï¼Œåˆ™æŸåçš„å¯¹è±¡å°†å¯¹å…¶ä»–çº¿ç¨‹å¯è§ï¼Œè¿™æœ‰å¯èƒ½å¯¼è‡´ä»»æ„çš„è¡Œä¸ºã€‚stop çš„è®¸å¤šä½¿ç”¨éƒ½åº”ç”±åªä¿®æ”¹æŸäº›å˜é‡ä»¥æŒ‡ç¤ºç›®æ ‡çº¿ç¨‹åº”è¯¥åœæ­¢è¿è¡Œçš„ä»£ç æ¥å–ä»£ã€‚ç›®æ ‡çº¿ç¨‹åº”å®šæœŸæ£€æŸ¥è¯¥å˜é‡ï¼Œå¹¶ä¸”å¦‚æœè¯¥å˜é‡æŒ‡ç¤ºå®ƒè¦åœæ­¢è¿è¡Œï¼Œåˆ™ä»å…¶è¿è¡Œæ–¹æ³•ä¾æ¬¡è¿”å›ã€‚å¦‚æœç›®æ ‡çº¿ç¨‹ç­‰å¾…å¾ˆé•¿æ—¶é—´ï¼ˆä¾‹å¦‚åŸºäºä¸€ä¸ªæ¡ä»¶å˜é‡ï¼‰ï¼Œåˆ™åº”ä½¿ç”¨ interrupt æ–¹æ³•æ¥ä¸­æ–­è¯¥ç­‰å¾…ã€‚</p>

<p><a href="https://docs.oracle.com/javase/7/docs/technotes/guides/concurrency/threadPrimitiveDeprecation.html">Why is Thread.stop deprecated?</a></p>

<p><strong>ç®€å•çš„è¯´ï¼Œé˜²æ­¢æ­»é”ï¼Œä»¥åŠçŠ¶æ€ä¸ä¸€è‡´çš„æƒ…å†µå‡ºç°ã€‚</strong></p>

<h4 id="åŠé€€ç‰ˆ-2">åŠé€€ç‰ˆ</h4>
<p>è¯·è¯´æ˜ Thread interrupt()ã€isInterrupted() ä»¥åŠ interrupted()çš„åŒºåˆ«ä»¥åŠæ„ä¹‰ï¼Ÿ</p>

<p><strong>Thread interrupt()ï¼š</strong> è®¾ç½®çŠ¶æ€ï¼Œè°ƒJVMçš„æœ¬åœ°ï¼ˆnativeï¼‰<code class="highlighter-rouge">interrupt0</code>()æ–¹æ³•ã€‚</p>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
</pre></td><td class="rouge-code"><pre>    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">interrupt</span><span class="o">()</span> <span class="o">{</span>
        <span class="k">if</span> <span class="o">(</span><span class="k">this</span> <span class="o">!=</span> <span class="nc">Thread</span><span class="o">.</span><span class="na">currentThread</span><span class="o">())</span>
            <span class="n">checkAccess</span><span class="o">();</span>

        <span class="kd">synchronized</span> <span class="o">(</span><span class="n">blockerLock</span><span class="o">)</span> <span class="o">{</span>
            <span class="nc">Interruptible</span> <span class="n">b</span> <span class="o">=</span> <span class="n">blocker</span><span class="o">;</span>
            <span class="k">if</span> <span class="o">(</span><span class="n">b</span> <span class="o">!=</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
                <span class="n">interrupt0</span><span class="o">();</span>  <span class="c1">// Just to set the interrupt flag</span>
                              <span class="c1">//--&gt; private native void interrupt0();</span>
                <span class="n">b</span><span class="o">.</span><span class="na">interrupt</span><span class="o">(</span><span class="k">this</span><span class="o">);</span>
                <span class="k">return</span><span class="o">;</span>
            <span class="o">}</span>
        <span class="o">}</span>
        <span class="n">interrupt0</span><span class="o">();</span>
    <span class="o">}</span>
</pre></td></tr></tbody></table></code></pre></div></div>

<p><strong>isInterrupted()ï¼š</strong> è°ƒçš„æ˜¯é™æ€æ–¹æ³•<code class="highlighter-rouge">isInterrupted()</code>,å½“ä¸”ä»…å½“çŠ¶æ€è®¾ç½®ä¸ºä¸­æ–­æ—¶ï¼Œè¿”å›<code class="highlighter-rouge">false</code>ï¼Œå¹¶ä¸æ¸…é™¤çŠ¶æ€ã€‚</p>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
</pre></td><td class="rouge-code"><pre>  <span class="kd">public</span> <span class="kd">static</span> <span class="kt">boolean</span> <span class="nf">interrupted</span><span class="o">()</span> <span class="o">{</span>
        <span class="k">return</span> <span class="nf">currentThread</span><span class="o">().</span><span class="na">isInterrupted</span><span class="o">(</span><span class="kc">true</span><span class="o">);</span>
    <span class="o">}</span>

    <span class="cm">/**
     * Tests whether this thread has been interrupted.  The &lt;i&gt;interrupted
     * status&lt;/i&gt; of the thread is unaffected by this method.
     *
     * &lt;p&gt;A thread interruption ignored because a thread was not alive
     * at the time of the interrupt will be reflected by this method
     * returning false.
     *
     * @return  &lt;code&gt;true&lt;/code&gt; if this thread has been interrupted;
     *          &lt;code&gt;false&lt;/code&gt; otherwise.
     * @see     #interrupted()
     * @revised 6.0
     */</span>
     
    <span class="kd">public</span> <span class="kt">boolean</span> <span class="nf">isInterrupted</span><span class="o">()</span> <span class="o">{</span>
        <span class="k">return</span> <span class="nf">isInterrupted</span><span class="o">(</span><span class="kc">false</span><span class="o">);</span>
    <span class="o">}</span>
</pre></td></tr></tbody></table></code></pre></div></div>

<p><strong>interrupted()ï¼š</strong> ç§æœ‰æœ¬åœ°æ–¹æ³•ï¼Œå³åˆ¤æ–­ä¸­æ–­çŠ¶æ€ï¼Œåˆæ¸…é™¤çŠ¶æ€ã€‚</p>
<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre></td><td class="rouge-code"><pre> <span class="kd">private</span> <span class="kd">native</span> <span class="kt">boolean</span> <span class="nf">isInterrupted</span><span class="o">(</span><span class="kt">boolean</span> <span class="nc">ClearInterrupted</span><span class="o">);</span>
</pre></td></tr></tbody></table></code></pre></div></div>

<h3 id="4çº¿ç¨‹å¼‚å¸¸">4ã€çº¿ç¨‹å¼‚å¸¸</h3>

<h4 id="åŸºæœ¬ç‰ˆ-3">åŸºæœ¬ç‰ˆ</h4>
<p>å½“çº¿ç¨‹é‡åˆ°å¼‚å¸¸æ—¶ï¼Œåˆ°åº•å‘ç”Ÿäº†ä»€ä¹ˆï¼Ÿ</p>

<p>çº¿ç¨‹ä¼šæŒ‚</p>
<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
</pre></td><td class="rouge-code"><pre><span class="kd">public</span> <span class="kd">class</span> <span class="nc">ThreadExceptionQuestion</span> <span class="o">{</span>

    <span class="kd">public</span> <span class="kd">static</span> <span class="kt">void</span> <span class="nf">main</span><span class="o">(</span><span class="nc">String</span><span class="o">[]</span> <span class="n">args</span><span class="o">)</span> <span class="kd">throws</span> <span class="nc">InterruptedException</span> <span class="o">{</span>
        <span class="c1">//...</span>
        <span class="c1">// main çº¿ç¨‹ -&gt; å­çº¿ç¨‹</span>
        <span class="nc">Thread</span> <span class="n">t1</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">Thread</span><span class="o">(()</span> <span class="o">-&gt;</span> <span class="o">{</span>
            <span class="k">throw</span> <span class="k">new</span> <span class="nf">RuntimeException</span><span class="o">(</span><span class="s">"æ•°æ®è¾¾åˆ°é˜ˆå€¼"</span><span class="o">);</span>
        <span class="o">},</span> <span class="s">"t1"</span><span class="o">);</span>

        <span class="n">t1</span><span class="o">.</span><span class="na">start</span><span class="o">();</span>
        <span class="c1">// main çº¿ç¨‹ä¼šä¸­æ­¢å—ï¼Ÿ</span>
        <span class="n">t1</span><span class="o">.</span><span class="na">join</span><span class="o">();</span>

        <span class="c1">// Java Thread æ˜¯ä¸€ä¸ªåŒ…è£…ï¼Œå®ƒç”± GC åšåƒåœ¾å›æ”¶</span>
        <span class="c1">// JVM Thread å¯èƒ½æ˜¯ä¸€ä¸ª OS Threadï¼ŒJVM ç®¡ç†ï¼Œ</span>
        <span class="c1">// å½“çº¿ç¨‹æ‰§è¡Œå®Œæ¯•ï¼ˆæ­£å¸¸æˆ–è€…å¼‚å¸¸ï¼‰</span>
        <span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="n">t1</span><span class="o">.</span><span class="na">isAlive</span><span class="o">());</span>
    <span class="o">}</span>
<span class="o">}</span>
</pre></td></tr></tbody></table></code></pre></div></div>

<h4 id="è¿›é˜¶ç‰ˆ-3">è¿›é˜¶ç‰ˆ</h4>
<p>å½“çº¿ç¨‹é‡åˆ°å¼‚å¸¸æ—¶ï¼Œå¦‚ä½•æ•è·ï¼Ÿ</p>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
</pre></td><td class="rouge-code"><pre><span class="o">...</span>
        <span class="nc">Thread</span><span class="o">.</span><span class="na">setDefaultUncaughtExceptionHandler</span><span class="o">((</span><span class="n">thread</span><span class="o">,</span> <span class="n">throwable</span><span class="o">)</span> <span class="o">-&gt;</span> <span class="o">{</span>
            <span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">printf</span><span class="o">(</span><span class="s">"çº¿ç¨‹[%s] é‡åˆ°äº†å¼‚å¸¸ï¼Œè¯¦ç»†ä¿¡æ¯ï¼š%s\n"</span><span class="o">,</span>
                    <span class="n">thread</span><span class="o">.</span><span class="na">getName</span><span class="o">(),</span>
                    <span class="n">throwable</span><span class="o">.</span><span class="na">getMessage</span><span class="o">());</span>
        <span class="o">});</span>
<span class="o">...</span>
</pre></td></tr></tbody></table></code></pre></div></div>

<h4 id="åŠé€€ç‰ˆ-3">åŠé€€ç‰ˆ</h4>
<p>å½“çº¿ç¨‹é‡åˆ°å¼‚å¸¸æ—¶ï¼ŒThreadPoolExecutor å¦‚ä½•æ•è·å¼‚å¸¸ï¼Ÿ</p>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
</pre></td><td class="rouge-code"><pre><span class="kd">public</span> <span class="kd">class</span> <span class="nc">ThreadPoolExecutorExceptionQuestion</span> <span class="o">{</span>

    <span class="kd">public</span> <span class="kd">static</span> <span class="kt">void</span> <span class="nf">main</span><span class="o">(</span><span class="nc">String</span><span class="o">[]</span> <span class="n">args</span><span class="o">)</span> <span class="kd">throws</span> <span class="nc">InterruptedException</span> <span class="o">{</span>

<span class="c1">//        ExecutorService executorService = Executors.newFixedThreadPool(2);</span>

        <span class="nc">ThreadPoolExecutor</span> <span class="n">executorService</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">ThreadPoolExecutor</span><span class="o">(</span>
                <span class="mi">1</span><span class="o">,</span>
                <span class="mi">1</span><span class="o">,</span>
                <span class="mi">0</span><span class="o">,</span>
                <span class="nc">TimeUnit</span><span class="o">.</span><span class="na">MILLISECONDS</span><span class="o">,</span>
                <span class="k">new</span> <span class="nc">LinkedBlockingQueue</span><span class="o">&lt;&gt;()</span>
        <span class="o">)</span> <span class="o">{</span>

            <span class="cm">/**
             * é€šè¿‡è¦†ç›– {@link ThreadPoolExecutor#afterExecute(Runnable, Throwable)} è¾¾åˆ°è·å–å¼‚å¸¸çš„ä¿¡æ¯
             * @param r
             * @param t
             */</span>
            <span class="nd">@Override</span>
            <span class="kd">protected</span> <span class="kt">void</span> <span class="nf">afterExecute</span><span class="o">(</span><span class="nc">Runnable</span> <span class="n">r</span><span class="o">,</span> <span class="nc">Throwable</span> <span class="n">t</span><span class="o">)</span> <span class="o">{</span>
                <span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">printf</span><span class="o">(</span><span class="s">"çº¿ç¨‹[%s] é‡åˆ°äº†å¼‚å¸¸ï¼Œè¯¦ç»†ä¿¡æ¯ï¼š%s\n"</span><span class="o">,</span>
                        <span class="nc">Thread</span><span class="o">.</span><span class="na">currentThread</span><span class="o">().</span><span class="na">getName</span><span class="o">(),</span>
                        <span class="n">t</span><span class="o">.</span><span class="na">getMessage</span><span class="o">());</span>
            <span class="o">}</span>

        <span class="o">};</span>

        <span class="n">executorService</span><span class="o">.</span><span class="na">execute</span><span class="o">(()</span> <span class="o">-&gt;</span> <span class="o">{</span>
            <span class="k">throw</span> <span class="k">new</span> <span class="nf">RuntimeException</span><span class="o">(</span><span class="s">"æ•°æ®è¾¾åˆ°é˜ˆå€¼"</span><span class="o">);</span>
        <span class="o">});</span>

        <span class="c1">// ç­‰å¾…ä¸€ç§’é’Ÿï¼Œç¡®ä¿æäº¤çš„ä»»åŠ¡å®Œæˆ</span>
        <span class="n">executorService</span><span class="o">.</span><span class="na">awaitTermination</span><span class="o">(</span><span class="mi">1</span><span class="o">,</span> <span class="nc">TimeUnit</span><span class="o">.</span><span class="na">SECONDS</span><span class="o">);</span>

        <span class="c1">// å…³é—­çº¿ç¨‹æ± </span>
        <span class="n">executorService</span><span class="o">.</span><span class="na">shutdown</span><span class="o">();</span>

    <span class="o">}</span>
<span class="o">}</span>
</pre></td></tr></tbody></table></code></pre></div></div>

<h3 id="5çº¿ç¨‹çŠ¶æ€">5ã€çº¿ç¨‹çŠ¶æ€</h3>

<h4 id="åŸºæœ¬ç‰ˆ-4">åŸºæœ¬ç‰ˆ</h4>
<p>Java çº¿ç¨‹æœ‰å“ªäº›çŠ¶æ€ï¼Œåˆ†åˆ«ä»£è¡¨ä»€ä¹ˆå«ä¹‰ï¼Ÿ</p>

<p><strong>NEW</strong>: Thread state for a thread which has not yet started.</p>

<p>æœªå¯åŠ¨çš„ã€‚ä¸ä¼šå‡ºç°åœ¨Dumpä¸­ã€‚</p>

<p><strong>RUNNABLE</strong>: Thread state for a runnable thread. A thread in the runnable state is executing in the Java virtual machine, but it may be waiting for other resources from the operating system such as processor.</p>

<p>åœ¨è™šæ‹Ÿæœºå†…æ‰§è¡Œçš„ã€‚è¿è¡Œä¸­çŠ¶æ€ï¼Œå¯èƒ½é‡Œé¢è¿˜èƒ½çœ‹åˆ°lockedå­—æ ·ï¼Œè¡¨æ˜å®ƒè·å¾—äº†æŸæŠŠé”ã€‚</p>

<p><strong>BLOCKE</strong>: Thread state for a thread blocked waiting for a monitor lock. A thread in the blocked state is waiting for a monitor lock to enter a synchronized block/method or reenter a synchronized block/method after calling {@link Object#wait() Object.wait}.</p>

<p>å—é˜»å¡å¹¶ç­‰å¾…ç›‘è§†å™¨é”ã€‚è¢«æŸä¸ªé”(synchronizers)çµ¦blockä½äº†ã€‚</p>

<p><strong>WAITING</strong>: Thread state for a waiting thread. A thread is in the waiting state due to calling one of the following methods:</p>

<div class="language-xml highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
</pre></td><td class="rouge-code"><pre><span class="nt">&lt;ul&gt;</span>
    <span class="nt">&lt;li&gt;</span>{@link Object#wait() Object.wait} with no timeout<span class="nt">&lt;/li&gt;</span>
    <span class="nt">&lt;li&gt;</span>{@link #join() Thread.join} with no timeout<span class="nt">&lt;/li&gt;</span>
    <span class="nt">&lt;li&gt;</span>{@link LockSupport#park() LockSupport.park}<span class="nt">&lt;/li&gt;</span>
<span class="nt">&lt;/ul&gt;</span>
</pre></td></tr></tbody></table></code></pre></div></div>

<p>A thread in the waiting state is waiting for another thread to perform a particular action.</p>

<p>For example, a thread that has called Object.wait() on an object is waiting for another thread to call Object.notify() or Object.notifyAll() on that object. A thread that has called Thread.join() is waiting for a specified thread to terminate.</p>

<p>æ— é™æœŸç­‰å¾…å¦ä¸€ä¸ªçº¿ç¨‹æ‰§è¡Œç‰¹å®šæ“ä½œã€‚ç­‰å¾…æŸä¸ªconditionæˆ–monitorå‘ç”Ÿï¼Œä¸€èˆ¬åœç•™åœ¨park(), wait(), sleep(),join() ç­‰è¯­å¥é‡Œã€‚</p>

<p><strong>TIMED_WAITING</strong>: Thread state for a waiting thread with a specified waiting time. A thread is in the timed waiting state due to calling one of the following methods with a specified positive waiting time:</p>

<div class="language-xml highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
</pre></td><td class="rouge-code"><pre><span class="nt">&lt;ul&gt;</span>
     <span class="nt">&lt;li&gt;</span>{@link #sleep Thread.sleep}<span class="nt">&lt;/li&gt;</span>
     <span class="nt">&lt;li&gt;</span>{@link Object#wait(long) Object.wait} with timeout<span class="nt">&lt;/li&gt;</span>
     <span class="nt">&lt;li&gt;</span>{@link #join(long) Thread.join} with timeout<span class="nt">&lt;/li&gt;</span>
     <span class="nt">&lt;li&gt;</span>{@link LockSupport#parkNanos LockSupport.parkNanos}<span class="nt">&lt;/li&gt;</span>
     <span class="nt">&lt;li&gt;</span>{@link LockSupport#parkUntil LockSupport.parkUntil}<span class="nt">&lt;/li&gt;</span>
<span class="nt">&lt;/ul&gt;</span>
</pre></td></tr></tbody></table></code></pre></div></div>

<p>æœ‰æ—¶é™çš„ç­‰å¾…å¦ä¸€ä¸ªçº¿ç¨‹çš„ç‰¹å®šæ“ä½œã€‚å’ŒWAITINGçš„åŒºåˆ«æ˜¯wait() ç­‰è¯­å¥åŠ ä¸Šäº†æ—¶é—´é™åˆ¶ wait(timeout)ã€‚</p>

<p><strong>TERMINATED</strong>: å·²é€€å‡ºçš„; Thread state for a terminated thread. The thread has completed execution.</p>

<h4 id="è¿›é˜¶ç‰ˆ-4">è¿›é˜¶ç‰ˆ</h4>
<p>å¦‚ä½•è·å–å½“å‰JVM æ‰€æœ‰çš„ç°åœºçŠ¶æ€ï¼Ÿ</p>

<p>æ–¹æ³•ä¸€ï¼šå‘½ä»¤</p>

<p><code class="highlighter-rouge">jstack</code>: jstackç”¨äºæ‰“å°å‡ºç»™å®šçš„javaè¿›ç¨‹IDæˆ–core fileæˆ–è¿œç¨‹è°ƒè¯•æœåŠ¡çš„Javaå †æ ˆä¿¡æ¯ã€‚ä¸»è¦ç”¨æ¥æŸ¥çœ‹Javaçº¿ç¨‹çš„è°ƒç”¨å †æ ˆçš„ï¼Œå¯ä»¥ç”¨æ¥åˆ†æçº¿ç¨‹é—®é¢˜ï¼ˆå¦‚æ­»é”ï¼‰ã€‚</p>

<p><code class="highlighter-rouge">jsp</code></p>

<p><code class="highlighter-rouge">jsp [option/ -l] pid</code></p>

<p>æ–¹æ³•äºŒï¼šThreadMXBean</p>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
</pre></td><td class="rouge-code"><pre><span class="kd">public</span> <span class="kd">class</span> <span class="nc">AllThreadStackQuestion</span> <span class="o">{</span>

    <span class="kd">public</span> <span class="kd">static</span> <span class="kt">void</span> <span class="nf">main</span><span class="o">(</span><span class="nc">String</span><span class="o">[]</span> <span class="n">args</span><span class="o">)</span> <span class="o">{</span>
        <span class="nc">ThreadMXBean</span> <span class="n">threadMXBean</span> <span class="o">=</span> <span class="nc">ManagementFactory</span><span class="o">.</span><span class="na">getThreadMXBean</span><span class="o">();</span>
        <span class="kt">long</span><span class="o">[]</span> <span class="n">threadIds</span> <span class="o">=</span> <span class="n">threadMXBean</span><span class="o">.</span><span class="na">getAllThreadIds</span><span class="o">();</span>

        <span class="k">for</span> <span class="o">(</span><span class="kt">long</span> <span class="n">threadId</span> <span class="o">:</span> <span class="n">threadIds</span><span class="o">)</span> <span class="o">{</span>
            <span class="nc">ThreadInfo</span> <span class="n">threadInfo</span> <span class="o">=</span> <span class="n">threadMXBean</span><span class="o">.</span><span class="na">getThreadInfo</span><span class="o">(</span><span class="n">threadId</span><span class="o">);</span>
            <span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="n">threadInfo</span><span class="o">.</span><span class="na">toString</span><span class="o">());</span>
        <span class="o">}</span>

    <span class="o">}</span>
<span class="o">}</span>
</pre></td></tr></tbody></table></code></pre></div></div>

<h4 id="åŠé€€ç‰ˆ-4">åŠé€€ç‰ˆ</h4>
<p>å¦‚ä½•è·å–çº¿ç¨‹çš„èµ„æºæ¶ˆè´¹æƒ…å†µï¼Ÿ</p>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
</pre></td><td class="rouge-code"><pre><span class="kd">public</span> <span class="kd">class</span> <span class="nc">AllThreadInfoQuestion</span> <span class="o">{</span>

    <span class="kd">public</span> <span class="kd">static</span> <span class="kt">void</span> <span class="nf">main</span><span class="o">(</span><span class="nc">String</span><span class="o">[]</span> <span class="n">args</span><span class="o">)</span> <span class="o">{</span>
        <span class="nc">ThreadMXBean</span> <span class="n">threadMXBean</span> <span class="o">=</span> <span class="o">(</span><span class="nc">ThreadMXBean</span><span class="o">)</span> <span class="nc">ManagementFactory</span><span class="o">.</span><span class="na">getThreadMXBean</span><span class="o">();</span>
        <span class="kt">long</span><span class="o">[]</span> <span class="n">threadIds</span> <span class="o">=</span> <span class="n">threadMXBean</span><span class="o">.</span><span class="na">getAllThreadIds</span><span class="o">();</span>

        <span class="k">for</span> <span class="o">(</span><span class="kt">long</span> <span class="n">threadId</span> <span class="o">:</span> <span class="n">threadIds</span><span class="o">)</span> <span class="o">{</span>
<span class="c1">//            ThreadInfo threadInfo = threadMXBean.getThreadInfo(threadId);</span>
<span class="c1">//            System.out.println(threadInfo.toString());</span>
            <span class="kt">long</span> <span class="n">bytes</span> <span class="o">=</span> <span class="n">threadMXBean</span><span class="o">.</span><span class="na">getThreadAllocatedBytes</span><span class="o">(</span><span class="n">threadId</span><span class="o">);</span>
            <span class="kt">long</span> <span class="n">kBytes</span> <span class="o">=</span> <span class="n">bytes</span> <span class="o">/</span> <span class="mi">1024</span><span class="o">;</span>
            <span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">printf</span><span class="o">(</span><span class="s">"çº¿ç¨‹[ID:%d] åˆ†é…å†…å­˜ï¼š %s KB\n"</span><span class="o">,</span> <span class="n">threadId</span><span class="o">,</span> <span class="n">kBytes</span><span class="o">);</span>
        <span class="o">}</span>

    <span class="o">}</span>
<span class="o">}</span>
</pre></td></tr></tbody></table></code></pre></div></div>

<h3 id="6çº¿ç¨‹åŒæ­¥">6ã€çº¿ç¨‹åŒæ­¥</h3>

<h4 id="åŸºæœ¬ç‰ˆ-5">åŸºæœ¬ç‰ˆ</h4>
<p>è¯·è¯´æ˜ synchronized å…³é”®å­—åœ¨ä¿®é¥°æ–¹æ³•ä¸ä»£ç å—ä¸­çš„åŒºåˆ«ï¼Ÿ</p>

<p>å­—èŠ‚ç çš„åŒºåˆ« (ä¸€ä¸ªmonitor,ä¸€ä¸ªsynchronizedå…³é”®å­—)</p>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
</pre></td><td class="rouge-code"><pre><span class="kd">public</span> <span class="kd">class</span> <span class="nc">SynchronizedKeywordQuestion</span> <span class="o">{</span>

    <span class="kd">public</span> <span class="kd">static</span> <span class="kt">void</span> <span class="nf">main</span><span class="o">(</span><span class="nc">String</span><span class="o">[]</span> <span class="n">args</span><span class="o">)</span> <span class="o">{</span>

    <span class="o">}</span>

    <span class="kd">private</span> <span class="kd">static</span> <span class="kt">void</span> <span class="nf">synchronizedBlock</span><span class="o">()</span> <span class="o">{</span>
        <span class="kd">synchronized</span> <span class="o">(</span><span class="nc">SynchronizedKeywordQuestion</span><span class="o">.</span><span class="na">class</span><span class="o">)</span> <span class="o">{</span>
        <span class="o">}</span>
    <span class="o">}</span>

    <span class="kd">private</span> <span class="kd">synchronized</span> <span class="kd">static</span> <span class="kt">void</span> <span class="nf">synchronizedMethod</span><span class="o">()</span> <span class="o">{</span>
    <span class="o">}</span>
<span class="o">}</span>
</pre></td></tr></tbody></table></code></pre></div></div>

<h4 id="è¿›é˜¶ç‰ˆ-5">è¿›é˜¶ç‰ˆ</h4>
<p>è¯·è¯´æ˜ synchronized å…³é”®å­—ä¸ ReentrantLock ä¹‹é—´çš„åŒºåˆ«ï¼Ÿ</p>

<ul>
  <li>ä¸¤è€…éƒ½æ˜¯å¯é‡å…¥é”</li>
  <li>synchronized ä¾èµ–äº JVM è€Œ ReentrantLock ä¾èµ–äº API</li>
  <li>ReentrantLock æ¯” synchronized å¢åŠ äº†ä¸€äº›é«˜çº§åŠŸèƒ½</li>
</ul>

<p>ç›¸æ¯”synchronizedï¼ŒReentrantLockå¢åŠ äº†ä¸€äº›é«˜çº§åŠŸèƒ½ã€‚ä¸»è¦æ¥è¯´ä¸»è¦æœ‰ä¸‰ç‚¹ï¼šâ‘ ç­‰å¾…å¯ä¸­æ–­ï¼›â‘¡å¯å®ç°å…¬å¹³é”ï¼›â‘¢å¯å®ç°é€‰æ‹©æ€§é€šçŸ¥ï¼ˆé”å¯ä»¥ç»‘å®šå¤šä¸ªæ¡ä»¶ï¼‰</p>
<ul>
  <li>ä¸¤è€…çš„æ€§èƒ½å·²ç»ç›¸å·®æ— å‡ </li>
</ul>

<p><a href="https://snailclimb.top/JavaGuide/#/./essential-content-for-interview/PreparingForInterview/ç¾å›¢é¢è¯•å¸¸è§é—®é¢˜æ€»ç»“?id=_3-è°ˆè°ˆ-synchronized-å’Œ-reentrantlock-çš„åŒºåˆ«">è°ˆè°ˆ synchronized å’Œ ReentrantLock çš„åŒºåˆ«</a></p>

<h4 id="åŠé€€ç‰ˆ-5">åŠé€€ç‰ˆ</h4>
<p>è¯·è§£é‡Šåå‘é”å¯¹ synchronized ä¸ ReentrantLock çš„ä»·å€¼ï¼Ÿ</p>

<p>åå‘é”åªå¯¹ synchronized æœ‰ç”¨ï¼Œè€Œ ReentrantLock å·²ç»å®ç°äº†åå‘é”ã€‚</p>

<p><a href="https://wiki.openjdk.java.net/display/HotSpot/Synchronization">Synchronization and Object Locking</a></p>

<h3 id="7çº¿ç¨‹é€šè®¯">7ã€çº¿ç¨‹é€šè®¯</h3>

<h4 id="åŸºæœ¬ç‰ˆ-6">åŸºæœ¬ç‰ˆ</h4>
<p>ä¸ºä»€ä¹ˆ wait() å’Œ notify() ä»¥åŠ notifyAll() æ–¹æ³•å±äº Object ,å¹¶è§£é‡Šå®ƒä»¬çš„ä½œç”¨ï¼Ÿ</p>

<p>Javaæ‰€æœ‰å¯¹è±¡éƒ½æ˜¯æ¥è‡ª Object</p>

<p><strong>wait():</strong></p>

<p><strong>notify():</strong></p>

<p><strong>notifyAll():</strong></p>

<h4 id="è¿›é˜¶ç‰ˆ-6">è¿›é˜¶ç‰ˆ</h4>
<p>ä¸ºä»€ä¹ˆ Object wait() notify() ä»¥åŠ notifyAll() æ–¹æ³•å¿…é¡» synchronized ä¹‹ä¸­æ‰§è¡Œï¼Ÿ</p>

<p><strong>wait():</strong> è·å¾—é”çš„å¯¹è±¡ï¼Œé‡Šæ”¾é”ï¼Œå½“å‰çº¿ç¨‹åˆè¢«é˜»å¡ï¼Œç­‰åŒäºJava 5 LockSupport ä¸­çš„parkæ–¹æ³•</p>

<p><strong>notify():</strong> å·²ç»è·å¾—é”ï¼Œå”¤èµ·ä¸€ä¸ªè¢«é˜»å¡çš„çº¿ç¨‹ï¼Œç­‰åŒäºJava 5 LockSupport ä¸­çš„unpark()æ–¹æ³•</p>

<p><strong>notifyAll():</strong></p>

<h4 id="åŠé€€ç‰ˆ-6">åŠé€€ç‰ˆ</h4>
<p>è¯·é€šè¿‡ Java ä»£ç æ¨¡æ‹Ÿå®ç° wait() å’Œ notify() ä»¥åŠ notifyAll() çš„è¯­ä¹‰ï¼Ÿ</p>

<h3 id="8çº¿ç¨‹é€€å‡º">8ã€çº¿ç¨‹é€€å‡º</h3>

<h4 id="åŸºæœ¬ç‰ˆ-7">åŸºæœ¬ç‰ˆ</h4>
<p>å½“ä¸»çº¿ç¨‹é€€å‡ºæ—¶ï¼Œå®ˆæŠ¤çº¿ç¨‹ä¼šæ‰§è¡Œå®Œæ¯•å—ï¼Ÿ</p>

<p>ä¸ä¸€å®šæ‰§è¡Œå®Œæ¯•</p>
<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
</pre></td><td class="rouge-code"><pre><span class="kd">public</span> <span class="kd">class</span> <span class="nc">DaemonThreadQuestion</span> <span class="o">{</span>

    <span class="kd">public</span> <span class="kd">static</span> <span class="kt">void</span> <span class="nf">main</span><span class="o">(</span><span class="nc">String</span><span class="o">[]</span> <span class="n">args</span><span class="o">)</span> <span class="o">{</span>
        <span class="c1">// main çº¿ç¨‹</span>
        <span class="nc">Thread</span> <span class="n">t1</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">Thread</span><span class="o">(()</span> <span class="o">-&gt;</span> <span class="o">{</span>
            <span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">"Hello,World"</span><span class="o">);</span>
<span class="c1">//            Thread currentThread = Thread.currentThread();</span>
<span class="c1">//            System.out.printf("çº¿ç¨‹[name : %s, daemon:%s]: Hello,World\n",</span>
<span class="c1">//                    currentThread.getName(),</span>
<span class="c1">//                    currentThread.isDaemon()</span>
<span class="c1">//            );</span>
        <span class="o">},</span> <span class="s">"daemon"</span><span class="o">);</span>
        <span class="c1">// ç¼–ç¨‹å®ˆå€™çº¿ç¨‹</span>
        <span class="n">t1</span><span class="o">.</span><span class="na">setDaemon</span><span class="o">(</span><span class="kc">true</span><span class="o">);</span>
        <span class="n">t1</span><span class="o">.</span><span class="na">start</span><span class="o">();</span>

        <span class="c1">// å®ˆå€™çº¿ç¨‹çš„æ‰§è¡Œä¾èµ–äºæ‰§è¡Œæ—¶é—´ï¼ˆéå”¯ä¸€è¯„åˆ¤ï¼‰</span>
    <span class="o">}</span>
<span class="o">}</span>
</pre></td></tr></tbody></table></code></pre></div></div>

<h4 id="è¿›é˜¶ç‰ˆ-7">è¿›é˜¶ç‰ˆ</h4>
<p>è¯·è¯´æ˜ ShutdownHook çº¿ç¨‹çš„ä½¿ç”¨åœºæ™¯ï¼Œä»¥åŠå¦‚ä½•è§¦å‘æ‰§è¡Œï¼Ÿ</p>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
</pre></td><td class="rouge-code"><pre><span class="kd">public</span> <span class="kd">class</span> <span class="nc">ShutdownHookQuestion</span> <span class="o">{</span>

    <span class="kd">public</span> <span class="kd">static</span> <span class="kt">void</span> <span class="nf">main</span><span class="o">(</span><span class="nc">String</span><span class="o">[]</span> <span class="n">args</span><span class="o">)</span> <span class="o">{</span>

        <span class="nc">Runtime</span> <span class="n">runtime</span> <span class="o">=</span> <span class="nc">Runtime</span><span class="o">.</span><span class="na">getRuntime</span><span class="o">();</span>

        <span class="n">runtime</span><span class="o">.</span><span class="na">addShutdownHook</span><span class="o">(</span><span class="k">new</span> <span class="nc">Thread</span><span class="o">(</span><span class="nl">ShutdownHookQuestion:</span><span class="o">:</span><span class="n">action</span><span class="o">,</span> <span class="s">"Shutdown Hook Question"</span><span class="o">));</span>

    <span class="o">}</span>

    <span class="kd">private</span> <span class="kd">static</span> <span class="kt">void</span> <span class="nf">action</span><span class="o">()</span> <span class="o">{</span>
        <span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">printf</span><span class="o">(</span><span class="s">"çº¿ç¨‹[%s] æ­£åœ¨æ‰§è¡Œ...\n"</span><span class="o">,</span> <span class="nc">Thread</span><span class="o">.</span><span class="na">currentThread</span><span class="o">().</span><span class="na">getName</span><span class="o">());</span>  <span class="c1">// 2</span>
    <span class="o">}</span>
<span class="o">}</span>
</pre></td></tr></tbody></table></code></pre></div></div>

<p>ä½¿ç”¨åœºæ™¯ï¼šSpring ä¸­ AbstractApplicationContext çš„ registerShutdownHook()</p>

<h4 id="åŠé€€ç‰ˆ-7">åŠé€€ç‰ˆ</h4>
<p>å¦‚ä½•ç¡®ä¿ä¸»çº¿ç¨‹é€€å‡ºå‰ï¼Œæ‰€æœ‰çº¿ç¨‹æ‰§è¡Œå®Œæ¯•ï¼Ÿ</p>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
</pre></td><td class="rouge-code"><pre><span class="kd">public</span> <span class="kd">class</span> <span class="nc">CompleteAllThreadsQuestion</span> <span class="o">{</span>

    <span class="kd">public</span> <span class="kd">static</span> <span class="kt">void</span> <span class="nf">main</span><span class="o">(</span><span class="nc">String</span><span class="o">[]</span> <span class="n">args</span><span class="o">)</span> <span class="kd">throws</span> <span class="nc">InterruptedException</span> <span class="o">{</span>

        <span class="c1">// main çº¿ç¨‹ -&gt; å­çº¿ç¨‹</span>
        <span class="nc">Thread</span> <span class="n">t1</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">Thread</span><span class="o">(</span><span class="nl">CompleteAllThreadsQuestion:</span><span class="o">:</span><span class="n">action</span><span class="o">,</span> <span class="s">"t1"</span><span class="o">);</span>
        <span class="nc">Thread</span> <span class="n">t2</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">Thread</span><span class="o">(</span><span class="nl">CompleteAllThreadsQuestion:</span><span class="o">:</span><span class="n">action</span><span class="o">,</span> <span class="s">"t2"</span><span class="o">);</span>
        <span class="nc">Thread</span> <span class="n">t3</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">Thread</span><span class="o">(</span><span class="nl">CompleteAllThreadsQuestion:</span><span class="o">:</span><span class="n">action</span><span class="o">,</span> <span class="s">"t3"</span><span class="o">);</span>

        <span class="c1">// ä¸ç¡®å®š t1ã€t2ã€t3 æ˜¯å¦è°ƒç”¨ start()</span>

        <span class="n">t1</span><span class="o">.</span><span class="na">start</span><span class="o">();</span>
        <span class="n">t2</span><span class="o">.</span><span class="na">start</span><span class="o">();</span>
        <span class="n">t3</span><span class="o">.</span><span class="na">start</span><span class="o">();</span>

        <span class="c1">// åˆ›å»ºäº† N Thread</span>

        <span class="nc">Thread</span> <span class="n">mainThread</span> <span class="o">=</span> <span class="nc">Thread</span><span class="o">.</span><span class="na">currentThread</span><span class="o">();</span>
        <span class="c1">// è·å– main çº¿ç¨‹ç»„</span>
        <span class="nc">ThreadGroup</span> <span class="n">threadGroup</span> <span class="o">=</span> <span class="n">mainThread</span><span class="o">.</span><span class="na">getThreadGroup</span><span class="o">();</span>
        <span class="c1">// æ´»è·ƒçš„çº¿ç¨‹æ•°</span>
        <span class="kt">int</span> <span class="n">count</span> <span class="o">=</span> <span class="n">threadGroup</span><span class="o">.</span><span class="na">activeCount</span><span class="o">();</span>
        <span class="nc">Thread</span><span class="o">[]</span> <span class="n">threads</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">Thread</span><span class="o">[</span><span class="n">count</span><span class="o">];</span>
        <span class="c1">// æŠŠæ‰€æœ‰çš„çº¿ç¨‹å¤åˆ¶ threads æ•°ç»„</span>
        <span class="n">threadGroup</span><span class="o">.</span><span class="na">enumerate</span><span class="o">(</span><span class="n">threads</span><span class="o">,</span> <span class="kc">true</span><span class="o">);</span>

        <span class="k">for</span> <span class="o">(</span><span class="nc">Thread</span> <span class="n">thread</span> <span class="o">:</span> <span class="n">threads</span><span class="o">)</span> <span class="o">{</span>
            <span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">printf</span><span class="o">(</span><span class="s">"å½“å‰æ´»è·ƒçº¿ç¨‹: %s\n"</span><span class="o">,</span> <span class="n">thread</span><span class="o">.</span><span class="na">getName</span><span class="o">());</span>
        <span class="o">}</span>
    <span class="o">}</span>

    <span class="kd">private</span> <span class="kd">static</span> <span class="kt">void</span> <span class="nf">action</span><span class="o">()</span> <span class="o">{</span>
        <span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">printf</span><span class="o">(</span><span class="s">"çº¿ç¨‹[%s] æ­£åœ¨æ‰§è¡Œ...\n"</span><span class="o">,</span> <span class="nc">Thread</span><span class="o">.</span><span class="na">currentThread</span><span class="o">().</span><span class="na">getName</span><span class="o">());</span>  <span class="c1">// 2</span>
    <span class="o">}</span>

<span class="o">}</span>
</pre></td></tr></tbody></table></code></pre></div></div>

<h2 id="java-å¹¶å‘é›†åˆæ¡†æ¶">Java å¹¶å‘é›†åˆæ¡†æ¶</h2>

<h3 id="1çº¿ç¨‹å®‰å…¨é›†åˆ">1ã€çº¿ç¨‹å®‰å…¨é›†åˆ</h3>

<h4 id="åŸºæœ¬ç‰ˆ-8">åŸºæœ¬ç‰ˆ</h4>
<p>è¯·åœ¨ Java é›†åˆæ¡†æ¶ä»¥åŠ J.U.C æ¡†æ¶ä¸­å„åˆ—ä¸¾å‡º Listã€Set ä»¥åŠ Map çš„å®ç°ï¼Ÿ</p>

<p>Java é›†åˆæ¡†æ¶: LinkedListã€ArrayListã€HashSetã€TreeSetã€HashMap</p>

<p>J.U.C æ¡†æ¶: CopyOnWriteArrayListã€CopyOnWriteArraySetã€ConcurrentSkipListSetã€ConcurrentSkipListMapã€ConcurrentHashMap</p>

<h4 id="è¿›é˜¶ç‰ˆ-8">è¿›é˜¶ç‰ˆ</h4>
<p>å¦‚ä½•å°†æ™®é€š Listã€Set ä»¥åŠ Map è½¬åŒ–ä¸ºçº¿ç¨‹å®‰å…¨å¯¹è±¡ï¼Ÿ</p>
<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
</pre></td><td class="rouge-code"><pre><span class="kd">public</span> <span class="kd">class</span> <span class="nc">ThreadSafeCollectionQuestion</span> <span class="o">{</span>

    <span class="kd">public</span> <span class="kd">static</span> <span class="kt">void</span> <span class="nf">main</span><span class="o">(</span><span class="nc">String</span><span class="o">[]</span> <span class="n">args</span><span class="o">)</span> <span class="o">{</span>

        <span class="nc">List</span><span class="o">&lt;</span><span class="nc">Integer</span><span class="o">&gt;</span> <span class="n">list</span> <span class="o">=</span> <span class="nc">Arrays</span><span class="o">.</span><span class="na">asList</span><span class="o">(</span><span class="mi">1</span><span class="o">,</span> <span class="mi">2</span><span class="o">,</span> <span class="mi">3</span><span class="o">,</span> <span class="mi">4</span><span class="o">,</span> <span class="mi">5</span><span class="o">);</span>

        <span class="nc">Set</span><span class="o">&lt;</span><span class="nc">Integer</span><span class="o">&gt;</span> <span class="n">set</span> <span class="o">=</span> <span class="nc">Set</span><span class="o">.</span><span class="na">of</span><span class="o">(</span><span class="mi">1</span><span class="o">,</span> <span class="mi">2</span><span class="o">,</span> <span class="mi">3</span><span class="o">,</span> <span class="mi">4</span><span class="o">,</span> <span class="mi">5</span><span class="o">);</span>

        <span class="nc">Map</span><span class="o">&lt;</span><span class="nc">Integer</span><span class="o">,</span> <span class="nc">String</span><span class="o">&gt;</span> <span class="n">map</span> <span class="o">=</span> <span class="nc">Map</span><span class="o">.</span><span class="na">of</span><span class="o">(</span><span class="mi">1</span><span class="o">,</span> <span class="s">"A"</span><span class="o">);</span>

        <span class="c1">// ä»¥ä¸Šå®ç°éƒ½æ˜¯ä¸å˜å¯¹è±¡ï¼Œä¸è¿‡ç¬¬ä¸€ä¸ªé™¤å¤–</span>

        <span class="c1">// é€šè¿‡ Collections#sychronized* æ–¹æ³•è¿”å›</span>

        <span class="c1">// Wrapper è®¾è®¡æ¨¡å¼ï¼ˆæ‰€æœ‰çš„æ–¹æ³•éƒ½è¢« synchronized åŒæ­¥æˆ–äº’æ–¥ï¼‰</span>
        <span class="n">list</span> <span class="o">=</span> <span class="nc">Collections</span><span class="o">.</span><span class="na">synchronizedList</span><span class="o">(</span><span class="n">list</span><span class="o">);</span>

        <span class="n">set</span> <span class="o">=</span> <span class="nc">Collections</span><span class="o">.</span><span class="na">synchronizedSet</span><span class="o">(</span><span class="n">set</span><span class="o">);</span>

        <span class="n">map</span> <span class="o">=</span> <span class="nc">Collections</span><span class="o">.</span><span class="na">synchronizedMap</span><span class="o">(</span><span class="n">map</span><span class="o">);</span>

    <span class="o">}</span>
<span class="o">}</span>
</pre></td></tr></tbody></table></code></pre></div></div>

<h4 id="åŠé€€ç‰ˆ-8">åŠé€€ç‰ˆ</h4>
<p>å¦‚ä½•åœ¨ Java 9+ å®ç°ä»¥ä¸Šé—®é¢˜ï¼Ÿ</p>
<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
</pre></td><td class="rouge-code"><pre><span class="kd">public</span> <span class="kd">class</span> <span class="nc">ThreadSafeCollectionQuestion</span> <span class="o">{</span>

    <span class="kd">public</span> <span class="kd">static</span> <span class="kt">void</span> <span class="nf">main</span><span class="o">(</span><span class="nc">String</span><span class="o">[]</span> <span class="n">args</span><span class="o">)</span> <span class="o">{</span>

        <span class="c1">// Java 9 çš„å®ç°</span>
        <span class="nc">List</span><span class="o">&lt;</span><span class="nc">Integer</span><span class="o">&gt;</span> <span class="n">list</span> <span class="o">=</span> <span class="nc">Arrays</span><span class="o">.</span><span class="na">asList</span><span class="o">(</span><span class="mi">1</span><span class="o">,</span> <span class="mi">2</span><span class="o">,</span> <span class="mi">3</span><span class="o">,</span> <span class="mi">4</span><span class="o">,</span> <span class="mi">5</span><span class="o">);</span>

        <span class="c1">// Java 9 + of å·¥å‚æ–¹æ³•ï¼Œè¿”å› Immutable å¯¹è±¡</span>

        <span class="n">list</span> <span class="o">=</span> <span class="nc">List</span><span class="o">.</span><span class="na">of</span><span class="o">(</span><span class="mi">1</span><span class="o">,</span> <span class="mi">2</span><span class="o">,</span> <span class="mi">3</span><span class="o">,</span> <span class="mi">4</span><span class="o">,</span> <span class="mi">5</span><span class="o">);</span>

        <span class="nc">Set</span><span class="o">&lt;</span><span class="nc">Integer</span><span class="o">&gt;</span> <span class="n">set</span> <span class="o">=</span> <span class="nc">Set</span><span class="o">.</span><span class="na">of</span><span class="o">(</span><span class="mi">1</span><span class="o">,</span> <span class="mi">2</span><span class="o">,</span> <span class="mi">3</span><span class="o">,</span> <span class="mi">4</span><span class="o">,</span> <span class="mi">5</span><span class="o">);</span>

        <span class="nc">Map</span><span class="o">&lt;</span><span class="nc">Integer</span><span class="o">,</span> <span class="nc">String</span><span class="o">&gt;</span> <span class="n">map</span> <span class="o">=</span> <span class="nc">Map</span><span class="o">.</span><span class="na">of</span><span class="o">(</span><span class="mi">1</span><span class="o">,</span> <span class="s">"A"</span><span class="o">);</span>

        <span class="c1">// ä»¥ä¸Šå®ç°éƒ½æ˜¯ä¸å˜å¯¹è±¡ï¼Œä¸è¿‡ç¬¬ä¸€ä¸ªé™¤å¤–</span>

        <span class="c1">// é€šè¿‡ Collections#sychronized* æ–¹æ³•è¿”å›</span>

        <span class="c1">// Wrapper è®¾è®¡æ¨¡å¼ï¼ˆæ‰€æœ‰çš„æ–¹æ³•éƒ½è¢« synchronized åŒæ­¥æˆ–äº’æ–¥ï¼‰</span>
        <span class="n">list</span> <span class="o">=</span> <span class="nc">Collections</span><span class="o">.</span><span class="na">synchronizedList</span><span class="o">(</span><span class="n">list</span><span class="o">);</span>

        <span class="n">set</span> <span class="o">=</span> <span class="nc">Collections</span><span class="o">.</span><span class="na">synchronizedSet</span><span class="o">(</span><span class="n">set</span><span class="o">);</span>

        <span class="n">map</span> <span class="o">=</span> <span class="nc">Collections</span><span class="o">.</span><span class="na">synchronizedMap</span><span class="o">(</span><span class="n">map</span><span class="o">);</span>

        <span class="c1">//</span>
        <span class="n">list</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">CopyOnWriteArrayList</span><span class="o">&lt;&gt;(</span><span class="n">list</span><span class="o">);</span>
        <span class="n">set</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">CopyOnWriteArraySet</span><span class="o">&lt;&gt;(</span><span class="n">set</span><span class="o">);</span>
        <span class="n">map</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">ConcurrentHashMap</span><span class="o">&lt;&gt;(</span><span class="n">map</span><span class="o">);</span>

    <span class="o">}</span>
<span class="o">}</span>
</pre></td></tr></tbody></table></code></pre></div></div>

<h3 id="2çº¿ç¨‹å®‰å…¨-list">2ã€çº¿ç¨‹å®‰å…¨ LIST</h3>

<h4 id="åŸºæœ¬ç‰ˆ-9">åŸºæœ¬ç‰ˆ</h4>
<p>è¯·è¯´æ˜ Listã€Vector ä»¥åŠ CopyOnWriteArrayList çš„ç›¸åŒç‚¹å’Œä¸åŒç‚¹ï¼Ÿ</p>

<p><strong>ç›¸åŒç‚¹ï¼š</strong></p>

<p>Vectorã€CopyOnWriteArrayList æ˜¯ List çš„å®ç°ã€‚</p>

<p><strong>ä¸åŒç‚¹ï¼š</strong></p>

<p>Vector æ˜¯åŒæ­¥çš„,ä»»ä½•æ—¶å€™ä¸åŠ é”ã€‚å¹¶ä¸”åœ¨è®¾è®¡ä¸­æœ‰ä¸ª interator ,è¿”å›çš„å¯¹è±¡æ˜¯ <code class="highlighter-rouge">fail-fast</code>ï¼›</p>

<p>CopyOnWriteArrayList è¯»çš„æ—¶å€™æ˜¯ä¸åŠ é”ï¼›å¼±ä¸€è‡´æ€§ï¼Œwhile trueçš„æ—¶å€™ä¸æŠ¥é”™ã€‚</p>

<h4 id="è¿›é˜¶ç‰ˆ-9">è¿›é˜¶ç‰ˆ</h4>
<p>è¯·è¯´æ˜ Collections#synchromizedList(List) ä¸ Vector çš„ç›¸åŒç‚¹å’Œä¸åŒç‚¹ï¼Ÿ</p>

<p><strong>ç›¸åŒç‚¹ï¼š</strong></p>

<p>éƒ½æ˜¯<code class="highlighter-rouge">synchromized</code> çš„å®ç°æ–¹å¼ã€‚</p>

<p><strong>ä¸åŒç‚¹ï¼š</strong></p>

<p>synchromized è¿”å›çš„æ˜¯list, å®ç°åŸç†æ–¹å¼æ˜¯ Wrapper å®ç°ï¼›</p>

<p>è€Œ Vector æ˜¯ List çš„å®ç°ã€‚å®ç°åŸç†æ–¹å¼æ˜¯é Wrapper å®ç°ã€‚</p>

<h4 id="åŠé€€ç‰ˆ-9">åŠé€€ç‰ˆ</h4>
<p>Arrays#asList(Objectâ€¦)æ–¹æ³•æ˜¯çº¿ç¨‹å®‰å…¨çš„å—ï¼Ÿå¦‚æœä¸æ˜¯çš„è¯ï¼Œå¦‚æœå®ç°æ›¿ä»£æ–¹æ¡ˆï¼Ÿ</p>
<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
</pre></td><td class="rouge-code"><pre><span class="kd">public</span> <span class="kd">class</span> <span class="nc">ArraysAsListMethodQuestion</span> <span class="o">{</span>

    <span class="kd">public</span> <span class="kd">static</span> <span class="kt">void</span> <span class="nf">main</span><span class="o">(</span><span class="nc">String</span><span class="o">[]</span> <span class="n">args</span><span class="o">)</span> <span class="o">{</span>

        <span class="nc">List</span><span class="o">&lt;</span><span class="nc">Integer</span><span class="o">&gt;</span> <span class="n">list</span> <span class="o">=</span> <span class="nc">Arrays</span><span class="o">.</span><span class="na">asList</span><span class="o">(</span><span class="mi">1</span><span class="o">,</span> <span class="mi">2</span><span class="o">,</span> <span class="mi">3</span><span class="o">,</span> <span class="mi">4</span><span class="o">,</span> <span class="mi">5</span><span class="o">);</span>
        <span class="c1">// è°ƒæ•´ç¬¬ä¸‰ä¸ªå…ƒç´ ä¸º 9</span>
        <span class="n">list</span><span class="o">.</span><span class="na">set</span><span class="o">(</span><span class="mi">2</span><span class="o">,</span> <span class="mi">9</span><span class="o">);</span>
        <span class="c1">// 3 -&gt; 9</span>
        <span class="c1">// Arrays.asList å¹¶éçº¿ç¨‹å®‰å…¨</span>
        <span class="n">list</span><span class="o">.</span><span class="na">forEach</span><span class="o">(</span><span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">::</span><span class="n">println</span><span class="o">);</span>
        <span class="c1">// Java &lt; 5 , Collections#synchronizedList</span>
        <span class="c1">// Java 5+ , CopyOnWriteArrayList</span>
        <span class="c1">// Java 9+ , List.of(...) åªè¯»</span>
    <span class="o">}</span>
<span class="o">}</span>
</pre></td></tr></tbody></table></code></pre></div></div>

<h3 id="3çº¿ç¨‹å®‰å…¨-set">3ã€çº¿ç¨‹å®‰å…¨ SET</h3>

<h4 id="åŸºæœ¬ç‰ˆ-10">åŸºæœ¬ç‰ˆ</h4>
<p>è¯·è‡³å°‘ä¸¾å‡ºä¸‰ç§çº¿ç¨‹å®‰å…¨çš„ Set å®ç°ï¼Ÿ</p>

<p>synchronizedSetã€CopyOnWriteArraySetã€ConcurrentSkipListSet</p>

<h4 id="è¿›é˜¶ç‰ˆ-10">è¿›é˜¶ç‰ˆ</h4>
<p>åœ¨ J.U.C æ¡†æ¶ä¸­ï¼Œå­˜åœ¨HashSet çš„çº¿ç¨‹å®‰å…¨å®ç°ï¼Ÿå¦‚æœä¸å­˜åœ¨çš„è¯ï¼Œè¦å¦‚ä½•å®ç°ï¼Ÿ</p>

<p>ä¸å­˜åœ¨ï¼›</p>
<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
44
45
46
47
48
49
50
51
52
53
54
55
56
57
58
59
60
61
62
63
64
65
66
67
68
69
70
71
72
73
74
75
76
77
78
79
80
81
82
83
</pre></td><td class="rouge-code"><pre><span class="kd">public</span> <span class="kd">class</span> <span class="nc">ConcurrentHashSetQuestion</span> <span class="o">{</span>


    <span class="kd">public</span> <span class="kd">static</span> <span class="kt">void</span> <span class="nf">main</span><span class="o">(</span><span class="nc">String</span><span class="o">[]</span> <span class="n">args</span><span class="o">)</span> <span class="o">{</span>

    <span class="o">}</span>

    <span class="kd">private</span> <span class="kd">static</span> <span class="kd">class</span> <span class="nc">ConcurrentHashSet</span><span class="o">&lt;</span><span class="no">E</span><span class="o">&gt;</span> <span class="kd">implements</span> <span class="nc">Set</span><span class="o">&lt;</span><span class="no">E</span><span class="o">&gt;</span> <span class="o">{</span>

        <span class="kd">private</span> <span class="kd">final</span> <span class="nc">Object</span> <span class="no">OBJECT</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">Object</span><span class="o">();</span>

        <span class="kd">private</span> <span class="kd">final</span> <span class="nc">ConcurrentHashMap</span><span class="o">&lt;</span><span class="no">E</span><span class="o">,</span> <span class="nc">Object</span><span class="o">&gt;</span> <span class="n">map</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">ConcurrentHashMap</span><span class="o">&lt;&gt;();</span>

        <span class="kd">private</span> <span class="nc">Set</span><span class="o">&lt;</span><span class="no">E</span><span class="o">&gt;</span> <span class="nf">keySet</span><span class="o">()</span> <span class="o">{</span>
            <span class="k">return</span> <span class="n">map</span><span class="o">.</span><span class="na">keySet</span><span class="o">();</span>
        <span class="o">}</span>

        <span class="nd">@Override</span>
        <span class="kd">public</span> <span class="kt">int</span> <span class="nf">size</span><span class="o">()</span> <span class="o">{</span>
            <span class="k">return</span> <span class="nf">keySet</span><span class="o">().</span><span class="na">size</span><span class="o">();</span>
        <span class="o">}</span>

        <span class="nd">@Override</span>
        <span class="kd">public</span> <span class="kt">boolean</span> <span class="nf">isEmpty</span><span class="o">()</span> <span class="o">{</span>
            <span class="k">return</span> <span class="nf">keySet</span><span class="o">().</span><span class="na">isEmpty</span><span class="o">();</span>
        <span class="o">}</span>

        <span class="nd">@Override</span>
        <span class="kd">public</span> <span class="kt">boolean</span> <span class="nf">contains</span><span class="o">(</span><span class="nc">Object</span> <span class="n">o</span><span class="o">)</span> <span class="o">{</span>
            <span class="k">return</span> <span class="nf">keySet</span><span class="o">().</span><span class="na">contains</span><span class="o">(</span><span class="n">o</span><span class="o">);</span>
        <span class="o">}</span>

        <span class="nd">@Override</span>
        <span class="kd">public</span> <span class="nc">Iterator</span><span class="o">&lt;</span><span class="no">E</span><span class="o">&gt;</span> <span class="nf">iterator</span><span class="o">()</span> <span class="o">{</span>
            <span class="k">return</span> <span class="nf">keySet</span><span class="o">().</span><span class="na">iterator</span><span class="o">();</span>
        <span class="o">}</span>

        <span class="nd">@Override</span>
        <span class="kd">public</span> <span class="nc">Object</span><span class="o">[]</span> <span class="nf">toArray</span><span class="o">()</span> <span class="o">{</span>
            <span class="k">return</span> <span class="k">new</span> <span class="nc">Object</span><span class="o">[</span><span class="mi">0</span><span class="o">];</span>
        <span class="o">}</span>

        <span class="nd">@Override</span>
        <span class="kd">public</span> <span class="o">&lt;</span><span class="no">T</span><span class="o">&gt;</span> <span class="no">T</span><span class="o">[]</span> <span class="nf">toArray</span><span class="o">(</span><span class="no">T</span><span class="o">[]</span> <span class="n">a</span><span class="o">)</span> <span class="o">{</span>
            <span class="k">return</span> <span class="kc">null</span><span class="o">;</span>
        <span class="o">}</span>

        <span class="nd">@Override</span>
        <span class="kd">public</span> <span class="kt">boolean</span> <span class="nf">add</span><span class="o">(</span><span class="no">E</span> <span class="n">e</span><span class="o">)</span> <span class="o">{</span>
            <span class="k">return</span> <span class="n">map</span><span class="o">.</span><span class="na">put</span><span class="o">(</span><span class="n">e</span><span class="o">,</span> <span class="no">OBJECT</span><span class="o">)</span> <span class="o">==</span> <span class="kc">null</span><span class="o">;</span>
        <span class="o">}</span>

        <span class="nd">@Override</span>
        <span class="kd">public</span> <span class="kt">boolean</span> <span class="nf">remove</span><span class="o">(</span><span class="nc">Object</span> <span class="n">o</span><span class="o">)</span> <span class="o">{</span>
            <span class="k">return</span> <span class="n">map</span><span class="o">.</span><span class="na">remove</span><span class="o">(</span><span class="n">o</span><span class="o">)</span> <span class="o">!=</span> <span class="kc">null</span><span class="o">;</span>
        <span class="o">}</span>

        <span class="nd">@Override</span>
        <span class="kd">public</span> <span class="kt">boolean</span> <span class="nf">containsAll</span><span class="o">(</span><span class="nc">Collection</span><span class="o">&lt;?&gt;</span> <span class="n">c</span><span class="o">)</span> <span class="o">{</span>
            <span class="k">return</span> <span class="kc">false</span><span class="o">;</span>
        <span class="o">}</span>

        <span class="nd">@Override</span>
        <span class="kd">public</span> <span class="kt">boolean</span> <span class="nf">addAll</span><span class="o">(</span><span class="nc">Collection</span><span class="o">&lt;?</span> <span class="kd">extends</span> <span class="no">E</span><span class="o">&gt;</span> <span class="n">c</span><span class="o">)</span> <span class="o">{</span>
            <span class="k">return</span> <span class="kc">false</span><span class="o">;</span>
        <span class="o">}</span>

        <span class="nd">@Override</span>
        <span class="kd">public</span> <span class="kt">boolean</span> <span class="nf">retainAll</span><span class="o">(</span><span class="nc">Collection</span><span class="o">&lt;?&gt;</span> <span class="n">c</span><span class="o">)</span> <span class="o">{</span>
            <span class="k">return</span> <span class="kc">false</span><span class="o">;</span>
        <span class="o">}</span>

        <span class="nd">@Override</span>
        <span class="kd">public</span> <span class="kt">boolean</span> <span class="nf">removeAll</span><span class="o">(</span><span class="nc">Collection</span><span class="o">&lt;?&gt;</span> <span class="n">c</span><span class="o">)</span> <span class="o">{</span>
            <span class="k">return</span> <span class="kc">false</span><span class="o">;</span>
        <span class="o">}</span>

        <span class="nd">@Override</span>
        <span class="kd">public</span> <span class="kt">void</span> <span class="nf">clear</span><span class="o">()</span> <span class="o">{</span>

        <span class="o">}</span>
    <span class="o">}</span>
<span class="o">}</span>
</pre></td></tr></tbody></table></code></pre></div></div>

<h4 id="åŠé€€ç‰ˆ-10">åŠé€€ç‰ˆ</h4>
<p>å½“ Set#iterator() æ–¹æ³•è¿”å› Iterator å¯¹è±¡åï¼Œèƒ½å¦åœ¨å…¶è¿­ä»£ä¸­ï¼Œç»™ Set å¯¹è±¡æ·»åŠ æ–°çš„å…ƒç´ ï¼Ÿ</p>

<p>ä¸ä¸€å®šï¼›Set åœ¨ä¼ ç»Ÿå®ç°ä¸­ï¼Œä¼šæœ‰<code class="highlighter-rouge">fail-fast</code>é—®é¢˜ï¼›è€Œåœ¨J.U.Cä¸­ä¼šå‡ºç°å¼±ä¸€è‡´æ€§ï¼Œå¯¹æ•°æ®çš„ä¸€è‡´æ€§è¦æ±‚è¾ƒä½ï¼Œæ˜¯å¯ä»¥ç»™ Set å¯¹è±¡æ·»åŠ æ–°çš„å…ƒç´ ã€‚</p>

<h3 id="4çº¿ç¨‹å®‰å…¨-map">4ã€çº¿ç¨‹å®‰å…¨ MAP</h3>

<h4 id="åŸºæœ¬ç‰ˆ-11">åŸºæœ¬ç‰ˆ</h4>
<p>è¯·è¯´æ˜ Hashtableã€HashMap ä»¥åŠ ConcurrentHashMap çš„åŒºåˆ«ï¼Ÿ</p>

<p><strong>Hashtableï¼š</strong> keyã€valueå€¼éƒ½ä¸èƒ½ä¸ºç©º; æ•°ç»„ç»“æ„ä¸Šï¼Œé€šè¿‡æ•°ç»„å’Œé“¾è¡¨å®ç°ã€‚</p>

<p><strong>HashMapï¼š</strong> keyã€valueå€¼éƒ½èƒ½ä¸ºç©ºï¼›æ•°ç»„ç»“æ„ä¸Šï¼Œå½“é˜ˆå€¼åˆ°è¾¾8æ—¶ï¼Œé€šè¿‡çº¢é»‘æ ‘å®ç°ã€‚</p>

<p><strong>ConcurrentHashMapï¼š</strong> keyã€valueå€¼éƒ½ä¸èƒ½ä¸ºç©ºï¼›æ•°ç»„ç»“æ„ä¸Šï¼Œå½“é˜ˆå€¼åˆ°è¾¾8æ—¶ï¼Œé€šè¿‡çº¢é»‘æ ‘å®ç°ã€‚</p>

<p><a href="https://zhuanlan.zhihu.com/p/37607299">HashMapå’ŒHashtableçš„æ¯”è¾ƒ</a></p>

<h4 id="è¿›é˜¶ç‰ˆ-11">è¿›é˜¶ç‰ˆ</h4>
<p>è¯·è¯´æ˜ ConcurrentHashMap åœ¨ä¸åŒçš„JDK ä¸­çš„å®ç°ï¼Ÿ</p>

<p>JDK 1.6ä¸­ï¼Œé‡‡ç”¨åˆ†ç¦»é”çš„æ–¹å¼ï¼Œåœ¨è¯»çš„æ—¶å€™ï¼Œéƒ¨åˆ†é”ï¼›å†™çš„æ—¶å€™ï¼Œå®Œå…¨é”ã€‚è€Œåœ¨JDK 1.7ã€1.8ä¸­ï¼Œè¯»çš„æ—¶å€™ä¸éœ€è¦é”çš„ï¼Œå†™çš„æ—¶å€™éœ€è¦é”çš„ã€‚å¹¶ä¸”JDK 1.8ä¸­åœ¨ä¸ºäº†è§£å†³Hashå†²çªï¼Œé‡‡ç”¨çº¢é»‘æ ‘è§£å†³ã€‚</p>

<p><a href="https://zhuanlan.zhihu.com/p/50675786">HashMap? ConcurrentHashMap? ç›¸ä¿¡çœ‹å®Œè¿™ç¯‡æ²¡äººèƒ½éš¾ä½ä½ ï¼</a></p>

<h4 id="åŠé€€ç‰ˆ-11">åŠé€€ç‰ˆ</h4>
<p>è¯·è¯´æ˜ ConcurrentHashMap ä¸ ConcurrentSkipListMap å„è‡ªçš„ä¼˜åŠ¿ä¸ä¸è¶³ï¼Ÿ</p>

<p>åœ¨ java 6 å’Œ 8 ä¸­ï¼ŒConcurrentHashMap å†™çš„æ—¶å€™ï¼Œæ˜¯åŠ é”çš„ï¼Œæ‰€ä»¥å†…å­˜å å¾—æ¯”è¾ƒå°ï¼Œè€Œ ConcurrentSkipListMap å†™çš„æ—¶å€™æ˜¯ä¸åŠ é”çš„ï¼Œå†…å­˜å å¾—ç›¸å¯¹æ¯”è¾ƒå¤§ï¼Œé€šè¿‡ç©ºé—´æ¢å–æ—¶é—´ä¸Šçš„æˆæœ¬ï¼Œé€Ÿåº¦è¾ƒå¿«ï¼Œä½†æ¯”å‰è€…è¦æ…¢ï¼ŒConcurrentHashMap åŸºæœ¬ä¸Šæ˜¯å¸¸é‡æ—¶é—´ã€‚ConcurrentSkipListMap è¯»å’Œå†™éƒ½æ˜¯log Nå®ç°ï¼Œé«˜æ€§èƒ½ç›¸å¯¹ç¨³å®šã€‚</p>

<h3 id="5çº¿ç¨‹å®‰å…¨-queue">5ã€çº¿ç¨‹å®‰å…¨ QUEUE</h3>

<h4 id="åŸºæœ¬ç‰ˆ-12">åŸºæœ¬ç‰ˆ</h4>
<p>è¯·è¯´æ˜ BlockingQueue ä¸ Queue çš„åŒºåˆ«ï¼Ÿ</p>

<p>BlockingQueue ç»§æ‰¿äº† Queue çš„å®ç°ï¼›put æ–¹æ³•ä¸­æœ‰ä¸ªé˜»å¡çš„æ“ä½œï¼ˆInterruptedExceptionï¼‰ï¼Œå½“é˜Ÿåˆ—æ»¡çš„æ—¶å€™ï¼Œput ä¼šè¢«é˜»å¡ï¼›å½“é˜Ÿåˆ—ç©ºçš„æ—¶å€™ï¼Œputæ–¹æ³•å¯ç”¨ã€‚take æ–¹æ³•ä¸­ï¼Œå½“æ•°æ®å­˜åœ¨æ—¶ï¼Œæ‰å¯ä»¥è¿”å›ï¼Œå¦åˆ™ä¸ºç©ºã€‚</p>

<h4 id="è¿›é˜¶ç‰ˆ-12">è¿›é˜¶ç‰ˆ</h4>
<p>è¯·è¯´æ˜ LinkedBlockingQueue ä¸ ArrayBlockingQueue çš„åŒºåˆ«ï¼Ÿ</p>

<p>LinkedBlockingQueue æ˜¯é“¾è¡¨ç»“æ„ï¼›æœ‰ä¸¤ä¸ªæ„é€ å™¨ï¼Œä¸€ä¸ªæ˜¯ï¼ˆInteger.MAX_VALUE)ï¼Œæ— è¾¹ç•Œï¼Œå¦ä¸€ä¸ªæ˜¯(int capacity)ï¼Œæœ‰è¾¹ç•Œï¼›ArrayBlockingQueue æ˜¯æ•°ç»„ç»“æ„ï¼›æœ‰è¾¹ç•Œã€‚</p>

<h4 id="åŠé€€ç‰ˆ-12">åŠé€€ç‰ˆ</h4>
<p>è¯·è¯´æ˜ LinkedTransferQueue ä¸ LinkedBlockingQueue çš„åŒºåˆ«ï¼Ÿ</p>

<p>LinkedTransferQueue æ˜¯java 7ä¸­æä¾›çš„æ–°æ¥å£ï¼Œæ€§èƒ½æ¯”åè€…æ›´ä¼˜åŒ–ã€‚</p>

<h3 id="6priorityblockingqueue">6ã€PRIORITYBLOCKINGQUEUE</h3>

<h4 id="è¯·è¯„ä¼°ä»¥ä¸‹ç¨‹åºçš„è¿è¡Œç»“æœ">è¯·è¯„ä¼°ä»¥ä¸‹ç¨‹åºçš„è¿è¡Œç»“æœï¼Ÿ</h4>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
</pre></td><td class="rouge-code"><pre><span class="kd">public</span> <span class="kd">class</span> <span class="nc">priorityBlockingQueueQuiz</span><span class="o">{</span>
    <span class="kd">public</span> <span class="kd">static</span> <span class="kt">void</span> <span class="nf">main</span><span class="o">(</span><span class="nc">String</span><span class="o">[]</span> <span class="n">args</span><span class="o">)</span> <span class="k">throw</span> <span class="nc">Exception</span> <span class="o">{</span>
        <span class="nc">BlockingQueue</span><span class="o">&lt;</span><span class="nc">Integer</span><span class="o">&gt;</span> <span class="n">queue</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">PriorityBlockingQueue</span><span class="o">&lt;&gt;(</span><span class="mi">2</span><span class="o">);</span>
        <span class="c1">// 1. PriorityBlockingQueue put(Object) æ–¹æ³•ä¸é˜»å¡ï¼Œä¸æŠ›å¼‚å¸¸</span>
        <span class="c1">// 2. PriorityBlockingQueue offer(Object) æ–¹æ³•ä¸é™åˆ¶ï¼Œå…è®¸é•¿åº¦å˜é•¿</span>
        <span class="c1">// 3. PriorityBlockingQueue æ’å…¥å¯¹è±¡ä¼šåšæ’åºï¼Œé»˜è®¤å‚ç…§å…ƒç´  Comparable å®ç°ï¼Œ</span>
        <span class="c1">//    æˆ–è€…æ˜¾ç¤ºåœ°ä¼ é€’ Comparator</span>
        <span class="n">queue</span><span class="o">.</span><span class="na">put</span><span class="o">(</span><span class="mi">9</span><span class="o">);</span>
        <span class="n">queue</span><span class="o">.</span><span class="na">put</span><span class="o">(</span><span class="mi">1</span><span class="o">);</span>
        <span class="n">queue</span><span class="o">.</span><span class="na">put</span><span class="o">(</span><span class="mi">8</span><span class="o">);</span>
        <span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">"queue.size() ="</span> <span class="o">+</span> <span class="n">queue</span><span class="o">.</span><span class="na">size</span><span class="o">());</span>
        <span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">"queue.take() ="</span> <span class="o">+</span> <span class="n">queue</span><span class="o">.</span><span class="na">take</span><span class="o">());</span>
        <span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">"queue ="</span> <span class="o">+</span> <span class="n">queue</span><span class="o">);</span>
    <span class="o">}</span>
<span class="o">}</span>
</pre></td></tr></tbody></table></code></pre></div></div>
<p>è¿è¡Œç»“æœï¼š</p>
<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
</pre></td><td class="rouge-code"><pre>queue.size() = 3
queue.take() = 1
queue = [8,9]
</pre></td></tr></tbody></table></code></pre></div></div>
<h3 id="7synchronousqueue">7ã€SYNCHRONOUSQUEUE</h3>

<h4 id="è¯·è¯„ä¼°ä»¥ä¸‹ç¨‹åºçš„è¿è¡Œç»“æœ-1">è¯·è¯„ä¼°ä»¥ä¸‹ç¨‹åºçš„è¿è¡Œç»“æœï¼Ÿ</h4>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
</pre></td><td class="rouge-code"><pre><span class="kd">public</span> <span class="kd">class</span> <span class="nc">SynchronusQueueQuiz</span><span class="o">{</span>
    
    <span class="kd">public</span> <span class="kd">static</span> <span class="kt">void</span> <span class="nf">main</span><span class="o">(</span><span class="nc">String</span><span class="o">[]</span> <span class="n">args</span><span class="o">)</span> <span class="kd">throws</span> <span class="nc">Exception</span> <span class="o">{</span>
        <span class="nc">BlockingQueue</span><span class="o">&lt;</span><span class="nc">Integer</span><span class="o">&gt;</span> <span class="n">queue</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">SynchronousQueue</span><span class="o">&lt;&gt;();</span>
        <span class="c1">// 1. SynchronousQueue æ˜¯æ— ç©ºé—´ï¼Œoffer æ°¸è¿œè¿”å› false</span>
        <span class="c1">// 2. SynchronousQueue take() æ–¹æ³•ä¼šè¢«é˜»å¡ï¼Œå¿…é¡»è¢«å…¶ä»–çº¿ç¨‹æ˜¾ç¤ºåœ°è°ƒç”¨ put(Object);</span>
        <span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">pringln</span><span class="o">(</span><span class="s">"queue.offer(1) = "</span> <span class="o">+</span> <span class="n">queue</span><span class="o">.</span><span class="na">offer</span><span class="o">(</span><span class="mi">1</span><span class="o">));</span>
        <span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">pringln</span><span class="o">(</span><span class="s">"queue.offer(2) = "</span> <span class="o">+</span> <span class="n">queue</span><span class="o">.</span><span class="na">offer</span><span class="o">(</span><span class="mi">2</span><span class="o">));</span>
        <span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">pringln</span><span class="o">(</span><span class="s">"queue.offer(3) = "</span> <span class="o">+</span> <span class="n">queue</span><span class="o">.</span><span class="na">offer</span><span class="o">(</span><span class="mi">3</span><span class="o">));</span>
        <span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">"queue.take() = "</span> <span class="o">+</span> <span class="n">queue</span><span class="o">.</span><span class="na">take</span><span class="o">());</span>
        <span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">"queue.size = "</span> <span class="o">+</span> <span class="n">queue</span><span class="o">.</span><span class="na">size</span><span class="o">());</span>
    <span class="o">}</span>
<span class="o">}</span>
</pre></td></tr></tbody></table></code></pre></div></div>
<p>è¿è¡Œç»“æœï¼š</p>
<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
</pre></td><td class="rouge-code"><pre>queue.offer(1) = false
queue.offer(2) = false
queue.offer(3) = false
</pre></td></tr></tbody></table></code></pre></div></div>
<p>SynchronousQueue take() æ–¹æ³•ä¼šè¢«é˜»å¡</p>

<h3 id="8blockingqueue-offer">8ã€BLOCKINGQUEUE OFFER()</h3>

<h4 id="è¯·è¯„ä¼°ä»¥ä¸‹ç¨‹åºçš„è¿è¡Œç»“æœ-2">è¯·è¯„ä¼°ä»¥ä¸‹ç¨‹åºçš„è¿è¡Œç»“æœï¼Ÿ</h4>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
</pre></td><td class="rouge-code"><pre><span class="kd">public</span> <span class="kd">class</span> <span class="nc">BlockingQueueQuiz</span><span class="o">{</span>
    <span class="kd">public</span> <span class="kd">static</span> <span class="kt">void</span> <span class="nf">main</span><span class="o">(</span><span class="nc">String</span><span class="o">[]</span> <span class="n">args</span><span class="o">)</span> <span class="kd">throws</span> <span class="nc">Exception</span> <span class="o">{</span>
        <span class="n">offer</span><span class="o">(</span><span class="k">new</span> <span class="nc">ArrayBlockingQueue</span><span class="o">&lt;&gt;(</span><span class="mi">2</span><span class="o">));</span>
        <span class="n">offer</span><span class="o">(</span><span class="k">new</span> <span class="nc">LinkedBlockingQueue</span><span class="o">&lt;&gt;(</span><span class="mi">2</span><span class="o">));</span>
        <span class="n">offer</span><span class="o">(</span><span class="k">new</span> <span class="nc">PriorityBlockingQueue</span><span class="o">&lt;&gt;(</span><span class="mi">2</span><span class="o">));</span>
        <span class="n">offer</span><span class="o">(</span><span class="k">new</span> <span class="nc">SynchronousQueue</span><span class="o">&lt;&gt;());</span>
    <span class="o">}</span>
<span class="o">}</span>

<span class="kd">private</span> <span class="kd">static</span> <span class="kt">void</span> <span class="nf">offer</span><span class="o">(</span><span class="nc">BlockingQueue</span><span class="o">&lt;</span><span class="nc">Integer</span><span class="o">&gt;</span> <span class="n">queue</span><span class="o">)</span> <span class="kd">throws</span> <span class="nc">Exception</span> <span class="o">{</span>
    <span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">"queue.getClass() = "</span> <span class="o">+</span><span class="n">queue</span><span class="o">.</span><span class="na">getClass</span><span class="o">().</span><span class="na">getName</span><span class="o">());</span>
    <span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">"queue.offer(1) = "</span> <span class="o">+</span> <span class="n">queue</span><span class="o">.</span><span class="na">offer</span><span class="o">(</span><span class="mi">1</span><span class="o">));</span>
    <span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">"queue.offer(2) = "</span> <span class="o">+</span> <span class="n">queue</span><span class="o">.</span><span class="na">offer</span><span class="o">(</span><span class="mi">2</span><span class="o">));</span>
    <span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">"queue.offer(3) = "</span> <span class="o">+</span> <span class="n">queue</span><span class="o">.</span><span class="na">offer</span><span class="o">(</span><span class="mi">3</span><span class="o">));</span>
    <span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">"queue.size() = "</span> <span class="o">+</span> <span class="n">queue</span><span class="o">.</span><span class="na">size</span><span class="o">());</span>
    <span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">"queue.take() = "</span> <span class="o">+</span> <span class="n">queue</span><span class="o">.</span><span class="na">take</span><span class="o">());</span>
    <span class="o">}</span>
<span class="o">}</span>
</pre></td></tr></tbody></table></code></pre></div></div>
<p>è¿è¡Œç»“æœï¼š</p>
<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
</pre></td><td class="rouge-code"><pre>queue.getClass() = java.util.concurrent.ArrayBlockingQueue
queue.offer(1) = true
queue.offer(2) = true
queue.offer(3) = false
queue.size() = 2
queue.take() = 1

queue.getClass() = java.util.concurrent.LinkedBlockingQueue
queue.offer(1) = true
queue.offer(2) = true
queue.offer(3) = false
queue.size() = 2
queue.take() = 1

queue.getClass() = java.util.concurrent.PriorityBlockingQueue
queue.offer(1) = true
queue.offer(2) = true
queue.offer(3) = false
queue.size() = 3
queue.take() = 1

queue.getClass() = java.util.concurrent.SynchronousQueue
queue.offer(1) = false
queue.offer(2) = false
queue.offer(3) = false
queue.size() = 0
</pre></td></tr></tbody></table></code></pre></div></div>
<p>queue.take() æ–¹æ³•ä¼šè¢«é˜»å¡</p>

<h2 id="java-å¹¶å‘æ¡†æ¶">Java å¹¶å‘æ¡†æ¶</h2>

<h3 id="1é”-lock">1ã€é” LOCK</h3>

<h4 id="åŸºæœ¬ç‰ˆ-13">åŸºæœ¬ç‰ˆ</h4>
<p>è¯·è¯´æ˜ ReentranLock ä¸ ReentrantReadWriteLock çš„åŒºåˆ«ï¼Ÿ</p>

<p>jdk 1.5 ä»¥åï¼ŒReentranLock(é‡è¿›å…¥é”)ä¸ ReentrantReadWriteLock éƒ½æ˜¯å¯é‡è¿›å…¥çš„é”ï¼ŒReentranLock éƒ½æ˜¯äº’æ–¥çš„ï¼Œè€Œ ReentrantReadWriteLock æ˜¯å…±äº«çš„ï¼Œå…¶ä¸­é‡Œé¢æœ‰ä¸¤ä¸ªç±»ï¼Œä¸€ä¸ªæ˜¯ ReadLockï¼ˆå…±äº«ï¼Œå¹¶è¡Œï¼Œå¼ºè°ƒæ•°æ®ä¸€è‡´æ€§æˆ–è€…è¯´å¯è§æ€§ï¼‰ï¼Œå¦ä¸€ä¸ªæ˜¯ WriteLock(äº’æ–¥ï¼Œä¸²è¡Œ)ã€‚</p>

<h4 id="è¿›é˜¶ç‰ˆ-13">è¿›é˜¶ç‰ˆ</h4>
<p>è¯·è§£é‡Š ReentrantLock ä¸ºä»€ä¹ˆå‘½åä¸ºé‡è¿›å…¥ï¼Ÿ</p>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
44
45
46
47
48
49
50
</pre></td><td class="rouge-code"><pre><span class="kd">public</span> <span class="kd">class</span> <span class="nc">ReentrantLockQuestion</span> <span class="o">{</span>

    <span class="cm">/**
     * T1 , T2 , T3
     *
     * T1(lock) , T2(park), T3(park)
     * Waited Queue -&gt; Head-&gt; T2 next -&gt; T3
     * T1(unlock) -&gt; unpark all
     * Waited Queue -&gt; Head-&gt; T2 next -&gt; T3
     * T2(free), T3(free)
     *
     * -&gt; T2(lock) , T3(park)
     * Waited Queue -&gt; Head-&gt; T3
     * T2(unlock) -&gt; unpark all
     * T3(free)
     */</span>


    <span class="kd">private</span> <span class="kd">static</span> <span class="nc">ReentrantLock</span> <span class="n">lock</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">ReentrantLock</span><span class="o">();</span>

    <span class="kd">public</span> <span class="kd">static</span> <span class="kt">void</span> <span class="nf">main</span><span class="o">(</span><span class="nc">String</span><span class="o">[]</span> <span class="n">args</span><span class="o">)</span> <span class="o">{</span>
        <span class="c1">// thread[main] -&gt;</span>
        <span class="c1">// lock     lock           lock</span>
        <span class="c1">// main -&gt; action1() -&gt; action2() -&gt; action3()</span>
        <span class="n">synchronizedAction</span><span class="o">(</span><span class="nl">ReentrantLockQuestion:</span><span class="o">:</span><span class="n">action1</span><span class="o">);</span>
    <span class="o">}</span>


    <span class="kd">private</span> <span class="kd">static</span> <span class="kt">void</span> <span class="nf">action1</span><span class="o">()</span> <span class="o">{</span>
        <span class="n">synchronizedAction</span><span class="o">(</span><span class="nl">ReentrantLockQuestion:</span><span class="o">:</span><span class="n">action2</span><span class="o">);</span>

    <span class="o">}</span>

    <span class="kd">private</span> <span class="kd">static</span> <span class="kt">void</span> <span class="nf">action2</span><span class="o">()</span> <span class="o">{</span>
        <span class="n">synchronizedAction</span><span class="o">(</span><span class="nl">ReentrantLockQuestion:</span><span class="o">:</span><span class="n">action3</span><span class="o">);</span>
    <span class="o">}</span>

    <span class="kd">private</span> <span class="kd">static</span> <span class="kt">void</span> <span class="nf">action3</span><span class="o">()</span> <span class="o">{</span>
        <span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">"Hello,World"</span><span class="o">);</span>
    <span class="o">}</span>

    <span class="kd">private</span> <span class="kd">static</span> <span class="kt">void</span> <span class="nf">synchronizedAction</span><span class="o">(</span><span class="nc">Runnable</span> <span class="n">runnable</span><span class="o">)</span> <span class="o">{</span>
        <span class="n">lock</span><span class="o">.</span><span class="na">lock</span><span class="o">();</span>
        <span class="k">try</span> <span class="o">{</span>
            <span class="n">runnable</span><span class="o">.</span><span class="na">run</span><span class="o">();</span>
        <span class="o">}</span> <span class="k">finally</span> <span class="o">{</span>
            <span class="n">lock</span><span class="o">.</span><span class="na">unlock</span><span class="o">();</span>
        <span class="o">}</span>
    <span class="o">}</span>
<span class="o">}</span>
</pre></td></tr></tbody></table></code></pre></div></div>
<h4 id="åŠé€€ç‰ˆ-13">åŠé€€ç‰ˆ</h4>
<p>è¯·è¯´æ˜ Lock#lock() ä¸ Lock#lockInterruptibly() çš„åŒºåˆ«ï¼Ÿ</p>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
</pre></td><td class="rouge-code"><pre>    <span class="cm">/**
     * java.util.concurrent.locks.AbstractQueuedSynchronizer.acquireQueued
     * å¦‚æœå½“å‰çº¿ç¨‹å·²è¢«å…¶ä»–çº¿ç¨‹è°ƒç”¨äº† interrupt() æ–¹æ³•æ—¶ï¼Œè¿™æ—¶ä¼šè¿”å› true
     * acquireQueued æ‰§è¡Œå®Œæ—¶ï¼Œinterrupt æ¸…ç©ºï¼ˆfalseï¼‰
     * å†é€šè¿‡ selfInterrupt() æ–¹æ³•å°†çŠ¶æ€æ¢å¤ï¼ˆinterrupt=trueï¼‰
     */</span>
         <span class="kd">public</span> <span class="kd">static</span> <span class="kt">void</span> <span class="nf">main</span><span class="o">(</span><span class="nc">String</span><span class="o">[]</span> <span class="n">args</span><span class="o">)</span> <span class="o">{</span>
         <span class="n">lockVsLockInterruptibly</span><span class="o">();</span>
     <span class="o">}</span>
     
        <span class="kd">private</span> <span class="kd">static</span> <span class="kt">void</span> <span class="nf">lockVsLockInterruptibly</span><span class="o">()</span> <span class="o">{</span>

        <span class="k">try</span> <span class="o">{</span>
            <span class="n">lock</span><span class="o">.</span><span class="na">lockInterruptibly</span><span class="o">();</span>
            <span class="n">action1</span><span class="o">();</span>
        <span class="o">}</span> <span class="k">catch</span> <span class="o">(</span><span class="nc">InterruptedException</span> <span class="n">e</span><span class="o">)</span> <span class="o">{</span>
            <span class="c1">// æ˜¾ç¤ºåœ°æ¢å¤ä¸­æ–­çŠ¶æ€</span>
            <span class="nc">Thread</span><span class="o">.</span><span class="na">currentThread</span><span class="o">().</span><span class="na">interrupt</span><span class="o">();</span>
            <span class="c1">// å½“å‰çº¿ç¨‹å¹¶æœªæ¶ˆäº¡ï¼Œçº¿ç¨‹æ± å¯èƒ½è¿˜åœ¨å­˜æ´»</span>
        <span class="o">}</span> <span class="k">finally</span> <span class="o">{</span>
            <span class="n">lock</span><span class="o">.</span><span class="na">unlock</span><span class="o">();</span>
        <span class="o">}</span>
    <span class="o">}</span>
</pre></td></tr></tbody></table></code></pre></div></div>

<p><strong>lock()</strong>  ä¼˜å…ˆè€ƒè™‘è·å–é”ï¼Œå¾…è·å–é”æˆåŠŸåï¼Œæ‰å“åº”ä¸­æ–­ã€‚</p>

<p>**lockInterruptibly() ** ä¼˜å…ˆè€ƒè™‘å“åº”ä¸­æ–­ï¼Œè€Œä¸æ˜¯å“åº”é”çš„æ™®é€šè·å–æˆ–é‡å…¥è·å–ã€‚</p>

<p><strong>ReentrantLock.lockInterruptibly</strong> å…è®¸åœ¨ç­‰å¾…æ—¶ç”±å…¶å®ƒçº¿ç¨‹è°ƒç”¨ç­‰å¾…çº¿ç¨‹çš„ Thread.interrupt æ–¹æ³•æ¥ä¸­æ–­ç­‰å¾…çº¿ç¨‹çš„ç­‰å¾…è€Œç›´æ¥è¿”å›ï¼Œè¿™æ—¶ä¸ç”¨è·å–é”ï¼Œè€Œä¼šæŠ›å‡ºä¸€ä¸ª InterruptedExceptionã€‚</p>

<p><strong>ReentrantLock.lock</strong> æ–¹æ³•ä¸å…è®¸ Thread.interrupt ä¸­æ–­,å³ä½¿æ£€æµ‹åˆ° Thread.isInterrupted ,ä¸€æ ·ä¼šç»§ç»­å°è¯•è·å–é”ï¼Œå¤±è´¥åˆ™ç»§ç»­ä¼‘çœ ã€‚åªæ˜¯åœ¨æœ€åè·å–é”æˆåŠŸåå†æŠŠå½“å‰çº¿ç¨‹ç½®ä¸º interrupted çŠ¶æ€,ç„¶åå†ä¸­æ–­çº¿ç¨‹ã€‚</p>

<h3 id="2æ¡ä»¶å˜é‡-condition">2ã€æ¡ä»¶å˜é‡ CONDITION</h3>

<h4 id="åŸºæœ¬ç‰ˆ-14">åŸºæœ¬ç‰ˆ</h4>
<p>è¯·ä¸¾ä¾‹è¯´æ˜ Condition ä½¿ç”¨åœºæ™¯ï¼Ÿ</p>

<ol>
  <li>CoutDownLatch (condition å˜ç§)</li>
  <li>CyclicBarrier (å¾ªç¯å±éšœ)</li>
  <li>ä¿¡å·é‡/ç¯ï¼ˆSemaphore) java 9</li>
  <li>ç”Ÿäº§è€…å’Œæ¶ˆè´¹è€…</li>
  <li>é˜»å¡é˜Ÿåˆ—</li>
</ol>

<h4 id="è¿›é˜¶ç‰ˆ-14">è¿›é˜¶ç‰ˆ</h4>
<p>è¯·ä½¿ç”¨ Condition å®ç° â€œç”Ÿäº§è€…-æ¶ˆè´¹è€…é—®é¢˜â€ï¼Ÿ</p>

<p><a href="https://blog.csdn.net/u014082714/article/details/83927697">ä½¿ç”¨Conditionå®ç°ç”Ÿäº§è€…æ¶ˆè´¹è€…</a></p>

<h4 id="åŠé€€ç‰ˆ-14">åŠé€€ç‰ˆ</h4>
<p>è¯·è§£é‡Š Condition await() å’Œ signal() ä¸ Object wait () å’Œ notify() çš„ç›¸åŒä¸å·®å¼‚ï¼Ÿ</p>

<p>ç›¸åŒï¼šé˜»å¡å’Œé‡Šæ”¾</p>

<p>å·®å¼‚ï¼šJava Thread å¯¹è±¡å’Œå®é™… JVM æ‰§è¡Œçš„ OS Thread ä¸æ˜¯ç›¸åŒå¯¹è±¡ï¼ŒJVM Thread å›è°ƒ Java Thread.run() æ–¹æ³•ï¼ŒåŒæ—¶ Thread æä¾›ä¸€äº› native æ–¹æ³•æ¥è·å– JVM Thread çŠ¶æ€ï¼Œå½“JVM thread æ‰§è¡Œåï¼Œè‡ªåŠ¨ notify()äº†ã€‚</p>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
</pre></td><td class="rouge-code"><pre>        <span class="k">while</span> <span class="o">(</span><span class="n">thread</span><span class="o">.</span><span class="na">isAlive</span><span class="o">())</span> <span class="o">{</span> <span class="c1">// Thread ç‰¹æ®Šçš„ Object</span>
            <span class="c1">// å½“çº¿ç¨‹ Thread isAlive() == false æ—¶ï¼Œthread.wait() æ“ä½œä¼šè¢«è‡ªåŠ¨é‡Šæ”¾</span>
            <span class="kd">synchronized</span> <span class="o">(</span><span class="n">thread</span><span class="o">)</span> <span class="o">{</span>
                <span class="k">try</span> <span class="o">{</span>
                    <span class="n">thread</span><span class="o">.</span><span class="na">wait</span><span class="o">();</span> <span class="c1">// åˆ°åº•æ˜¯è°é€šçŸ¥ Thread -&gt; thread.notify();</span>
<span class="c1">//                    LockSupport.park(); // æ­»é”å‘ç”Ÿ</span>
                <span class="o">}</span> <span class="k">catch</span> <span class="o">(</span><span class="nc">Exception</span> <span class="n">e</span><span class="o">)</span> <span class="o">{</span>
                    <span class="k">throw</span> <span class="k">new</span> <span class="nf">RuntimeException</span><span class="o">(</span><span class="n">e</span><span class="o">);</span>
                <span class="o">}</span>
            <span class="o">}</span>
</pre></td></tr></tbody></table></code></pre></div></div>

<h3 id="3å±éšœ-barriers">3ã€å±éšœ BARRIERS</h3>

<h4 id="åŸºæœ¬ç‰ˆ-15">åŸºæœ¬ç‰ˆ</h4>
<p>è¯·è¯´æ˜ CountDownLatch ä¸ CyclicBarrier çš„åŒºåˆ«ï¼Ÿ</p>

<p><strong>CountDownLatch</strong> : ä¸å¯å¾ªç¯çš„ï¼Œä¸€æ¬¡æ€§æ“ä½œï¼ˆå€’è®¡æ—¶ï¼‰ã€‚</p>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
</pre></td><td class="rouge-code"><pre><span class="kd">public</span> <span class="kd">class</span> <span class="nc">CountDownLatchQuestion</span> <span class="o">{</span>

    <span class="kd">public</span> <span class="kd">static</span> <span class="kt">void</span> <span class="nf">main</span><span class="o">(</span><span class="nc">String</span><span class="o">[]</span> <span class="n">args</span><span class="o">)</span> <span class="kd">throws</span> <span class="nc">InterruptedException</span> <span class="o">{</span>

        <span class="c1">// å€’æ•°è®¡æ•° 5</span>
        <span class="nc">CountDownLatch</span> <span class="n">latch</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">CountDownLatch</span><span class="o">(</span><span class="mi">5</span><span class="o">);</span>

        <span class="nc">ExecutorService</span> <span class="n">executorService</span> <span class="o">=</span> <span class="nc">Executors</span><span class="o">.</span><span class="na">newFixedThreadPool</span><span class="o">(</span><span class="mi">5</span><span class="o">);</span>

        <span class="k">for</span> <span class="o">(</span><span class="kt">int</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="o">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="mi">4</span><span class="o">;</span> <span class="n">i</span><span class="o">++)</span> <span class="o">{</span>
            <span class="n">executorService</span><span class="o">.</span><span class="na">submit</span><span class="o">(()</span> <span class="o">-&gt;</span> <span class="o">{</span>
                <span class="n">action</span><span class="o">();</span>
                <span class="n">latch</span><span class="o">.</span><span class="na">countDown</span><span class="o">();</span> <span class="c1">// -1</span>
            <span class="o">});</span>
        <span class="o">}</span>

        <span class="c1">// ç­‰å¾…å®Œæˆ</span>
        <span class="c1">// å½“è®¡æ•° &gt; 0ï¼Œä¼šè¢«é˜»å¡</span>
        <span class="n">latch</span><span class="o">.</span><span class="na">await</span><span class="o">();</span>

        <span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">"Done"</span><span class="o">);</span>

        <span class="c1">// å…³é—­çº¿ç¨‹æ± </span>
        <span class="n">executorService</span><span class="o">.</span><span class="na">shutdown</span><span class="o">();</span>
    <span class="o">}</span>

    <span class="kd">private</span> <span class="kd">static</span> <span class="kt">void</span> <span class="nf">action</span><span class="o">()</span> <span class="o">{</span>
        <span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">printf</span><span class="o">(</span><span class="s">"çº¿ç¨‹[%s] æ­£åœ¨æ‰§è¡Œ...\n"</span><span class="o">,</span> <span class="nc">Thread</span><span class="o">.</span><span class="na">currentThread</span><span class="o">().</span><span class="na">getName</span><span class="o">());</span>  <span class="c1">// 2</span>
    <span class="o">}</span>

<span class="o">}</span>
</pre></td></tr></tbody></table></code></pre></div></div>

<p><strong>CyclicBarrier</strong>ï¼šå¯å¾ªç¯çš„ï¼Œ å…ˆè®¡æ•° -1ï¼Œå†åˆ¤æ–­å½“è®¡æ•° &gt; 0 æ—¶å€™ï¼Œæ‰é˜»å¡ã€‚</p>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
</pre></td><td class="rouge-code"><pre><span class="kd">public</span> <span class="kd">class</span> <span class="nc">CyclicBarrierQuestion</span> <span class="o">{</span>

    <span class="kd">public</span> <span class="kd">static</span> <span class="kt">void</span> <span class="nf">main</span><span class="o">(</span><span class="nc">String</span><span class="o">[]</span> <span class="n">args</span><span class="o">)</span> <span class="kd">throws</span> <span class="nc">InterruptedException</span> <span class="o">{</span>

        <span class="nc">CyclicBarrier</span> <span class="n">barrier</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">CyclicBarrier</span><span class="o">(</span><span class="mi">5</span><span class="o">);</span> <span class="c1">// 5</span>

        <span class="nc">ExecutorService</span> <span class="n">executorService</span> <span class="o">=</span> <span class="nc">Executors</span><span class="o">.</span><span class="na">newFixedThreadPool</span><span class="o">(</span><span class="mi">5</span><span class="o">);</span> <span class="c1">// 3</span>

        <span class="k">for</span> <span class="o">(</span><span class="kt">int</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="o">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="mi">20</span><span class="o">;</span> <span class="n">i</span><span class="o">++)</span> <span class="o">{</span>
            <span class="n">executorService</span><span class="o">.</span><span class="na">submit</span><span class="o">(()</span> <span class="o">-&gt;</span> <span class="o">{</span>
                <span class="n">action</span><span class="o">();</span>
                <span class="k">try</span> <span class="o">{</span>
                    <span class="c1">// CyclicBarrier.await() = CountDownLatch.countDown() + await()</span>
                    <span class="c1">// å…ˆè®¡æ•° -1ï¼Œå†åˆ¤æ–­å½“è®¡æ•° &gt; 0 æ—¶å€™ï¼Œæ‰é˜»å¡</span>
                    <span class="n">barrier</span><span class="o">.</span><span class="na">await</span><span class="o">();</span>
                <span class="o">}</span> <span class="k">catch</span> <span class="o">(</span><span class="nc">InterruptedException</span> <span class="n">e</span><span class="o">)</span> <span class="o">{</span>
                    <span class="n">e</span><span class="o">.</span><span class="na">printStackTrace</span><span class="o">();</span>
                <span class="o">}</span> <span class="k">catch</span> <span class="o">(</span><span class="nc">BrokenBarrierException</span> <span class="n">e</span><span class="o">)</span> <span class="o">{</span>
                    <span class="n">e</span><span class="o">.</span><span class="na">printStackTrace</span><span class="o">();</span>
                <span class="o">}</span>
            <span class="o">});</span>
        <span class="o">}</span>

        <span class="c1">// å°½å¯èƒ½ä¸è¦æ‰§è¡Œå®Œæˆå† reset</span>
        <span class="c1">// å…ˆç­‰å¾… 3 ms</span>
        <span class="n">executorService</span><span class="o">.</span><span class="na">awaitTermination</span><span class="o">(</span><span class="mi">3</span><span class="o">,</span> <span class="nc">TimeUnit</span><span class="o">.</span><span class="na">MILLISECONDS</span><span class="o">);</span>
        <span class="c1">// å†æ‰§è¡Œ CyclicBarrier reset</span>
        <span class="c1">// reset æ–¹æ³•æ˜¯ä¸€ä¸ªåºŸæ“ä½œ</span>
        <span class="n">barrier</span><span class="o">.</span><span class="na">reset</span><span class="o">();</span>

        <span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">"Done"</span><span class="o">);</span>

        <span class="c1">// å…³é—­çº¿ç¨‹æ± </span>
        <span class="n">executorService</span><span class="o">.</span><span class="na">shutdown</span><span class="o">();</span>
    <span class="o">}</span>

    <span class="kd">private</span> <span class="kd">static</span> <span class="kt">void</span> <span class="nf">action</span><span class="o">()</span> <span class="o">{</span>
        <span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">printf</span><span class="o">(</span><span class="s">"çº¿ç¨‹[%s] æ­£åœ¨æ‰§è¡Œ...\n"</span><span class="o">,</span> <span class="nc">Thread</span><span class="o">.</span><span class="na">currentThread</span><span class="o">().</span><span class="na">getName</span><span class="o">());</span>  <span class="c1">// 2</span>
    <span class="o">}</span>

<span class="o">}</span>

</pre></td></tr></tbody></table></code></pre></div></div>

<h4 id="è¿›é˜¶ç‰ˆ-15">è¿›é˜¶ç‰ˆ</h4>
<p>è¯·è¯´æ˜ Semaphoreï¼ˆä¿¡å·é‡/ç¯ï¼‰ çš„ä½¿ç”¨åœºæ™¯ï¼Ÿ</p>

<p>Semaphore å’ŒLockç±»ä¼¼ï¼Œæ¯”Lockçµæ´»ã€‚å…¶ä¸­æœ‰ acquire() å’Œ release() ä¸¤ç§æ–¹æ³•ï¼Œarg éƒ½ç­‰äº 1ã€‚acquire() ä¼šæŠ›å‡º InterruptedExceptionï¼ŒåŒæ—¶ä» <code class="highlighter-rouge">sync.acquireSharedInterruptibly(arg:1)</code>å¯ä»¥çœ‹å‡ºæ˜¯è¯»æ¨¡å¼ï¼ˆshared)ï¼› release()ä¸­å¯ä»¥è®¡æ•°ï¼Œå¯ä»¥æ§åˆ¶æ•°é‡ï¼Œpermitså¯ä»¥ä¼ é€’Nä¸ªæ•°é‡ã€‚</p>

<p><a href="https://blog.csdn.net/zbc1090549839/article/details/53389602">Javaä¸­Semaphore(ä¿¡å·é‡)çš„ä½¿ç”¨</a></p>

<h4 id="åŠé€€ç‰ˆ-15">åŠé€€ç‰ˆ</h4>
<p>è¯·é€šè¿‡ Java 1.4 çš„è¯­æ³•å®ç°ä¸€ä¸ª CountDownLatch?</p>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
44
45
46
47
48
49
50
51
52
53
54
55
56
57
58
59
60
61
62
63
64
65
66
67
68
69
70
71
72
73
74
75
76
77
78
79
80
81
82
83
84
85
86
87
88
89
90
91
92
93
94
95
96
97
98
99
100
101
102
103
104
105
106
107
108
109
110
111
112
113
114
115
116
</pre></td><td class="rouge-code"><pre><span class="kd">public</span> <span class="kd">class</span> <span class="nc">LegacyCountDownLatchDemo</span> <span class="o">{</span>

    <span class="kd">public</span> <span class="kd">static</span> <span class="kt">void</span> <span class="nf">main</span><span class="o">(</span><span class="nc">String</span><span class="o">[]</span> <span class="n">args</span><span class="o">)</span> <span class="kd">throws</span> <span class="nc">InterruptedException</span> <span class="o">{</span>

        <span class="c1">// å€’æ•°è®¡æ•° 5</span>
        <span class="nc">MyCountDownLatch</span> <span class="n">latch</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">MyCountDownLatch</span><span class="o">(</span><span class="mi">5</span><span class="o">);</span>

        <span class="nc">ExecutorService</span> <span class="n">executorService</span> <span class="o">=</span> <span class="nc">Executors</span><span class="o">.</span><span class="na">newFixedThreadPool</span><span class="o">(</span><span class="mi">5</span><span class="o">);</span>

        <span class="k">for</span> <span class="o">(</span><span class="kt">int</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="o">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="mi">5</span><span class="o">;</span> <span class="n">i</span><span class="o">++)</span> <span class="o">{</span>
            <span class="n">executorService</span><span class="o">.</span><span class="na">submit</span><span class="o">(()</span> <span class="o">-&gt;</span> <span class="o">{</span>
                <span class="n">action</span><span class="o">();</span>
                <span class="n">latch</span><span class="o">.</span><span class="na">countDown</span><span class="o">();</span> <span class="c1">// -1</span>
            <span class="o">});</span>
        <span class="o">}</span>

        <span class="c1">// ç­‰å¾…å®Œæˆ</span>
        <span class="c1">// å½“è®¡æ•° &gt; 0ï¼Œä¼šè¢«é˜»å¡</span>
        <span class="n">latch</span><span class="o">.</span><span class="na">await</span><span class="o">();</span>

        <span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">"Done"</span><span class="o">);</span>

        <span class="c1">// å…³é—­çº¿ç¨‹æ± </span>
        <span class="n">executorService</span><span class="o">.</span><span class="na">shutdown</span><span class="o">();</span>
    <span class="o">}</span>

    <span class="kd">private</span> <span class="kd">static</span> <span class="kt">void</span> <span class="nf">action</span><span class="o">()</span> <span class="o">{</span>
        <span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">printf</span><span class="o">(</span><span class="s">"çº¿ç¨‹[%s] æ­£åœ¨æ‰§è¡Œ...\n"</span><span class="o">,</span> <span class="nc">Thread</span><span class="o">.</span><span class="na">currentThread</span><span class="o">().</span><span class="na">getName</span><span class="o">());</span>  <span class="c1">// 2</span>
    <span class="o">}</span>

    <span class="cm">/**
     * Java 1.5+ Lock å®ç°
     */</span>
    <span class="kd">private</span> <span class="kd">static</span> <span class="kd">class</span> <span class="nc">MyCountDownLatch</span> <span class="o">{</span>

        <span class="kd">private</span> <span class="kt">int</span> <span class="n">count</span><span class="o">;</span>

        <span class="kd">private</span> <span class="kd">final</span> <span class="nc">Lock</span> <span class="n">lock</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">ReentrantLock</span><span class="o">();</span>

        <span class="kd">private</span> <span class="kd">final</span> <span class="nc">Condition</span> <span class="n">condition</span> <span class="o">=</span> <span class="n">lock</span><span class="o">.</span><span class="na">newCondition</span><span class="o">();</span>

        <span class="kd">private</span> <span class="nf">MyCountDownLatch</span><span class="o">(</span><span class="kt">int</span> <span class="n">count</span><span class="o">)</span> <span class="o">{</span>
            <span class="k">this</span><span class="o">.</span><span class="na">count</span> <span class="o">=</span> <span class="n">count</span><span class="o">;</span>
        <span class="o">}</span>

        <span class="kd">public</span> <span class="kt">void</span> <span class="nf">await</span><span class="o">()</span> <span class="kd">throws</span> <span class="nc">InterruptedException</span> <span class="o">{</span>
            <span class="c1">// å½“ count &gt; 0 ç­‰å¾…</span>
            <span class="k">if</span> <span class="o">(</span><span class="nc">Thread</span><span class="o">.</span><span class="na">interrupted</span><span class="o">())</span> <span class="o">{</span>
                <span class="k">throw</span> <span class="k">new</span> <span class="nf">InterruptedException</span><span class="o">();</span>
            <span class="o">}</span>

            <span class="n">lock</span><span class="o">.</span><span class="na">lock</span><span class="o">();</span>
            <span class="k">try</span> <span class="o">{</span>
                <span class="k">while</span> <span class="o">(</span><span class="n">count</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="o">)</span> <span class="o">{</span>
                    <span class="n">condition</span><span class="o">.</span><span class="na">await</span><span class="o">();</span> <span class="c1">// é˜»å¡å½“å‰çº¿ç¨‹</span>
                <span class="o">}</span>
            <span class="o">}</span> <span class="k">finally</span> <span class="o">{</span>
                <span class="n">lock</span><span class="o">.</span><span class="na">unlock</span><span class="o">();</span>
            <span class="o">}</span>
        <span class="o">}</span>

        <span class="kd">public</span> <span class="kt">void</span> <span class="nf">countDown</span><span class="o">()</span> <span class="o">{</span>

            <span class="n">lock</span><span class="o">.</span><span class="na">lock</span><span class="o">();</span>
            <span class="k">try</span> <span class="o">{</span>
                <span class="k">if</span> <span class="o">(</span><span class="n">count</span> <span class="o">&lt;</span> <span class="mi">1</span><span class="o">)</span> <span class="o">{</span>
                    <span class="k">return</span><span class="o">;</span>
                <span class="o">}</span>
                <span class="n">count</span><span class="o">--;</span>
                <span class="k">if</span> <span class="o">(</span><span class="n">count</span> <span class="o">&lt;</span> <span class="mi">1</span><span class="o">)</span> <span class="o">{</span> <span class="c1">// å½“æ•°é‡å‡å°‘è‡³0æ—¶ï¼Œå”¤èµ·è¢«é˜»å¡çš„çº¿ç¨‹</span>
                    <span class="n">condition</span><span class="o">.</span><span class="na">signalAll</span><span class="o">();</span>
                <span class="o">}</span>
            <span class="o">}</span> <span class="k">finally</span> <span class="o">{</span>
                <span class="n">lock</span><span class="o">.</span><span class="na">unlock</span><span class="o">();</span>
            <span class="o">}</span>
        <span class="o">}</span>
    <span class="o">}</span>

    <span class="cm">/**
     * Java &lt; 1.5 å®ç°
     */</span>
    <span class="kd">private</span> <span class="kd">static</span> <span class="kd">class</span> <span class="nc">LegacyCountDownLatch</span> <span class="o">{</span>

        <span class="kd">private</span> <span class="kt">int</span> <span class="n">count</span><span class="o">;</span>

        <span class="kd">private</span> <span class="nf">LegacyCountDownLatch</span><span class="o">(</span><span class="kt">int</span> <span class="n">count</span><span class="o">)</span> <span class="o">{</span>
            <span class="k">this</span><span class="o">.</span><span class="na">count</span> <span class="o">=</span> <span class="n">count</span><span class="o">;</span>
        <span class="o">}</span>

        <span class="kd">public</span> <span class="kt">void</span> <span class="nf">await</span><span class="o">()</span> <span class="kd">throws</span> <span class="nc">InterruptedException</span> <span class="o">{</span>
            <span class="c1">// å½“ count &gt; 0 ç­‰å¾…</span>
            <span class="k">if</span> <span class="o">(</span><span class="nc">Thread</span><span class="o">.</span><span class="na">interrupted</span><span class="o">())</span> <span class="o">{</span>
                <span class="k">throw</span> <span class="k">new</span> <span class="nf">InterruptedException</span><span class="o">();</span>
            <span class="o">}</span>

            <span class="kd">synchronized</span> <span class="o">(</span><span class="k">this</span><span class="o">)</span> <span class="o">{</span>
                <span class="k">while</span> <span class="o">(</span><span class="n">count</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="o">)</span> <span class="o">{</span>
                    <span class="n">wait</span><span class="o">();</span> <span class="c1">// é˜»å¡å½“å‰çº¿ç¨‹</span>
                <span class="o">}</span>
            <span class="o">}</span>
        <span class="o">}</span>

        <span class="kd">public</span> <span class="kt">void</span> <span class="nf">countDown</span><span class="o">()</span> <span class="o">{</span>
            <span class="kd">synchronized</span> <span class="o">(</span><span class="k">this</span><span class="o">)</span> <span class="o">{</span>
                <span class="k">if</span> <span class="o">(</span><span class="n">count</span> <span class="o">&lt;</span> <span class="mi">1</span><span class="o">)</span> <span class="o">{</span>
                    <span class="k">return</span><span class="o">;</span>
                <span class="o">}</span>
                <span class="n">count</span><span class="o">--;</span>
                <span class="k">if</span> <span class="o">(</span><span class="n">count</span> <span class="o">&lt;</span> <span class="mi">1</span><span class="o">)</span> <span class="o">{</span> <span class="c1">// å½“æ•°é‡å‡å°‘è‡³0æ—¶ï¼Œå”¤èµ·è¢«é˜»å¡çš„çº¿ç¨‹</span>
                    <span class="n">notifyAll</span><span class="o">();</span>
                <span class="o">}</span>
            <span class="o">}</span>
        <span class="o">}</span>
    <span class="o">}</span>
<span class="o">}</span>

</pre></td></tr></tbody></table></code></pre></div></div>

<h3 id="4çº¿ç¨‹æ± -thread-pool">4ã€çº¿ç¨‹æ±  THREAD POOL</h3>

<h4 id="åŸºæœ¬ç‰ˆ-16">åŸºæœ¬ç‰ˆ</h4>
<p>è¯·é—® J.U.C ä¸­å†…å»ºäº†å‡ ç§ ExceptionService å®ç°ï¼Ÿ</p>

<p>1.5ï¼šThreadPoolExecutorã€ScheduledThreadPoolExecutor</p>

<p>1.7ï¼šForkJoinPool</p>
<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
</pre></td><td class="rouge-code"><pre><span class="kd">public</span> <span class="kd">class</span> <span class="nc">ExecutorServiceQuestion</span> <span class="o">{</span>

    <span class="kd">public</span> <span class="kd">static</span> <span class="kt">void</span> <span class="nf">main</span><span class="o">(</span><span class="nc">String</span><span class="o">[]</span> <span class="n">args</span><span class="o">)</span> <span class="o">{</span>
        <span class="cm">/**
         * 1.5
         *  ThreadPoolExecutor
         *  ScheduledThreadPoolExecutor :: ThreadPoolExecutor
         * 1.7
         *  ForkJoinPool
         */</span>
        <span class="nc">ExecutorService</span> <span class="n">executorService</span> <span class="o">=</span> <span class="nc">Executors</span><span class="o">.</span><span class="na">newFixedThreadPool</span><span class="o">(</span><span class="mi">2</span><span class="o">);</span>

        <span class="n">executorService</span> <span class="o">=</span> <span class="nc">Executors</span><span class="o">.</span><span class="na">newScheduledThreadPool</span><span class="o">(</span><span class="mi">2</span><span class="o">);</span>

        <span class="c1">// executorService ä¸å†è¢«å¼•ç”¨ï¼Œå®ƒä¼šè¢« GC -&gt; finalize() -&gt; shutdown()</span>
        <span class="nc">ExecutorService</span> <span class="n">executorService2</span> <span class="o">=</span> <span class="nc">Executors</span><span class="o">.</span><span class="na">newSingleThreadExecutor</span><span class="o">();</span>
    <span class="o">}</span>
<span class="o">}</span>
</pre></td></tr></tbody></table></code></pre></div></div>

<h4 id="è¿›é˜¶ç‰ˆ-16">è¿›é˜¶ç‰ˆ</h4>
<p>è¯·åˆ†åˆ«è§£é‡Š ThreadPoolExecutor æ„é€ å™¨å‚æ•°åœ¨è¿è¡Œæ—¶çš„ä½œç”¨ï¼Ÿ</p>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
</pre></td><td class="rouge-code"><pre><span class="cm">/**
 * Creates a new {@code ThreadPoolExecutor} with the given initial
 * parameters.
 *
 * @param corePoolSize the number of threads to keep in the pool, even
 *        if they are idle, unless {@code allowCoreThreadTimeOut} is set
 * @param maximumPoolSize the maximum number of threads to allow in the
 *        pool
 * @param keepAliveTime when the number of threads is greater than
 *        the core, this is the maximum time that excess idle threads
 *        will wait for new tasks before terminating.
 * @param unit the time unit for the {@code keepAliveTime} argument
 * @param workQueue the queue to use for holding tasks before they are
 *        executed.  This queue will hold only the {@code Runnable}
 *        tasks submitted by the {@code execute} method.
 * @param threadFactory the factory to use when the executor
 *        creates a new thread
 * @param handler the handler to use when execution is blocked
 *        because the thread bounds and queue capacities are reached
 * @throws IllegalArgumentException if one of the following holds:&lt;br&gt;
 *         {@code corePoolSize &lt; 0}&lt;br&gt;
 *         {@code keepAliveTime &lt; 0}&lt;br&gt;
 *         {@code maximumPoolSize &lt;= 0}&lt;br&gt;
 *         {@code maximumPoolSize &lt; corePoolSize}
 * @throws NullPointerException if {@code workQueue}
 *         or {@code threadFactory} or {@code handler} is null
 */</span>
<span class="kd">public</span> <span class="nf">ThreadPoolExecutor</span><span class="o">(</span><span class="kt">int</span> <span class="n">corePoolSize</span><span class="o">,</span>
                          <span class="kt">int</span> <span class="n">maximumPoolSize</span><span class="o">,</span>
                          <span class="kt">long</span> <span class="n">keepAliveTime</span><span class="o">,</span>
                          <span class="nc">TimeUnit</span> <span class="n">unit</span><span class="o">,</span>
                          <span class="nc">BlockingQueue</span><span class="o">&lt;</span><span class="nc">Runnable</span><span class="o">&gt;</span> <span class="n">workQueue</span><span class="o">,</span>
                          <span class="nc">ThreadFactory</span> <span class="n">threadFactory</span><span class="o">,</span>
                          <span class="nc">RejectedExecutionHandler</span> <span class="n">handler</span><span class="o">);</span>
</pre></td></tr></tbody></table></code></pre></div></div>

<p><strong>corePoolSize</strong>: æ ¸å¿ƒçº¿ç¨‹æ± å¤§å°ã€‚è¿™ä¸ªå‚æ•°æ˜¯å¦ç”Ÿæ•ˆå–å†³äºallowCoreThreadTimeOutå˜é‡çš„å€¼ï¼Œè¯¥å˜é‡é»˜è®¤æ˜¯falseï¼Œå³å¯¹äºæ ¸å¿ƒçº¿ç¨‹æ²¡æœ‰è¶…æ—¶é™åˆ¶ï¼Œæ‰€ä»¥è¿™ç§æƒ…å†µä¸‹ï¼ŒcorePoolSizeå‚æ•°æ˜¯èµ·æ•ˆçš„ã€‚å¦‚æœallowCoreThreadTimeOutä¸ºtrueï¼Œé‚£ä¹ˆæ ¸å¿ƒçº¿ç¨‹å…è®¸è¶…æ—¶ï¼Œå¹¶ä¸”è¶…æ—¶æ—¶é—´å°±æ˜¯keepAliveTimeå‚æ•°å’Œunitå…±åŒå†³å®šçš„å€¼ï¼Œè¿™ç§æƒ…å†µä¸‹ï¼Œå¦‚æœçº¿ç¨‹æ± é•¿æ—¶é—´ç©ºé—²çš„è¯æœ€ç»ˆå­˜æ´»çš„çº¿ç¨‹ä¼šå˜ä¸º0ï¼Œä¹Ÿå³corePoolSizeå‚æ•°å¤±æ•ˆã€‚</p>

<p><strong>maximumPoolSize</strong>: çº¿ç¨‹æ± ä¸­æœ€å¤§çš„å­˜æ´»çº¿ç¨‹æ•°ã€‚è¿™ä¸ªå‚æ•°æ¯”è¾ƒå¥½ç†è§£ï¼Œå¯¹äºè¶…å‡ºcorePoolSizeéƒ¨åˆ†çš„çº¿ç¨‹ï¼Œæ— è®ºallowCoreThreadTimeOutå˜é‡çš„å€¼æ˜¯trueè¿˜æ˜¯falseï¼Œéƒ½ä¼šè¶…æ—¶ï¼Œè¶…æ—¶æ—¶é—´ç”±keepAliveTimeå’Œunitä¸¤ä¸ªå‚æ•°ç®—å‡ºã€‚</p>

<p><strong>keepAliveTime</strong>: è¶…æ—¶æ—¶é—´ã€‚</p>

<p><strong>unit</strong>: è¶…æ—¶æ—¶é—´çš„å•ä½ï¼Œç§’ï¼Œæ¯«ç§’ï¼Œå¾®ç§’ï¼Œçº³ç§’ç­‰ï¼Œä¸keepAliveTimeå‚æ•°å…±åŒå†³å®šè¶…æ—¶æ—¶é—´ã€‚</p>

<p><strong>workQueue</strong>: çº¿ç¨‹ç­‰å¾…é˜Ÿåˆ—ã€‚å½“è°ƒç”¨executeæ–¹æ³•æ—¶ï¼Œå¦‚æœçº¿ç¨‹æ± ä¸­æ²¡æœ‰ç©ºé—²çš„å¯ç”¨çº¿ç¨‹ï¼Œé‚£ä¹ˆå°±ä¼šæŠŠè¿™ä¸ªRunnableå¯¹è±¡æ”¾åˆ°è¯¥é˜Ÿåˆ—ä¸­ã€‚è¿™ä¸ªå‚æ•°å¿…é¡»æ˜¯ä¸€ä¸ªå®ç°BlockingQueueæ¥å£çš„é˜»å¡é˜Ÿåˆ—ï¼Œå› ä¸ºè¦ä¿è¯çº¿ç¨‹å®‰å…¨ã€‚æœ‰ä¸€ä¸ªè¦æ³¨æ„çš„ç‚¹æ˜¯ï¼Œåªæœ‰åœ¨è°ƒç”¨executeæ–¹æ³•æ˜¯ï¼Œæ‰ä¼šå‘è¿™ä¸ªé˜Ÿåˆ—ä¸­æ·»åŠ ä»»åŠ¡ï¼Œé‚£ä¹ˆå¯¹äºsubmitæ–¹æ³•å‘¢ï¼Œéš¾é“submitæ–¹æ³•æäº¤ä»»åŠ¡æ—¶å¦‚æœæ²¡æœ‰å¯ç”¨çš„çº¿ç¨‹å°±ç›´æ¥æ‰”æ‰å—ï¼Ÿå½“ç„¶ä¸æ˜¯ï¼Œçœ‹ä¸€ä¸‹AbstractExecutorServiceç±»ä¸­submitæ–¹æ³•å®ç°ï¼Œå…¶å®submitæ–¹æ³•åªæ˜¯æŠŠä¼ è¿›æ¥çš„Runnableå¯¹è±¡æˆ–Callableå¯¹è±¡åŒ…è£…æˆä¸€ä¸ªæ–°çš„Runnableå¯¹è±¡ï¼Œç„¶åè°ƒç”¨executeæ–¹æ³•ï¼Œå¹¶å°†åŒ…è£…åçš„FutureTaskå¯¹è±¡ä½œä¸ºä¸€ä¸ªFutureå¼•ç”¨è¿”å›ç»™è°ƒç”¨è€…ã€‚Futureçš„é˜»å¡ç‰¹æ€§å®é™…æ˜¯åœ¨FutureTaskä¸­å®ç°çš„ï¼Œå…·ä½“æ€ä¹ˆå®ç°æ„Ÿå…´è¶£çš„è¯å¯ä»¥çœ‹ä¸€ä¸‹FutureTaskçš„æºç ã€‚</p>

<p><strong>threadFactory</strong>: çº¿ç¨‹åˆ›å»ºå·¥å‚ã€‚ç”¨äºåœ¨éœ€è¦çš„æ—¶å€™ç”Ÿæˆæ–°çš„çº¿ç¨‹ã€‚é»˜è®¤å®ç°æ˜¯Executors.defaultThreadFactory()ï¼Œå³new ä¸€ä¸ªThreadå¯¹è±¡ï¼Œå¹¶è®¾ç½®çº¿ç¨‹åç§°ï¼Œdaemonç­‰å±æ€§ã€‚</p>

<p><strong>handler</strong>: æ‹’ç»ç­–ç•¥ã€‚è¿™ä¸ªå‚æ•°çš„ä½œç”¨æ˜¯å½“æäº¤ä»»åŠ¡æ—¶æ—¢æ²¡æœ‰ç©ºé—²çº¿ç¨‹ï¼Œä»»åŠ¡é˜Ÿåˆ—ä¹Ÿæ»¡äº†ï¼Œè¿™æ—¶å€™å°±ä¼šè°ƒç”¨handlerçš„rejectedExecutionæ–¹æ³•ã€‚é»˜è®¤çš„å®ç°æ˜¯æŠ›å‡ºä¸€ä¸ªRejectedExecutionExceptionå¼‚å¸¸ã€‚</p>

<h4 id="åŠé€€ç‰ˆ-16">åŠé€€ç‰ˆ</h4>
<p>å¦‚ä½•è·å– ThreadPoolExecutor æ­£åœ¨è¿è¡Œçš„çº¿ç¨‹ï¼Ÿ</p>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
44
45
46
47
48
49
50
51
52
53
54
55
56
57
58
59
60
61
62
63
64
65
66
67
68
69
70
71
72
73
74
</pre></td><td class="rouge-code"><pre><span class="kd">public</span> <span class="kd">class</span> <span class="nc">ThreadPoolExecutorThreadQuestion</span> <span class="o">{</span>

    <span class="kd">public</span> <span class="kd">static</span> <span class="kt">void</span> <span class="nf">main</span><span class="o">(</span><span class="nc">String</span><span class="o">[]</span> <span class="n">args</span><span class="o">)</span> <span class="kd">throws</span> <span class="nc">InterruptedException</span> <span class="o">{</span>

        <span class="c1">// main çº¿ç¨‹å¯åŠ¨å­çº¿ç¨‹ï¼Œå­çº¿ç¨‹çš„åˆ›é€ æ¥è‡ªäº Executors.defaultThreadFactory()</span>

        <span class="nc">ExecutorService</span> <span class="n">executorService</span> <span class="o">=</span> <span class="nc">Executors</span><span class="o">.</span><span class="na">newCachedThreadPool</span><span class="o">();</span>
        <span class="c1">// ä¹‹å‰äº†è§£ ThreadPoolExecutor beforeExecute å’Œ afterExecute èƒ½å¤Ÿè·å–å½“å‰çº¿ç¨‹æ•°é‡</span>

        <span class="nc">Set</span><span class="o">&lt;</span><span class="nc">Thread</span><span class="o">&gt;</span> <span class="n">threadsContainer</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">HashSet</span><span class="o">&lt;&gt;();</span>

        <span class="n">setThreadFactory</span><span class="o">(</span><span class="n">executorService</span><span class="o">,</span> <span class="n">threadsContainer</span><span class="o">);</span>
        <span class="k">for</span> <span class="o">(</span><span class="kt">int</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="o">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="mi">9</span><span class="o">;</span> <span class="n">i</span><span class="o">++)</span> <span class="o">{</span> <span class="c1">// å¼€å¯ 9 ä¸ªçº¿ç¨‹</span>
            <span class="n">executorService</span><span class="o">.</span><span class="na">submit</span><span class="o">(()</span> <span class="o">-&gt;</span> <span class="o">{</span>
            <span class="o">});</span>
        <span class="o">}</span>

        <span class="c1">// çº¿ç¨‹æ± ç­‰å¾…æ‰§è¡Œ 3 ms</span>
        <span class="n">executorService</span><span class="o">.</span><span class="na">awaitTermination</span><span class="o">(</span><span class="mi">3</span><span class="o">,</span> <span class="nc">TimeUnit</span><span class="o">.</span><span class="na">MILLISECONDS</span><span class="o">);</span>

        <span class="n">threadsContainer</span><span class="o">.</span><span class="na">stream</span><span class="o">()</span>
                <span class="o">.</span><span class="na">filter</span><span class="o">(</span><span class="nl">Thread:</span><span class="o">:</span><span class="n">isAlive</span><span class="o">)</span>
                <span class="o">.</span><span class="na">forEach</span><span class="o">(</span><span class="n">thread</span> <span class="o">-&gt;</span> <span class="o">{</span>
                    <span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">"çº¿ç¨‹æ± åˆ›é€ çš„çº¿ç¨‹ : "</span> <span class="o">+</span> <span class="n">thread</span><span class="o">);</span>
                <span class="o">});</span>

        <span class="nc">Thread</span> <span class="n">mainThread</span> <span class="o">=</span> <span class="nc">Thread</span><span class="o">.</span><span class="na">currentThread</span><span class="o">();</span>

        <span class="nc">ThreadGroup</span> <span class="n">mainThreadGroup</span> <span class="o">=</span> <span class="n">mainThread</span><span class="o">.</span><span class="na">getThreadGroup</span><span class="o">();</span>

        <span class="kt">int</span> <span class="n">count</span> <span class="o">=</span> <span class="n">mainThreadGroup</span><span class="o">.</span><span class="na">activeCount</span><span class="o">();</span>
        <span class="nc">Thread</span><span class="o">[]</span> <span class="n">threads</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">Thread</span><span class="o">[</span><span class="n">count</span><span class="o">];</span>
        <span class="n">mainThreadGroup</span><span class="o">.</span><span class="na">enumerate</span><span class="o">(</span><span class="n">threads</span><span class="o">,</span> <span class="kc">true</span><span class="o">);</span>

        <span class="nc">Stream</span><span class="o">.</span><span class="na">of</span><span class="o">(</span><span class="n">threads</span><span class="o">)</span>
                <span class="o">.</span><span class="na">filter</span><span class="o">(</span><span class="nl">Thread:</span><span class="o">:</span><span class="n">isAlive</span><span class="o">)</span>
                <span class="o">.</span><span class="na">forEach</span><span class="o">(</span><span class="n">thread</span> <span class="o">-&gt;</span> <span class="o">{</span>
                    <span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">"çº¿ç¨‹ : "</span> <span class="o">+</span> <span class="n">thread</span><span class="o">);</span>
                <span class="o">});</span>

        <span class="c1">// å…³é—­çº¿ç¨‹æ± </span>
        <span class="n">executorService</span><span class="o">.</span><span class="na">shutdown</span><span class="o">();</span>

    <span class="o">}</span>

    <span class="kd">private</span> <span class="kd">static</span> <span class="kt">void</span> <span class="nf">setThreadFactory</span><span class="o">(</span><span class="nc">ExecutorService</span> <span class="n">executorService</span><span class="o">,</span> <span class="nc">Set</span><span class="o">&lt;</span><span class="nc">Thread</span><span class="o">&gt;</span> <span class="n">threadsContainer</span><span class="o">)</span> <span class="o">{</span>

        <span class="k">if</span> <span class="o">(</span><span class="n">executorService</span> <span class="k">instanceof</span> <span class="nc">ThreadPoolExecutor</span><span class="o">)</span> <span class="o">{</span>
            <span class="nc">ThreadPoolExecutor</span> <span class="n">threadPoolExecutor</span> <span class="o">=</span> <span class="o">(</span><span class="nc">ThreadPoolExecutor</span><span class="o">)</span> <span class="n">executorService</span><span class="o">;</span>
            <span class="nc">ThreadFactory</span> <span class="n">oldThreadFactory</span> <span class="o">=</span> <span class="n">threadPoolExecutor</span><span class="o">.</span><span class="na">getThreadFactory</span><span class="o">();</span>
            <span class="n">threadPoolExecutor</span><span class="o">.</span><span class="na">setThreadFactory</span><span class="o">(</span><span class="k">new</span> <span class="nc">DelegatingThreadFactory</span><span class="o">(</span><span class="n">oldThreadFactory</span><span class="o">,</span> <span class="n">threadsContainer</span><span class="o">));</span>
        <span class="o">}</span>
    <span class="o">}</span>

    <span class="kd">private</span> <span class="kd">static</span> <span class="kd">class</span> <span class="nc">DelegatingThreadFactory</span> <span class="kd">implements</span> <span class="nc">ThreadFactory</span> <span class="o">{</span>

        <span class="kd">private</span> <span class="kd">final</span> <span class="nc">ThreadFactory</span> <span class="n">delegate</span><span class="o">;</span>

        <span class="kd">private</span> <span class="kd">final</span> <span class="nc">Set</span><span class="o">&lt;</span><span class="nc">Thread</span><span class="o">&gt;</span> <span class="n">threadsContainer</span><span class="o">;</span>

        <span class="kd">private</span> <span class="nf">DelegatingThreadFactory</span><span class="o">(</span><span class="nc">ThreadFactory</span> <span class="n">delegate</span><span class="o">,</span> <span class="nc">Set</span><span class="o">&lt;</span><span class="nc">Thread</span><span class="o">&gt;</span> <span class="n">threadsContainer</span><span class="o">)</span> <span class="o">{</span>
            <span class="k">this</span><span class="o">.</span><span class="na">delegate</span> <span class="o">=</span> <span class="n">delegate</span><span class="o">;</span>
            <span class="k">this</span><span class="o">.</span><span class="na">threadsContainer</span> <span class="o">=</span> <span class="n">threadsContainer</span><span class="o">;</span>
        <span class="o">}</span>

        <span class="nd">@Override</span>
        <span class="kd">public</span> <span class="nc">Thread</span> <span class="nf">newThread</span><span class="o">(</span><span class="nc">Runnable</span> <span class="n">r</span><span class="o">)</span> <span class="o">{</span>
            <span class="nc">Thread</span> <span class="n">thread</span> <span class="o">=</span> <span class="n">delegate</span><span class="o">.</span><span class="na">newThread</span><span class="o">(</span><span class="n">r</span><span class="o">);</span>
            <span class="c1">// cache thread</span>
            <span class="n">threadsContainer</span><span class="o">.</span><span class="na">add</span><span class="o">(</span><span class="n">thread</span><span class="o">);</span>
            <span class="k">return</span> <span class="n">thread</span><span class="o">;</span>
        <span class="o">}</span>
    <span class="o">}</span>
<span class="o">}</span>
</pre></td></tr></tbody></table></code></pre></div></div>

<h3 id="5future">5ã€FUTURE</h3>

<h4 id="åŸºæœ¬ç‰ˆ-17">åŸºæœ¬ç‰ˆ</h4>
<p>å¦‚ä½•è·å– Future å¯¹è±¡ï¼Ÿ</p>

<p>submit()</p>

<h4 id="è¿›é˜¶ç‰ˆ-17">è¿›é˜¶ç‰ˆ</h4>
<p>è¯·ä¸¾ä¾‹ Future get() ä»¥åŠ get(Long,TimeUnit) æ–¹æ³•çš„ä½¿ç”¨åœºæ™¯ï¼Ÿ</p>

<p><strong>è¶…æ—¶ç­‰å¾…</strong></p>

<p><strong>InterruptedException</strong></p>

<p><strong>ExcutionException</strong></p>

<p><strong>TimeOutException</strong></p>

<h4 id="åŠé€€ç‰ˆ-17">åŠé€€ç‰ˆ</h4>
<p>å¦‚ä½•åˆ©ç”¨ Future ä¼˜é›…åœ°å–æ¶ˆä¸€ä¸ªä»»åŠ¡çš„æ‰§è¡Œï¼Ÿ</p>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
</pre></td><td class="rouge-code"><pre><span class="kd">public</span> <span class="kd">class</span> <span class="nc">CancellableFutureQuestion</span> <span class="o">{</span>

    <span class="kd">public</span> <span class="kd">static</span> <span class="kt">void</span> <span class="nf">main</span><span class="o">(</span><span class="nc">String</span><span class="o">[]</span> <span class="n">args</span><span class="o">)</span> <span class="o">{</span>

        <span class="nc">ExecutorService</span> <span class="n">executorService</span> <span class="o">=</span> <span class="nc">Executors</span><span class="o">.</span><span class="na">newSingleThreadExecutor</span><span class="o">();</span>

        <span class="nc">Future</span> <span class="n">future</span> <span class="o">=</span> <span class="n">executorService</span><span class="o">.</span><span class="na">submit</span><span class="o">(()</span> <span class="o">-&gt;</span> <span class="o">{</span> <span class="c1">// 3ç§’å†…æ‰§è¡Œå®Œæˆï¼Œæ‰ç®—æ­£å¸¸</span>
            <span class="n">action</span><span class="o">(</span><span class="mi">5</span><span class="o">);</span>
        <span class="o">});</span>

        <span class="k">try</span> <span class="o">{</span>
            <span class="n">future</span><span class="o">.</span><span class="na">get</span><span class="o">(</span><span class="mi">3</span><span class="o">,</span> <span class="nc">TimeUnit</span><span class="o">.</span><span class="na">SECONDS</span><span class="o">);</span>
        <span class="o">}</span> <span class="k">catch</span> <span class="o">(</span><span class="nc">InterruptedException</span> <span class="n">e</span><span class="o">)</span> <span class="o">{</span>
            <span class="c1">// Thread æ¢å¤ä¸­æ–­çŠ¶æ€</span>
            <span class="nc">Thread</span><span class="o">.</span><span class="na">currentThread</span><span class="o">().</span><span class="na">interrupt</span><span class="o">();</span>
        <span class="o">}</span> <span class="k">catch</span> <span class="o">(</span><span class="nc">ExecutionException</span> <span class="n">e</span><span class="o">)</span> <span class="o">{</span>
            <span class="k">throw</span> <span class="k">new</span> <span class="nf">RuntimeException</span><span class="o">(</span><span class="n">e</span><span class="o">);</span>
        <span class="o">}</span> <span class="k">catch</span> <span class="o">(</span><span class="nc">TimeoutException</span> <span class="n">e</span><span class="o">)</span> <span class="o">{</span>
            <span class="c1">// æ‰§è¡Œè¶…æ—¶ï¼Œé€‚å½“åœ°å…³é—­</span>
            <span class="nc">Thread</span><span class="o">.</span><span class="na">currentThread</span><span class="o">().</span><span class="na">interrupt</span><span class="o">();</span> <span class="c1">// è®¾ç½®ä¸­æ–­çŠ¶æ€</span>
            <span class="n">future</span><span class="o">.</span><span class="na">cancel</span><span class="o">(</span><span class="kc">true</span><span class="o">);</span> <span class="c1">// å°è¯•å–æ¶ˆ</span>
        <span class="o">}</span>

        <span class="n">executorService</span><span class="o">.</span><span class="na">shutdown</span><span class="o">();</span>
    <span class="o">}</span>

    <span class="kd">private</span> <span class="kd">static</span> <span class="kt">void</span> <span class="nf">action</span><span class="o">(</span><span class="kt">int</span> <span class="n">seconds</span><span class="o">)</span> <span class="o">{</span>
        <span class="k">try</span> <span class="o">{</span>
            <span class="nc">Thread</span><span class="o">.</span><span class="na">sleep</span><span class="o">(</span><span class="nc">TimeUnit</span><span class="o">.</span><span class="na">SECONDS</span><span class="o">.</span><span class="na">toMillis</span><span class="o">(</span><span class="n">seconds</span><span class="o">));</span> <span class="c1">// 5 - 3</span>
            <span class="c1">// seconds - timeout = å‰©ä½™æ‰§è¡Œæ—¶é—´</span>
            <span class="k">if</span> <span class="o">(</span><span class="nc">Thread</span><span class="o">.</span><span class="na">interrupted</span><span class="o">())</span> <span class="o">{</span> <span class="c1">// åˆ¤æ–­å¹¶ä¸”æ¸…é™¤ä¸­æ–­çŠ¶æ€</span>
                <span class="k">return</span><span class="o">;</span>
            <span class="o">}</span>
            <span class="n">action</span><span class="o">();</span>
        <span class="o">}</span> <span class="k">catch</span> <span class="o">(</span><span class="nc">InterruptedException</span> <span class="n">e</span><span class="o">)</span> <span class="o">{</span>
        <span class="o">}</span>
    <span class="o">}</span>

    <span class="kd">private</span> <span class="kd">static</span> <span class="kt">void</span> <span class="nf">action</span><span class="o">()</span> <span class="o">{</span>
        <span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">printf</span><span class="o">(</span><span class="s">"çº¿ç¨‹[%s] æ­£åœ¨æ‰§è¡Œ...\n"</span><span class="o">,</span> <span class="nc">Thread</span><span class="o">.</span><span class="na">currentThread</span><span class="o">().</span><span class="na">getName</span><span class="o">());</span>  <span class="c1">// 2</span>
    <span class="o">}</span>
<span class="o">}</span>
</pre></td></tr></tbody></table></code></pre></div></div>

<h3 id="6volatile-å˜é‡">6ã€VOLATILE å˜é‡</h3>

<h4 id="åŸºæœ¬ç‰ˆ-18">åŸºæœ¬ç‰ˆ</h4>
<p>åœ¨ Java ä¸­ï¼Œvolatile ä¿è¯çš„æ˜¯å¯è§æ€§è¿˜æ˜¯åŸå­æ€§ï¼Ÿ</p>

<p><strong>volatile</strong> æ—¢æœ‰å¯è§æ€§åˆæœ‰åŸå­æ€§ï¼ˆéæˆ‘åŠå½¼ï¼‰ï¼Œå¯è§æ€§æ˜¯ä¸€å®šçš„ï¼ŒåŸå­æ€§æ˜¯çœ‹æƒ…å†µçš„ã€‚å¯¹è±¡ç±»å‹å’ŒåŸç”Ÿç±»å‹éƒ½æ˜¯å¯è§æ€§ï¼ŒåŸç”Ÿç±»å‹æ˜¯åŸå­æ€§ã€‚</p>

<h4 id="è¿›é˜¶ç‰ˆ-18">è¿›é˜¶ç‰ˆ</h4>
<p>åœ¨ Java ä¸­ï¼Œvolatile long å’Œ double æ˜¯çº¿ç¨‹å®‰å…¨çš„å—ï¼Ÿ</p>

<p>volatile long å’Œ double æ˜¯çº¿ç¨‹å®‰å…¨çš„ã€‚</p>

<h4 id="åŠé€€ç‰ˆ-18">åŠé€€ç‰ˆ</h4>
<p>åœ¨ Java ä¸­ï¼Œvolatile åº•å±‚å®ç°æ˜¯åŸºäºä»€ä¹ˆæœºåˆ¶ï¼Ÿ</p>

<p><strong>å†…å­˜å±éšœ</strong>ï¼ˆå˜é‡ Lockï¼‰æœºåˆ¶ï¼šä¸€ä¸ªå˜é‡çš„åŸå­æ€§çš„ä¿è¯ã€‚</p>

<h3 id="7åŸå­æ“ä½œ-atomic">7ã€åŸå­æ“ä½œ ATOMIC</h3>

<h4 id="åŸºæœ¬ç‰ˆ-19">åŸºæœ¬ç‰ˆ</h4>
<p>ä¸ºä»€ä¹ˆ AtomicBoolean å†…éƒ¨å˜é‡ä½¿ç”¨ int å®ç°ï¼Œè€Œé boolean?</p>

<p>æ“ä½œç³»ç»Ÿæœ‰ X86 å’Œ X64ï¼Œåœ¨è™šæ‹Ÿæœºä¸­ï¼ŒåŸºäºboolean å®ç°å°±æ˜¯ç”¨ int å®ç°çš„ï¼Œç”¨å“ªä¸€ç§å®ç°éƒ½å¯ä»¥ã€‚è™šæ‹Ÿæœºåªæœ‰32ä½å’Œ64ä½çš„ï¼Œæ‰€ä»¥ç”¨32ä½çš„å®ç°ã€‚</p>

<h4 id="è¿›é˜¶ç‰ˆ-19">è¿›é˜¶ç‰ˆ</h4>
<p>åœ¨å˜é‡åŸå­æ“ä½œæ—¶ï¼ŒAtomic* CAS æ“ä½œæ¯” synchronized å…³é”®å­—å“ªä¸ªæ›´é‡ï¼Ÿ</p>

<p><a href="https://wiki.openjdk.java.net/display/HotSpot/Synchronization">Synchronization</a></p>

<p>åŒçº¿ç¨‹çš„æ—¶å€™ï¼Œsynchronized åˆšå¿«ï¼›è€Œå¤šçº¿ç¨‹çš„æ—¶å€™åˆ™è¦åˆ†æƒ…å†µè®¨è®ºã€‚</p>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
</pre></td><td class="rouge-code"><pre><span class="kd">public</span> <span class="kd">class</span> <span class="nc">AtomicQuestion</span> <span class="o">{</span>

    <span class="kd">private</span> <span class="kd">static</span> <span class="kt">int</span> <span class="n">actualValue</span> <span class="o">=</span> <span class="mi">3</span><span class="o">;</span>

    <span class="kd">public</span> <span class="kd">static</span> <span class="kt">void</span> <span class="nf">main</span><span class="o">(</span><span class="nc">String</span><span class="o">[]</span> <span class="n">args</span><span class="o">)</span> <span class="o">{</span>
        <span class="nc">AtomicInteger</span> <span class="n">atomicInteger</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">AtomicInteger</span><span class="o">(</span><span class="mi">3</span><span class="o">);</span>
        <span class="c1">// if( value == 3 )</span>
        <span class="c1">//     value = 5</span>
        <span class="n">atomicInteger</span><span class="o">.</span><span class="na">compareAndSet</span><span class="o">(</span><span class="mi">3</span><span class="o">,</span> <span class="mi">5</span><span class="o">);</span>
        <span class="c1">// åå‘é” &lt; CAS æ“ä½œ &lt; é‡é”ï¼ˆå®Œå…¨äº’æ–¥ï¼‰</span>
        <span class="c1">// CAS æ“ä½œä¹Ÿæ˜¯ç›¸å¯¹é‡çš„æ“ä½œï¼Œå®ƒä¹Ÿæ˜¯å®ç° synchronized ç˜¦é”(thin lock)çš„å…³é”®</span>
        <span class="c1">// åå‘é”å°±æ˜¯é¿å… CASï¼ˆCompare And Set/Swap)æ“ä½œ</span>
    <span class="o">}</span>

    <span class="kd">private</span> <span class="kd">synchronized</span> <span class="kd">static</span> <span class="kt">void</span> <span class="nf">compareAndSet</span><span class="o">(</span><span class="kt">int</span> <span class="n">expectedValue</span><span class="o">,</span> <span class="kt">int</span> <span class="n">newValue</span><span class="o">)</span> <span class="o">{</span>
        <span class="k">if</span> <span class="o">(</span><span class="n">actualValue</span> <span class="o">==</span> <span class="n">expectedValue</span><span class="o">)</span> <span class="o">{</span>
            <span class="n">actualValue</span> <span class="o">=</span> <span class="n">newValue</span><span class="o">;</span>
        <span class="o">}</span>
    <span class="o">}</span>
<span class="o">}</span>
</pre></td></tr></tbody></table></code></pre></div></div>

<h4 id="åŠé€€ç‰ˆ-19">åŠé€€ç‰ˆ</h4>
<p>Atomic* CAS çš„åº•å±‚æ˜¯å¦‚ä½•å®ç°ï¼Ÿ</p>

<p>æ±‡ç¼–æŒ‡ä»¤ï¼š<code class="highlighter-rouge">cpmxchg</code> (Compare and Exchange)</p>
:ET