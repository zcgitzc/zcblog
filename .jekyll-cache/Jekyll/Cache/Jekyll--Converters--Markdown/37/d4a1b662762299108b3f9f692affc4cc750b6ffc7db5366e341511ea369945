I"¿:<p>åœ¨mongoDBæ•°æ®åº“ä¸­ï¼Œæ—¶é—´çš„ä¿å­˜æ˜¯ISODateç±»å‹ï¼Œormå…³ç³»æ˜ å°„ä¸ºjava.util.Dateç±»å‹ï¼Œå…¶ä¿å­˜çš„æ—¶é—´ä¸æˆ‘ä»¬ä¼šæœ‰8å°æ—¶çš„åŒºåˆ«ï¼ˆä¿å­˜çš„æ—¶é—´æ¯”æˆ‘ä»¬æ—©äº†8ä¸ªå°æ—¶ï¼‰ã€‚</p>

<p>åŸæ•°æ®ä¸ºï¼š</p>
<pre><code class="language-Bash">Person [id=11188, name=doctorwho, age=888888, birth=2016-01-01 13:55:00]
</code></pre>

<p>mongoDBæ•°æ®åº“ä¸­ä¸ºï¼š</p>
<pre><code class="language-mongoDB">{ 
    "_id" : "11188", 
    "_class" : "com.doctor.domain.Person", 
    "name" : "doctorwho", 
    "age" : NumberInt(888888), 
    "birth" : ISODate("2016-01-01T05:55:00.000+0000")
}
</code></pre>

<p>é‚£æˆ‘ä»¬ç”¨æ—¶é—´æŸ¥è¯¢æ•°æ®çš„æ—¶å€™ï¼Œçœ‹ä¸‹java é©±åŠ¨å¦‚ä½•åšçš„ï¼ˆéƒ¨åˆ†æ—¥å¿—ï¼‰ï¼š</p>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
44
45
46
47
48
49
50
51
52
53
54
55
56
57
58
59
60
</pre></td><td class="rouge-code"><pre><span class="kn">package</span> <span class="n">com</span><span class="o">.</span><span class="na">doctor</span><span class="o">.</span><span class="na">springdoc</span><span class="o">;</span>
 
<span class="kn">import</span> <span class="nn">java.time.LocalDateTime</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">java.time.ZoneId</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">java.time.ZonedDateTime</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">java.util.Date</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">java.util.List</span><span class="o">;</span>
 
<span class="kn">import</span> <span class="nn">org.springframework.context.support.ClassPathXmlApplicationContext</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">org.springframework.data.mongodb.core.MongoTemplate</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">org.springframework.data.mongodb.core.query.Criteria</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">org.springframework.data.mongodb.core.query.Query</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">org.springframework.data.mongodb.core.query.Update</span><span class="o">;</span>
 
<span class="kn">import</span> <span class="nn">com.doctor.domain.Person</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">com.mongodb.WriteResult</span><span class="o">;</span>
 
<span class="cm">/**
 * JSONSerializers L205-216æœ‰å…³mongoDBå¯¹æ—¶é—´çš„å¤„ç†ISODateä¸æˆ‘ä»¬æ—¶åŒºç›¸å·®8å°æ—¶ï¼ˆåšä¸ªæ—¶åŒºè½¬æ¢ï¼‰
 * 
 * @author sdcuike
 *
 * @time 2015å¹´12æœˆ27æ—¥ ä¸‹åˆ10:54:16
 */</span>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">SavingUpdatingRemovingDocuments</span> <span class="o">{</span>
 
    <span class="cm">/**
     * @param args
     */</span>
    <span class="kd">public</span> <span class="kd">static</span> <span class="kt">void</span> <span class="nf">main</span><span class="o">(</span><span class="nc">String</span><span class="o">[]</span> <span class="n">args</span><span class="o">)</span> <span class="o">{</span>
        <span class="nc">ClassPathXmlApplicationContext</span> <span class="n">context</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">ClassPathXmlApplicationContext</span><span class="o">(</span><span class="s">"classpath:/mongoDBConfig/spring-mongoDB.xml"</span><span class="o">);</span>
        <span class="nc">MongoTemplate</span> <span class="n">mongoTemplate</span> <span class="o">=</span> <span class="n">context</span><span class="o">.</span><span class="na">getBean</span><span class="o">(</span><span class="nc">MongoTemplate</span><span class="o">.</span><span class="na">class</span><span class="o">);</span>
 
        <span class="nc">Person</span> <span class="n">person</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">Person</span><span class="o">(</span><span class="s">"doctorwho"</span><span class="o">,</span> <span class="mi">28888</span><span class="o">,</span> <span class="s">"11188"</span><span class="o">);</span>
 
        <span class="nc">LocalDateTime</span> <span class="n">localDateTime</span> <span class="o">=</span> <span class="nc">LocalDateTime</span><span class="o">.</span><span class="na">of</span><span class="o">(</span><span class="mi">2016</span><span class="o">,</span> <span class="mi">1</span><span class="o">,</span> <span class="mi">1</span><span class="o">,</span> <span class="mi">13</span><span class="o">,</span> <span class="mi">55</span><span class="o">);</span>
        <span class="nc">ZonedDateTime</span> <span class="n">zonedDateTime</span> <span class="o">=</span> <span class="n">localDateTime</span><span class="o">.</span><span class="na">atZone</span><span class="o">(</span><span class="nc">ZoneId</span><span class="o">.</span><span class="na">of</span><span class="o">(</span><span class="s">"Asia/Shanghai"</span><span class="o">));</span>
        <span class="n">person</span><span class="o">.</span><span class="na">setBirth</span><span class="o">(</span><span class="nc">Date</span><span class="o">.</span><span class="na">from</span><span class="o">(</span><span class="n">zonedDateTime</span><span class="o">.</span><span class="na">toInstant</span><span class="o">()));</span>
 
        <span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="n">person</span><span class="o">);</span>
        <span class="k">if</span> <span class="o">(</span><span class="n">mongoTemplate</span><span class="o">.</span><span class="na">findById</span><span class="o">(</span><span class="n">person</span><span class="o">.</span><span class="na">getId</span><span class="o">(),</span> <span class="nc">Person</span><span class="o">.</span><span class="na">class</span><span class="o">)</span> <span class="o">==</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
            <span class="n">mongoTemplate</span><span class="o">.</span><span class="na">insert</span><span class="o">(</span><span class="n">person</span><span class="o">);</span>
        <span class="o">}</span>
 
        <span class="nc">Person</span> <span class="n">findById</span> <span class="o">=</span> <span class="n">mongoTemplate</span><span class="o">.</span><span class="na">findById</span><span class="o">(</span><span class="n">person</span><span class="o">.</span><span class="na">getId</span><span class="o">(),</span> <span class="nc">Person</span><span class="o">.</span><span class="na">class</span><span class="o">);</span>
        <span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="n">findById</span><span class="o">);</span>
 
        <span class="nc">List</span><span class="o">&lt;</span><span class="nc">Person</span><span class="o">&gt;</span> <span class="n">find</span> <span class="o">=</span> <span class="n">mongoTemplate</span><span class="o">.</span><span class="na">find</span><span class="o">(</span><span class="nc">Query</span><span class="o">.</span><span class="na">query</span><span class="o">(</span><span class="nc">Criteria</span><span class="o">.</span><span class="na">where</span><span class="o">(</span><span class="s">"name"</span><span class="o">).</span><span class="na">is</span><span class="o">(</span><span class="s">"doctorwho"</span><span class="o">).</span><span class="na">and</span><span class="o">(</span><span class="s">"age"</span><span class="o">).</span><span class="na">is</span><span class="o">(</span><span class="mi">28888</span><span class="o">)),</span> <span class="nc">Person</span><span class="o">.</span><span class="na">class</span><span class="o">);</span>
        <span class="n">find</span><span class="o">.</span><span class="na">forEach</span><span class="o">(</span><span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">::</span><span class="n">println</span><span class="o">);</span>
 
        <span class="nc">WriteResult</span> <span class="n">updateMulti</span> <span class="o">=</span> <span class="n">mongoTemplate</span><span class="o">.</span><span class="na">updateMulti</span><span class="o">(</span><span class="nc">Query</span><span class="o">.</span><span class="na">query</span><span class="o">(</span><span class="nc">Criteria</span><span class="o">.</span><span class="na">where</span><span class="o">(</span><span class="s">"age"</span><span class="o">).</span><span class="na">is</span><span class="o">(</span><span class="mi">28888</span><span class="o">)),</span> <span class="nc">Update</span><span class="o">.</span><span class="na">update</span><span class="o">(</span><span class="s">"age"</span><span class="o">,</span> <span class="mi">888888</span><span class="o">),</span> <span class="nc">Person</span><span class="o">.</span><span class="na">class</span><span class="o">);</span>
        <span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="n">updateMulti</span><span class="o">.</span><span class="na">getN</span><span class="o">());</span>
 
        <span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">"time query"</span><span class="o">);</span>
        <span class="nc">List</span><span class="o">&lt;</span><span class="nc">Person</span><span class="o">&gt;</span> <span class="n">find2</span> <span class="o">=</span> <span class="n">mongoTemplate</span><span class="o">.</span><span class="na">find</span><span class="o">(</span><span class="nc">Query</span><span class="o">.</span><span class="na">query</span><span class="o">(</span><span class="nc">Criteria</span><span class="o">.</span><span class="na">where</span><span class="o">(</span><span class="s">"birth"</span><span class="o">).</span><span class="na">is</span><span class="o">(</span><span class="n">person</span><span class="o">.</span><span class="na">getBirth</span><span class="o">())),</span> <span class="nc">Person</span><span class="o">.</span><span class="na">class</span><span class="o">);</span>
        <span class="n">find2</span><span class="o">.</span><span class="na">forEach</span><span class="o">(</span><span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">::</span><span class="n">println</span><span class="o">);</span>
        <span class="c1">// JSONSerializers L205-216æœ‰å…³mongoDBå¯¹æ—¶é—´çš„å¤„ç†ISODateä¸æˆ‘ä»¬æ—¶åŒºç›¸å·®8å°æ—¶ï¼ˆåšä¸ªæ—¶åŒºè½¬æ¢ï¼‰</span>
    <span class="o">}</span>
 
<span class="o">}</span>
</pre></td></tr></tbody></table></code></pre></div></div>

<p>time query:</p>

<ul>
  <li>
    <p>01-02 22:12:37.195 mainÂ  DEBUG org.springframework.data.mongodb.core.MongoTemplate - find using query: { â€œbirthâ€ : { â€œ$dateâ€ : â€œ2016-01-01T05:55:00.000Zâ€}} fields: null for class: class com.doctor.domain.Person in collection: person</p>
  </li>
  <li>
    <p>01-02 22:12:37.196 mainÂ  DEBUG org.springframework.data.mongodb.core.MongoDbUtils - Getting Mongo Database name=[sdcuike]
Person [id=11188, name=doctorwho, age=888888,birth=2016-01-01 13:55:00]</p>
  </li>
</ul>

<p>{ â€œbirthâ€ : { â€œ$dateâ€ : â€œ2016-01-01T05:55:00.000Zâ€}}æŸ¥è¯¢è¯­å¥æŒ‰æˆ‘ä»¬çš„ç›¸å·®æ—¶é—´æŸ¥è¯¢ï¼Œè¿”å›çš„æ•°æ®ç¡®å®æ˜¯æˆ‘ä»¬éœ€è¦çš„ï¼Œå³ä½¿æ•°æ®åº“ä¸­æˆ‘ä»¬çœ‹åˆ°çš„iso dateç›¸å·®8ä¸ªå°æ—¶ã€‚å…¶å®java é©±åŠ¨å¸®æˆ‘ä»¬åšäº†è½¬æ¢ã€‚</p>

<p>com.mongodb.util.JSONSerializers.LegacyDateSerializerä»£ç ï¼š</p>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
</pre></td><td class="rouge-code"><pre> <span class="kd">private</span> <span class="kd">static</span> <span class="kd">class</span> <span class="nc">LegacyDateSerializer</span> <span class="kd">extends</span> <span class="nc">CompoundObjectSerializer</span> <span class="o">{</span>
 
        <span class="nc">LegacyDateSerializer</span><span class="o">(</span><span class="nc">ObjectSerializer</span> <span class="n">serializer</span><span class="o">)</span> <span class="o">{</span>
            <span class="kd">super</span><span class="o">(</span><span class="n">serializer</span><span class="o">);</span>
        <span class="o">}</span>
 
        <span class="nd">@Override</span>
        <span class="kd">public</span> <span class="kt">void</span> <span class="nf">serialize</span><span class="o">(</span><span class="nc">Object</span> <span class="n">obj</span><span class="o">,</span> <span class="nc">StringBuilder</span> <span class="n">buf</span><span class="o">)</span> <span class="o">{</span>
            <span class="nc">Date</span> <span class="n">d</span> <span class="o">=</span> <span class="o">(</span><span class="nc">Date</span><span class="o">)</span> <span class="n">obj</span><span class="o">;</span>
            <span class="nc">SimpleDateFormat</span> <span class="n">format</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">SimpleDateFormat</span><span class="o">(</span>
                    <span class="s">"yyyy-MM-dd'T'HH:mm:ss.SSS'Z'"</span><span class="o">);</span>
            <span class="n">format</span><span class="o">.</span><span class="na">setCalendar</span><span class="o">(</span><span class="k">new</span> <span class="nc">GregorianCalendar</span><span class="o">(</span>
                    <span class="k">new</span> <span class="nf">SimpleTimeZone</span><span class="o">(</span><span class="mi">0</span><span class="o">,</span> <span class="s">"GMT"</span><span class="o">)));</span>
            <span class="n">serializer</span><span class="o">.</span><span class="na">serialize</span><span class="o">(</span>
                    <span class="k">new</span> <span class="nf">BasicDBObject</span><span class="o">(</span><span class="s">"$date"</span><span class="o">,</span> <span class="n">format</span><span class="o">.</span><span class="na">format</span><span class="o">(</span><span class="n">d</span><span class="o">)),</span>
                    <span class="n">buf</span><span class="o">);</span>
        <span class="o">}</span>
    <span class="o">}</span>
</pre></td></tr></tbody></table></code></pre></div></div>

<p>æ‰€ä»¥åœ¨è¿™é‡Œ<code class="highlighter-rouge">GregorianCalendar</code> ï¼Œåšäº†æ—¶åŒºè½¬æ¢ã€‚</p>
:ET